

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlL77uQpwMB9qBfHvy7wxYFNoyAGitGcY",
            authDomain: "situation-epid.firebaseapp.com",
            databaseURL: "https://situation-epid-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "situation-epid",
            storageBucket: "situation-epid.firebasestorage.app",
            messagingSenderId: "619424310207",
            appId: "1:619424310207:web:de8c53b897ab7940a0f70a",
            measurementId: "G-253XD0NV73"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            push,
            remove,
            onValue,
            off
        };
        
        // Initialize the application after Firebase is ready
        window.initializeFirebaseApp = function() {
            console.log('üî• Firebase connected to Asia Southeast region!');
            
            // Update Firebase status indicator
            const firebaseStatus = document.getElementById('firebaseStatus');
            if (firebaseStatus) {
                firebaseStatus.className = 'mt-2 inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium';
                firebaseStatus.innerHTML = `
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢) ‡πÅ‡∏•‡πâ‡∏ß
                `;
            }
            
            initializeData();
            showPage('summary');
            
            // Show connection status notification
            const statusDiv = document.createElement('div');
            statusDiv.className = 'fixed top-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 slide-in text-sm';
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>
                    üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                </div>
            `;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@100;200;300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Anuphan', sans-serif; 
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-card {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(6, 95, 70, 0.3);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(6, 95, 70, 0.3);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 95, 70, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
            border: none;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(6, 95, 70, 0.3);
            transform: translateY(-2px);
        }
        
        .tab-inactive {
            color: #6b7280;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            transform: translateY(-1px);
        }
        
        .input-field {
            border: 2px solid rgba(6, 95, 70, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .input-field:focus {
            outline: none;
            border-color: #065f46;
            box-shadow: 0 0 0 4px rgba(6, 95, 70, 0.1);
            background: white;
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid rgba(6, 95, 70, 0.1);
        }
        
        .table-row:hover {
            background: rgba(6, 95, 70, 0.05);
        }
        
        .icon-gradient-blue {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
        }
        
        .icon-gradient-green {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            color: white;
        }
        
        .icon-gradient-purple {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
        }
        
        .icon-gradient-orange {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            color: white;
        }
        
        .icon-gradient-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .icon-gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulse-glow {
            from { box-shadow: 0 4px 20px rgba(6, 95, 70, 0.3); }
            to { box-shadow: 0 8px 40px rgba(6, 95, 70, 0.5); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slideInFromTop {
            animation: slideInFromTop 0.5s ease-out;
        }
        
        @keyframes slideInFromTop {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .master-data-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .master-data-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(6, 95, 70, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .master-data-card:hover::before {
            left: 100%;
        }
        
        .master-data-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(6, 95, 70, 0.2);
            border-color: rgba(6, 95, 70, 0.3);
        }
        
        .notification-badge {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: -8px;
            right: -8px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        /* Report Preview Styles */
        .report-preview {
            max-width: 210mm;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 0 auto;
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content {
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content h1 {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content h2 {
            font-size: 16px;
            font-weight: normal;
            text-align: center;
            margin: 0.3rem 0;
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content h3 {
            font-size: 14px;
            font-weight: normal;
            text-align: center;
            margin: 0.3rem 0;
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content ul {
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content li {
            margin: 0.3rem 0;
            line-height: 1.5;
            font-family: 'Anuphan', sans-serif;
        }
        
        .report-content p {
            font-family: 'Anuphan', sans-serif;
        }
        
        @media print {
            .report-preview {
                box-shadow: none;
                width: 100%;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Background Pattern -->
    <div class="fixed inset-0 opacity-10">
        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 25% 25%, white 2px, transparent 2px); background-size: 50px 50px;"></div>
    </div>

    <!-- Header -->
    <header class="relative z-10 pt-8 pb-6">
        <div class="max-w-7xl mx-auto px-4">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-20 h-20 gradient-card flex items-center justify-center mx-auto mb-6 floating-animation">
                            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"/>
                            </svg>
                        </div>
                        <h1 class="text-4xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-6">
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ
                        </h1>
                        <p class="text-gray-600 text-lg mb-4">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</p>
                        <div class="mt-4 inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </div>
                        <div id="firebaseStatus" class="mt-2 inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></div>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 py-6 relative z-10">
        <div class="glass-card p-3">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <button id="summaryTab" onclick="showPage('summary')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-active">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                        <span class="text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</span>
                    </div>
                </button>
                <button id="reportTab" onclick="showPage('report')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-inactive">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                        </svg>
                        <span class="text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                    </div>
                </button>
                <button id="patientDbTab" onclick="showPage('patientDb')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-inactive">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z"/>
                        </svg>
                        <span class="text-sm">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                    </div>
                </button>

                <button id="masterDataTab" onclick="showPage('masterData')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-inactive">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                        <span class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 pb-12 relative z-10">

        <!-- Summary Page -->
        <div id="summaryPage" class="slide-in">
            <!-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö -->
            <div class="glass-card p-8 mb-12">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-4">
                        ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                    </h2>
                    <p class="text-gray-600 text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ</p>
                </div>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                    <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ -->
                    <div class="glass-card p-6">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 icon-gradient-blue rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
                                <div id="diseaseCount" class="text-2xl font-bold text-gray-900">-</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                    </div>

                    <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                    <div class="glass-card p-6">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 icon-gradient-green rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                                <div id="patientCount" class="text-2xl font-bold text-gray-900">-</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                    </div>

                    <!-- ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                    <div class="glass-card p-6">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 icon-gradient-orange rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                                <div id="currentWeek" class="text-2xl font-bold text-gray-900">-</div>
                            </div>
                        </div>
                        <div id="weekDateRange" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>
            </div>

            <!-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div class="glass-card p-8 mb-12">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-4">
                        ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </h2>
                    <p class="text-gray-600 text-lg">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>
                
                <div id="summaryDatabaseOverviewGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Database overview cards will be populated here -->
                    <div class="text-center text-gray-500 col-span-full py-12">
                        <div class="animate-spin w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full mx-auto mb-3"></div>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ -->
            <div class="glass-card p-8 mb-12">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-4">
                        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ
                    </h2>
                    <p class="text-gray-600 text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ</p>
                </div>

                <div class="mb-8">
                    <label for="diseaseSelect" class="block text-sm font-medium text-gray-700 mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                    <select id="diseaseSelect" onchange="loadDiseaseDetails()" class="w-full max-w-md px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ --</option>
                    </select>
                </div>
                
                <div id="diseaseDetailsContainer" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏° -->
                        <div class="glass-card p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 icon-gradient-blue rounded-xl flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏° (‡∏£‡∏≤‡∏¢)</h3>
                                    <div id="totalPatients" class="text-2xl font-bold text-gray-900">-</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ</div>
                        </div>

                        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢ -->
                        <div class="glass-card p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 icon-gradient-green rounded-xl flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢)</h3>
                                    <div id="malePatients" class="text-2xl font-bold text-blue-600">-</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢</div>
                        </div>

                        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á -->
                        <div class="glass-card p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 icon-gradient-orange rounded-xl flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á (‡∏£‡∏≤‡∏¢)</h3>
                                    <div id="femalePatients" class="text-2xl font-bold text-pink-600">-</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á</div>
                        </div>

                        <!-- ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏´‡∏ç‡∏¥‡∏á -->
                        <div class="glass-card p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 icon-gradient-purple rounded-xl flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 01-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏´‡∏ç‡∏¥‡∏á</h3>
                                    <div id="genderRatio" class="text-2xl font-bold text-purple-600">-</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢ : ‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á</div>
                        </div>

                        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï -->
                        <div class="glass-card p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 icon-gradient-red rounded-xl flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (‡∏£‡∏≤‡∏¢)</h3>
                                    <div id="deathPatients" class="text-2xl font-bold text-red-600">-</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ</div>
                        </div>
                    </div>

                    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô -->
                    <div class="glass-card p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢</span>
                                    <span id="malePercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="maleBar" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á</span>
                                    <span id="femalePercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="femaleBar" class="bg-pink-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î -->
                    <div class="glass-card p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                        <div id="topDistrictsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Top districts will be populated here -->
                            <div class="text-center text-gray-500 col-span-full py-8">
                                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï</p>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ -->
                    <div class="glass-card p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</h3>
                        <div id="topAgeGroupsRateContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Top age groups by rate will be populated here -->
                            <div class="text-center text-gray-500 col-span-full py-8">
                                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ -->
                    <div class="glass-card p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</h3>
                        <div id="topAgeGroupsPercentageContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Top age groups by percentage will be populated here -->
                            <div class="text-center text-gray-500 col-span-full py-8">
                                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                            </div>
                        </div>
                    </div>

                    <!-- Epidemic Curve -->
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Epidemic Curve - ‡πÄ‡∏™‡πâ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h3>
                        <div class="relative h-96">
                            <canvas id="epidemicCurveChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="noDiseaseSelected" class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                    </svg>
                    <p class="text-lg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </div>
        </div>

        <!-- Report Page -->
        <div id="reportPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-3">
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ
                        </h2>
                        <p class="text-gray-600 text-lg">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                    </div>
                    <button onclick="showPage('summary')" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</label>
                            <select id="diseaseCode" class="w-full input-field" onchange="loadDiseaseInfo()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="date" id="startDate" class="w-full input-field">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="date" id="endDate" class="w-full input-field" onchange="updateReportMonth()">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="reportMonth" class="w-full input-field bg-gray-50" readonly>
                        </div>

                        <button onclick="generateReport()" class="w-full btn-primary text-lg py-4">
                            <svg class="w-6 h-6 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm3 2h6v2H7V4zm0 4h6v2H7V8zm0 4h6v2H7v-2z"/>
                            </svg>
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </button>
                    </div>

                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-700" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                            </svg>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                        </h3>
                        <div class="space-y-6">
                            <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                                <span class="text-xs font-bold text-blue-600 uppercase tracking-wide">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</span>
                                <p id="diseaseName" class="text-gray-900 mt-2 font-semibold text-lg">-</p>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                                <span class="text-xs font-bold text-green-600 uppercase tracking-wide">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                                <p id="reportResponsible" class="text-gray-900 mt-2 font-semibold">-</p>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                                <span class="text-xs font-bold text-purple-600 uppercase tracking-wide">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</span>
                                <p id="reportReviewer" class="text-gray-900 mt-2 font-semibold">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Preview Section -->
            <div id="reportPreviewSection" class="glass-card p-8 slide-in mt-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-800 to-blue-600 bg-clip-text text-transparent">
                        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </h3>
                    <button onclick="hideReportPreview()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- A4 Paper Preview -->
                <div class="bg-white shadow-2xl mx-auto border border-gray-300" style="width: 210mm; min-height: 297mm; padding: 25mm 20mm 15mm 25mm; font-family: 'Anuphan', sans-serif; position: relative; font-size: 16px; line-height: 1.6;">
                    <!-- Report Content -->
                    <div id="reportContent" style="min-height: calc(297mm - 40mm); padding-bottom: 40px;">
                        <!-- Content will be generated here -->
                    </div>
                    
                    <!-- Footer -->
                    <div class="absolute bottom-0 left-0 right-0 text-center text-sm text-gray-600" style="padding: 5mm; font-size: 12px; font-family: 'Anuphan', sans-serif;">
                        <div class="mb-1">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
                        <div>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Master Data Page -->
        <div id="masterDataPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-3">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </h2>
                        <p class="text-gray-600 text-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
                    </div>
                    <button onclick="showPage('summary')" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="master-data-card" onclick="showMasterDataDetail('diseases')">
                        <div class="w-16 h-16 icon-gradient-blue rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</h3>
                        <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('responsible')">
                        <div class="w-16 h-16 icon-gradient-green rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h3>
                        <p class="text-gray-600">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('population')">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('agePopulation')">
                        <div class="w-16 h-16 icon-gradient-orange rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</h3>
                        <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('thailandPopulation')">
                        <div class="w-16 h-16 icon-gradient-blue rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('bangkokDistricts')">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ç‡∏ß‡∏á ‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('diseaseHistory')">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2 1h10v8H5V6z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                        <p class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('epidemicWeeks')">
                        <div class="w-16 h-16 icon-gradient-green rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Database Page -->
        <div id="patientDbPage" class="hidden">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                        <div class="flex space-x-4">
                            <div class="flex space-x-4">
                                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFileUpload(event)">
                                <button onclick="document.getElementById('excelFileInput').click()" class="btn-primary flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                    <span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel</span>
                                </button>
                                <button onclick="showDeleteConfirmation()" class="flex items-center space-x-2 px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    <span>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Disease Summary Section -->
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="diseaseSummaryGrid">
                            <!-- Disease summary cards will be populated here -->
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            <span id="totalPatientCount">‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏£‡∏≤‡∏¢</span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="patientTable" class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏û‡∏®</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÅ‡∏Ç‡∏ß‡∏á</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="patientTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="deleteConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="flex items-center justify-center">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="mt-2 px-7 py-3">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 text-center">
                                    ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br/>
                                    ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-4 px-4 py-3">
                            <button onclick="deleteAllPatients()" class="flex-1 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                            </button>
                            <button onclick="hideDeleteConfirmation()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Import Progress Modal -->
            <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="flex items-center justify-center">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100">
                                <svg class="animate-spin h-6 w-6 text-emerald-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="mt-2 px-7 py-3">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <div class="mt-3">
                                <div class="relative pt-1">
                                    <div class="flex mb-2 items-center justify-between">
                                        <div>
                                            <span id="progressText" class="text-xs font-semibold inline-block text-emerald-800"></span>
                                        </div>
                                        <div class="text-right">
                                            <span id="progressPercentage" class="text-xs font-semibold inline-block text-emerald-800"></span>
                                        </div>
                                    </div>
                                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-emerald-200">
                                        <div id="progressBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-emerald-800 w-0 transition-all duration-300"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="cancelImport" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors duration-200">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Master Data Detail Pages -->
        <div id="masterDataDetailPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <h2 id="masterDataDetailTitle" class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent"></h2>
                    <div class="flex space-x-4">
                        <button id="addNewButton" class="btn-primary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="showPage('masterData')" class="btn-secondary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                            </svg>
                            ‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                    </div>
                </div>
                <div id="masterDataDetailContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Patient Database Functions
        window.importCancelled = false; // Move to global scope

        function showImportProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${current} ‡∏à‡∏≤‡∏Å ${total} ‡∏£‡∏≤‡∏¢`;
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
        }

        function showImportModal() {
            const modal = document.getElementById('importModal');
            modal.classList.remove('hidden');
            window.importCancelled = false;

            // Setup cancel button
            document.getElementById('cancelImport').onclick = () => {
                window.importCancelled = true;
                modal.classList.add('hidden');
            };
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        async function handleExcelFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel');
                    return;
                }

                showImportModal();

                // Transform data to match our schema
                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Excel
                function validateAndFormatDate(dateValue) {
                    if (!dateValue) return '';
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Excel date number
                    if (typeof dateValue === 'number') {
                        const date = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                        if (!isNaN(date.getTime())) {
                            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                        }
                    }
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy
                    if (typeof dateValue === 'string' && dateValue.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        return dateValue;
                    }
                    
                    return '';
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                const patientsWithAgeGroup = await Promise.all(jsonData.map(async row => {
                    const patientData = {
                        diseaseCode: row['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || '',
                        gender: row['‡πÄ‡∏û‡∏®'] || '',
                        ageYears: parseInt(row['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ']) || 0,
                        ageMonths: parseInt(row['‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô']) || 0,
                        ageDays: parseInt(row['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô']) || 0,
                        subdistrict: row['‡πÅ‡∏Ç‡∏ß‡∏á'] || '',
                        district: row['‡πÄ‡∏Ç‡∏ï'] || '',
                        province: row['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || '',
                        onsetDate: validateAndFormatDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢']),
                        patientCondition: row['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'] || '',
                        deathDate: validateAndFormatDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])
                    };

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                    try {
                        const ageGroup = await getPatientAgeGroup(patientData);
                        patientData.ageGroup = ageGroup;
                    } catch (error) {
                        console.warn('Could not determine age group for patient:', error);
                        patientData.ageGroup = '-';
                    }

                    return patientData;
                }));

                // Save to Firebase
                const { database, ref, push } = window.firebaseDB;
                const patientRef = ref(database, 'patients');

                const total = patientsWithAgeGroup.length;
                for (let i = 0; i < total; i++) {
                    if (window.importCancelled) {
                        hideImportModal();
                        alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
                        return;
                    }

                    await push(patientRef, patientsWithAgeGroup[i]);
                    showImportProgress(i + 1, total);
                }

                // Update the table
                displayPatients();
                
                // Hide modal and show success message
                hideImportModal();
                alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${total} ‡∏£‡∏≤‡∏¢`);
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                if (window.firebaseDB) {
                    loadSystemOverview();
                }
            } catch (error) {
                console.error('Error processing Excel file:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å dd/mm/yyyy ‡πÄ‡∏õ‡πá‡∏ô Date object
        function parseThaiDate(dateStr) {
            if (!dateStr) return null;
            const [day, month, year] = dateStr.split('/').map(num => parseInt(num, 10));
            if (!day || !month || !year) return null;
            return new Date(year, month - 1, day);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy
        function formatThaiDate(dateStr) {
            if (!dateStr) return '-';
            const date = parseThaiDate(dateStr);
            if (!date || isNaN(date.getTime())) return dateStr; // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Cache
        let diseaseCache = {};
        window.allPatients = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        window.currentPatientPage = 1;
        const itemsPerPage = 50; // ‡πÅ‡∏™‡∏î‡∏á 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤

        async function loadDiseases() {
            try {
                const { database, ref, get } = window.firebaseDB;
                const diseaseRef = ref(database, 'diseases');
                const snapshot = await get(diseaseRef);
                
                if (snapshot.exists()) {
                    const diseases = snapshot.val();
                    diseaseCache = {};
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Map ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ disease code ‡πÄ‡∏õ‡πá‡∏ô key
                    Object.entries(diseases).forEach(([key, disease]) => {
                        if (disease.code) {
                            diseaseCache[disease.code] = disease.name;
                        }
                    });
                    console.log('Loaded diseases:', Object.keys(diseaseCache).length);
                } else {
                    console.log('No diseases data available');
                }
            } catch (error) {
                console.error('Error loading diseases:', error);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
        function getDiseaseName(diseaseCode) {
            return diseaseCache[diseaseCode] || diseaseCode || '-';
        }

        async function displayPatients() {
            console.log('Starting to display patients...');
            if (!window.firebaseDB) {
                console.error('Firebase not initialized');
                return;
            }
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
            loadDiseases();

            const { database, ref, onValue } = window.firebaseDB;
            if (!database || !ref || !onValue) {
                console.error('Firebase functions not available');
                return;
            }

            const patientRef = ref(database, 'patients');
            console.log('Patient reference created');
            
            onValue(patientRef, async (snapshot) => {
                console.log('Received Firebase snapshot');
                const data = snapshot.val();
                const tableBody = document.getElementById('patientTableBody');
                if (!tableBody) {
                    console.error('Patient table body not found');
                    return;
                }

                if (data) {
                    console.log('Found patient data:', Object.keys(data).length, 'records');
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô allPatients
                    window.allPatients = Object.entries(data).map(([key, patient]) => ({
                        ...patient,
                        id: key
                    }));
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö pagination
                    await displayPaginatedPatients();
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                    createDiseaseSummary();
                } else {
                    console.log('No patient data found');
                    window.allPatients = [];
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="px-6 py-4 text-center text-gray-500">
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                            </td>
                        </tr>
                    `;
                    updatePaginationInfo(0, 1, 1);
                    createDiseaseSummary(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                }
            }, (error) => {
                console.error('Error fetching patient data:', error);
                const tableBody = document.getElementById('patientTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="px-6 py-4 text-center text-red-500">
                                ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                            </td>
                        </tr>
                    `;
                }
            });
        }

        function createDiseaseSummary() {
            if (!window.allPatients || window.allPatients.length === 0) {
                document.getElementById('diseaseSummaryGrid').innerHTML = '<p class="text-gray-500 col-span-full text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>';
                document.getElementById('totalPatientCount').textContent = '‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏£‡∏≤‡∏¢';
                return;
            }

            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ
            const diseaseCount = {};
            window.allPatients.forEach(patient => {
                const diseaseCode = patient.diseaseCode;
                if (diseaseCode) {
                    diseaseCount[diseaseCode] = (diseaseCount[diseaseCode] || 0) + 1;
                }
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
            const sortedDiseases = Object.entries(diseaseCount)
                .sort(([,a], [,b]) => b - a);

            const summaryGrid = document.getElementById('diseaseSummaryGrid');
            const totalPatients = window.allPatients.length;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á cards ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ
            const diseaseCards = sortedDiseases.map(([diseaseCode, count]) => {
                const diseaseName = getDiseaseName(diseaseCode);
                const percentage = ((count / totalPatients) * 100).toFixed(1);
                
                return `
                    <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium text-gray-900 truncate">${diseaseName}</h4>
                            <span class="text-xs text-gray-500">${diseaseCode}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold text-emerald-600">${count}</span>
                            <span class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢ (${percentage}%)</span>
                        </div>
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-emerald-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            summaryGrid.innerHTML = diseaseCards;
            document.getElementById('totalPatientCount').textContent = `‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalPatients} ‡∏£‡∏≤‡∏¢`;
        }

        async function displayPaginatedPatients() {
            const tableBody = document.getElementById('patientTableBody');
            if (!tableBody) return;

            const totalRecords = window.allPatients.length;
            const totalPages = Math.ceil(totalRecords / itemsPerPage);
            const startIndex = (window.currentPatientPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageData = window.allPatients.slice(startIndex, endIndex);

            tableBody.innerHTML = '';

            // ‡πÅ‡∏™‡∏î‡∏á loading state
            tableBody.innerHTML = '<tr><td colspan="13" class="px-6 py-4 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏...</td></tr>';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö async ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
            const rows = [];
            for (const patient of currentPageData) {
                const row = document.createElement('tr');
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ
                const ageGroup = await getPatientAgeGroup(patient);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.diseaseCode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getDiseaseName(patient.diseaseCode)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.gender}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.ageYears !== undefined ? patient.ageYears : patient.ageYear !== undefined ? patient.ageYear : 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">${ageGroup}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.ageMonths || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.ageDays || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.subdistrict}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.district}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.province}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatThaiDate(patient.onsetDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${patient.patientCondition}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatThaiDate(patient.deathDate)}</td>
                `;
                rows.push(row);
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó pagination info
            updatePatientPaginationInfo(totalRecords, window.currentPatientPage, totalPages);
            updatePatientPaginationControls(totalPages);
        }

        function updatePatientPaginationInfo(totalRecords, currentPage, totalPages) {
            let paginationInfo = document.getElementById('patientPaginationInfo');
            if (!paginationInfo) {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á pagination info element ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                const tableContainer = document.querySelector('#patientTable').parentElement;
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'flex items-center justify-between px-6 py-3 bg-white border-t border-gray-200';
                paginationDiv.innerHTML = `
                    <div>
                        <p id="patientPaginationInfo" class="text-sm text-gray-700"></p>
                    </div>
                    <div id="patientPaginationControls" class="flex-1 flex justify-end">
                    </div>
                `;
                tableContainer.appendChild(paginationDiv);
                paginationInfo = document.getElementById('patientPaginationInfo');
            }
            
            const startRecord = Math.min((currentPage - 1) * itemsPerPage + 1, totalRecords);
            const endRecord = Math.min(currentPage * itemsPerPage, totalRecords);
            paginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á ${startRecord} ‡∏ñ‡∏∂‡∏á ${endRecord} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        function updatePatientPaginationControls(totalPages) {
            const controls = document.getElementById('patientPaginationControls');
            if (!controls || totalPages <= 1) {
                if (controls) controls.innerHTML = '';
                return;
            }

            let html = `
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <button onclick="goToPatientPage(${window.currentPatientPage - 1})" ${window.currentPatientPage === 1 ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${window.currentPatientPage === 1 ? 'cursor-not-allowed opacity-50' : ''}">
                        ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    </button>
            `;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤
            const startPage = Math.max(1, window.currentPatientPage - 2);
            const endPage = Math.min(totalPages, window.currentPatientPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === window.currentPatientPage;
                html += `
                    <button onclick="goToPatientPage(${i})" 
                            class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${isActive 
                                ? 'z-10 bg-emerald-50 border-emerald-500 text-emerald-600' 
                                : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}">
                        ${i}
                    </button>
                `;
            }

            html += `
                    <button onclick="goToPatientPage(${window.currentPatientPage + 1})" ${window.currentPatientPage === totalPages ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${window.currentPatientPage === totalPages ? 'cursor-not-allowed opacity-50' : ''}">
                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    </button>
                </nav>
            `;

            controls.innerHTML = html;
        }

        async function goToPatientPage(page) {
            const totalPages = Math.ceil(window.allPatients.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                window.currentPatientPage = page;
                await displayPaginatedPatients();
            }
        }

        // Call displayPatients when the page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, checking Firebase...');
            if (window.firebaseDB) {
                console.log('Firebase available, displaying patients...');
                displayPatients();
            } else {
                console.log('Firebase not available yet');
            }
        });

        // Delete confirmation functions
        function showDeleteConfirmation() {
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        function hideDeleteConfirmation() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }

        async function deleteAllPatients() {
            try {
                const { database, ref, remove } = window.firebaseDB;
                const patientRef = ref(database, 'patients');
                
                // Remove all data
                await remove(patientRef);
                
                // Hide confirmation modal
                hideDeleteConfirmation();
                
                // Show success message
                alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
                // Refresh the table
                displayPatients();
                
                // Reset summary
                createDiseaseSummary();
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                if (window.firebaseDB) {
                    loadSystemOverview();
                }
            } catch (error) {
                console.error('Error deleting patients:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function getLatestEpidemicWeekFromDatabase() {
            try {
                const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                
                if (!epidemicWeeks || epidemicWeeks.length === 0) {
                    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const fallbackWeek = getCurrentEpiWeekDateRange();
                    return {
                        weekNumber: fallbackWeek.weekNumber,
                        year: currentYear,
                        startDate: fallbackWeek.startDate,
                        endDate: fallbackWeek.endDate,
                        dateRange: fallbackWeek.dateRange,
                        isFromDatabase: false
                    };
                }
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏µ)
                const relevantWeeks = epidemicWeeks.filter(week => {
                    const weekYear = parseInt(week.year);
                    return weekYear >= currentYear - 1 && weekYear <= currentYear;
                });
                
                if (relevantWeeks.length === 0) {
                    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const fallbackWeek = getCurrentEpiWeekDateRange();
                    return {
                        weekNumber: fallbackWeek.weekNumber,
                        year: currentYear,
                        startDate: fallbackWeek.startDate,
                        endDate: fallbackWeek.endDate,
                        dateRange: fallbackWeek.dateRange,
                        isFromDatabase: false
                    };
                }
                
                // ‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                // 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                const sortedWeeks = relevantWeeks.sort((a, b) => {
                    if (a.year !== b.year) {
                        return parseInt(b.year) - parseInt(a.year); // ‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
                    }
                    return parseInt(b.weekNumber) - parseInt(a.weekNumber); // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
                });
                
                // 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                let selectedWeek = null;
                
                // ‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const currentWeekNumber = getCurrentEpiWeek();
                const currentYearWeeks = sortedWeeks.filter(w => parseInt(w.year) === currentYear);
                
                if (currentYearWeeks.length > 0) {
                    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const validCurrentYearWeeks = currentYearWeeks.filter(w => 
                        parseInt(w.weekNumber) <= currentWeekNumber
                    );
                    
                    if (validCurrentYearWeeks.length > 0) {
                        selectedWeek = validCurrentYearWeeks[0]; // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    }
                }
                
                // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                if (!selectedWeek) {
                    const lastYearWeeks = sortedWeeks.filter(w => parseInt(w.year) === currentYear - 1);
                    if (lastYearWeeks.length > 0) {
                        selectedWeek = lastYearWeeks[0];
                    } else {
                        selectedWeek = sortedWeeks[0]; // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏î‡πÜ
                    }
                }
                
                // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                if (!selectedWeek) {
                    const fallbackWeek = getCurrentEpiWeekDateRange();
                    return {
                        weekNumber: fallbackWeek.weekNumber,
                        year: currentYear,
                        startDate: fallbackWeek.startDate,
                        endDate: fallbackWeek.endDate,
                        dateRange: fallbackWeek.dateRange,
                        isFromDatabase: false
                    };
                }
                
                // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                const startDate = selectedWeek.startDate ? formatDateTH(selectedWeek.startDate) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const endDate = selectedWeek.endDate ? formatDateTH(selectedWeek.endDate) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const dateRange = `${startDate} - ${endDate}`;
                
                return {
                    weekNumber: selectedWeek.weekNumber,
                    year: selectedWeek.year,
                    startDate: startDate,
                    endDate: endDate,
                    dateRange: dateRange,
                    note: selectedWeek.note,
                    isFromDatabase: true
                };
                
            } catch (error) {
                console.error('Error getting latest epidemic week from database:', error);
                // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const fallbackWeek = getCurrentEpiWeekDateRange();
                return {
                    weekNumber: fallbackWeek.weekNumber,
                    year: new Date().getFullYear(),
                    startDate: fallbackWeek.startDate,
                    endDate: fallbackWeek.endDate,
                    dateRange: fallbackWeek.dateRange,
                    isFromDatabase: false
                };
            }
        }

        // System Overview Functions - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏£‡∏¥‡∏á
        async function loadSystemOverview() {
            try {
                console.log('Loading system overview data...');
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á
                const { database, ref, get } = window.firebaseDB;
                let diseaseCount = 0;
                let patientCount = 0;
                
                if (database && ref && get) {
                    const patientSnapshot = await get(ref(database, 'patients'));
                    if (patientSnapshot.exists()) {
                        const patients = patientSnapshot.val();
                        const patientsArray = Object.values(patients);
                        patientCount = patientsArray.length;
                        
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        const uniqueDiseases = new Set();
                        patientsArray.forEach(patient => {
                            if (patient.diseaseCode) {
                                uniqueDiseases.add(patient.diseaseCode);
                            }
                        });
                        diseaseCount = uniqueDiseases.size;
                    }
                }
                
                document.getElementById('diseaseCount').textContent = diseaseCount.toLocaleString();
                document.getElementById('patientCount').textContent = patientCount.toLocaleString();
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const latestEpiWeek = await getLatestEpidemicWeekFromDatabase();
                document.getElementById('currentWeek').textContent = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${latestEpiWeek.weekNumber}/${latestEpiWeek.year}`;
                document.getElementById('weekDateRange').textContent = latestEpiWeek.dateRange;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const weekDateRangeElement = document.getElementById('weekDateRange');
                if (latestEpiWeek.isFromDatabase) {
                    weekDateRangeElement.title = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î';
                    weekDateRangeElement.classList.add('cursor-help');
                } else {
                    weekDateRangeElement.title = '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
                    weekDateRangeElement.classList.add('cursor-help', 'text-orange-600');
                }
                
                console.log('System overview loaded successfully');
            } catch (error) {
                console.error('Error loading system overview:', error);
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                document.getElementById('diseaseCount').textContent = '0';
                document.getElementById('patientCount').textContent = '0';
                document.getElementById('currentWeek').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ';
                document.getElementById('weekDateRange').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
            }
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
            loadSummaryDatabaseOverview();
        }

        // Summary Database Overview Functions
        async function loadSummaryDatabaseOverview() {
            try {
                const overviewGrid = document.getElementById('summaryDatabaseOverviewGrid');
                if (!overviewGrid) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ
                const { database, ref, get } = window.firebaseDB;
                if (!database || !ref || !get) {
                    overviewGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>';
                    return;
                }

                const [patientSnapshot, diseaseSnapshot] = await Promise.all([
                    get(ref(database, 'patients')),
                    get(ref(database, 'diseases'))
                ]);

                if (!patientSnapshot.exists()) {
                    overviewGrid.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-12">
                            <div class="text-6xl mb-4">üì≠</div>
                            <h4 class="text-lg font-semibold mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h4>
                            <p class="text-sm">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                        </div>
                    `;
                    return;
                }

                const patients = Object.values(patientSnapshot.val());
                const diseases = diseaseSnapshot.exists() ? diseaseSnapshot.val() : [];
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
                const diseaseMap = {};
                if (diseases && Array.isArray(diseases)) {
                    diseases.forEach(disease => {
                        if (disease.code && disease.name) {
                            diseaseMap[disease.code] = disease.name;
                        }
                    });
                }

                // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ
                const diseaseCount = {};
                patients.forEach(patient => {
                    if (patient.diseaseCode) {
                        diseaseCount[patient.diseaseCode] = (diseaseCount[patient.diseaseCode] || 0) + 1;
                    }
                });

                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (> 0) ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                const filteredDiseases = Object.entries(diseaseCount)
                    .filter(([code, count]) => count > 0)
                    .sort(([,a], [,b]) => b - a);

                if (filteredDiseases.length === 0) {
                    overviewGrid.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-12">
                            <div class="text-6xl mb-4">üìä</div>
                            <h4 class="text-lg font-semibold mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h4>
                            <p class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                        </div>
                    `;
                    return;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const overviewCards = filteredDiseases.map(([diseaseCode, count]) => {
                    const diseaseName = diseaseMap[diseaseCode] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ';
                    const totalPatients = patients.length;
                    const percentage = ((count / totalPatients) * 100).toFixed(1);
                    
                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-lg hover:border-blue-200 transition-all duration-300">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full mr-3"></div>
                                    <span class="text-sm text-gray-500 font-medium">${diseaseCode}</span>
                                </div>
                                <span class="text-sm text-blue-600 font-semibold">${percentage}%</span>
                            </div>
                            <h4 class="text-base font-bold text-gray-900 mb-3 line-clamp-2" title="${diseaseName}">
                                ${diseaseName}
                            </h4>
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-2xl font-bold text-blue-600">${count.toLocaleString()}</span>
                                <span class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500" 
                                     style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                overviewGrid.innerHTML = overviewCards;

            } catch (error) {
                console.error('Error loading summary database overview:', error);
                const overviewGrid = document.getElementById('summaryDatabaseOverviewGrid');
                if (overviewGrid) {
                    overviewGrid.innerHTML = `
                        <div class="text-center text-red-500 col-span-full py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h4 class="text-lg font-semibold mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4>
                            <p class="text-sm">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                        </div>
                    `;
                }
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô dropdown
        async function loadDiseaseSelectOptions() {
            try {
                const { database, ref, get } = window.firebaseDB;
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                const [patientSnapshot, diseaseSnapshot] = await Promise.all([
                    get(ref(database, 'patients')),
                    get(ref(database, 'diseases'))
                ]);
                
                const patients = patientSnapshot.val();
                const diseases = diseaseSnapshot.val();
                
                if (!patients) {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    const select = document.getElementById('diseaseSelect');
                    select.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ --</option>';
                    return;
                }
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mapping ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
                const diseaseMap = new Map();
                if (diseases && Array.isArray(diseases)) {
                    diseases.forEach(disease => {
                        if (disease.code && disease.name) {
                            diseaseMap.set(disease.code, disease.name);
                        }
                    });
                }
                
                console.log('Disease map loaded:', diseaseMap.size, 'diseases');
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                const diseaseCount = {};
                
                Object.values(patients).forEach(patient => {
                    if (patient.diseaseCode) {
                        diseaseCount[patient.diseaseCode] = (diseaseCount[patient.diseaseCode] || 0) + 1;
                    }
                });
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢) ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
                const sortedDiseases = Object.entries(diseaseCount)
                    .sort(([a, countA], [b, countB]) => {
                        if (countB !== countA) return countB - countA; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        return a.localeCompare(b); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
                    });
                
                // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô select
                const select = document.getElementById('diseaseSelect');
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏£‡∏Å)
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ --</option>';
                
                sortedDiseases.forEach(([diseaseCode, count]) => {
                    const option = document.createElement('option');
                    option.value = diseaseCode;
                    
                    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å Map
                    const diseaseName = diseaseMap.get(diseaseCode);
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ (‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ)" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠
                    if (diseaseName) {
                        option.textContent = `${diseaseCode} (${diseaseName})`;
                    } else {
                        option.textContent = diseaseCode;
                    }
                    
                    select.appendChild(option);
                });
                
                console.log(`Loaded ${sortedDiseases.length} diseases from patient database`);
                
            } catch (error) {
                console.error('Error loading disease options:', error);
                const select = document.getElementById('diseaseSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        async function loadDiseaseDetails() {
            const selectedDisease = document.getElementById('diseaseSelect').value;
            const detailsContainer = document.getElementById('diseaseDetailsContainer');
            const noSelectionDiv = document.getElementById('noDiseaseSelected');
            
            if (!selectedDisease) {
                detailsContainer.classList.add('hidden');
                noSelectionDiv.classList.remove('hidden');
                return;
            }
            
            noSelectionDiv.classList.add('hidden');
            detailsContainer.classList.remove('hidden');
            
            try {
                const { database, ref, get } = window.firebaseDB;
                const snapshot = await get(ref(database, 'patients'));
                const patients = snapshot.val();
                
                if (!patients) {
                    console.log('No patient data found');
                    return;
                }
                
                console.log('Selected disease CODE:', selectedDisease);
                console.log('Total patients in database:', Object.keys(patients).length);
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å - ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                const allPatients = Object.values(patients);
                let totalCount = 0;
                let maleCount = 0;
                let femaleCount = 0;
                let deathCount = 0;
                
                allPatients.forEach(patient => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏´‡∏±‡∏™ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏∑‡πà‡∏≠)
                    if (patient.diseaseCode && patient.diseaseCode.toString().trim() === selectedDisease.toString().trim()) {
                        totalCount++;
                        
                        console.log('Found matching patient:', {
                            diseaseCode: patient.diseaseCode,
                            gender: patient.gender,
                            status: patient.patientStatus,
                            deathDate: patient.deathDate
                        });
                        
                        // ‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®
                        const gender = patient.gender;
                        if (gender === '‡∏ä‡∏≤‡∏¢' || gender === 'Male' || gender === 'M') {
                            maleCount++;
                        } else if (gender === '‡∏´‡∏ç‡∏¥‡∏á' || gender === 'Female' || gender === 'F') {
                            femaleCount++;
                        }
                        
                        // ‡∏ô‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
                        const status = patient.patientStatus;
                        const deathDate = patient.deathDate;
                        if (status === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï' || status === '‡∏ï‡∏≤‡∏¢' || status === 'Dead' || 
                            (deathDate && deathDate !== '' && deathDate !== '-')) {
                            deathCount++;
                        }
                    }
                });
                
                console.log('Final counts - Total:', totalCount, 'Male:', maleCount, 'Female:', femaleCount, 'Deaths:', deathCount);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
                const malePercentage = totalCount > 0 ? (maleCount / totalCount * 100).toFixed(1) : 0;
                const femalePercentage = totalCount > 0 ? (femaleCount / totalCount * 100).toFixed(1) : 0;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:‡∏´‡∏ç‡∏¥‡∏á
                let genderRatio = '';
                if (maleCount > 0 && femaleCount > 0) {
                    const ratio = femaleCount / maleCount; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏ç‡∏¥‡∏á/‡∏ä‡∏≤‡∏¢
                    genderRatio = `1 : ${ratio.toFixed(2)}`;
                } else if (maleCount > 0 && femaleCount === 0) {
                    genderRatio = '‡∏ä‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
                } else if (maleCount === 0 && femaleCount > 0) {
                    genderRatio = '‡∏´‡∏ç‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
                } else {
                    genderRatio = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                }
                
                console.log('About to update UI with:', {
                    total: totalCount,
                    male: maleCount,
                    female: femaleCount,
                    deaths: deathCount,
                    ratio: genderRatio
                });
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                document.getElementById('totalPatients').textContent = totalCount.toLocaleString();
                document.getElementById('malePatients').textContent = maleCount.toLocaleString();
                document.getElementById('femalePatients').textContent = femaleCount.toLocaleString();
                document.getElementById('deathPatients').textContent = deathCount.toLocaleString();
                document.getElementById('genderRatio').textContent = genderRatio;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
                document.getElementById('malePercentage').textContent = `${malePercentage}%`;
                document.getElementById('femalePercentage').textContent = `${femalePercentage}%`;
                document.getElementById('maleBar').style.width = `${malePercentage}%`;
                document.getElementById('femaleBar').style.width = `${femalePercentage}%`;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Epidemic Curve
                await createEpidemicCurve(selectedDisease, allPatients);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï
                await createTopDistrictsRanking(selectedDisease);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                await createTopAgeGroupsRanking(selectedDisease);
                
                console.log('UI updated successfully');
                
            } catch (error) {
                console.error('Error loading disease details:', error);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        async function createTopDistrictsRanking(diseaseCode) {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const { database, ref, get } = window.firebaseDB;
                const [patientsSnapshot, populationSnapshot] = await Promise.all([
                    get(ref(database, 'patients')),
                    get(ref(database, 'population'))
                ]);
                
                const patients = patientsSnapshot.val();
                const populationData = populationSnapshot.val();
                
                if (!patients) {
                    const container = document.getElementById('topDistrictsContainer');
                    container.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-8">
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                        </div>
                    `;
                    return;
                }

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const allPatients = Object.values(patients);
                const filteredPatients = allPatients.filter(patient => 
                    patient.diseaseCode && patient.diseaseCode.toString().trim() === diseaseCode.toString().trim()
                );

                // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ç‡∏ï
                const districtCount = {};
                filteredPatients.forEach(patient => {
                    const district = patient.district || patient.‡πÄ‡∏Ç‡∏ï || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï';
                    if (district && district !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï') {
                        districtCount[district] = (districtCount[district] || 0) + 1;
                    }
                });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ç‡∏ï (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
                const districtPopulation = {};
                if (populationData) {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    const sortedPopulation = Object.values(populationData).sort((a, b) => (b.year || 2568) - (a.year || 2568));
                    
                    sortedPopulation.forEach(pop => {
                        const district = pop.district || pop.‡πÄ‡∏Ç‡∏ï;
                        if (district && !districtPopulation[district]) {
                            districtPopulation[district] = parseInt(pop.totalPopulation || (pop.malePopulation || 0) + (pop.femalePopulation || 0) || 0);
                        }
                    });
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                const districtRates = Object.entries(districtCount)
                    .map(([district, count]) => {
                        const population = districtPopulation[district] || 0;
                        const rate = population > 0 ? (count / population * 100000) : 0;
                        return {
                            district,
                            count,
                            population,
                            rate: Math.round(rate * 100) / 100 // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        };
                    })
                    .sort((a, b) => b.rate - a.rate)
                    .slice(0, 3);

                const container = document.getElementById('topDistrictsContainer');
                
                if (districtRates.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-8">
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï</p>
                        </div>
                    `;
                    return;
                }

                const rankColors = ['bg-gray-100 border-gray-300', 'bg-gray-100 border-gray-300', 'bg-gray-100 border-gray-300'];

                const districtCards = districtRates.map((data, index) => {
                    const rankNumber = index + 1;
                    const populationText = data.population > 0 ? data.population.toLocaleString() : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    const rateText = data.rate > 0 ? data.rate.toLocaleString() : '0';
                    
                    return `
                        <div class="border-2 ${rankColors[index]} rounded-lg p-4 text-center">
                            <div class="text-lg font-bold text-gray-700 mb-2">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${rankNumber}</div>
                            <h4 class="font-bold text-gray-800 mb-1 text-lg">‡πÄ‡∏Ç‡∏ï${data.district}</h4>
                            <div class="text-xl font-bold text-red-600 mb-1">${rateText}</div>
                            <div class="text-sm text-red-500 mb-2">‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</div>
                            <div class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${data.count.toLocaleString()} ‡∏£‡∏≤‡∏¢</div>
                            <div class="text-xs text-gray-500">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£: ${populationText} ‡∏Ñ‡∏ô</div>
                        </div>
                    `;
                }).join('');

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                const viewMoreButton = `
                    <div class="col-span-full mt-4 text-center">
                        <button onclick="showAllDistrictsRanking('${diseaseCode}')" 
                                class="bg-green-700 hover:bg-green-800 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                `;

                container.innerHTML = districtCards + viewMoreButton;
                
            } catch (error) {
                console.error('Error creating top districts ranking:', error);
                const container = document.getElementById('topDistrictsContainer');
                container.innerHTML = `
                    <div class="text-center text-red-500 col-span-full py-8">
                        <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï</p>
                    </div>
                `;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        async function createTopAgeGroupsRanking(diseaseCode) {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const { database, ref, get } = window.firebaseDB;
                const [patientsSnapshot, agePopulationSnapshot] = await Promise.all([
                    get(ref(database, 'patients')),
                    get(ref(database, 'agePopulation'))
                ]);
                
                const patients = patientsSnapshot.val();
                const agePopulationData = agePopulationSnapshot.val();
                
                if (!patients || !agePopulationData) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏');
                }

                console.log('üîç Age Groups Ranking Debug Info:');
                console.log('- Disease Code:', diseaseCode);
                console.log('- Total patients in DB:', Object.keys(patients).length);
                console.log('- Age population data type:', Array.isArray(agePopulationData) ? 'Array' : 'Object');
                console.log('- Age population count:', Array.isArray(agePopulationData) ? agePopulationData.length : Object.keys(agePopulationData).length);

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const allPatients = Object.values(patients);
                
                console.log('üîç Filtering patients for disease:', diseaseCode);
                console.log('- Total patients in database:', allPatients.length);
                
                // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                const samplePatient = allPatients[0];
                if (samplePatient) {
                    console.log('- Sample patient fields:', Object.keys(samplePatient));
                    console.log('- Sample patient disease fields:', {
                        diseaseCode: samplePatient.diseaseCode,
                        ‡πÇ‡∏£‡∏Ñ: samplePatient.‡πÇ‡∏£‡∏Ñ,
                        ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ: samplePatient.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                    });
                    console.log('- Sample patient age fields:', {
                        ageYears: samplePatient.ageYears,
                        ageYear: samplePatient.ageYear,
                        '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ': samplePatient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'],
                        age: samplePatient.age
                    });
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏á
                const uniqueDiseases = [...new Set(allPatients.map(p => p.diseaseCode).filter(Boolean))];
                console.log('- Available disease codes in database:', uniqueDiseases);
                
                const filteredPatients = allPatients.filter(patient => 
                    patient.diseaseCode === diseaseCode || 
                    patient.‡πÇ‡∏£‡∏Ñ === diseaseCode ||
                    patient.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ === diseaseCode
                );
                
                console.log('- Filtered patients count:', filteredPatients.length);
                
                // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                if (filteredPatients.length > 0) {
                    console.log('- Sample filtered patients (first 3):');
                    filteredPatients.slice(0, 3).forEach((patient, index) => {
                        console.log(`  Patient ${index + 1}:`, {
                            diseaseCode: patient.diseaseCode,
                            ageGroup: patient.ageGroup,
                            hasAgeGroup: patient.hasOwnProperty('ageGroup'),
                            ageYears: patient.ageYears,
                            ageYear: patient.ageYear,
                            '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ': patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'],
                            age: patient.age,
                            finalAge: patient.ageYears || patient.ageYear || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] || patient.age
                        });
                    });
                } else {
                    console.log('‚ùå No patients found for disease code:', diseaseCode);
                    console.log('   Try one of these disease codes instead:', uniqueDiseases.slice(0, 5));
                }

                // ‡πÅ‡∏õ‡∏•‡∏á agePopulationData ‡πÄ‡∏õ‡πá‡∏ô array ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                let agePopulationArray = Array.isArray(agePopulationData) 
                    ? agePopulationData 
                    : Object.values(agePopulationData);
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                agePopulationArray = convertLegacyAgePopulationData(agePopulationArray);
                
                console.log('- Age population array length:', agePopulationArray.length);
                if (agePopulationArray.length > 0) {
                    console.log('- Sample age group:', agePopulationArray[0]);
                    console.log('- All age groups structure:', agePopulationArray.map(g => ({
                        year: g.year,
                        startAge: g.startAge,
                        endAge: g.endAge,
                        total: g.total,
                        hasStartAge: g.hasOwnProperty('startAge'),
                        hasEndAge: g.hasOwnProperty('endAge')
                    })));
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ageGroup ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                const ageGroupStats = calculateAgeGroupStats(filteredPatients, agePopulationArray);
                
                console.log('üéØ Age Group Stats Result:', {
                    topThreeLength: ageGroupStats.topThree.length,
                    percentageTopLength: ageGroupStats.percentageTop.length,
                    topThree: ageGroupStats.topThree,
                    percentageTop: ageGroupStats.percentageTop
                });
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
                const rateContainer = document.getElementById('topAgeGroupsRateContainer');
                const percentageContainer = document.getElementById('topAgeGroupsPercentageContainer');
                
                if (ageGroupStats.topThree.length === 0) {
                    rateContainer.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-8">
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                        </div>
                    `;
                    percentageContainer.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-8">
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                        </div>
                    `;
                    return;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢
                const rankColors = ['bg-yellow-100 border-yellow-300', 'bg-gray-100 border-gray-300', 'bg-orange-100 border-orange-300'];
                const rateCards = ageGroupStats.topThree.map((data, index) => {
                    const colorClass = rankColors[index] || 'bg-gray-100 border-gray-300';
                    return `
                        <div class="border-2 ${colorClass} rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800 mb-1">#${index + 1}</div>
                                <div class="text-lg font-semibold text-blue-600 mb-2">${data.ageGroup}</div>
                                <div class="text-sm text-gray-600 mb-2">
                                    ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: <span class="font-semibold">${data.patients.toLocaleString()}</span> ‡∏£‡∏≤‡∏¢
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£: <span class="font-semibold">${parseInt(data.population).toLocaleString()}</span> ‡∏Ñ‡∏ô
                                </div>
                                <div class="text-xl font-bold text-red-600">
                                    ${data.rate}
                                </div>
                                <div class="text-xs text-gray-500">‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢
                const rateViewMoreButton = `
                    <div class="col-span-full mt-4 text-center">
                        <button onclick="showAllAgeGroupsRanking('${diseaseCode}', 'rate')" 
                                class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                `;

                rateContainer.innerHTML = rateCards + rateViewMoreButton;

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                const percentageCards = ageGroupStats.percentageTop.map((data, index) => {
                    const colorClass = rankColors[index] || 'bg-gray-100 border-gray-300';
                    return `
                        <div class="border-2 ${colorClass} rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800 mb-1">#${index + 1}</div>
                                <div class="text-lg font-semibold text-purple-600 mb-2">${data.ageGroup}</div>
                                <div class="text-sm text-gray-600 mb-2">
                                    ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: <span class="font-semibold">${data.patients.toLocaleString()}</span> ‡∏£‡∏≤‡∏¢
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="font-semibold">${filteredPatients.length.toLocaleString()}</span> ‡∏£‡∏≤‡∏¢
                                </div>
                                <div class="text-xl font-bold text-green-600">
                                    ${data.percentage}%
                                </div>
                                <div class="text-xs text-gray-500">‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞
                const percentageViewMoreButton = `
                    <div class="col-span-full mt-4 text-center">
                        <button onclick="showAllAgeGroupsRanking('${diseaseCode}', 'percentage')" 
                                class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                `;

                percentageContainer.innerHTML = percentageCards + percentageViewMoreButton;
                
            } catch (error) {
                console.error('Error creating top age groups ranking:', error);
                const rateContainer = document.getElementById('topAgeGroupsRateContainer');
                const percentageContainer = document.getElementById('topAgeGroupsPercentageContainer');
                
                const errorMessage = `
                    <div class="text-center text-red-500 col-span-full py-8">
                        <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                    </div>
                `;
                
                rateContainer.innerHTML = errorMessage;
                percentageContainer.innerHTML = errorMessage;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á popup ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function showAllDistrictsRanking(diseaseCode) {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const { database, ref, get } = window.firebaseDB;
                const [patientsSnapshot, populationSnapshot] = await Promise.all([
                    get(ref(database, 'patients')),
                    get(ref(database, 'population'))
                ]);
                
                const patients = patientsSnapshot.val();
                const populationData = populationSnapshot.val();
                
                if (!patients) {
                    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
                    return;
                }

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const allPatients = Object.values(patients);
                const filteredPatients = allPatients.filter(patient => 
                    patient.diseaseCode && patient.diseaseCode.toString().trim() === diseaseCode.toString().trim()
                );

                // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ç‡∏ï
                const districtCount = {};
                filteredPatients.forEach(patient => {
                    const district = patient.district || patient.‡πÄ‡∏Ç‡∏ï || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï';
                    if (district && district !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï') {
                        districtCount[district] = (districtCount[district] || 0) + 1;
                    }
                });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ç‡∏ï (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
                const districtPopulation = {};
                if (populationData) {
                    const sortedPopulation = Object.values(populationData).sort((a, b) => (b.year || 2568) - (a.year || 2568));
                    
                    sortedPopulation.forEach(pop => {
                        const district = pop.district || pop.‡πÄ‡∏Ç‡∏ï;
                        if (district && !districtPopulation[district]) {
                            districtPopulation[district] = parseInt(pop.totalPopulation || (pop.malePopulation || 0) + (pop.femalePopulation || 0) || 0);
                        }
                    });
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                const allDistrictRates = Object.entries(districtCount)
                    .map(([district, count]) => {
                        const population = districtPopulation[district] || 0;
                        const rate = population > 0 ? (count / population * 100000) : 0;
                        return {
                            district,
                            count,
                            population,
                            rate: Math.round(rate * 100) / 100
                        };
                    })
                    .sort((a, b) => b.rate - a.rate);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup content
                const popupContent = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeAllDistrictsModal()">
                        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-xl font-bold">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</h2>
                                    <button onclick="closeAllDistrictsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
                                </div>
                            </div>
                            <div class="p-6 overflow-y-auto max-h-[60vh]">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${allDistrictRates.map((data, index) => {
                                        const rankNumber = index + 1;
                                        const populationText = data.population > 0 ? data.population.toLocaleString() : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                                        const rateText = data.rate > 0 ? data.rate.toLocaleString() : '0';
                                        const rankColor = index < 3 ? 'border-red-300 bg-red-50' : 'border-gray-300 bg-gray-50';
                                        
                                        return `
                                            <div class="border-2 ${rankColor} rounded-lg p-4 text-center">
                                                <div class="text-lg font-bold ${index < 3 ? 'text-red-700' : 'text-gray-700'} mb-2">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${rankNumber}</div>
                                                <h4 class="font-semibold text-gray-800 mb-1">‡πÄ‡∏Ç‡∏ï${data.district}</h4>
                                                <div class="text-xl font-bold text-red-600 mb-1">${rateText}</div>
                                                <div class="text-sm text-red-500 mb-2">‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</div>
                                                <div class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${data.count.toLocaleString()} ‡∏£‡∏≤‡∏¢</div>
                                                <div class="text-xs text-gray-500">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£: ${populationText} ‡∏Ñ‡∏ô</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // ‡πÅ‡∏™‡∏î‡∏á popup
                const modalContainer = document.createElement('div');
                modalContainer.id = 'allDistrictsModal';
                modalContainer.innerHTML = popupContent;
                document.body.appendChild(modalContainer);

            } catch (error) {
                console.error('Error showing all districts ranking:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î popup
        function closeAllDistrictsModal() {
            const modal = document.getElementById('allDistrictsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á popup ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function showAllAgeGroupsRanking(diseaseCode, type = 'rate') {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const { database, ref, get } = window.firebaseDB;
                const [patientsSnapshot, agePopulationSnapshot] = await Promise.all([
                    get(ref(database, 'patients')),
                    get(ref(database, 'agePopulation'))
                ]);
                
                const patients = patientsSnapshot.val();
                const agePopulationData = agePopulationSnapshot.val();
                
                if (!patients || !agePopulationData) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏');
                    return;
                }

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const allPatients = Object.values(patients);
                const filteredPatients = allPatients.filter(patient => 
                    patient.diseaseCode === diseaseCode || patient.‡πÇ‡∏£‡∏Ñ === diseaseCode
                );

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ageGroup ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                const ageGroupStats = calculateAgeGroupStats(filteredPatients, agePopulationData);
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                let sortedStats, titleText, unitText, colorClass;
                if (type === 'percentage') {
                    sortedStats = ageGroupStats.percentageTop;
                    titleText = '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                    unitText = '%';
                    colorClass = 'text-green-600';
                } else {
                    sortedStats = ageGroupStats.topThree;
                    titleText = '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                    unitText = '‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£';
                    colorClass = 'text-red-600';
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup content
                const rowsHTML = sortedStats.map((data, index) => `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'} font-semibold text-sm">
                                ${index + 1}
                            </span>
                        </td>
                        <td class="py-3 px-4 font-medium text-gray-900">${data.ageGroup}</td>
                        <td class="py-3 px-4 text-center">${data.patients.toLocaleString()}</td>
                        <td class="py-3 px-4 text-center">${parseInt(data.population).toLocaleString()}</td>
                        <td class="py-3 px-4 text-center">
                            <span class="font-bold ${colorClass}">
                                ${type === 'percentage' ? data.percentage : data.rate} ${unitText}
                            </span>
                        </td>
                    </tr>
                `).join('');

                const popupContent = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeAllAgeGroupsModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex justify-between items-center">
                                <h2 class="text-2xl font-bold">${titleText}</h2>
                                <button onclick="closeAllAgeGroupsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
                            </div>
                            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                                <div class="mb-4 text-sm text-gray-600">
                                    <p><strong>‡πÇ‡∏£‡∏Ñ:</strong> ${diseaseCode}</p>
                                    <p><strong>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${filteredPatients.length.toLocaleString()} ‡∏£‡∏≤‡∏¢</p>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡∏≤‡∏¢)</th>
                                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£ (‡∏Ñ‡∏ô)</th>
                                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${type === 'percentage' ? '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞' : '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢'}</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${rowsHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // ‡πÅ‡∏™‡∏î‡∏á popup
                const modalContainer = document.createElement('div');
                modalContainer.id = 'allAgeGroupsModal';
                modalContainer.innerHTML = popupContent;
                document.body.appendChild(modalContainer);

            } catch (error) {
                console.error('Error showing all age groups ranking:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î popup ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
        function closeAllAgeGroupsModal() {
            const modal = document.getElementById('allAgeGroupsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Epidemic Curve
        let epidemicChart = null; // ‡πÄ‡∏Å‡πá‡∏ö chart instance
        
        async function createEpidemicCurve(diseaseCode, allPatients) {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                const { database, ref, get } = window.firebaseDB;
                const epidemicWeeksSnapshot = await get(ref(database, 'epidemicWeeks'));
                const epidemicWeeks = epidemicWeeksSnapshot.val();
                
                if (!epidemicWeeks || !Array.isArray(epidemicWeeks)) {
                    console.error('Epidemic weeks data not found');
                    return;
                }

                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
                const diseasesSnapshot = await get(ref(database, 'diseases'));
                const diseases = diseasesSnapshot.val();
                let diseaseName = diseaseCode; // fallback ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
                
                if (diseases && Array.isArray(diseases)) {
                    const disease = diseases.find(d => d.code === diseaseCode);
                    if (disease) {
                        diseaseName = disease.name;
                    }
                }
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const diseasePatients = allPatients.filter(patient => 
                    patient.diseaseCode && patient.diseaseCode.toString().trim() === diseaseCode.toString().trim()
                );
                
                console.log('Disease patients for epidemic curve:', diseasePatients.length);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                const weeklyData = [];
                const labels = [];
                
                epidemicWeeks.forEach(week => {
                    if (!week.startDate || !week.endDate) return;
                    // ‡πÉ‡∏ä‡πâ parseThaiDate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö dd/mm/yyyy
                    const weekStart = parseThaiDate(week.startDate);
                    const weekEnd = parseThaiDate(week.endDate);

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ô‡∏±‡∏ö‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                    const countedPatients = [];
                    let weeklyCount = 0;

                    diseasePatients.forEach(patient => {
                        if (patient.onsetDate) {
                            const onsetDate = parseThaiDate(patient.onsetDate);
                            if (onsetDate && onsetDate >= weekStart && onsetDate <= weekEnd) {
                                weeklyCount++;
                                // countedPatients.push({ ... }) // ‡∏•‡∏ö log debug
                            }
                        }
                    });

                    weeklyData.push(weeklyCount);
                    labels.push(`${week.weekNumber}/${week.year}`);
                });
                
                console.log('Epidemic curve data:', { labels, data: weeklyData });
                
                // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î stepSize
                const maxValue = Math.max(...weeklyData);
                console.log('Max value in epidemic curve:', maxValue);
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î stepSize ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
                let stepSize;
                if (maxValue <= 10) {
                    stepSize = 1;
                } else if (maxValue <= 100) {
                    stepSize = 10;
                } else if (maxValue <= 500) {
                    stepSize = 50;
                } else if (maxValue <= 1000) {
                    stepSize = 100;
                } else if (maxValue <= 5000) {
                    stepSize = 500;
                } else {
                    stepSize = 1000;
                }
                
                console.log('Using stepSize:', stepSize, 'for max value:', maxValue);
                
                // ‡∏•‡∏ö chart ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (epidemicChart) {
                    epidemicChart.destroy();
                }
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á chart ‡πÉ‡∏´‡∏°‡πà
                const ctx = document.getElementById('epidemicCurveChart').getContext('2d');
                epidemicChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡∏≤‡∏¢)',
                            data: weeklyData,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1,
                            categoryPercentage: 1.0,
                            barPercentage: 1.0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Epidemic Curve - ${diseaseName}`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡∏≤‡∏¢)'
                                },
                                max: function(context) {
                                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 80% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                                    const targetMax = Math.ceil(maxValue / 0.8);
                                    
                                    // ‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏° stepSize ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                                    return Math.ceil(targetMax / stepSize) * stepSize;
                                },
                                ticks: {
                                    stepSize: stepSize,
                                    callback: function(value, index, values) {
                                        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ stepSize ‡∏•‡∏á‡∏ï‡∏±‡∏ß
                                        if (Number.isInteger(value) && value % stepSize === 0) {
                                            return value;
                                        }
                                        return '';
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error creating epidemic curve:', error);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å dd/mm/yyyy ‡πÄ‡∏õ‡πá‡∏ô Date object (‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥)
        function parseThaiDate(dateStr) {
            if (!dateStr) return null;
            const [day, month, year] = dateStr.split('/').map(num => parseInt(num, 10));
            if (!day || !month || !year) return null;
            return new Date(year, month - 1, day);
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        function getCurrentEpiWeek() {
            const today = new Date();
            const year = today.getFullYear();
            const startOfYear = new Date(year, 0, 1);
            
            // ‡∏´‡∏≤ Thursday ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ (ISO week date system)
            const jan4 = new Date(year, 0, 4);
            const firstThursday = new Date(jan4.getTime() - (jan4.getDay() - 4) * 24 * 60 * 60 * 1000);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const weekNumber = Math.ceil(((today.getTime() - firstThursday.getTime()) / (24 * 60 * 60 * 1000) + 1) / 7);
            
            return Math.max(1, Math.min(52, weekNumber));
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
        function getCurrentEpiWeekDateRange() {
            const today = new Date();
            const year = today.getFullYear();
            
            // ‡∏´‡∏≤ Thursday ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ (ISO week date system)
            const jan4 = new Date(year, 0, 4);
            const firstThursday = new Date(jan4.getTime() - (jan4.getDay() - 4) * 24 * 60 * 60 * 1000);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const weekNumber = Math.ceil(((today.getTime() - firstThursday.getTime()) / (24 * 60 * 60 * 1000) + 1) / 7);
            const adjustedWeekNumber = Math.max(1, Math.min(52, weekNumber));
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentWeekStart = new Date(firstThursday.getTime() + (adjustedWeekNumber - 1) * 7 * 24 * 60 * 60 * 1000);
            // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Thursday)
            currentWeekStart.setDate(currentWeekStart.getDate() - 3);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
            
            // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
            const options = { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                locale: 'th-TH'
            };
            
            const startDateThai = currentWeekStart.toLocaleDateString('th-TH', options);
            const endDateThai = currentWeekEnd.toLocaleDateString('th-TH', options);
            
            return {
                weekNumber: adjustedWeekNumber,
                startDate: startDateThai,
                endDate: endDateThai,
                dateRange: `${startDateThai} - ${endDateThai}`
            };
        }

        // Firebase data management functions
        async function saveToFirebase(path, data) {
            try {
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, path), data);
                // Clear localStorage after successful Firebase save
                localStorage.removeItem(path.replace('/', '_'));
                console.log(`‚úÖ Saved to Firebase: ${path}`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error saving to Firebase (${path}):`, error);
                // Fallback to localStorage only if data is not empty
                if (data && (!Array.isArray(data) || data.length > 0)) {
                    localStorage.setItem(path.replace('/', '_'), JSON.stringify(data));
                } else {
                    localStorage.removeItem(path.replace('/', '_'));
                }
                return false;
            }
        }

        async function loadFromFirebase(path) {
            try {
                console.log(`üîÑ Attempting to load from Firebase: ${path}`);
                const { database, ref, get } = window.firebaseDB;
                if (!database || !ref || !get) {
                    console.error('‚ùå Firebase DB functions not available');
                    return [];
                }
                const snapshot = await get(ref(database, path));
                let data = null;

                // Try to get data from Firebase first
                if (snapshot.exists()) {
                    data = snapshot.val();
                    console.log(`‚úÖ Loaded from Firebase: ${path}, Data:`, data);
                }

                // If data is an object with numeric keys, convert to array
                if (data && typeof data === 'object' && !Array.isArray(data)) {
                    const keys = Object.keys(data);
                    if (keys.every(key => !isNaN(key))) {
                        data = Object.values(data);
                        console.log(`üîÑ Converted object to array for ${path}, Length:`, data.length);
                    }
                }

                // If no data in Firebase, try localStorage
                if (!data || (Array.isArray(data) && data.length === 0)) {
                    console.log(`üì≠ No data found in Firebase: ${path}`);
                    try {
                        const localData = localStorage.getItem(path.replace('/', '_'));
                        if (localData) {
                            data = JSON.parse(localData);
                            console.log(`‚úÖ Loaded from localStorage: ${path}, Length:`, Array.isArray(data) ? data.length : 'not array');
                        }
                    } catch (localError) {
                        console.error(`‚ùå Error loading from localStorage: ${path}`, localError);
                    }
                }

                // If still no data, return empty array
                if (!data) {
                    console.log(`üì≠ No data found in both Firebase and localStorage: ${path}`);
                    return [];
                }

                // Process the data
                if (Array.isArray(data)) {
                    console.log(`‚úÖ Got array data (${data.length} items)`);
                    return data;
                }
                
                if (typeof data === 'object') {
                    const arrayData = Object.values(data);
                    console.log(`üîÑ Converted object to array (${arrayData.length} items)`);
                    return arrayData;
                }

                console.log(`‚ö†Ô∏è Unexpected data format: ${typeof data}`);
                return [];

            } catch (error) {
                console.error(`‚ùå Error loading data: ${path}`, error);
                return [];
            }
        }

        // Helper function to convert old age population data to new structure
        function convertLegacyAgePopulationData(data) {
            if (!Array.isArray(data)) return data;
            
            return data.map(item => {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ startAge ‡πÅ‡∏•‡∏∞ endAge ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
                if (item.hasOwnProperty('startAge') && item.hasOwnProperty('endAge')) {
                    return item;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ageGroup ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ startAge/endAge ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á
                if (item.ageGroup && !item.hasOwnProperty('startAge')) {
                    console.log(`üîÑ Converting legacy age group: ${item.ageGroup}`);
                    
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å ageGroup string ‡πÄ‡∏õ‡πá‡∏ô startAge/endAge
                    const ageGroupStr = item.ageGroup.toString();
                    let startAge = 0;
                    let endAge = 999;
                    
                    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "0-4 ‡∏õ‡∏µ", "5-14 ‡∏õ‡∏µ", "80+ ‡∏õ‡∏µ"
                    const rangeMatch = ageGroupStr.match(/(\d+)-(\d+)/);
                    const plusMatch = ageGroupStr.match(/(\d+)\+/);
                    
                    if (rangeMatch) {
                        startAge = parseInt(rangeMatch[1]);
                        endAge = parseInt(rangeMatch[2]);
                    } else if (plusMatch) {
                        startAge = parseInt(plusMatch[1]);
                        endAge = 999;
                    }
                    
                    return {
                        ...item,
                        startAge,
                        endAge
                    };
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏î‡πÜ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
                console.log(`‚ö†Ô∏è Age population item missing age group info:`, item);
                return {
                    ...item,
                    startAge: 0,
                    endAge: 999
                };
            });
        }

        async function deleteFromFirebase(path) {
            try {
                const { database, ref, remove } = window.firebaseDB;
                await remove(ref(database, path));
                console.log(`üóëÔ∏è Deleted from Firebase: ${path}`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error deleting from Firebase (${path}):`, error);
                return false;
            }
        }

        // Initialize data structure with Firebase
        async function initializeData() {
            console.log('üîÑ Initializing data with Firebase...');
            
            // Initialize all data collections
            const collections = [
                'diseases', 'responsible', 'population', 
                'agePopulation', 'thailandPopulation', 'epidemicWeeks', 'bangkokDistricts'
            ];
            
            for (const collection of collections) {
                const data = await loadFromFirebase(collection);
                
                // Initialize with sample data if empty
                if (collection === 'diseases' && data.length === 0) {
                    const sampleDiseases = [
                        { code: '506', name: '‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å' },
                        { code: '507', name: '‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà' },
                        { code: '508', name: '‡πÇ‡∏£‡∏Ñ‡∏°‡∏∑‡∏≠ ‡πÄ‡∏ó‡πâ‡∏≤ ‡∏õ‡∏≤‡∏Å' },
                        { code: '509', name: '‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡∏£‡πà‡∏ß‡∏á' },
                        { code: '510', name: '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏Å' }
                    ];
                    await saveToFirebase('diseases', sampleDiseases);
                    localStorage.setItem(collection, JSON.stringify(sampleDiseases));
                    console.log('‚úÖ Initialized sample diseases data');
                } else {
                    // Keep a local cache for faster access
                    localStorage.setItem(collection, JSON.stringify(data));
                }
            }
            
            console.log('‚úÖ Data initialization complete');
        }

        // Page navigation with animation
        function showPage(page) {
            // Hide all pages
            const pages = ['summaryPage', 'reportPage', 'masterDataPage', 'masterDataDetailPage', 'patientDbPage'];
            pages.forEach(pageId => {
                const element = document.getElementById(pageId);
                element.classList.add('hidden');
                element.classList.remove('slide-in');
            });

            // Reset all tabs
            const tabs = ['summaryTab', 'reportTab', 'masterDataTab', 'patientDbTab'];
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                tab.className = tab.className.replace('tab-active', 'tab-inactive');
            });

            // Show selected page and activate tab
            setTimeout(() => {
                if (page === 'summary') {
                    const pageElement = document.getElementById('summaryPage');
                    pageElement.classList.remove('hidden');
                    document.getElementById('summaryTab').className = document.getElementById('summaryTab').className.replace('tab-inactive', 'tab-active');
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                    if (window.firebaseDB) {
                        loadSystemOverview();
                        loadSummaryDatabaseOverview(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        loadDiseaseSelectOptions(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ
                    }
                } else if (page === 'patientDb') {
                    const pageElement = document.getElementById('patientDbPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    document.getElementById('patientDbTab').className = document.getElementById('patientDbTab').className.replace('tab-inactive', 'tab-active');
                    // Initialize patient data display
                    if (window.firebaseDB) {
                        displayPatients();
                    }
                } else if (page === 'report') {
                    const pageElement = document.getElementById('reportPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('reportTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                    loadDiseaseOptions();
                    initializeReportDates(); // Initialize default dates
                } else if (page === 'patients') {
                    const pageElement = document.getElementById('patientsPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('patientsTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                    loadPatientsTable();
                } else if (page === 'masterData') {
                    const pageElement = document.getElementById('masterDataPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('masterDataTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                }
            }, 100);
        }

        // Load disease options for report
        async function loadDiseaseOptions() {
            const diseases = await loadFromFirebase('diseases');
            const select = document.getElementById('diseaseCode');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>';
            
            diseases.forEach(disease => {
                const option = document.createElement('option');
                option.value = disease.code;
                option.textContent = `${disease.code} - ${disease.name}`;
                select.appendChild(option);
            });
        }

        // Load disease info when code is selected
        async function loadDiseaseInfo() {
            const selectedCode = document.getElementById('diseaseCode').value;
            if (!selectedCode) {
                document.getElementById('diseaseName').textContent = '-';
                document.getElementById('reportResponsible').textContent = '-';
                document.getElementById('reportReviewer').textContent = '-';
                return;
            }

            const diseases = await loadFromFirebase('diseases');
            const responsible = await loadFromFirebase('responsible');
            
            const disease = diseases.find(d => d.code === selectedCode);
            const resp = responsible.find(r => r.diseaseCode === selectedCode);

            document.getElementById('diseaseName').textContent = disease ? disease.name : '-';
            document.getElementById('reportResponsible').textContent = resp ? `${resp.responsibleName} (${resp.responsiblePosition})` : '-';
            document.getElementById('reportReviewer').textContent = resp ? `${resp.reviewerName} (${resp.reviewerPosition})` : '-';
        }

        // Update report month based on end date
        function updateReportMonth() {
            const endDate = document.getElementById('endDate').value;
            if (endDate) {
                const date = new Date(endDate);
                const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                const month = months[date.getMonth()];
                const year = date.getFullYear() + 543;
                document.getElementById('reportMonth').value = `${month} ${year}`;
            }
        }

        // Generate report with validation and preview
        async function generateReport() {
            const diseaseCode = document.getElementById('diseaseCode').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!diseaseCode || !startDate || !endDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                return;
            }
            
            // Show loading animation
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
            
            try {
                // Generate report content
                await generateReportContent(diseaseCode, startDate, endDate);
                
                // Show report preview
                document.getElementById('reportPreviewSection').classList.remove('hidden');
                document.getElementById('reportPreviewSection').scrollIntoView({ behavior: 'smooth' });
                
                button.innerHTML = originalText;
            } catch (error) {
                console.error('Error generating report:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
                button.innerHTML = originalText;
            }
        }

        // Generate report content based on selected criteria
        async function generateReportContent(diseaseCode, startDate, endDate) {
            try {
                // Load necessary data
                const [diseases, patients, rawAgePopulation, bangkokDistricts] = await Promise.all([
                    loadFromFirebase('diseases'),
                    loadFromFirebase('patients'),
                    loadFromFirebase('agePopulation'),
                    loadFromFirebase('bangkokDistricts')
                ]);
                
                // Convert legacy age population data to new structure
                const agePopulation = convertLegacyAgePopulationData(rawAgePopulation);
                
                // Find selected disease
                const selectedDisease = diseases.find(d => d.code === diseaseCode);
                if (!selectedDisease) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                }
                
                // Filter patients by disease and date range
                const filteredPatients = patients.filter(patient => {
                    if (patient.diseaseCode !== diseaseCode) return false;
                    
                    const onsetDate = new Date(patient.onsetDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    return onsetDate >= start && onsetDate <= end;
                });
                
                // Generate report HTML
                const reportHTML = generateReportHTML(selectedDisease, filteredPatients, startDate, endDate, agePopulation, bangkokDistricts);
                
                // Display in preview
                document.getElementById('reportContent').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error in generateReportContent:', error);
                throw error;
            }
        }

        // Generate the actual report HTML content
        function generateReportHTML(disease, patients, startDate, endDate, agePopulation, bangkokDistricts) {
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            // Format dates in Thai
            const formatDateThai = (date) => {
                const day = date.getDate();
                const month = date.getMonth();
                const year = date.getFullYear() + 543;
                const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                                   '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                return `${day} ${monthNames[month]} ${year}`;
            };
            
            const reportMonth = startDateObj.toLocaleString('th-TH', { month: 'long' });
            const startDateFormatted = formatDateThai(startDateObj);
            const endDateFormatted = formatDateThai(endDateObj);
            
            // Calculate statistics
            const totalPatients = patients.length;
            const deaths = patients.filter(p => p.outcome === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï').length;
            const malePatients = patients.filter(p => p.gender === '‡∏ä‡∏≤‡∏¢').length;
            const femalePatients = patients.filter(p => p.gender === '‡∏´‡∏ç‡∏¥‡∏á').length;
            
            // Calculate gender ratio (‡∏ä‡∏≤‡∏¢ : ‡∏´‡∏ç‡∏¥‡∏á) ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô 1 : x
            let genderRatio;
            if (malePatients > 0 && femalePatients > 0) {
                const ratio = (femalePatients / malePatients).toFixed(1);
                genderRatio = `1 : ${ratio}`;
            } else if (malePatients > 0 && femalePatients === 0) {
                genderRatio = '‡∏ä‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
            } else if (malePatients === 0 && femalePatients > 0) {
                genderRatio = '‡∏´‡∏ç‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
            } else {
                genderRatio = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
            
            // Calculate total population for Bangkok from age population data
            const totalPopulation = agePopulation.reduce((sum, group) => {
                const population = parseInt(group.total || group.population || 0);
                return sum + population;
            }, 0);
            
            // Calculate cumulative incidence rate
            const incidenceRate = totalPopulation > 0 ? ((totalPatients / totalPopulation) * 100000).toFixed(2) : '0.00';
            
            // Generate age group statistics - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ageGroup ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const ageGroupStats = calculateAgeGroupStats(patients, agePopulation);
            const districtStats = calculateDistrictStats(patients, bangkokDistricts);
            
            return `
                <div class="report-content" style="font-family: 'Anuphan', sans-serif;">
                    <!-- Header -->
                    <h1 style="font-family: 'Anuphan', sans-serif;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ${disease.name} ‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h1>
                    <h2 style="font-family: 'Anuphan', sans-serif;">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${reportMonth}</h2>
                    <h3 style="font-family: 'Anuphan', sans-serif;">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${startDateFormatted} - ${endDateFormatted}</h3>
                    
                    <div style="margin: 1.5rem 0;"></div>
                    
                    <p style="font-size: 14px; line-height: 1.5; text-align: justify; font-family: 'Anuphan', sans-serif; text-indent: 1cm;">
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏à‡∏∂‡∏á‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
                    </p>
                    
                    <div style="margin: 1.5rem 0;"></div>
                    
                    <!-- Situation Overview -->
                    <h3 style="text-align: left; font-weight: bold; font-family: 'Anuphan', sans-serif;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå${disease.name} ‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h3>
                    <p style="font-size: 14px; margin: 0.5rem 0; font-family: 'Anuphan', sans-serif; text-indent: 1cm;">
                        ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÇ‡∏£‡∏Ñ (‡∏£‡∏á.506) ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ
                    </p>
                    
                    <ul style="font-size: 14px; line-height: 1.8; list-style: none; padding-left: 1cm; font-family: 'Anuphan', sans-serif;">
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${totalPatients.toLocaleString()} ‡∏£‡∏≤‡∏¢ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏∞‡∏™‡∏° ${incidenceRate} ‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏™‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</li>
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ${deaths > 0 ? `‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ${deaths} ‡∏£‡∏≤‡∏¢` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'}</li>
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏´‡∏ç‡∏¥‡∏á ‡∏Ñ‡∏∑‡∏≠ ${genderRatio}</li>
                        ${ageGroupStats.topThree.length > 0 ? `
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∑‡∏≠ ${ageGroupStats.topThree[0].ageGroup} (${ageGroupStats.topThree[0].rate} ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏ô‡∏Ñ‡∏ô) ${ageGroupStats.topThree.length > 1 ? `‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤ ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ${ageGroupStats.topThree[1].ageGroup} (${ageGroupStats.topThree[1].rate} ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏ô‡∏Ñ‡∏ô)` : ''} ${ageGroupStats.topThree.length > 2 ? `‡πÅ‡∏•‡∏∞ ${ageGroupStats.topThree[2].ageGroup} (${ageGroupStats.topThree[2].rate} ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏ô‡∏Ñ‡∏ô)` : ''} ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö</li>
                        ` : ''}
                        ${ageGroupStats.percentageTop.length > 0 ? `
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∑‡∏≠ ${ageGroupStats.percentageTop[0].ageGroup} (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ${ageGroupStats.percentageTop[0].percentage}) ${ageGroupStats.percentageTop.length > 1 ? `‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤ ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ${ageGroupStats.percentageTop[1].ageGroup} (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ${ageGroupStats.percentageTop[1].percentage})` : ''} ${ageGroupStats.percentageTop.length > 2 ? `‡πÅ‡∏•‡∏∞ ${ageGroupStats.percentageTop[2].ageGroup} (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ${ageGroupStats.percentageTop[2].percentage})` : ''} ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö</li>
                        ` : ''}
                        ${districtStats.length > 0 ? `
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∑‡∏≠ ${districtStats[0].district} (${districtStats[0].rate} ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏ô‡∏Ñ‡∏ô) ${districtStats.length > 1 ? `‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤ ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ${districtStats[1].district} (${districtStats[1].rate} ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏ô‡∏Ñ‡∏ô)` : ''} ${districtStats.length > 2 ? `‡πÅ‡∏•‡∏∞ ${districtStats[2].district} (${districtStats[2].rate} ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏ô‡∏Ñ‡∏ô)` : ''} ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö</li>
                        ` : ''}
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡πÉ‡∏ô‡∏õ‡∏µ ${new Date().getFullYear() + 543} ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${startDateObj.toLocaleString('th-TH', { month: 'long' })}‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${endDateObj.toLocaleString('th-TH', { month: 'long' })} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ${disease.name} ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô 5 ‡∏õ‡∏µ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏û‡∏ö‡∏ß‡πà‡∏≤ ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô 5 ‡∏õ‡∏µ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô 1.2 ‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</li>
                        <li style="margin: 0.4rem 0; text-indent: -0.2cm; padding-left: 0.2cm;">- ‡πÉ‡∏ô‡∏õ‡∏µ ${new Date().getFullYear() + 543} ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${startDateObj.toLocaleString('th-TH', { month: 'long' })}‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${endDateObj.toLocaleString('th-TH', { month: 'long' })} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ${disease.name} ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ ${new Date().getFullYear() + 542} ‡∏û‡∏ö‡∏ß‡πà‡∏≤ ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏µ ${new Date().getFullYear() + 542} ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô 1.1 ‡πÄ‡∏ó‡πà‡∏≤ ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</li>
                    </ul>
                </div>
            `;
        }

        // Helper function to get age group for a patient in the table
        async function getPatientAgeGroup(patient) {
            try {
                // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ ageGroup ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
                if (patient.ageGroup && patient.ageGroup !== '-') {
                    return patient.ageGroup;
                }

                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å window object ‡∏´‡∏≤‡∏Å‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Firebase
                let agePopulationArray = window.agePopulationData;
                
                if (!agePopulationArray) {
                    const { database, ref, get } = window.firebaseDB;
                    const agePopulationSnapshot = await get(ref(database, 'agePopulation'));
                    const agePopulationData = agePopulationSnapshot.val();
                    
                    if (!agePopulationData) {
                        return '-';
                    }
                    
                    agePopulationArray = Array.isArray(agePopulationData) 
                        ? agePopulationData 
                        : Object.values(agePopulationData);
                    
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    agePopulationArray = convertLegacyAgePopulationData(agePopulationArray);
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                    window.agePopulationData = agePopulationArray;
                }
                
                // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ - ‡∏£‡∏ß‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ 0 ‡∏õ‡∏µ
                let patientAge = patient.ageYears !== undefined ? patient.ageYears 
                    : patient.ageYear !== undefined ? patient.ageYear 
                    : patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] !== undefined ? patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] 
                    : patient.age;
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 0
                if (patientAge !== undefined && patientAge !== null && patientAge !== '') {
                    patientAge = parseInt(patientAge);
                    if (isNaN(patientAge) || patientAge < 0) {
                        patientAge = 0; // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏¢‡∏∏ 0 ‡∏õ‡∏µ
                    }
                } else {
                    patientAge = 0; // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏¢‡∏∏ 0 ‡∏õ‡∏µ
                }
                
                const ageGroup = getAgeGroupFromAge(patientAge, agePopulationArray);
                
                return ageGroup || '-';
            } catch (error) {
                console.error('Error getting age group for patient:', error);
                return '-';
            }
        }

        // Helper function to determine age group from patient's age (backup function)
        function getAgeGroupFromAge(ageValue, agePopulation) {
            if (!ageValue && ageValue !== 0) {
                return null;
            }
            if (!agePopulation || !Array.isArray(agePopulation)) {
                return null;
            }
            
            const age = parseInt(ageValue);
            if (isNaN(age) || age < 0) {
                return null;
            }
            
            // Find the age group that contains this age
            for (const group of agePopulation) {
                const startAge = parseInt(group.startAge || 0);
                const endAge = parseInt(group.endAge || 999);
                
                // Check if patient's age falls within this age group range
                if (age >= startAge && age <= endAge) {
                    // Return the age group label (either predefined or auto-generated)
                    const ageGroupLabel = group.ageGroup || `${startAge}-${endAge >= 999 ? '999+' : endAge} ‡∏õ‡∏µ`;
                    return ageGroupLabel;
                }
            }
            
            return null;
        }

        // Calculate age group statistics - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ageGroup ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        function calculateAgeGroupStats(patients, agePopulation) {
            const ageGroups = {};
            
            // Initialize age groups using population data
            agePopulation.forEach(group => {
                const key = group.ageGroup || `${group.startAge || 0}-${group.endAge >= 999 ? '999+' : group.endAge || 0} ‡∏õ‡∏µ`;
                ageGroups[key] = {
                    patients: 0,
                    population: group.total || group.population || 0,
                    startAge: parseInt(group.startAge || 0),
                    endAge: parseInt(group.endAge || 999)
                };
            });
            
            // Count patients by age group using existing ageGroup field from database
            console.log(`üìä Starting age group counting from database for ${patients.length} patients`);
            console.log(`üìä Available age groups:`, Object.keys(ageGroups));
            
            // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 5 ‡∏£‡∏≤‡∏¢‡πÅ‡∏£‡∏Å
            if (patients.length > 0) {
                console.log(`üìä Sample patients (first 5):`);
                patients.slice(0, 5).forEach((patient, index) => {
                    console.log(`  Patient ${index + 1}:`, {
                        ageGroup: patient.ageGroup,
                        ageYears: patient.ageYears,
                        ageYear: patient.ageYear,
                        diseaseCode: patient.diseaseCode,
                        hasAgeGroup: patient.hasOwnProperty('ageGroup'),
                        ageGroupType: typeof patient.ageGroup
                    });
                });
            }
            
            let patientsWithAgeGroup = 0;
            let patientsClassified = 0;
            let debugCount = 0;
            
            patients.forEach((patient, index) => {
                // ‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå ageGroup ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                let patientAgeGroup = patient.ageGroup;
                
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ageGroup ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏
                if (!patientAgeGroup || patientAgeGroup === '-' || patientAgeGroup === '') {
                    const patientAge = patient.ageYears !== undefined ? patient.ageYears 
                        : patient.ageYear !== undefined ? patient.ageYear 
                        : patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] !== undefined ? patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] 
                        : patient.age;
                    
                    if (patientAge !== undefined && patientAge !== null && patientAge >= 0) {
                        patientAgeGroup = getAgeGroupFromAge(patientAge, agePopulation);
                        console.log(`üîÑ Calculated age group for patient ${index + 1}: age ${patientAge} ‚Üí "${patientAgeGroup}"`);
                    }
                }
                
                // Debug ‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                if (debugCount < 5) {
                    console.log(`üìä Patient ${index + 1}:`, {
                        ageGroup: patient.ageGroup,
                        calculatedAgeGroup: patientAgeGroup,
                        ageYears: patient.ageYears,
                        ageYear: patient.ageYear,
                        '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ': patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'],
                        age: patient.age
                    });
                    debugCount++;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (patientAgeGroup && patientAgeGroup !== '-' && patientAgeGroup !== '') {
                    patientsWithAgeGroup++;
                    
                    // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                    console.log(`üîç Processing patient ${index + 1}: ageGroup "${patientAgeGroup}"`);
                    console.log(`   Available age groups:`, Object.keys(ageGroups));
                    
                    if (ageGroups[patientAgeGroup]) {
                        ageGroups[patientAgeGroup].patients++;
                        patientsClassified++;
                        
                        console.log(`‚úÖ Patient classified successfully: ageGroup "${patientAgeGroup}" (total in group: ${ageGroups[patientAgeGroup].patients})`);
                    } else {
                        console.log(`‚ö†Ô∏è Age group "${patientAgeGroup}" not found in population data:`, Object.keys(ageGroups));
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                        ageGroups[patientAgeGroup] = {
                            patients: 1,
                            population: 0, // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                            startAge: 0,
                            endAge: 999
                        };
                        patientsClassified++;
                        console.log(`üÜï Created new age group: "${patientAgeGroup}" with 1 patient`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è Patient ${index + 1} has no age group data:`, {
                        ageGroup: patient.ageGroup,
                        ageYears: patient.ageYears,
                        ageYear: patient.ageYear
                    });
                }
            });
            
            console.log(`üìä Age group classification complete:`);
            console.log(`   - Total patients: ${patients.length}`);
            console.log(`   - Patients with age group data: ${patientsWithAgeGroup}`);
            console.log(`   - Patients successfully classified: ${patientsClassified}`);
            console.log(`   - Age group counts:`, Object.entries(ageGroups).map(([group, data]) => `${group}: ${data.patients} patients`));
            console.log(`üìã Detailed age group breakdown:`);
            Object.entries(ageGroups).forEach(([group, data]) => {
                console.log(`   ${group}: ${data.patients} patients, population: ${data.population}, rate: ${data.population > 0 ? ((data.patients / data.population) * 100000).toFixed(2) : '0.00'} per 100k`);
            });
            
            // Calculate rates and percentages
            const totalPatients = patients.length;
            const stats = Object.entries(ageGroups).map(([ageGroup, data]) => ({
                ageGroup,
                patients: data.patients,
                population: data.population,
                rate: data.population > 0 ? ((data.patients / data.population) * 100000).toFixed(2) : '0.00',
                percentage: totalPatients > 0 ? ((data.patients / totalPatients) * 100).toFixed(1) : '0.0'
            }));
            
            // Sort by rate for top 3
            const sortedByRate = [...stats].sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate));
            const topThree = sortedByRate.slice(0, 3);
            
            // Sort by percentage for top 3
            const sortedByPercentage = [...stats].sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
            const percentageTop = sortedByPercentage.slice(0, 3);
            
            return { topThree, percentageTop };
        }

        // Calculate district statistics
        function calculateDistrictStats(patients, bangkokDistricts) {
            const districtStats = {};
            
            // Initialize districts
            bangkokDistricts.forEach(district => {
                districtStats[district.district] = {
                    patients: 0,
                    population: district.population || 0
                };
            });
            
            // Count patients by district
            patients.forEach(patient => {
                if (patient.district && districtStats[patient.district]) {
                    districtStats[patient.district].patients++;
                }
            });
            
            // Calculate rates and sort
            const stats = Object.entries(districtStats)
                .map(([district, data]) => ({
                    district,
                    patients: data.patients,
                    population: data.population,
                    rate: data.population > 0 ? ((data.patients / data.population) * 100000).toFixed(2) : '0.00'
                }))
                .sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate))
                .slice(0, 3);
            
            return stats;
        }

        // Hide report preview
        function hideReportPreview() {
            document.getElementById('reportPreviewSection').classList.add('hidden');
        }

        // Initialize default dates when page loads
        function initializeReportDates() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Start date: January 1st of current year (1 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°)
            const startDate = new Date(currentYear, 0, 1); // 0 = January, 1 = first day
            
            // End date: Last day of previous month
            const endDate = new Date(currentYear, currentMonth, 0); // This gives last day of previous month
            
            // Format dates for input fields (YYYY-MM-DD) - avoid timezone issues
            const formatForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatForInput(startDate);
            document.getElementById('endDate').value = formatForInput(endDate);
            
            // Update report month
            updateReportMonth();
        }

        // High-performance Excel import for large datasets (100K+ records)
        function importExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
            console.log(`üìä File size: ${fileSizeMB} MB`);
            
            // Enhanced file size warnings with performance tips
            if (file.size > 100 * 1024 * 1024) { // 100MB+
                const confirmed = confirm(
                    `‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å: ${fileSizeMB} MB\n\n` +
                    `üöÄ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:\n` +
                    `‚Ä¢ ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n` +
                    `‚Ä¢ ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô\n` +
                    `‚Ä¢ ‡πÉ‡∏ä‡πâ Chrome ‡∏´‡∏£‡∏∑‡∏≠ Edge (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ Firefox)\n` +
                    `‚Ä¢ ‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πá‡∏õ‡∏ó‡πá‡∏≠‡∏õ)\n\n` +
                    `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: 5-15 ‡∏ô‡∏≤‡∏ó‡∏µ\n` +
                    `üìà ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${Math.round(file.size / 200).toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` +
                    `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
                );
                
                if (!confirmed) return;
                
                // Show performance mode notification
                showPerformanceModeNotification();
                
            } else if (file.size > 50 * 1024 * 1024) { // 50MB+
                const confirmed = confirm(
                    `üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà: ${fileSizeMB} MB\n\n` +
                    `‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á:\n` +
                    `‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö batch (‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 3-5 ‡πÄ‡∏ó‡πà‡∏≤)\n` +
                    `‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå\n` +
                    `‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤\n\n` +
                    `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: 2-5 ‡∏ô‡∏≤‡∏ó‡∏µ\n` +
                    `üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${Math.round(file.size / 200).toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` +
                    `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
                );
                
                if (!confirmed) return;
            }

            // Show progress container
            const progressContainer = document.getElementById('importProgressContainer');
            progressContainer.classList.remove('hidden');
            
            // Reset progress indicators
            resetProgressIndicators();
            
            // Show file analysis
            updateImportStatus(`üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå Excel (${fileSizeMB} MB)...`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                updateImportStatus('‚ö° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á...');
                
                // Use requestIdleCallback for better performance
                if (window.requestIdleCallback) {
                    requestIdleCallback(() => processExcelFile(e.target.result, fileSizeMB));
                } else {
                    setTimeout(() => processExcelFile(e.target.result, fileSizeMB), 100);
                }
            };
            
            reader.onerror = function() {
                updateImportStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                setTimeout(() => {
                    document.getElementById('importProgressContainer').classList.add('hidden');
                }, 2000);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Show performance mode notification
        function showPerformanceModeNotification() {
            const perfDiv = document.createElement('div');
            perfDiv.className = 'fixed top-4 left-4 bg-purple-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            perfDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/>
                    </svg>
                    <div>
                        <div class="font-bold mb-1">üöÄ ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á</div>
                        <div class="text-sm opacity-90">
                            ‚Ä¢ ‡πÉ‡∏ä‡πâ Web Workers<br>
                            ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Batch<br>
                            ‚Ä¢ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 5-10 ‡πÄ‡∏ó‡πà‡∏≤
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(perfDiv);
            
            setTimeout(() => {
                perfDiv.remove();
            }, 4000);
        }

        // High-performance Excel processing
        function processExcelFile(arrayBuffer, fileSizeMB) {
            try {
                const data = new Uint8Array(arrayBuffer);
                
                // Show processing status based on file size
                if (parseFloat(fileSizeMB) > 50) {
                    updateImportStatus('üî• ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà...');
                } else {
                    updateImportStatus('‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel...');
                }
                
                // Optimized XLSX reading for large files
                const workbook = XLSX.read(data, {
                    type: 'array',
                    cellDates: true,
                    cellNF: false,
                    cellText: false,
                    // Performance optimizations
                    dense: true,  // Use dense mode for better memory usage
                    raw: false,   // Don't parse formulas
                    codepage: 65001 // UTF-8 for Thai characters
                });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Use faster conversion method for large datasets
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                    raw: false,
                    dateNF: 'dd/mm/yyyy',
                    defval: '', // Default value for empty cells
                    blankrows: false // Skip blank rows
                });
                
                console.log(`üìä Parsed ${jsonData.length.toLocaleString()} records from Excel`);
                
                // Clear the workbook from memory immediately
                workbook.Sheets = null;
                
                updateImportStatus('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á...');
                updateImportCount(0, jsonData.length);
                
                // Enhanced time estimation based on actual performance data
                const estimatedSpeed = getEstimatedProcessingSpeed(jsonData.length);
                const estimatedTime = Math.ceil(jsonData.length / estimatedSpeed);
                
                if (jsonData.length > 500000) {
                    updateImportStatus(`‚ö° ‡πÇ‡∏´‡∏°‡∏î‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏£‡πá‡∏ß: ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.ceil(estimatedTime/60)} ‡∏ô‡∏≤‡∏ó‡∏µ)`);
                } else if (jsonData.length > 200000) {
                    updateImportStatus(`üöÄ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡πá‡∏ß: ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${estimatedTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`);
                } else if (jsonData.length > 100000) {
                    updateImportStatus(`‚ö° ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${estimatedTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`);
                } else {
                    updateImportStatus(`üìä ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                }
                
                // Use high-performance processing
                setTimeout(() => {
                    processDataWithHighPerformance(jsonData);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error processing Excel file:', error);
                handleExcelProcessingError(error, fileSizeMB);
            }
        }

        // Get estimated processing speed based on dataset size
        function getEstimatedProcessingSpeed(recordCount) {
            if (recordCount > 500000) return 8000;  // 8K records/second for very large
            if (recordCount > 200000) return 12000; // 12K records/second for large
            if (recordCount > 100000) return 15000; // 15K records/second for medium-large
            if (recordCount > 50000) return 20000;  // 20K records/second for medium
            return 25000; // 25K records/second for small datasets
        }

        // Handle Excel processing errors with helpful messages
        function handleExcelProcessingError(error, fileSizeMB) {
            updateImportStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Excel');
            
            let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ';
            let suggestion = '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (.xlsx)';
            
            if (error.message && error.message.includes('memory')) {
                errorMessage = '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠';
                suggestion = `‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î ${fileSizeMB} MB ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ<br>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏¢‡πà‡∏≠‡∏¢ < 50 MB`;
            } else if (error.message && error.message.includes('format')) {
                errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                suggestion = '‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå .xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            errorDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                    </svg>
                    <div>
                        <div class="font-bold mb-1">${errorMessage}</div>
                        <div class="text-sm opacity-90">${suggestion}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
                document.getElementById('importProgressContainer').classList.add('hidden');
            }, 8000);
        }

        // Reset all progress indicators
        function resetProgressIndicators() {
            document.getElementById('importPercentage').textContent = '0%';
            document.getElementById('importCount').textContent = '0 / 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            document.getElementById('processedCount').textContent = '0';
            document.getElementById('validCount').textContent = '0';
            document.getElementById('errorCount').textContent = '0';
            document.getElementById('importSpeed').textContent = '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ';
            document.getElementById('timeRemaining').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...';
            document.getElementById('progressBar').style.width = '0%';
            
            // Reset batch details
            document.getElementById('batchDetails').classList.add('hidden');
            document.getElementById('batchSize').textContent = '-';
            document.getElementById('totalBatches').textContent = '-';
            document.getElementById('currentBatch').textContent = '-';
            document.getElementById('batchRange').textContent = '-';
            document.getElementById('batchPercentage').textContent = '0%';
            document.getElementById('batchProgressBar').style.width = '0%';
            document.getElementById('currentBatchInfo').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°...';
            
            // Reset icon to spinning
            const icon = document.getElementById('importIcon');
            icon.innerHTML = `
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            `;
            icon.classList.add('animate-spin');
            
            // Reset import control variables
            importCancelled = false;
            currentImportProcess = null;
        }
        
        // Show batch processing information
        function showBatchProcessingInfo(totalRecords, batchSize, phase = 'validation') {
            const batchDetails = document.getElementById('batchDetails');
            batchDetails.classList.remove('hidden');
            
            const totalBatches = Math.ceil(totalRecords / batchSize);
            
            document.getElementById('batchSize').textContent = batchSize.toLocaleString();
            document.getElementById('totalBatches').textContent = totalBatches.toLocaleString();
            
            const phaseText = phase === 'validation' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('currentBatchInfo').textContent = `‡πÄ‡∏£‡∏¥‡πà‡∏°${phaseText}‡πÅ‡∏ö‡∏ö batch`;
            
            console.log(`üìä Batch Info: ${totalRecords.toLocaleString()} records, ${batchSize.toLocaleString()} per batch, ${totalBatches} batches total`);
        }
        
        // Update batch progress
        function updateBatchProgress(phase, currentBatch, totalBatches, startIndex, endIndex, totalRecords) {
            const batchPercentage = Math.round((currentBatch / totalBatches) * 100);
            
            // Update batch-specific elements
            document.getElementById('currentBatch').textContent = `${currentBatch}/${totalBatches}`;
            document.getElementById('batchRange').textContent = `${(startIndex + 1).toLocaleString()}-${endIndex.toLocaleString()}`;
            document.getElementById('batchPercentage').textContent = `${batchPercentage}%`;
            document.getElementById('batchProgressBar').style.width = `${batchPercentage}%`;
            
            // Update phase-specific info
            const phaseText = phase === 'validation' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            const phaseIcon = phase === 'validation' ? 'üîç' : 'üíæ';
            
            document.getElementById('currentBatchInfo').textContent = 
                `${phaseIcon} ${phaseText} Batch ${currentBatch}/${totalBatches}`;
            
            // Add visual feedback for batch completion
            if (currentBatch === totalBatches) {
                setTimeout(() => {
                    document.getElementById('currentBatchInfo').textContent = 
                        `‚úÖ ${phaseText}‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! (${totalBatches} batches)`;
                }, 100);
            }
            
            console.log(`üìà Batch Progress: ${phase} ${currentBatch}/${totalBatches} (${batchPercentage}%) - Records ${startIndex + 1}-${endIndex}`);
        }
        
        // Cancel import process
        function cancelImport() {
            const confirmed = confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà');
            
            if (confirmed) {
                importCancelled = true;
                
                // Update UI to show cancellation
                updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...');
                
                // Change icon to warning
                const icon = document.getElementById('importIcon');
                icon.classList.remove('animate-spin');
                icon.innerHTML = `
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                `;
                
                // Disable cancel button
                const cancelBtn = document.getElementById('cancelImportBtn');
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...
                `;
                
                // Show cancellation notification
                const cancelDiv = document.createElement('div');
                cancelDiv.className = 'fixed top-4 left-4 bg-orange-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in';
                cancelDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        <div>
                            <div class="font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
                            <div class="text-sm opacity-90">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(cancelDiv);
                
                setTimeout(() => {
                    cancelDiv.remove();
                }, 3000);
                
                // The actual cancellation will be handled in the processAndSaveRecord function
                setTimeout(() => {
                    finishCancellation();
                }, 1000);
            }
        }
        
        // Finish cancellation process
        function finishCancellation() {
            updateImportStatus('‚ùå ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            
            // Change icon to cancelled
            const icon = document.getElementById('importIcon');
            icon.innerHTML = `
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
            `;
            
            // Hide progress after delay
            setTimeout(async () => {
                document.getElementById('importProgressContainer').classList.add('hidden');
                
                // Auto-refresh data to show what was imported before cancellation
                console.log('üîÑ Auto-refreshing data after cancellation...');
                await autoRefreshData('cancel', window.allPatients ? window.allPatients.length : 0);
                
                // Show final cancellation message
                const finalDiv = document.createElement('div');
                finalDiv.className = 'fixed top-4 right-4 bg-orange-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in';
                finalDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                        </svg>
                        <div>
                            <div class="font-bold">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
                            <div class="text-sm opacity-90">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(finalDiv);
                
                setTimeout(() => {
                    finalDiv.remove();
                }, 5000);
                
            }, 2000);
        }

        // Update import status text
        function updateImportStatus(status) {
            document.getElementById('importStatus').textContent = status;
        }

        // Update import count display
        function updateImportCount(current, total) {
            document.getElementById('importCount').textContent = `${current.toLocaleString()} / ${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // Process data one by one with batch progress display
        function processDataWithHighPerformance(jsonData) {
            const requiredFields = ['‡πÇ‡∏£‡∏Ñ', '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡πÄ‡∏û‡∏®', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô', '‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢', '‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'];
            
            const totalRecords = jsonData.length;
                    let processedCount = 0;
                    let successCount = 0;
                    let errorCount = 0;
                    
                    // Initialize or reset global patients array
                    if (!window.allPatients) {
                        window.allPatients = [];
                    }
                    
                    // Process records sequentially
                    async function processRecords() {
                        // Clear loading message if exists
                        if (processedCount > 0) {
                            tbody.innerHTML = '';
                        }
                        
                        // Process current record
                        const record = jsonData[processedCount];
                        if (record) {
                            try {
                                // Clean and validate record
                                const cleanRecord = {};
                                for (const field of requiredFields) {
                                    let value = record[field] || '';
                                    if (field === '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ' && value) {
                                        value = parseInt(value, 10);
                                    }
                                    cleanRecord[field] = value;
                                }
                                
                                // Save if valid
                                if (cleanRecord['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] && cleanRecord['‡πÄ‡∏û‡∏®']) {
                                    const saved = await saveRecordToDatabase(cleanRecord);
                                    if (saved) {
                                        successCount++;
                                        window.allPatients.unshift(cleanRecord);
                                        addRecordToTable(cleanRecord, successCount);
                                    }
                                } else {
                                    errorCount++;
                                }
                            } catch (error) {
                                console.error('Error processing record:', error);
                                errorCount++;
                            }
                            
                            // Update status
                            processedCount++;
                            const statusElement = document.getElementById('importStatus');
                            if (statusElement) {
                                statusElement.textContent = `${processedCount} / ${jsonData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount}, ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorCount})`;
                            }
                            
                            // Process next record after small delay
                            setTimeout(processRecords, 50);
                        } else {
                            // All records processed
                            showNotification(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô\n‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                            
                            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            createDiseaseSummary();
                            if (window.firebaseDB) {
                                loadSystemOverview();
                            }
                        }
                    }
                    
                    // Start processing
                    processRecords();            // Determine batch size for progress display only
            const batchSize = Math.max(100, Math.floor(totalRecords / 20));
            console.log(`üìä Using batch size for progress: ${batchSize.toLocaleString()} for ${totalRecords.toLocaleString()} records`);
            
            // Show batch processing info (for progress display)
            showBatchProcessingInfo(totalRecords, batchSize);
            
            updateImportStatus('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...');
            
            // Process records one by one
        function processRecord(index) {
            if (importCancelled) {
                console.log(`üõë Import cancelled at record ${index + 1}`);
                return;
            }
            
            if (index >= totalRecords) {
                // Finish import
                finishImportProcess(savedRecords, validRecords, errorRecords);
                return;
            }
            
            const row = jsonData[index];
            const newRow = {};
            
            // Copy required fields with data cleaning
            for (const field of requiredFields) {
                let value = row[field] || '';
                // Clean up common data issues
                value = value.toString().trim();
                if (field === '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ' && !isNaN(value)) {
                    value = parseInt(value);
                }
                newRow[field] = value;
            }                processedRecords++;
                
                // Validate record
                if (newRow['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] && newRow['‡πÄ‡∏û‡∏®']) {
                    validRecords++;
                    
                    // Save record to database
                    saveRecordToDatabase(newRow).then((success) => {
                        if (success) {
                            savedRecords++;
                            
                            // Add to global array (newest first)
                            window.allPatients.unshift(newRow);
                            
                            // Add to table display (limit to 100 records)
                            addRecordToTable(newRow, savedRecords);
                        }
                        
                        // Update batch progress display
                        const currentBatch = Math.ceil(processedRecords / batchSize);
                        const totalBatches = Math.ceil(totalRecords / batchSize);
                        const batchStartIndex = (currentBatch - 1) * batchSize;
                        const batchEndIndex = Math.min(currentBatch * batchSize, totalRecords);
                        
                        updateBatchProgress('saving', currentBatch, totalBatches, batchStartIndex, batchEndIndex - 1, totalRecords);
                        
                        // Update progress stats
                        updateProgressStats(processedRecords, totalRecords, savedRecords, validRecords, errorRecords, startTime);
                        
                        // Continue with next record
                        const delay = getProcessingDelay(totalRecords);
                        setTimeout(() => processRecord(index + 1), delay);
                    });
                } else {
                    errorRecords++;
                    
                    // Update batch progress display
                    const currentBatch = Math.ceil(processedRecords / batchSize);
                    const totalBatches = Math.ceil(totalRecords / batchSize);
                    const batchStartIndex = (currentBatch - 1) * batchSize;
                    const batchEndIndex = Math.min(currentBatch * batchSize, totalRecords);
                    
                    updateBatchProgress('validation', currentBatch, totalBatches, batchStartIndex, batchEndIndex - 1, totalRecords);
                    
                    // Update progress stats
                    updateProgressStats(processedRecords, totalRecords, savedRecords, validRecords, errorRecords, startTime);
                    
                    // Continue with next record
                    const delay = getProcessingDelay(totalRecords);
                    setTimeout(() => processRecord(index + 1), delay);
                }
            }
            
            // Start processing from first record
            processRecord(0);
        }

        // Get optimal batch size based on dataset size and browser performance
        function getOptimalBatchSize(totalRecords) {
            // Detect browser performance capability
            const isHighPerformance = navigator.hardwareConcurrency >= 8 && navigator.deviceMemory >= 8;
            const isMediumPerformance = navigator.hardwareConcurrency >= 4 && navigator.deviceMemory >= 4;
            
            if (totalRecords > 500000) {
                return isHighPerformance ? 5000 : isMediumPerformance ? 3000 : 2000;
            } else if (totalRecords > 200000) {
                return isHighPerformance ? 8000 : isMediumPerformance ? 5000 : 3000;
            } else if (totalRecords > 100000) {
                return isHighPerformance ? 10000 : isMediumPerformance ? 7000 : 5000;
            } else if (totalRecords > 50000) {
                return isHighPerformance ? 15000 : isMediumPerformance ? 10000 : 7000;
            } else {
                return Math.min(totalRecords, 20000);
            }
        }





        // Legacy function for backward compatibility
        function processDataInChunks(jsonData) {
            console.log('üîÑ Redirecting to high-performance processing...');
            processDataWithHighPerformance(jsonData);
        }
        
        // Get processing delay based on dataset size
        function getProcessingDelay(totalRecords) {
            if (totalRecords > 100000) return 100; // 100ms for very large datasets
            if (totalRecords > 50000) return 50;   // 50ms for large datasets
            if (totalRecords > 10000) return 20;   // 20ms for medium datasets
            return 10; // 10ms for small datasets
        }
        
        // Save individual record to database
        async function saveRecordToDatabase(record) {
            try {
                // Save to Firebase (individual record)
                const { database, ref, push } = window.firebaseDB;
                const patientsRef = ref(database, 'patients');
                const newRef = await push(patientsRef, record);
                
                // Also update localStorage
                const existingData = JSON.parse(localStorage.getItem('patients') || '[]');
                existingData.unshift({...record, _id: newRef.key}); // Add to beginning with Firebase ID
                
                // Keep only latest 50000 records in localStorage to prevent memory issues
                if (existingData.length > 50000) {
                    existingData.splice(50000);
                }
                
                localStorage.setItem('patients', JSON.stringify(existingData));
                
                return true;
            } catch (error) {
                console.error('‚ùå Error saving record:', error);
                
                // Fallback to localStorage only
                try {
                    const existingData = JSON.parse(localStorage.getItem('patients') || '[]');
                    existingData.unshift(record);
                    
                    if (existingData.length > 50000) {
                        existingData.splice(50000);
                    }
                    
                    localStorage.setItem('patients', JSON.stringify(existingData));
                    return true;
                } catch (localError) {
                    console.error('‚ùå Error saving to localStorage:', localError);
                    return false;
                }
            }
        }
        
        // Show import patients modal
        function showImportPatientsModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importPatientsModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                        <button onclick="closeImportPatientsModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <p>‚Ä¢ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</p>
                            <p>‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô:</p>
                            <ul class="list-disc list-inside pl-4 text-sm">
                                <li>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</li>
                                <li>‡πÄ‡∏û‡∏®</li>
                                <li>‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ</li>
                                <li>‡πÅ‡∏Ç‡∏ß‡∏á</li>
                                <li>‡πÄ‡∏Ç‡∏ï</li>
                                <li>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</li>
                                <li>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢</li>
                                <li>‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</li>
                                <li>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</li>
                            </ul>
                        </div>

                        <div>
                            <input type="file" id="patientsExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handlePatientsFileSelect(this)">
                            <div class="flex justify-between items-center">
                                <button onclick="document.getElementById('patientsExcelFile').click()" class="btn-secondary text-sm">
                                    <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"/>
                                        <path d="M9 13h2v5a1 1 0 11-2 0v-5z"/>
                                    </svg>
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                </button>
                                <button onclick="downloadPatientsExampleFile()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                </button>
                            </div>
                            <div id="patientsFileInfo" class="mt-2 text-sm"></div>
                        </div>

                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowPatients" class="form-checkbox text-green-600" checked>
                            <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="closeImportPatientsModal()" class="flex-1 btn-secondary">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button onclick="processImportPatients()" class="flex-1 btn-primary" id="importPatientsButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import patients modal
        function closeImportPatientsModal() {
            const modal = document.getElementById('importPatientsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle patients file select
        function handlePatientsFileSelect(input) {
            const fileInfo = document.getElementById('patientsFileInfo');
            const importButton = document.getElementById('importPatientsButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download example file for patients
        function downloadPatientsExampleFile() {
            const wb = XLSX.utils.book_new();
            
            // Create headers
            const headers = [
                '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ',
                '‡πÄ‡∏û‡∏®',
                '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ',
                '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô',
                '‡πÅ‡∏Ç‡∏ß‡∏á',
                '‡πÄ‡∏Ç‡∏ï',
                '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î',
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢',
                '‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢',
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'
            ];
            
            // Create sample data
            const data = [
                headers,
                ['A90', '‡∏ä‡∏≤‡∏¢', '25', '0', '0', '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '2023-07-15', '‡∏´‡∏≤‡∏¢', ''],
                ['A00', '‡∏´‡∏ç‡∏¥‡∏á', '35', '0', '0', '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '2023-07-20', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï', '2023-07-25']
            ];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Auto-size columns
            const colWidths = headers.map((header, i) => {
                return { wch: Math.max(...data.map(row => String(row[i]).length)) };
            });
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
            
            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_${dateStr}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Process patients import
        async function processImportPatients() {
            const fileInput = document.getElementById('patientsExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowPatients').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importPatientsButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const diseases = await loadFromFirebase('diseases');
                const diseasesMap = new Map(diseases.map(d => [d.code, d.name]));
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first worksheet
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        let jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (skipFirstRow) {
                            jsonData = jsonData.slice(1);
                        }
                        
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                        jsonData = jsonData.map(row => {
                            const diseaseCode = row['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'];
                            return {
                                ...row,
                                '‡πÇ‡∏£‡∏Ñ': diseasesMap.get(diseaseCode) || row['‡πÇ‡∏£‡∏Ñ'] || ''
                            };
                        });
                        
                        // Process records
                        await importRecords(jsonData);
                        
                        closeImportPatientsModal();
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(fileInput.files[0]);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Improved record import function with direct processing
        async function importRecords(jsonData) {
            const tbody = document.getElementById('patientsTableBody');
            if (!tbody) {
                console.error('‚ùå Table body not found');
                return;
            }

            // Clear table
            tbody.innerHTML = '';
            
            // Show import status with progress bar
            const statusDiv = document.createElement('div');
            statusDiv.id = 'importStatus';
            statusDiv.className = 'fixed top-4 right-4 bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg z-50 slide-in';
            document.body.appendChild(statusDiv);
            
            let successCount = 0;
            const totalRecords = jsonData.length;
            
            // Process records one by one
            for (let i = 0; i < totalRecords; i++) {
                const record = jsonData[i];
                const progress = ((i + 1) / totalRecords) * 100;
                
                // Update status with progress bar
                statusDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                            <div class="text-sm font-medium">${i + 1} / ${totalRecords}</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-sm text-gray-600">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                `;
                
                // Save record
                try {
                    const saved = await saveRecordToDatabase(record);
                    if (saved) {
                        successCount++;
                        addRecordToTable(record, successCount);
                    }
                } catch (error) {
                    console.error('Error saving record:', error);
                }
                
                // Small delay between records
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Show completion status
            statusDiv.innerHTML = `
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="font-medium text-green-600">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
                        <div class="text-sm font-medium">${totalRecords} / ${totalRecords}</div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-600 h-2.5 rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                    <div class="text-sm text-gray-600">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
            `;
            
            // Remove status after delay
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => statusDiv.remove(), 300);
            }, 5000);
        }
        
        // Add record to table with animation
        function addRecordToTable(record, recordNumber) {
            const tbody = document.getElementById('patientsTableBody');
            if (!tbody) {
                console.error('‚ùå Table body not found');
                return;
            }
            
            // Remove empty state if exists
            const emptyState = tbody.querySelector('td[colspan="12"]');
            if (emptyState) {
                tbody.innerHTML = '';
            }
            
            // Limit display to 100 records to prevent performance issues
            const existingRows = tbody.querySelectorAll('tr');
            if (existingRows.length >= 100) {
                // Remove the last row with fade out animation
                const lastRow = existingRows[existingRows.length - 1];
                lastRow.style.transition = 'opacity 0.3s';
                lastRow.style.opacity = '0';
                setTimeout(() => lastRow.remove(), 300);
            }
            
            // Create new row with fade in animation
            const newRow = document.createElement('tr');
            newRow.style.opacity = '0';
            newRow.style.transition = 'opacity 0.3s';
            newRow.className = 'table-row transition-all duration-300 border-b border-gray-100 bg-green-50 animate-slideInFromTop';
            newRow.innerHTML = `
                <td class="px-6 py-4 text-sm font-semibold text-gray-900">${record.‡πÇ‡∏£‡∏Ñ || record['‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                <td class="px-6 py-4 text-sm text-blue-600 font-medium">${record.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ || record['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡πÄ‡∏û‡∏® || record['‡πÄ‡∏û‡∏®'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ || record['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô || record['‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô || record['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡πÅ‡∏Ç‡∏ß‡∏á || record['‡πÅ‡∏Ç‡∏ß‡∏á'] || ''}</td>
                <td class="px-6 py-4 text-sm font-medium">${record.‡πÄ‡∏Ç‡∏ï || record['‡πÄ‡∏Ç‡∏ï'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î || record['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || ''}</td>
                <td class="px-6 py-4 text-sm">${convertExcelDateToThai(record.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢ || record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢'])}</td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${(record.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || record['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢']) === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${record.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || record['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'] || ''}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm">${convertExcelDateToThai(record.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï || record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])}</td>
            `;
            
            // Insert at the beginning
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // Remove highlight after animation
            setTimeout(() => {
                newRow.classList.remove('bg-green-50');
                newRow.classList.add(recordNumber % 2 === 0 ? 'bg-white' : 'bg-gray-50');
            }, 2000);
        }
        
        // Update progress statistics
        function updateProgressStats(processed, total, saved, valid, errors, startTime) {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const speed = Math.round(processed / elapsedTime);
            const remainingRecords = total - processed;
            const estimatedTimeRemaining = speed > 0 ? Math.round(remainingRecords / speed) : 0;
            const percentage = Math.round((processed / total) * 100);
            const savedPercentage = Math.round((saved / total) * 100);
            
            // Update progress bar and percentage
            document.getElementById('importPercentage').textContent = `${savedPercentage}%`;
            document.getElementById('progressBar').style.width = `${savedPercentage}%`;
            
            // Update counts
            updateImportCount(saved, total);
            document.getElementById('processedCount').textContent = processed.toLocaleString();
            document.getElementById('validCount').textContent = valid.toLocaleString();
            document.getElementById('errorCount').textContent = errors.toLocaleString();
            document.getElementById('importSpeed').textContent = `${speed.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            
            // Update time remaining
            if (estimatedTimeRemaining > 0) {
                const minutes = Math.floor(estimatedTimeRemaining / 60);
                const seconds = estimatedTimeRemaining % 60;
                document.getElementById('timeRemaining').textContent = 
                    minutes > 0 ? `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ` : `${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            } else {
                document.getElementById('timeRemaining').textContent = '‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß...';
            }
            
            // Update status message
            updateImportStatus(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${saved.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${savedPercentage}%) - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${processed.toLocaleString()}/${total.toLocaleString()}`);
        }
        
        // Finish import process
        function finishImportProcess(saved, valid, errors) {
            updateImportStatus(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${saved.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            // Update final statistics
            document.getElementById('importPercentage').textContent = '100%';
            document.getElementById('progressBar').style.width = '100%';
            
            // Change icon to success
            const icon = document.getElementById('importIcon');
            icon.classList.remove('animate-spin');
            icon.innerHTML = `
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            `;
            
            // Hide progress after delay and auto-refresh data
            setTimeout(async () => {
                document.getElementById('importProgressContainer').classList.add('hidden');
                
                // Auto-refresh data after import
                console.log('üîÑ Auto-refreshing data after import...');
                await autoRefreshData('import', saved);
                
                showImportSuccessNotification(saved, valid, errors);
            }, 2000);
        }

        // Legacy function - no longer used with real-time import
        async function finishImport(filteredData, validRecords, errorRecords) {
            // This function is kept for compatibility but not used in real-time import
            console.log('Legacy finishImport called - using real-time import instead');
        }

        // Save to Firebase with chunked uploads for large datasets
        async function saveToFirebaseWithProgress(path, data) {
            try {
                const { database, ref, set } = window.firebaseDB;
                const totalRecords = data.length;
                const CHUNK_SIZE = 2000; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞ 2,000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                
                updateImportStatus(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase...`);
                
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô chunks
                if (totalRecords > CHUNK_SIZE) {
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢...`);
                    
                    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                    await set(ref(database, path), null);
                    updateImportStatus(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...`);
                    
                    let savedRecords = 0;
                    const totalChunks = Math.ceil(totalRecords / CHUNK_SIZE);
                    let currentChunk = 0;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞ chunk
                    for (let i = 0; i < totalRecords; i += CHUNK_SIZE) {
                        currentChunk++;
                        const chunk = data.slice(i, Math.min(i + CHUNK_SIZE, totalRecords));
                        
                        try {
                            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å chunk ‡∏ô‡∏µ‡πâ‡∏•‡∏á Firebase
                            const chunkRef = ref(database, `${path}/chunk_${currentChunk}`);
                            await set(chunkRef, chunk);
                            
                            savedRecords += chunk.length;
                            const percentage = Math.round((savedRecords / totalRecords) * 100);
                            
                            updateImportStatus(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase: ${savedRecords.toLocaleString()}/${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${percentage}%) - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${currentChunk}/${totalChunks}`);
                            
                            console.log(`‚úÖ Saved chunk ${currentChunk}/${totalChunks}: ${chunk.length} records`);
                            
                            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Firebase ‡∏ñ‡∏π‡∏Å rate limit
                            if (currentChunk < totalChunks) {
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                            
                        } catch (chunkError) {
                            console.error(`‚ùå Error saving chunk ${currentChunk}:`, chunkError);
                            updateImportStatus(`‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${currentChunk} - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...`);
                            
                            // ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            try {
                                const retryChunkRef = ref(database, `${path}/chunk_${currentChunk}`);
                                await set(retryChunkRef, chunk);
                                savedRecords += chunk.length;
                                console.log(`‚úÖ Retry successful for chunk ${currentChunk}`);
                            } catch (retryError) {
                                console.error(`‚ùå Retry failed for chunk ${currentChunk}:`, retryError);
                                throw retryError;
                            }
                        }
                    }
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° chunks
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢...`);
                    await set(ref(database, path), data);
                    
                    // ‡∏•‡∏ö chunks ‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÑ‡∏ß‡πâ
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß...`);
                    for (let i = 1; i <= totalChunks; i++) {
                        try {
                            await set(ref(database, `${path}/chunk_${i}`), null);
                        } catch (cleanupError) {
                            console.warn(`Warning: Could not cleanup chunk ${i}:`, cleanupError);
                        }
                    }
                    
                    updateImportStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    
                } else {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á Firebase...`);
                    await set(ref(database, path), data);
                    updateImportStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                }
                
                console.log(`‚úÖ Successfully saved ${totalRecords.toLocaleString()} records to Firebase: ${path}`);
                return true;
                
            } catch (error) {
                console.error(`‚ùå Error saving to Firebase (${path}):`, error);
                updateImportStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÑ‡∏î‡πâ - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô`);
                
                // Fallback to localStorage
                try {
                    localStorage.setItem(path.replace('/', '_'), JSON.stringify(data));
                    updateImportStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${data.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                } catch (localError) {
                    console.error('‚ùå Error saving to localStorage:', localError);
                    updateImportStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ`);
                }
                return false;
            }
        }

        // Optimized saving for large datasets with better memory management
        function simulateSavingProgress(filteredData, validRecords, errorRecords, firebaseSaved = false) {
            const totalRecords = filteredData.length;
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏•‡∏≠‡∏á
            if (totalRecords > 50000) {
                updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);
                
                const saveFunction = () => {
                    try {
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡πÄ‡∏õ‡πá‡∏ô backup
                        updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á...');
                        
                        // ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡πÄ‡∏õ‡πá‡∏ô chunks ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á
                        const localStorageChunkSize = 10000;
                        const chunks = [];
                        
                        for (let i = 0; i < totalRecords; i += localStorageChunkSize) {
                            const chunk = filteredData.slice(i, Math.min(i + localStorageChunkSize, totalRecords));
                            chunks.push(chunk);
                        }
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å metadata
                        localStorage.setItem('patients_metadata', JSON.stringify({
                            totalRecords: totalRecords,
                            chunks: chunks.length,
                            timestamp: Date.now(),
                            firebaseSaved: firebaseSaved
                        }));
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ chunk
                        chunks.forEach((chunk, index) => {
                            localStorage.setItem(`patients_chunk_${index}`, JSON.stringify(chunk));
                        });
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility)
                        localStorage.setItem('patients', JSON.stringify(filteredData));
                        
                        // ‡∏•‡πâ‡∏≤‡∏á memory
                        filteredData.length = 0;
                        chunks.length = 0;
                        
                        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
                        document.getElementById('importPercentage').textContent = '100%';
                        document.getElementById('progressBar').style.width = '100%';
                        updateImportStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
                        
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô icon ‡πÄ‡∏õ‡πá‡∏ô success
                        const icon = document.getElementById('importIcon');
                        icon.classList.remove('animate-spin');
                        icon.innerHTML = `
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                        `;
                        
                        // ‡∏ã‡πà‡∏≠‡∏ô progress ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        setTimeout(async () => {
                            document.getElementById('importProgressContainer').classList.add('hidden');
                            
                            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                            console.log('üîÑ Refreshing data from Firebase...');
                            await initializeData();
                            
                            loadPatientsTable();
                            showImportSuccessNotification(totalRecords, validRecords, errorRecords);
                            
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ memory
                            console.log(`üíæ Data saved successfully:`);
                            console.log(`   - Total records: ${totalRecords.toLocaleString()}`);
                            console.log(`   - Firebase: ${firebaseSaved ? 'Yes' : 'No'}`);
                            console.log(`   - LocalStorage chunks: ${chunks.length}`);
                            console.log(`   - Memory freed: ~${Math.round(totalRecords * 0.5 / 1024)} MB`);
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error saving large dataset:', error);
                        
                        // ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
                        try {
                            // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                            const essentialData = filteredData.map(record => ({
                                '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ': record['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'],
                                '‡πÄ‡∏û‡∏®': record['‡πÄ‡∏û‡∏®'],
                                '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ': record['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'],
                                '‡πÄ‡∏Ç‡∏ï': record['‡πÄ‡∏Ç‡∏ï'],
                                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢': record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢'],
                                '‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢': record['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢']
                            }));
                            
                            localStorage.setItem('patients', JSON.stringify(essentialData));
                            updateImportStatus(`‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${essentialData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                            
                            setTimeout(async () => {
                                document.getElementById('importProgressContainer').classList.add('hidden');
                                
                                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                console.log('üîÑ Refreshing data from Firebase...');
                                await initializeData();
                                
                                loadPatientsTable();
                                showImportSuccessNotification(essentialData.length, validRecords, errorRecords);
                            }, 1500);
                            
                        } catch (fallbackError) {
                            console.error('Fallback save also failed:', fallbackError);
                            updateImportStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ');
                            
                            // ‡πÅ‡∏™‡∏î‡∏á error notification
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
                            errorDiv.innerHTML = `
                                <div class="flex items-start">
                                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                                    </svg>
                                    <div>
                                        <div class="font-bold mb-1">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ</div>
                                        <div class="text-sm opacity-90">
                                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)<br>
                                            ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ‡πÜ (< 100,000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                                        </div>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(errorDiv);
                            
                            setTimeout(() => {
                                errorDiv.remove();
                                document.getElementById('importProgressContainer').classList.add('hidden');
                            }, 10000);
                        }
                    }
                };
                
                // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
                setTimeout(saveFunction, 500);
                return;
            }
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ñ‡∏∂‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
            const chunkSize = Math.max(1, Math.floor(totalRecords / 20));
            let savedRecords = 0;
            
            function saveChunk() {
                const recordsToSave = Math.min(chunkSize, totalRecords - savedRecords);
                savedRecords += recordsToSave;
                
                const savePercentage = Math.round((savedRecords / totalRecords) * 100);
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó progress bar ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                document.getElementById('importPercentage').textContent = `${savePercentage}%`;
                document.getElementById('progressBar').style.width = `${savePercentage}%`;
                updateImportCount(savedRecords, totalRecords);
                document.getElementById('processedCount').textContent = savedRecords.toLocaleString();
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                if (savePercentage < 30) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                } else if (savePercentage < 60) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö...');
                } else if (savePercentage < 90) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
                } else if (savePercentage < 100) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                } else {
                    updateImportStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
                }
                
                // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                if (savedRecords < totalRecords) {
                    setTimeout(saveChunk, 30); // ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å
                } else {
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô icon ‡πÄ‡∏õ‡πá‡∏ô success
                    const icon = document.getElementById('importIcon');
                    icon.classList.remove('animate-spin');
                    icon.innerHTML = `
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    `;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                    localStorage.setItem('patients', JSON.stringify(filteredData));
                    
                    // ‡∏ã‡πà‡∏≠‡∏ô progress ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    setTimeout(async () => {
                        document.getElementById('importProgressContainer').classList.add('hidden');
                        
                        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        console.log('üîÑ Refreshing data from Firebase...');
                        await initializeData();
                        
                        loadPatientsTable();
                        showImportSuccessNotification(filteredData.length, validRecords, errorRecords);
                    }, 1000);
                }
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            saveChunk();
        }

        // Show import success notification
        function showImportSuccessNotification(total, valid, errors) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            successDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    </svg>
                    <div>
                        <div class="font-bold mb-1">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
                        <div class="text-sm opacity-90">
                            ‚Ä¢ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
                            ‚Ä¢ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${valid.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
                            ${errors > 0 ? `‚Ä¢ ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errors.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Utility functions for date conversion
        function convertThaiYearToChristian(thaiYear) {
            if (!thaiYear) return '';
            const year = parseInt(thaiYear);
            return year > 2400 ? year - 543 : year;
        }

        function convertChristianYearToThai(christianYear) {
            if (!christianYear) return '';
            const year = parseInt(christianYear);
            return year < 2400 ? year + 543 : year;
        }

        function formatDateTH(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            
            const day = parts[0];
            const month = parts[1];
            let year = parts[2];
            
            // Convert Thai year to Christian year if needed
            year = convertThaiYearToChristian(year);
            
            return `${day}/${month}/${year}`;
        }

        // Convert Excel date serial number to Christian date format
        function convertExcelDateToChristian(excelDate) {
            if (!excelDate || excelDate === '') return '';
            
            // If it's already a date string, convert Thai year to Christian year
            if (typeof excelDate === 'string' && excelDate.includes('/')) {
                return formatDateTH(excelDate);
            }
            
            // Convert Excel serial number to JavaScript Date
            const serialNumber = parseInt(excelDate);
            if (isNaN(serialNumber) || serialNumber <= 0) return '';
            
            // Excel date starts from January 1, 1900 (but Excel incorrectly treats 1900 as leap year)
            const excelEpoch = new Date(1900, 0, 1);
            const jsDate = new Date(excelEpoch.getTime() + (serialNumber - 2) * 24 * 60 * 60 * 1000);
            
            // Format as DD/MM/YYYY (Christian year)
            const day = jsDate.getDate().toString().padStart(2, '0');
            const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
            const year = jsDate.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // Pagination variables
        let currentPage = 1;
        let recordsPerPage = 50; // Show 50 records per page
        let filteredPatients = [];
        let allPatients = [];
        
        // Import control variables
        let importCancelled = false;
        let currentImportProcess = null;

        // Load patients table with pagination
        async function loadPatientsTable(searchTerm = '') {
            console.log('üîÑ Loading patients table...');
            
            // Use global variables if available (for real-time import)
            if (window.allPatients && Array.isArray(window.allPatients) && window.allPatients.length > 0) {
                allPatients = window.allPatients;
                console.log(`üìä Using cached patients data: ${allPatients.length}`);
            } else {
                // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô
                const firebaseData = await loadFromFirebase('patients');
                if (Array.isArray(firebaseData)) {
                    allPatients = firebaseData;
                    console.log(`üìä Total patients loaded from Firebase: ${allPatients.length}`);
                } else {
                    console.error('‚ùå Firebase data is not an array:', firebaseData);
                    allPatients = [];
                }
                
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage
                if (allPatients.length === 0) {
                    console.log('üîç No data from Firebase, checking localStorage...');
                    const localData = localStorage.getItem('patients');
                    if (localData) {
                        try {
                            const parsedData = JSON.parse(localData);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                allPatients = parsedData;
                                console.log(`‚úÖ Loaded ${allPatients.length} patients from localStorage`);
                            }
                        } catch (error) {
                            console.error('‚ùå Error parsing localStorage patients data:', error);
                        }
                    }
                }
            }
            
            // Filter patients based on search term
            if (searchTerm) {
                filteredPatients = allPatients.filter(patient => {
                    const searchFields = [
                        patient.‡πÇ‡∏£‡∏Ñ || patient['‡πÇ‡∏£‡∏Ñ'] || '',
                        patient.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ || patient['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || '',
                        patient.‡πÄ‡∏û‡∏® || patient['‡πÄ‡∏û‡∏®'] || '',
                        patient.‡πÅ‡∏Ç‡∏ß‡∏á || patient['‡πÅ‡∏Ç‡∏ß‡∏á'] || '',
                        patient.‡πÄ‡∏Ç‡∏ï || patient['‡πÄ‡∏Ç‡∏ï'] || '',
                        patient.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î || patient['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || ''
                    ];
                    return searchFields.some(field => 
                        field.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                });
            } else {
                filteredPatients = [...allPatients];
            }

            const tbody = document.getElementById('patientsTableBody');
            
            if (filteredPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-6 py-20 text-center text-gray-500">
                            <div class="text-6xl mb-4">üìã</div>
                            <p class="font-semibold text-xl text-gray-700">${searchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'}</p>
                            <p class="text-gray-500 mt-2">${searchTerm ? '‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel'}</p>
                        </td>
                    </tr>
                `;
                updatePaginationInfo(0, 0, 0);
                return;
            }

            // Ensure we have valid data to work with
            if (!Array.isArray(filteredPatients)) {
                console.error('‚ùå filteredPatients is not an array:', filteredPatients);
                filteredPatients = [];
            }

            // Calculate pagination
            const totalRecords = filteredPatients.length;
            console.log(`üìä Filtered patients: ${totalRecords}`);
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const currentPageData = filteredPatients.slice(startIndex, endIndex);

            // Render current page data
            tbody.innerHTML = currentPageData.map((patient, index) => {
                const globalIndex = startIndex + index;
                return `
                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${globalIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-6 py-4 text-sm font-semibold text-gray-900">${patient.‡πÇ‡∏£‡∏Ñ || patient['‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                        <td class="px-6 py-4 text-sm text-blue-600 font-medium">${patient.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ || patient['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡πÄ‡∏û‡∏® || patient['‡πÄ‡∏û‡∏®'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡πÅ‡∏Ç‡∏ß‡∏á || patient['‡πÅ‡∏Ç‡∏ß‡∏á'] || ''}</td>
                        <td class="px-6 py-4 text-sm font-medium">${patient.‡πÄ‡∏Ç‡∏ï || patient['‡πÄ‡∏Ç‡∏ï'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î || patient['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${convertExcelDateToThai(patient.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢ || patient['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢'])}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${(patient.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || patient['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢']) === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${patient.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || patient['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'] || ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">${convertExcelDateToThai(patient.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï || patient['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])}</td>
                    </tr>
                `;
            }).join('');

            // Update pagination info
            updatePaginationInfo(totalRecords, currentPage, totalPages);
            updatePaginationControls(totalPages);
            
            console.log(`Table updated: Page ${currentPage}/${totalPages}, showing ${currentPageData.length} of ${totalRecords} records`);
        }

        // Update pagination information display
        function updatePaginationInfo(totalRecords, currentPage, totalPages) {
            const startRecord = totalRecords > 0 ? ((currentPage - 1) * recordsPerPage) + 1 : 0;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
            
            document.getElementById('paginationInfo').textContent = 
                `‡πÅ‡∏™‡∏î‡∏á ${startRecord.toLocaleString()} - ${endRecord.toLocaleString()} ‡∏à‡∏≤‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // Update pagination controls
        function updatePaginationControls(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            
            if (totalPages <= 1) {
                paginationControls.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 ${currentPage === 1 ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
                <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border-t border-b border-gray-300 hover:bg-gray-50 ${currentPage === 1 ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
            `;

            // Show page numbers (max 5 pages around current page)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="goToPage(${i})" 
                            class="px-3 py-2 text-sm font-medium border-t border-b border-gray-300 ${i === currentPage ? 'bg-blue-50 text-blue-600 border-blue-500' : 'text-gray-500 bg-white hover:bg-gray-50 hover:text-gray-700'}">
                        ${i}
                    </button>
                `;
            }

            paginationHTML += `
                <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border-t border-b border-gray-300 hover:bg-gray-50 ${currentPage === totalPages ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                </button>
                <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 ${currentPage === totalPages ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                </button>
            `;

            paginationControls.innerHTML = paginationHTML;
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredPatients.length / recordsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadPatientsTable(document.getElementById('searchInput').value);
            }
        }

        // Change records per page
        function changeRecordsPerPage(newRecordsPerPage) {
            recordsPerPage = parseInt(newRecordsPerPage);
            currentPage = 1; // Reset to first page
            loadPatientsTable(document.getElementById('searchInput').value);
        }

        // Search patients
        function searchPatients() {
            const searchTerm = document.getElementById('searchInput').value;
            currentPage = 1; // Reset to first page when searching
            loadPatientsTable(searchTerm);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentPage = 1;
            loadPatientsTable();
        }

        // Show master data detail
        function showMasterDataDetail(type) {
            document.getElementById('masterDataPage').classList.add('hidden');
            const detailPage = document.getElementById('masterDataDetailPage');
            detailPage.classList.remove('hidden');
            detailPage.classList.add('slide-in');
            
            const titles = {
                'diseases': '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ',
                'responsible': '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                'population': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
                'agePopulation': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏',
                'thailandPopulation': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢',
                'bangkokDistricts': '‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
                'epidemicWeeks': '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î',
                'diseaseHistory': '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á'
            };
            
            document.getElementById('masterDataDetailTitle').textContent = titles[type];
            
            // Set up add button
            const addButton = document.getElementById('addNewButton');
            addButton.onclick = () => addNewMasterData(type);
            
            // Set up import button for diseases
            const buttonContainer = addButton.parentElement;
            
            // Remove existing import button if any
            const existingImportBtn = document.getElementById('importExcelButton');
            if (existingImportBtn) {
                existingImportBtn.remove();
            }
            
            if (type === 'diseases' || type === 'responsible' || type === 'population' || type === 'thailandPopulation' || type === 'bangkokDistricts' || type === 'epidemicWeeks' || type === 'diseaseHistory') {
                const importButton = document.createElement('button');
                importButton.id = 'importExcelButton';
                importButton.className = 'btn-secondary text-sm flex items-center ml-2';
                importButton.onclick = () => {
                    switch (type) {
                        case 'diseases':
                            showImportDiseaseModal();
                            break;
                        case 'responsible':
                            showImportResponsibleModal();
                            break;
                        case 'population':
                            showImportPopulationModal();
                            break;
                        case 'thailandPopulation':
                            showImportThailandPopulationModal();
                            break;
                        case 'bangkokDistricts':
                            showImportBangkokDistrictsModal();
                            break;
                        case 'epidemicWeeks':
                            showImportEpidemicWeeksModal();
                            break;
                        case 'diseaseHistory':
                            showImportDiseaseHistoryModal();
                            break;
                    }
                };
                importButton.innerHTML = `
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                    </svg>
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                `;
                buttonContainer.appendChild(importButton);
            }
            
            loadMasterDataDetail(type);
        }

        // Load master data detail content (same as before but with better styling)
        async function loadMasterDataDetail(type) {
            const content = document.getElementById('masterDataDetailContent');
            
            switch(type) {
                case 'diseases':
                    await loadDiseasesTable();
                    break;
                case 'responsible':
                    await loadResponsibleTable();
                    break;
                case 'population':
                    loadPopulationTable();
                    break;
                case 'agePopulation':
                    loadAgePopulationTable();
                    break;
                case 'thailandPopulation':
                    await loadThailandPopulationTable();
                    break;
                case 'bangkokDistricts':
                    await loadBangkokDistrictsTable();
                    break;
                case 'epidemicWeeks':
                    loadEpidemicWeeksTable();
                    break;
                case 'diseaseHistory':
                    loadDiseaseHistoryTable();
                    break;
            }
        }

        // Load disease history table
        async function loadDiseaseHistoryTable() {
            const diseases = await loadFromFirebase('diseases');
            const diseaseHistory = await loadFromFirebase('diseaseHistory') || [];
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-3">
                                <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2 1h10v8H5V6z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                                <p class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 rounded bg-blue-600"></div>
                            <span class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 rounded bg-red-600"></div>
                            <span class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-purple-50 to-blue-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏°.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏Å.‡∏û.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏°‡∏µ.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏°.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏û.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏°‡∏¥.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏Å.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏™.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏Å.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏ï.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏û.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏ò.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏£‡∏ß‡∏°</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${diseaseHistory.length === 0 ? `
                                <tr>
                                    <td colspan="18" class="px-6 py-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                                </tr>
                            ` : diseaseHistory.map((record, index) => {
                                const disease = diseases.find(d => d.code === record.diseaseCode);
                                const totalPatients = Object.values(record.months).reduce((sum, month) => sum + (month.patients || 0), 0);
                                const totalDeaths = Object.values(record.months).reduce((sum, month) => sum + (month.deaths || 0), 0);
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${record.year}</td>
                                        <td class="px-6 py-4 text-sm font-medium text-blue-600">${record.diseaseCode}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${disease ? disease.name : '-'}</td>
                                        ${['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].map(month => `
                                            <td class="px-6 py-4 text-sm text-center">
                                                <div class="text-blue-600">${record.months[month]?.patients || 0}</div>
                                                <div class="text-red-600">${record.months[month]?.deaths || 0}</div>
                                            </td>
                                        `).join('')}
                                        <td class="px-6 py-4 text-sm text-center font-medium">
                                            <div class="text-blue-600">${totalPatients}</div>
                                            <div class="text-red-600">${totalDeaths}</div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-center">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="editDiseaseHistory(${index})" class="text-blue-600 hover:text-blue-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deleteDiseaseHistory(${index})" class="text-red-600 hover:text-red-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Function to show the form for adding/editing disease history
        function showDiseaseHistoryForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á';
            
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'diseaseHistoryModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-6xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-800 to-blue-600 bg-clip-text text-transparent">
                            üìä ${title}
                        </h3>
                        <button onclick="closeDiseaseHistoryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="diseaseHistoryForm" onsubmit="saveDiseaseHistoryData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</label>
                                <input type="number" id="historyYear" required min="1900" max="2100"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</label>
                                <select id="historyDiseaseCode" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                            <h4 class="text-lg font-semibold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                ${['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].map(month => `
                                    <div class="p-4 border rounded-lg">
                                        <h5 class="font-medium mb-2">${getThaiMonth(month)}</h5>
                                        <div class="space-y-2">
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                                                <input type="number" id="patients_${month}" min="0"
                                                    class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</label>
                                                <input type="number" id="deaths_${month}" min="0"
                                                    class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 btn-primary bg-gradient-to-r from-purple-600 to-blue-600">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeDiseaseHistoryModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            loadDiseaseOptionsForHistory();
            
            if (isEdit) {
                populateDiseaseHistoryForm(editIndex);
            }
        }

        // Helper function to get Thai month name
        function getThaiMonth(monthNumber) {
            const months = {
                '01': '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
                '02': '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
                '03': '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
                '04': '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
                '05': '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
                '06': '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '07': '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
                '08': '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
                '09': '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
                '10': '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
                '11': '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
                '12': '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            };
            return months[monthNumber];
        }

        // Load disease options for the history form
        async function loadDiseaseOptionsForHistory() {
            const diseases = await loadFromFirebase('diseases');
            const select = document.getElementById('historyDiseaseCode');
            
            if (select) {
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>';
                diseases.forEach(disease => {
                    const option = document.createElement('option');
                    option.value = disease.code;
                    option.textContent = `${disease.code} - ${disease.name}`;
                    select.appendChild(option);
                });
            }
        }

        // Close disease history modal
        function closeDiseaseHistoryModal() {
            const modal = document.getElementById('diseaseHistoryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Add new disease history entry
        function addNewDiseaseHistory() {
            showDiseaseHistoryForm();
        }

        // Populate form with existing data for editing
        async function populateDiseaseHistoryForm(index) {
            const diseaseHistory = await loadFromFirebase('diseaseHistory');
            const record = diseaseHistory[index];
            
            if (record) {
                document.getElementById('historyYear').value = record.year;
                document.getElementById('historyDiseaseCode').value = record.diseaseCode;
                
                // Populate monthly data
                Object.entries(record.months).forEach(([month, data]) => {
                    if (data.patients) document.getElementById(`patients_${month}`).value = data.patients;
                    if (data.deaths) document.getElementById(`deaths_${month}`).value = data.deaths;
                });
            }
        }

        // Save disease history data
        async function saveDiseaseHistoryData(event, editIndex = null) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const diseaseHistory = await loadFromFirebase('diseaseHistory') || [];
                const year = document.getElementById('historyYear').value;
                const diseaseCode = document.getElementById('historyDiseaseCode').value;
                
                const months = {};
                ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].forEach(month => {
                    const patients = parseInt(document.getElementById(`patients_${month}`).value) || 0;
                    const deaths = parseInt(document.getElementById(`deaths_${month}`).value) || 0;
                    if (patients > 0 || deaths > 0) {
                        months[month] = { patients, deaths };
                    }
                });
                
                const newRecord = {
                    year,
                    diseaseCode,
                    months
                };
                
                if (editIndex !== null) {
                    diseaseHistory[editIndex] = newRecord;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    diseaseHistory.push(newRecord);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                await saveToFirebase('diseaseHistory', diseaseHistory);
                closeDiseaseHistoryModal();
                await loadDiseaseHistoryTable();
                
            } catch (error) {
                console.error('Error saving disease history:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Delete disease history entry
        async function deleteDiseaseHistory(index) {
            const diseaseHistory = await loadFromFirebase('diseaseHistory');
            const record = diseaseHistory[index];
            
            if (!record) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const disease = (await loadFromFirebase('diseases')).find(d => d.code === record.diseaseCode);
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏õ‡∏µ: ${record.year}\n‡πÇ‡∏£‡∏Ñ: ${disease ? disease.name : record.diseaseCode}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    diseaseHistory.splice(index, 1);
                    await saveToFirebase('diseaseHistory', diseaseHistory);
                    await loadDiseaseHistoryTable();
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } catch (error) {
                    console.error('Error deleting disease history:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Edit disease history entry
        function editDiseaseHistory(index) {
            showDiseaseHistoryForm(index);
        }

        // Show import disease history modal
        function showImportDiseaseHistoryModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importDiseaseHistoryModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                        <button onclick="closeImportDiseaseHistoryModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-blue-900">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel</li>
                                <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</li>
                                <li>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß</li>
                            </ol>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)
                            </label>
                            <input type="file" id="diseaseHistoryExcelFile" accept=".xlsx" class="w-full"
                                onchange="handleDiseaseHistoryFileSelect(this)">
                        </div>

                        <div id="diseaseHistoryFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowDiseaseHistory" class="form-checkbox" checked>
                            <label for="skipFirstRowDiseaseHistory" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingDiseaseHistory" class="form-checkbox">
                            <label for="replaceExistingDiseaseHistory" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadDiseaseHistoryExample()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportDiseaseHistoryModal()" class="btn-secondary">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="processDiseaseHistoryImport()" id="importDiseaseHistoryButton" class="btn-primary" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import disease history modal
        function closeImportDiseaseHistoryModal() {
            const modal = document.getElementById('importDiseaseHistoryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle disease history file select
        function handleDiseaseHistoryFileSelect(input) {
            const fileInfo = document.getElementById('diseaseHistoryFileInfo');
            const importButton = document.getElementById('importDiseaseHistoryButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                fileInfo.textContent = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${file.name}`;
                importButton.disabled = false;
            } else {
                fileInfo.textContent = '';
                importButton.disabled = true;
            }
        }

        // Download disease history example file
        function downloadDiseaseHistoryExample() {
            const wb = XLSX.utils.book_new();
            
            // Create headers
            const headers = [
                '‡∏õ‡∏µ (‡∏Ñ.‡∏®.)',
                '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°',
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];

            // Create example data
            const exampleData = [
                headers,
                ['2023', 'D01', 100, 5, 150, 8, 120, 6, 80, 4, 90, 3, 110, 7, 130, 6, 140, 8, 95, 5, 85, 4, 100, 6, 115, 7],
                ['2023', 'D02', 75, 3, 85, 4, 95, 5, 70, 2, 80, 3, 90, 4, 100, 5, 110, 6, 65, 2, 70, 3, 85, 4, 95, 5]
            ];

            const ws = XLSX.utils.aoa_to_sheet(exampleData);
            
            // Set column widths
            const colWidths = headers.map(() => ({ wch: 15 }));
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á.xlsx');
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Process disease history import
        async function processDiseaseHistoryImport() {
            const fileInput = document.getElementById('diseaseHistoryExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowDiseaseHistory').checked;
            const replaceExisting = document.getElementById('replaceExistingDiseaseHistory').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importDiseaseHistoryButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const startRow = skipFirstRow ? 1 : 0;
                const diseases = await loadFromFirebase('diseases');
                const existingHistory = replaceExisting ? [] : (await loadFromFirebase('diseaseHistory') || []);
                
                for (let i = startRow; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row[0] || !row[1]) continue;  // Skip if year or disease code is missing
                    
                    const year = row[0].toString();
                    const diseaseCode = row[1].toString();
                    
                    // Verify disease code exists
                    if (!diseases.some(d => d.code === diseaseCode)) {
                        showNotification(`‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${diseaseCode} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`, 'error');
                        continue;
                    }
                    
                    const months = {};
                    for (let m = 0; m < 12; m++) {
                        const patients = parseInt(row[2 + m * 2]) || 0;
                        const deaths = parseInt(row[3 + m * 2]) || 0;
                        if (patients > 0 || deaths > 0) {
                            const monthKey = (m + 1).toString().padStart(2, '0');
                            months[monthKey] = { patients, deaths };
                        }
                    }
                    
                    const newRecord = { year, diseaseCode, months };
                    existingHistory.push(newRecord);
                }
                
                await saveToFirebase('diseaseHistory', existingHistory);
                
                closeImportDiseaseHistoryModal();
                await loadDiseaseHistoryTable();
                showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                
            } catch (error) {
                console.error('Error importing disease history:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Enhanced table loading functions with better styling
        async function loadDiseasesTable() {
            const diseases = await loadFromFirebase('diseases');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                <div class="text-2xl font-bold text-blue-600">${diseases.length}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${diseases.length === 0 ? 
                                `<tr><td colspan="5" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">üìã</div>
                                    <p class="font-semibold text-xl text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ</p>
                                    <p class="text-gray-500 mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                                    <div class="flex justify-center space-x-4">
                                        <button onclick="addNewMasterData('diseases')" class="btn-primary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                            </svg>
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ
                                        </button>
                                    </div>
                                </td></tr>` :
                                diseases.map((disease, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                        <td class="px-6 py-4 text-sm text-gray-600">${index + 1}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${disease.code}</td>
                                        <td class="px-6 py-4 font-semibold text-gray-900">${disease.name}</td>
                                        <td class="px-6 py-4 text-center">
                                            <select onchange="updateDiseaseReportType(${index}, this.value)" class="px-3 py-1 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${(disease.reportType === 'high' || !disease.reportType) ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
                                                <option value="high" ${(disease.reportType === 'high' || !disease.reportType) ? 'selected' : ''}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å</option>
                                                <option value="low" ${disease.reportType === 'low' ? 'selected' : ''}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢</option>
                                            </select>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="editDisease(${index})" class="text-blue-600 hover:text-blue-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deleteDisease(${index})" class="text-red-600 hover:text-red-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                ${diseases.length > 0 ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                        </h4>
                        <div class="text-sm text-gray-600">
                            <p>‚Ä¢ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong class="text-blue-600">${diseases.length}</strong> ‡πÇ‡∏£‡∏Ñ</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                            <p>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô</p>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Similar enhanced styling for other table functions...
        async function loadResponsibleTable() {
            const responsible = await loadFromFirebase('responsible');
            const diseases = await loadFromFirebase('diseases');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
                                <div class="text-2xl font-bold text-blue-600">${responsible.length}</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
                                <div class="text-2xl font-bold text-green-600">${responsible.length}</div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${responsible.length === 0 ? 
                                `<tr><td colspan="8" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">ÔøΩ</div>
                                    <p class="font-semibold text-xl text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                                    <p class="text-gray-500 mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                                    <div class="flex justify-center space-x-4">
                                        <button onclick="addNewMasterData('responsible')" class="btn-primary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                            </svg>
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                                        </button>
                                        <button onclick="showImportExcelModal('responsible')" class="btn-secondary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                            </svg>
                                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                                        </button>
                                    </div>
                                </td></tr>` :
                                responsible.map((resp, index) => {
                                    const disease = diseases.find(d => d.code === resp.diseaseCode);
                                    return `
                                        <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                            <td class="px-6 py-4 text-sm text-gray-600">${index + 1}</td>
                                            <td class="px-6 py-4 font-bold text-blue-600">${resp.diseaseCode}</td>
                                            <td class="px-6 py-4 font-semibold text-gray-900">${disease ? disease.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ'}</td>
                                            <td class="px-6 py-4 font-medium text-gray-900">${resp.responsibleName}</td>
                                            <td class="px-6 py-4 text-gray-600">${resp.responsiblePosition}</td>
                                            <td class="px-6 py-4 font-medium text-gray-900">${resp.reviewerName}</td>
                                            <td class="px-6 py-4 text-gray-600">${resp.reviewerPosition}</td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex justify-center space-x-2">
                                                    <button onclick="editResponsible(${index})" class="text-blue-600 hover:text-blue-900 transition-colors p-1 rounded">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                        </svg>
                                                    </button>
                                                    <button onclick="deleteResponsible(${index})" class="text-red-600 hover:text-red-900 transition-colors p-1 rounded">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                ${responsible.length > 0 ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                        </h4>
                        <div class="text-sm text-gray-600">
                            <p>‚Ä¢ ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong class="text-blue-600">${responsible.length}</strong> ‡∏Ñ‡∏ô</p>
                            <p>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                            <p>‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</p>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Enhanced population table with full functionality
        async function loadPopulationTable() {
            const population = await loadFromFirebase('population');
            const content = document.getElementById('masterDataDetailContent');
            
            // Calculate totals for summary
            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
            const dataByYear = population.reduce((acc, pop) => {
                const year = pop.year || 2568; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                if (!acc[year]) {
                    acc[year] = {
                        totalPopulation: 0,
                        totalMale: 0,
                        totalFemale: 0,
                        districtCount: 0
                    };
                }
                acc[year].totalPopulation += parseInt(pop.totalPopulation || pop.malePopulation + pop.femalePopulation || 0);
                acc[year].totalMale += parseInt(pop.malePopulation || 0);
                acc[year].totalFemale += parseInt(pop.femalePopulation || 0);
                acc[year].districtCount += 1;
                return acc;
            }, {});

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
            const years = Object.keys(dataByYear).sort((a, b) => b - a);
            
            content.innerHTML = `
                ${years.map(year => `
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-900 mb-4 text-xl flex items-center">
                            <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">‡∏õ‡∏µ ${year}</span>
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°</div>
                                <div class="text-2xl font-bold text-blue-600">${dataByYear[year].totalPopulation.toLocaleString()} ‡∏Ñ‡∏ô</div>
                                <div class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${dataByYear[year].districtCount} ‡πÄ‡∏Ç‡∏ï</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</div>
                                <div class="text-2xl font-bold text-green-600">${dataByYear[year].totalMale.toLocaleString()} ‡∏Ñ‡∏ô</div>
                                <div class="text-sm text-gray-500 mt-1">${((dataByYear[year].totalMale/dataByYear[year].totalPopulation)*100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-gradient-to-r from-pink-50 to-pink-100 rounded-lg p-4 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</div>
                                <div class="text-2xl font-bold text-pink-600">${dataByYear[year].totalFemale.toLocaleString()} ‡∏Ñ‡∏ô</div>
                                <div class="text-sm text-gray-500 mt-1">${((dataByYear[year].totalFemale/dataByYear[year].totalPopulation)*100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `).join('')}

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏µ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${population.length === 0 ? 
                                `<tr><td colspan="6" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">üèôÔ∏è</div>
                                    <p class="font-semibold text-xl text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</p>
                                    <p class="text-gray-500 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</p>
                                    <div class="flex justify-center space-x-4">
                                        <button onclick="addNewMasterData('population')" class="btn-primary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                            </svg>
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                                        </button>
                                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                                        </button>
                                    </div>
                                </td></tr>` :
                                population.map((pop, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                        <td class="px-6 py-4 text-sm text-gray-600">${pop.year || 2568}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${pop.district}</td>
                                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${(pop.totalPopulation || pop.malePopulation + pop.femalePopulation).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-blue-600">${pop.malePopulation.toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${pop.femalePopulation.toLocaleString()}</td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="editPopulation(${index})" class="text-blue-600 hover:text-blue-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deletePopulation(${index})" class="text-red-600 hover:text-red-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                ${population.length > 0 ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg">
                        <div class="text-sm text-gray-600">
                            <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</p>
                            <p class="mt-1">‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
                        </div>
                    </div>
                    </div>
                ` : ''}
            `;
        }

        async function loadAgePopulationTable() {
            const agePopulation = await loadFromFirebase('agePopulation');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</div>
                                <div class="text-2xl font-bold text-blue-600">${agePopulation.length}</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°</div>
                                <div class="text-2xl font-bold text-green-600">${agePopulation.reduce((sum, p) => sum + parseInt(p.total), 0).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showImportAgePopulationModal()" class="btn-secondary text-sm">
                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${agePopulation.length === 0 ? 
                                '<tr><td colspan="7" class="px-6 py-20 text-center text-gray-500"><div class="text-6xl mb-4">üë•</div><p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p><p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p></td></tr>' :
                                agePopulation.map((age, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 font-semibold text-gray-900">${age.year}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${age.startAge || age.startAge === 0 ? age.startAge : '-'}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${age.endAge || age.endAge === 0 ? age.endAge : '-'}</td>
                                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${age.total ? parseInt(age.total).toLocaleString() : ''}</td>
                                        <td class="px-6 py-4 text-right text-blue-600">${age.male ? parseInt(age.male).toLocaleString() : ''}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${age.female ? parseInt(age.female).toLocaleString() : ''}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="editAgePopulation(${index})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:from-blue-600 hover:to-blue-700 mr-2 transition-all transform hover:scale-105">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteAgePopulation(${index})" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg text-sm hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Show import Bangkok Districts modal
        function showImportBangkokDistrictsModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importBangkokDistrictsModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <h2 class="text-2xl font-bold mb-6">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span></p>
                                    <p class="text-xs text-gray-500">Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (.xlsx, .xls)</p>
                                </div>
                                <input type="file" id="bangkokDistrictsExcelFile" class="hidden" accept=".xlsx, .xls" onchange="handleBangkokDistrictsFileSelect(this)" />
                            </label>
                        </div>
                        
                        <div id="bangkokDistrictsFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowBangkokDistricts" class="form-checkbox" checked />
                            <label for="skipFirstRowBangkokDistricts" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingBangkokDistricts" class="form-checkbox" />
                            <label for="replaceExistingBangkokDistricts" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadBangkokDistrictsExampleFile()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportBangkokDistrictsModal()" class="btn-secondary text-sm">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="processBangkokDistrictsImport()" id="importBangkokDistrictsButton" class="btn-primary text-sm" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import Bangkok districts modal
        function closeImportBangkokDistrictsModal() {
            const modal = document.getElementById('importBangkokDistrictsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle Bangkok districts file select
        function handleBangkokDistrictsFileSelect(input) {
            const fileInfo = document.getElementById('bangkokDistrictsFileInfo');
            const importButton = document.getElementById('importBangkokDistrictsButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = `<span class="text-red-500">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>`;
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úÖ ${fileName}</span><br>
                    <span class="text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î: ${fileSize} KB</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download Bangkok districts example file
        function downloadBangkokDistrictsExampleFile() {
            const data = [
                ['‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'],
                ['‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö', '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏î‡πÄ‡∏ó‡∏û‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£']
            ];
            
            // Convert array to worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            ws['!cols'] = [
                { wch: 25 },  // ‡πÅ‡∏Ç‡∏ß‡∏á
                { wch: 25 },  // ‡πÄ‡∏Ç‡∏ï
                { wch: 25 }   // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "F0F9FF" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            ['A1', 'B1', 'C1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Process Bangkok districts import
        async function processBangkokDistrictsImport() {
            const fileInput = document.getElementById('bangkokDistrictsExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowBangkokDistricts').checked;
            const replaceExisting = document.getElementById('replaceExistingBangkokDistricts').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importBangkokDistrictsButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length < 2) {
                        showNotification('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    const startRow = skipFirstRow ? 1 : 0;
                    let newData = [];
                    let errors = [];
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 2) continue;
                        
                        const subdistrict = row[0]?.toString().trim();
                        const district = row[1]?.toString().trim();
                        const province = row[2]?.toString().trim() || '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£';
                        
                        if (!district || !subdistrict) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            continue;
                        }
                        
                        newData.push({
                            subdistrict,
                            district,
                            province
                        });
                    }
                    
                    if (errors.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`, 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    try {
                        let existingData = replaceExisting ? [] : await loadFromFirebase('bangkokDistricts');
                        
                        for (const newItem of newData) {
                            const existingIndex = existingData.findIndex(item => 
                                item.district.toLowerCase() === newItem.district.toLowerCase() &&
                                item.subdistrict.toLowerCase() === newItem.subdistrict.toLowerCase()
                            );
                            
                            if (existingIndex !== -1) {
                                existingData[existingIndex] = newItem;
                            } else {
                                existingData.push(newItem);
                            }
                        }
                        
                        await saveToFirebase('bangkokDistricts', existingData);
                        await loadBangkokDistrictsTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportBangkokDistrictsModal();
                        
                    } catch (error) {
                        console.error('Error saving data:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Show import Thailand population modal
        // Show import Bangkok Districts modal
        function showImportBangkokDistrictsModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importBangkokDistrictsModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-4xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h2>
                        <button onclick="closeImportBangkokDistrictsModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="text-blue-800 font-semibold mb-3">üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡πÅ‡∏Ç‡∏ß‡∏á</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡πÄ‡∏Ç‡∏ï</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-blue-100">
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-blue-600">
                            <p>‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
                            <p>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" ‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£")</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span></p>
                                    <p class="text-xs text-gray-500">Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (.xlsx, .xls)</p>
                                </div>
                                <input type="file" id="bangkokDistrictsFile" class="hidden" accept=".xlsx, .xls" 
                                    onchange="handleBangkokDistrictsFileSelect(this)"/>
                            </label>
                        </div>
                        
                        <div id="bangkokDistrictsFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowBangkokDistricts" class="form-checkbox" checked />
                            <label for="skipFirstRowBangkokDistricts" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingBangkokDistricts" class="form-checkbox" />
                            <label for="replaceExistingBangkokDistricts" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadBangkokDistrictsExample()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportBangkokDistrictsModal()" class="btn-secondary">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="importBangkokDistricts()" id="importBangkokDistrictsButton" class="btn-primary" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Show import Thailand population modal
        function showImportThailandPopulationModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importThailandPopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</h2>
                        <button onclick="closeImportThailandPopulationModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Import Instructions -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                            ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </h4>
                        <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                            <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                            <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                            <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2024)</li>
                            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                        </ol>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm border border-gray-300 rounded">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏ä‡∏≤‡∏¢</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏´‡∏ç‡∏¥‡∏á</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    <tr>
                                        <td class="px-4 py-2 border-b">2024</td>
                                        <td class="px-4 py-2 border-b">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                        <td class="px-4 py-2 border-b">5666264</td>
                                        <td class="px-4 py-2 border-b">2694574</td>
                                        <td class="px-4 py-2 border-b">2971690</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 border-b">2024</td>
                                        <td class="px-4 py-2 border-b">‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</td>
                                        <td class="px-4 py-2 border-b">1276745</td>
                                        <td class="px-4 py-2 border-b">598741</td>
                                        <td class="px-4 py-2 border-b">678004</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="thailandPopulationExcelFile" accept=".xlsx, .xls" class="hidden" 
                                    onchange="handleThailandPopulationFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('thailandPopulationExcelFile').click()" class="btn-secondary text-sm flex items-center">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadThailandPopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                    </button>
                                </div>
                                <div id="thailandPopulationFileInfo" class="mt-3"></div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 mt-4">
                            <input type="checkbox" id="skipFirstRowThailand" class="rounded text-blue-600">
                            <label for="skipFirstRowThailand" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        <div class="flex items-center space-x-2 mt-2">
                            <input type="checkbox" id="replaceExistingThailand" class="rounded text-blue-600">
                            <label for="replaceExistingThailand" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        <div class="flex justify-between mt-8">
                            <button onclick="closeImportThailandPopulationModal()" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button onclick="processThailandPopulationImport()" class="btn-primary" id="importThailandPopulationButton" disabled>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import Thailand population modal
        function closeImportBangkokDistrictsModal() {
            const modal = document.getElementById('importBangkokDistrictsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle Bangkok districts file selection
        function handleBangkokDistrictsFileSelect(input) {
            const fileInfo = document.getElementById('bangkokDistrictsFileInfo');
            const importButton = document.getElementById('importBangkokDistrictsButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (!file.name.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-500">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = `
                    <div class="text-green-600">‚úÖ ${file.name}</div>
                    <div class="text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î: ${fileSize} KB</div>
                `;
                importButton.disabled = false;
            }
        }

        // Download Bangkok districts example file
        function downloadBangkokDistrictsExample() {
            const data = [
                ['‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'],
                ['‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏î‡∏£‡∏≤‡∏ä‡∏ö‡∏û‡∏¥‡∏ò', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏™‡∏≥‡∏£‡∏≤‡∏ç‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 25},  // ‡πÅ‡∏Ç‡∏ß‡∏á
                {wch: 25},  // ‡πÄ‡∏Ç‡∏ï
                {wch: 25}   // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            ];
            
            // Style header row
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "E5E7EB" } },
                alignment: { horizontal: "center" }
            };
            
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (!ws[cell]) ws[cell] = {};
                ws[cell].s = headerStyle;
            });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // Import Bangkok districts from Excel
        async function importBangkokDistricts() {
            const fileInput = document.getElementById('bangkokDistrictsFile');
            const skipFirstRow = document.getElementById('skipFirstRowBangkokDistricts').checked;
            const replaceExisting = document.getElementById('replaceExistingBangkokDistricts').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importBangkokDistrictsButton');
            const originalButtonText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (jsonData.length < 2) {
                            throw new Error('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        }
                        
                        const startRow = skipFirstRow ? 1 : 0;
                        let newData = [];
                        let errors = [];
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            
                            const subdistrict = row[0]?.toString().trim();
                            const district = row[1]?.toString().trim();
                            const province = row[2]?.toString().trim() || '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£';
                            
                            if (!subdistrict || !district) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                                continue;
                            }
                            
                            newData.push({
                                subdistrict,
                                district,
                                province
                            });
                        }
                        
                        if (errors.length > 0) {
                            throw new Error('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n' + errors.join('\n'));
                        }
                        
                        let existingData = replaceExisting ? [] : await loadFromFirebase('bangkokDistricts');
                        
                        for (const item of newData) {
                            const index = existingData.findIndex(existing => 
                                existing.district.toLowerCase() === item.district.toLowerCase() &&
                                existing.subdistrict.toLowerCase() === item.subdistrict.toLowerCase()
                            );
                            
                            if (index !== -1) {
                                existingData[index] = item;
                            } else {
                                existingData.push(item);
                            }
                        }
                        
                        await saveToFirebase('bangkokDistricts', existingData);
                        await loadBangkokDistrictsTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportBangkokDistrictsModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalButtonText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(fileInput.files[0]);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalButtonText;
                importButton.disabled = false;
            }
        }

        function closeImportThailandPopulationModal() {
            const modal = document.getElementById('importThailandPopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle Thailand population file select
        function handleThailandPopulationFileSelect(input) {
            const fileInfo = document.getElementById('thailandPopulationFileInfo');
            const importButton = document.getElementById('importThailandPopulationButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                    fileInfo.innerHTML = '';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-gray-700">${fileName}</span>
                        <span class="text-gray-500">(${fileSize} KB)</span>
                    </div>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download Thailand population example file
        function downloadThailandPopulationExampleFile() {
            const data = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [2024, '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', 5666264, 2694574, 2971690],
                [2024, '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', 1276745, 598741, 678004],
                [2024, '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', 1164897, 553874, 611023],
                [2024, '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', 1351479, 652147, 699332]
            ];
            
            // Convert array to worksheet
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 },   // ‡∏õ‡∏µ
                { wch: 20 },  // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                { wch: 15 },  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                { wch: 15 },  // ‡∏ä‡∏≤‡∏¢
                { wch: 15 }   // ‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "F0F9FF" } }, // bg-blue-50
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling to all header cells
            ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Style for numeric columns
            const numberStyle = {
                alignment: { horizontal: "right" },
                numFmt: "#,##0"
            };

            // Apply number formatting to population columns (columns C, D, E)
            for (let row = 2; row <= sampleData.length; row++) {
                ['C', 'D', 'E'].forEach(col => {
                    const cell = col + row;
                    if (ws[cell]) ws[cell].s = numberStyle;
                });
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢");

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Show import epidemic weeks modal
        function showImportEpidemicWeeksModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importEpidemicWeeksModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-4xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h2>
                        <button onclick="closeImportEpidemicWeeksModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="text-blue-800 font-semibold mb-3">üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-blue-100">
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">1</td>
                                        <td class="px-4 py-2 text-gray-700">01/01/2024</td>
                                        <td class="px-4 py-2 text-gray-700">07/01/2024</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">2</td>
                                        <td class="px-4 py-2 text-gray-700">08/01/2024</td>
                                        <td class="px-4 py-2 text-gray-700">14/01/2024</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">3</td>
                                        <td class="px-4 py-2 text-gray-700">15/01/2024</td>
                                        <td class="px-4 py-2 text-gray-700">21/01/2024</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-blue-600">
                            <p>‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
                            <p>‚Ä¢ ‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2024)</p>
                            <p>‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span></p>
                                    <p class="text-xs text-gray-500">Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (.xlsx, .xls)</p>
                                </div>
                                <input type="file" id="epidemicWeeksFile" class="hidden" accept=".xlsx, .xls" 
                                    onchange="handleEpidemicWeeksFileSelect(this)"/>
                            </label>
                        </div>
                        
                        <div id="epidemicWeeksFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowEpidemicWeeks" class="form-checkbox" checked />
                            <label for="skipFirstRowEpidemicWeeks" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingEpidemicWeeks" class="form-checkbox" />
                            <label for="replaceExistingEpidemicWeeks" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadEpidemicWeeksExample()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportEpidemicWeeksModal()" class="btn-secondary">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="importEpidemicWeeks()" id="importEpidemicWeeksButton" class="btn-primary" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import epidemic weeks modal
        function closeImportEpidemicWeeksModal() {
            const modal = document.getElementById('importEpidemicWeeksModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle epidemic weeks file select
        function handleEpidemicWeeksFileSelect(input) {
            const fileInfo = document.getElementById('epidemicWeeksFileInfo');
            const importButton = document.getElementById('importEpidemicWeeksButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (!file.name.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-500">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = `
                    <div class="text-green-600">‚úÖ ${file.name}</div>
                    <div class="text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î: ${fileSize} KB</div>
                `;
                importButton.disabled = false;
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download epidemic weeks example file
        function downloadEpidemicWeeksExample() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û.‡∏®.
            
            const currentYearCE = currentYear - 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
            const data = [
                ['‡∏õ‡∏µ', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'],
                [currentYearCE, '1', '01/01/2024', '07/01/2024', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ'],
                [currentYearCE, '2', '08/01/2024', '14/01/2024', ''],
                [currentYearCE, '3', '15/01/2024', '21/01/2024', ''],
                [currentYearCE, '4', '22/01/2024', '28/01/2024', '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 10},  // ‡∏õ‡∏µ
                {wch: 12},  // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
                {wch: 15},  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                {wch: 15},  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                {wch: 30}   // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            ];
            
            // Style header row
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "E5E7EB" } },
                alignment: { horizontal: "center" }
            };
            
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (!ws[cell]) ws[cell] = {};
                ws[cell].s = headerStyle;
            });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î");
            
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // Function to parse and format date from various formats
        function parseDateFormat(dateStr) {
            if (!dateStr) return '';
            
            // Remove any whitespace
            dateStr = dateStr.toString().trim();
            
            // If it's already in DD/MM/YYYY format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            
            try {
                // Handle Excel serial number
                if (!isNaN(dateStr) && parseInt(dateStr) > 0) {
                    const excelEpoch = new Date(1900, 0, 1);
                    const jsDate = new Date(excelEpoch.getTime() + (parseInt(dateStr) - 2) * 24 * 60 * 60 * 1000);
                    return `${jsDate.getDate().toString().padStart(2, '0')}/${(jsDate.getMonth() + 1).toString().padStart(2, '0')}/${jsDate.getFullYear()}`;
                }

                // Handle YYYY-MM-DD format
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
                    const [year, month, day] = dateStr.split('-');
                    return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                }
                
                // Handle DD-MM-YYYY format
                if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateStr)) {
                    return dateStr.replace(/-/g, '/');
                }
                
                // Handle DD.MM.YYYY format
                if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(dateStr)) {
                    return dateStr.replace(/\./g, '/');
                }

                // Try parsing as a JavaScript Date
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                }

                return '';
            } catch (error) {
                console.error('Error parsing date:', error);
                return '';
            }
        }

        // Import epidemic weeks from Excel
        async function importEpidemicWeeks() {
            const fileInput = document.getElementById('epidemicWeeksFile');
            const skipFirstRow = document.getElementById('skipFirstRowEpidemicWeeks').checked;
            const replaceExisting = document.getElementById('replaceExistingEpidemicWeeks').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importEpidemicWeeksButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (jsonData.length < 2) {
                            throw new Error('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        }
                        
                        const startRow = skipFirstRow ? 1 : 0;
                        let newData = [];
                        let errors = [];
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            
                            let year = row[0];
                            const weekNumber = parseInt(row[1]);
                            let startDate = row[2];
                            let endDate = row[3];
                            const note = row[4]?.toString().trim() || '';
                            
                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                            startDate = parseDateFormat(startDate);
                            endDate = parseDateFormat(endDate);

                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
                            if (!startDate || !endDate) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                                continue;
                            }

                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                            if (!year) {
                                const startDateParts = startDate.split('/');
                                year = parseInt(startDateParts[2]);
                            }
                            
                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                            year = parseInt(year);
                            
                            if (!year || !weekNumber) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà)`);
                                continue;
                            }
                            
                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ ‡∏Ñ.‡∏®.
                            if (year < 1957 || year > 2057) { // 1957-2057 = 2500-2600
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á ‡∏Ñ.‡∏®. 1957-2057`);
                                continue;
                            }
                            
                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                            const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                            if (!dateRegex.test(startDate) || !dateRegex.test(endDate)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY)`);
                                continue;
                            }
                            
                            newData.push({
                                year,
                                weekNumber,
                                startDate,
                                endDate,
                                note
                            });
                        }
                        
                        if (errors.length > 0) {
                            throw new Error('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n' + errors.join('\n'));
                        }
                        
                        let existingData = replaceExisting ? [] : await loadFromFirebase('epidemicWeeks');
                        
                        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
                        for (const item of newData) {
                            const index = existingData.findIndex(existing => 
                                existing.weekNumber === item.weekNumber
                            );
                            
                            if (index !== -1) {
                                existingData[index] = item;
                            } else {
                                existingData.push(item);
                            }
                        }
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                        existingData.sort((a, b) => a.weekNumber - b.weekNumber);
                        
                        await saveToFirebase('epidemicWeeks', existingData);
                        await loadEpidemicWeeksTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportEpidemicWeeksModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(fileInput.files[0]);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Validate CE year for Thailand population
        function validateThailandPopulationYear(year) {
            const currentYear = new Date().getFullYear();
            const yearNum = parseInt(year);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + 10 ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1900)
            if (isNaN(yearNum) || yearNum > currentYear + 10 || yearNum < 1900) {
                return false;
            }
            return true;
        }

        // Process Thailand population import
        async function processThailandPopulationImport() {
            const fileInput = document.getElementById('thailandPopulationExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowThailand').checked;
            const replaceExisting = document.getElementById('replaceExistingThailand').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importThailandPopulationButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length < 2) {
                        showNotification('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    // Start processing from row 1 if skipFirstRow is true
                    const startRow = skipFirstRow ? 1 : 0;
                    let newData = [];
                    let errors = [];
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 4) continue; // Skip incomplete rows
                        
                        const year = parseInt(row[0]) || new Date().getFullYear();
                        // Validate that the year is in CE format
                        if (year > (new Date().getFullYear() + 10) || year < 1900) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (1900-${new Date().getFullYear() + 10})`);
                            continue;
                        }
                        const province = row[1]?.toString().trim();
                        const total = parseInt(row[2]);
                        const male = parseInt(row[3]);
                        const female = parseInt(row[4]);
                        
                        if (!province || isNaN(total) || isNaN(male) || isNaN(female)) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            continue;
                        }
                        
                        newData.push({
                            year,
                            province,
                            total,
                            male,
                            female
                        });
                    }
                    
                    if (errors.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`, 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    try {
                        let existingData = replaceExisting ? [] : await loadFromFirebase('thailandPopulation');
                        
                        // Update existing data with new data
                        for (const newItem of newData) {
                            const existingIndex = existingData.findIndex(item => 
                                item.province.toLowerCase() === newItem.province.toLowerCase() &&
                                item.year === newItem.year
                            );
                            
                            if (existingIndex !== -1) {
                                existingData[existingIndex] = newItem;
                            } else {
                                existingData.push(newItem);
                            }
                        }
                        
                        await saveToFirebase('thailandPopulation', existingData);
                        await loadThailandPopulationTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportThailandPopulationModal();
                        
                    } catch (error) {
                        console.error('Error saving data:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        async function loadThailandPopulationTable() {
            let thailandPopulation = await loadFromFirebase('thailandPopulation');
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            thailandPopulation.sort((a, b) => {
                if (a.year !== b.year) {
                    return a.year - b.year;
                }
                return a.province.localeCompare(b.province);
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
            const yearSummary = thailandPopulation.reduce((acc, curr) => {
                if (!acc[curr.year]) {
                    acc[curr.year] = {
                        totalPopulation: 0,
                        totalMale: 0,
                        totalFemale: 0,
                        provinceCount: 0
                    };
                }
                acc[curr.year].totalPopulation += parseInt(curr.total) || 0;
                acc[curr.year].totalMale += parseInt(curr.male) || 0;
                acc[curr.year].totalFemale += parseInt(curr.female) || 0;
                acc[curr.year].provinceCount++;
                return acc;
            }, {});
            
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                ${Object.keys(yearSummary).length > 0 ? `
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${Object.entries(yearSummary).map(([year, data]) => `
                        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-gray-800">‡∏õ‡∏µ ‡∏Ñ.‡∏®. ${year}</h3>
                                <span class="text-sm text-gray-500">${data.provinceCount} ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</span>
                                    <span class="font-semibold text-blue-600">${data.totalPopulation.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏ä‡∏≤‡∏¢:</span>
                                    <span class="font-medium text-blue-500">${data.totalMale.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span class="font-medium text-pink-500">${data.totalFemale.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}
                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${thailandPopulation.length === 0 ? 
                                '<tr><td colspan="5" class="px-6 py-20 text-center text-gray-500"><div class="text-6xl mb-4">üáπüá≠</div><p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</p><p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p></td></tr>' :
                                thailandPopulation.map((province, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 text-gray-900">${province.year || new Date().getFullYear()}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${province.province}</td>
                                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${parseInt(province.total).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-blue-600">${parseInt(province.male).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${parseInt(province.female).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="editThailandPopulation(${index})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:from-blue-600 hover:to-blue-700 mr-2 transition-all transform hover:scale-105">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteThailandPopulation(${index})" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg text-sm hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Get regional summary
        function getRegionalSummary(thailandPopulation) {
            const regions = {};
            
            thailandPopulation.forEach(province => {
                if (!regions[province.region]) {
                    regions[province.region] = {
                        name: province.region,
                        provinces: 0,
                        total: 0,
                        male: 0,
                        female: 0,
                        totalDensity: 0
                    };
                }
                
                regions[province.region].provinces++;
                regions[province.region].total += parseInt(province.total);
                regions[province.region].male += parseInt(province.male);
                regions[province.region].female += parseInt(province.female);
                regions[province.region].totalDensity += parseFloat(province.density);
            });
            
            return Object.values(regions).map(region => ({
                ...region,
                avgDensity: region.totalDensity / region.provinces
            }));
        }

        async function loadBangkokDistrictsTable() {
            const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÅ‡∏Ç‡∏ß‡∏á</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bangkokDistricts.length === 0 ? 
                                '<tr><td colspan="4" class="px-6 py-20 text-center text-gray-500"><div class="text-6xl mb-4">üè¢</div><p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï</p><p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ç‡∏ß‡∏á ‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p></td></tr>' :
                                bangkokDistricts.map((district, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 font-semibold text-gray-900">${district.subdistrict}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${district.district}</td>
                                        <td class="px-6 py-4 font-medium text-green-600">${district.province}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="editBangkokDistrict(${index})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:from-blue-600 hover:to-blue-700 mr-2 transition-all transform hover:scale-105">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteBangkokDistrict(${index})" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg text-sm hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Statistics -->
                ${bangkokDistricts.length > 0 ? `
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="stat-card">
                            <div class="w-12 h-12 icon-gradient-blue rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-2">${bangkokDistricts.length}</div>
                            <div class="text-sm text-gray-600 font-medium">‡πÅ‡∏Ç‡∏ß‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="w-12 h-12 icon-gradient-green rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-2">${getUniqueDistricts(bangkokDistricts).length}</div>
                            <div class="text-sm text-gray-600 font-medium">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="w-12 h-12 icon-gradient-purple rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-2">1</div>
                            <div class="text-sm text-gray-600 font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</div>
                        </div>
                    </div>
                    
                    <!-- District Summary -->
                    <div class="mt-8">
                        <h4 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-700" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${getDistrictSummary(bangkokDistricts).map(district => `
                                <div class="glass-card p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h5 class="font-bold text-lg text-gray-900">${district.name}</h5>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${district.subdistricts} ‡πÅ‡∏Ç‡∏ß‡∏á</span>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Ç‡∏ß‡∏á:</span>
                                            <span class="font-semibold text-gray-900">${district.subdistricts} ‡πÅ‡∏Ç‡∏ß‡∏á</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
                                            <span class="font-medium text-green-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Get unique districts
        function getUniqueDistricts(bangkokDistricts) {
            const uniqueDistricts = [...new Set(bangkokDistricts.map(d => d.district))];
            return uniqueDistricts;
        }

        // Get district summary
        function getDistrictSummary(bangkokDistricts) {
            const districtCounts = {};
            
            bangkokDistricts.forEach(item => {
                if (!districtCounts[item.district]) {
                    districtCounts[item.district] = {
                        name: item.district,
                        subdistricts: 0
                    };
                }
                districtCounts[item.district].subdistricts++;
            });
            
            return Object.values(districtCounts).sort((a, b) => b.subdistricts - a.subdistricts);
        }

        async function loadEpidemicWeeksTable() {
            const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                        üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                    </h3>
                    <button onclick="addNewMasterData('epidemicWeeks')" class="btn-primary text-sm px-4 py-2">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                        </svg>
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                    </button>
                </div>
                
                ${epidemicWeeks && epidemicWeeks.length > 0 ? `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow">
                            <thead class="bg-gradient-to-r from-green-50 to-emerald-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏µ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${epidemicWeeks.map((week, index) => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${week.year}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${week.weekNumber}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTH(week.startDate)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTH(week.endDate)}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${week.note || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex space-x-2">
                                                <button onclick="editEpidemicWeek(${index})" class="text-blue-600 hover:text-blue-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deleteEpidemicWeek(${index})" class="text-red-600 hover:text-red-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-white rounded p-3 shadow-sm">
                                <div class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                <div class="text-2xl font-bold text-blue-600">${epidemicWeeks.length}</div>
                            </div>
                            <div class="bg-white rounded p-3 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                                <div class="text-2xl font-bold text-green-600">${getLatestYear(epidemicWeeks)}</div>
                            </div>
                            <div class="bg-white rounded p-3 shadow-sm">
                                <div class="text-gray-600">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                                <div class="text-2xl font-bold text-purple-600">${getLatestWeek(epidemicWeeks)}</div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="text-center py-20">
                        <div class="text-6xl mb-4">üìÖ</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h3>
                        <p class="text-gray-500 mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà</p>
                        <button onclick="addNewMasterData('epidemicWeeks')" class="btn-primary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                `}
            `;
        }

        // Helper functions for epidemic weeks
        function getLatestYear(epidemicWeeks) {
            if (!epidemicWeeks || epidemicWeeks.length === 0) return '-';
            return Math.max(...epidemicWeeks.map(w => parseInt(w.year)));
        }

        function getLatestWeek(epidemicWeeks) {
            if (!epidemicWeeks || epidemicWeeks.length === 0) return '-';
            const latestYear = getLatestYear(epidemicWeeks);
            const weeksInLatestYear = epidemicWeeks.filter(w => parseInt(w.year) === latestYear);
            return Math.max(...weeksInLatestYear.map(w => parseInt(w.weekNumber)));
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Clear all patients data
        async function clearAllPatients() {
            const patients = await loadFromFirebase('patients');
            
            if (patients.length === 0) {
                // Show info message if no data
                const infoDiv = document.createElement('div');
                infoDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                infoDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                        </svg>
                        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏ö
                    </div>
                `;
                document.body.appendChild(infoDiv);
                
                setTimeout(() => {
                    infoDiv.remove();
                }, 3000);
                return;
            }

            // Show confirmation dialog
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${patients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                const deletedCount = patients.length;
                
                // Clear the data from Firebase and localStorage
                await saveToFirebase('patients', []);
                localStorage.setItem('patients', JSON.stringify([]));
                
                // Clear global cache
                window.allPatients = [];
                
                // Auto-refresh data after delete
                console.log('üîÑ Auto-refreshing data after delete...');
                await autoRefreshData('delete', deletedCount);
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                        </svg>
                        ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${deletedCount.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                    </div>
                `;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        }

        // Auto-refresh data after operations
        async function autoRefreshData(operation, count) {
            try {
                console.log(`üîÑ Auto-refreshing after ${operation} operation (${count} records)...`);
                
                // Force refresh from Firebase
                await initializeData();
                
                // Clear search and reset pagination
                document.getElementById('searchInput').value = '';
                currentPage = 1;
                
                // Reload table
                await loadPatientsTable();
                
                // Show auto-refresh notification
                const refreshDiv = document.createElement('div');
                refreshDiv.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 slide-in text-sm';
                refreshDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
                    </div>
                `;
                document.body.appendChild(refreshDiv);
                
                setTimeout(() => {
                    refreshDiv.remove();
                }, 2000);
                
                console.log(`‚úÖ Auto-refresh completed after ${operation}`);
                
            } catch (error) {
                console.error(`‚ùå Error in auto-refresh after ${operation}:`, error);
                
                // Show error notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 slide-in text-sm';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            }
        }

        // Refresh patients data from Firebase
        async function refreshPatientsData() {
            console.log('üîÑ Manual refresh requested...');
            
            // Show loading indicator
            const button = event.target;
            const originalHTML = button.innerHTML;
            button.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...
            `;
            button.disabled = true;
            
            try {
                // Force refresh from Firebase
                await initializeData();
                
                // Clear search and reset pagination
                document.getElementById('searchInput').value = '';
                currentPage = 1;
                
                await loadPatientsTable();
                
                // Show success notification
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
                    </div>
                `;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error refreshing data:', error);
                
                // Show error notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            } finally {
                // Restore button
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        }

        // Master data management functions
        function addNewMasterData(type) {
            if (type === 'diseases') {
                showDiseaseForm();
            } else if (type === 'responsible') {
                showResponsibleForm();
            } else if (type === 'population') {
                showPopulationForm();
            } else if (type === 'agePopulation') {
                showAgePopulationForm();
            } else if (type === 'thailandPopulation') {
                showThailandPopulationForm();
            } else if (type === 'bangkokDistricts') {
                showBangkokDistrictForm();
            } else if (type === 'epidemicWeeks') {
                showEpidemicWeekForm();
            } else if (type === 'diseaseHistory') {
                showDiseaseHistoryForm();
            } else {
                alert(`‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type} ‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢`);
            }
        }

        // Show disease form modal
        function showDiseaseForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'diseaseModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-md w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeDiseaseModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="diseaseForm" onsubmit="saveDiseaseData(event, ${editIndex})">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</label>
                                <input type="text" id="diseaseCode" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 506" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</label>
                                <input type="text" id="diseaseName" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <select id="diseaseReportType" class="w-full input-field" required>
                                    <option value="high">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å</option>
                                    <option value="low">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeDiseaseModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateDiseaseForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('diseaseCode').focus();
            }, 100);
        }

        // Populate form for editing
        async function populateDiseaseForm(index) {
            const diseases = await loadFromFirebase('diseases');
            const disease = diseases[index];
            
            if (disease) {
                document.getElementById('diseaseCode').value = disease.code;
                document.getElementById('diseaseName').value = disease.name;
                document.getElementById('diseaseReportType').value = disease.reportType || 'high';
            }
        }

        // Close disease modal
        function closeDiseaseModal() {
            const modal = document.getElementById('diseaseModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save disease data
        async function saveDiseaseData(event, editIndex = null) {
            event.preventDefault();
            
            const code = document.getElementById('diseaseCode').value.trim();
            const name = document.getElementById('diseaseName').value.trim();
            const reportType = document.getElementById('diseaseReportType').value;
            
            if (!code || !name || !reportType) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const diseases = await loadFromFirebase('diseases');
                
                // Check for duplicate code (only if not editing the same record)
                const existingIndex = diseases.findIndex(d => d.code === code);
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∑‡πà‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newDisease = { code, name, reportType };
                
                if (editIndex !== null) {
                    // Edit existing disease
                    diseases[editIndex] = newDisease;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new disease
                    diseases.push(newDisease);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('diseases', diseases);
                
                // Close modal
                closeDiseaseModal();
                
                // Refresh table
                await loadDiseasesTable();
                
            } catch (error) {
                console.error('Error saving disease:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit disease function
        function editDisease(index) {
            showDiseaseForm(index);
        }

        // Update disease report type function
        async function updateDiseaseReportType(index, reportType) {
            try {
                const diseases = await loadFromFirebase('diseases');
                if (diseases[index]) {
                    diseases[index].reportType = reportType;
                    await saveToFirebase('diseases', diseases);
                    
                    // Reload the table to reflect changes
                    await loadDiseasesTable();
                    
                    // Show success message
                    const typeText = reportType === 'high' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å' : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢';
                    showSuccessMessage(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô "${typeText}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                }
            } catch (error) {
                console.error('Error updating disease report type:', error);
                showErrorMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
            }
        }

        // Show success message function
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Show error message function
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }

        // Delete disease function
        // Show import disease modal
        function showImportDiseaseModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importDiseaseModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                        </h3>
                        <button onclick="closeImportDiseaseModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-red-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">B01</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ICD-10 ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢" (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å")</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="diseaseExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleDiseaseFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('diseaseExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadDiseaseExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="diseaseFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRow" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExisting" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processDiseaseImport()" class="flex-1 btn-primary" id="importDiseaseButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportDiseaseModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import disease modal
        function closeImportDiseaseModal() {
            const modal = document.getElementById('importDiseaseModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle disease file select
        function handleDiseaseFileSelect(input) {
            const fileInfo = document.getElementById('diseaseFileInfo');
            const importButton = document.getElementById('importDiseaseButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download disease example file
        function downloadDiseaseExampleFile() {
            const data = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'],
                ['A00', '‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å'],
                ['B01', '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢'],
                ['C02', '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å'],
                ['D03', '‡πÇ‡∏£‡∏Ñ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≠‡∏¢'],
                ['E04', '‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i] ? row[i].length : 0)) + 2};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ.xlsx');
        }

        // Process disease import
        async function processDiseaseImport() {
            const fileInput = document.getElementById('diseaseExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRow').checked;
            const replaceExisting = document.getElementById('replaceExisting').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importDiseaseButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        let startRow = skipFirstRow ? 1 : 0;
                        const processedData = [];
                        const errors = [];
                        const duplicateCodes = new Set();
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const code = row[0] ? row[0].toString().trim() : '';
                            const name = row[1] ? row[1].toString().trim() : '';
                            const reportTypeText = row[2] ? row[2].toString().trim() : '';
                            
                            // Convert Thai report type text to code
                            let reportType = 'high'; // default
                            if (reportTypeText) {
                                if (reportTypeText.includes('‡∏ô‡πâ‡∏≠‡∏¢') || reportTypeText.toLowerCase().includes('low')) {
                                    reportType = 'low';
                                } else if (reportTypeText.includes('‡∏°‡∏≤‡∏Å') || reportTypeText.toLowerCase().includes('high')) {
                                    reportType = 'high';
                                }
                            }
                            
                            if (!code || !name) {
                                if (code || name) {
                                    errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                                }
                                continue;
                            }
                            
                            if (duplicateCodes.has(code)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${code} ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                                continue;
                            }
                            
                            duplicateCodes.add(code);
                            processedData.push({code, name, reportType});
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                        }
                        
                        let existingDiseases = await loadFromFirebase('diseases');
                        // Ensure existing diseases have reportType field (backward compatibility)
                        existingDiseases = existingDiseases.map(disease => ({
                            ...disease,
                            reportType: disease.reportType || 'high'
                        }));
                        
                        if (!replaceExisting) {
                            const existingCodes = new Set(existingDiseases.map(d => d.code));
                            const duplicateExisting = processedData.filter(d => existingCodes.has(d.code));
                            
                            if (duplicateExisting.length > 0) {
                                errors.push(`‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß: ${duplicateExisting.map(d => d.code).join(', ')}`);
                            }
                            
                            const newData = processedData.filter(d => !existingCodes.has(d.code));
                            processedData.length = 0;
                            processedData.push(...newData);
                        }
                        
                        if (errors.length > 0) {
                            const errorMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? '\\n...' : ''}`;
                            if (!confirm(`${errorMsg}\\n\\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                            }
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                        }
                        
                        const finalData = replaceExisting ? processedData : [...existingDiseases, ...processedData];
                        await saveToFirebase('diseases', finalData);
                        
                        const message = replaceExisting 
                            ? `‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                            : `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        showNotification(message, 'success');
                        closeImportDiseaseModal();
                        loadDiseasesTable();
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        async function deleteDisease(index) {
            const diseases = await loadFromFirebase('diseases');
            const disease = diseases[index];
            
            if (!disease) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏£‡∏´‡∏±‡∏™: ${disease.code}\n‡∏ä‡∏∑‡πà‡∏≠: ${disease.name}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    diseases.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('diseases', diseases);
                    
                    // Refresh table
                    await loadDiseasesTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting disease:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Show responsible form modal
        function showResponsibleForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'responsibleModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeResponsibleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="responsibleForm" onsubmit="saveResponsibleData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Disease Selection -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                    </svg>
                                    ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                                </label>
                                <select id="responsibleDiseaseCode" class="w-full input-field" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>
                                </select>
                            </div>
                            
                            <!-- Responsible Person -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                                </label>
                                <input type="text" id="responsibleName" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"/>
                                    </svg>
                                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                                </label>
                                <input type="text" id="responsiblePosition" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç" required>
                            </div>
                            
                            <!-- Reviewer -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                                </label>
                                <input type="text" id="reviewerName" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"/>
                                    </svg>
                                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                                </label>
                                <input type="text" id="reviewerPosition" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤" required>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeResponsibleModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Load disease options
            loadDiseaseOptionsForResponsible();
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateResponsibleForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('responsibleDiseaseCode').focus();
            }, 100);
        }

        // Load disease options for responsible form
        async function loadDiseaseOptionsForResponsible() {
            const diseases = await loadFromFirebase('diseases');
            const select = document.getElementById('responsibleDiseaseCode');
            
            if (select) {
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>';
                
                diseases.forEach(disease => {
                    const option = document.createElement('option');
                    option.value = disease.code;
                    option.textContent = `${disease.code} - ${disease.name}`;
                    select.appendChild(option);
                });
            }
        }

        // Populate responsible form for editing
        async function populateResponsibleForm(index) {
            const responsible = await loadFromFirebase('responsible');
            const resp = responsible[index];
            
            if (resp) {
                document.getElementById('responsibleDiseaseCode').value = resp.diseaseCode;
                document.getElementById('responsibleName').value = resp.responsibleName;
                document.getElementById('responsiblePosition').value = resp.responsiblePosition;
                document.getElementById('reviewerName').value = resp.reviewerName;
                document.getElementById('reviewerPosition').value = resp.reviewerPosition;
            }
        }

        // Close responsible modal
        function closeResponsibleModal() {
            const modal = document.getElementById('responsibleModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show import responsible modal
        function showImportResponsibleModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importResponsibleModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </h3>
                        <button onclick="closeImportResponsibleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏≤‡∏ô‡∏∞ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÑ‡∏î‡πâ)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:</strong> ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏ï‡πá‡∏°</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="responsibleExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleResponsibleFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('responsibleExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadResponsibleExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="responsibleFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRowResponsible" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExistingResponsible" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processResponsibleImport()" class="flex-1 btn-primary" id="importResponsibleButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportResponsibleModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import responsible modal
        function closeImportResponsibleModal() {
            const modal = document.getElementById('importResponsibleModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle responsible file select
        function handleResponsibleFileSelect(input) {
            const fileInfo = document.getElementById('responsibleFileInfo');
            const importButton = document.getElementById('importResponsibleButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download responsible example file
        function downloadResponsibleExampleFile() {
            const data = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô'],
                ['A00', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏≤‡∏ô‡∏∞ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç'],
                ['B01', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏µ', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ', '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'],
                ['C02', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ò‡∏µ‡∏£‡∏∞ ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏£‡∏±‡∏ï‡∏ô‡∏≤ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö.xlsx');
        }

        // Process responsible import
        async function processResponsibleImport() {
            const fileInput = document.getElementById('responsibleExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowResponsible').checked;
            const replaceExisting = document.getElementById('replaceExistingResponsible').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importResponsibleButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        let startRow = skipFirstRow ? 1 : 0;
                        const processedData = [];
                        const errors = [];
                        const duplicateCodes = new Set();
                        
                        // Load existing diseases to validate disease codes
                        const diseases = await loadFromFirebase('diseases');
                        const validDiseaseCodes = new Set(diseases.map(d => d.code));
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const diseaseCode = row[0] ? row[0].toString().trim() : '';
                            const responsibleName = row[1] ? row[1].toString().trim() : '';
                            const responsiblePosition = row[2] ? row[2].toString().trim() : '';
                            const reviewerName = row[3] ? row[3].toString().trim() : '';
                            const reviewerPosition = row[4] ? row[4].toString().trim() : '';
                            
                            if (!diseaseCode || !responsibleName || !responsiblePosition || !reviewerName || !reviewerPosition) {
                                if (diseaseCode || responsibleName || responsiblePosition || reviewerName || reviewerPosition) {
                                    errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                                }
                                continue;
                            }
                            
                            if (!validDiseaseCodes.has(diseaseCode)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${diseaseCode} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                                continue;
                            }
                            
                            if (duplicateCodes.has(diseaseCode)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${diseaseCode} ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                                continue;
                            }
                            
                            duplicateCodes.add(diseaseCode);
                            processedData.push({
                                diseaseCode,
                                responsibleName,
                                responsiblePosition,
                                reviewerName,
                                reviewerPosition
                            });
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                        }
                        
                        let existingResponsible = await loadFromFirebase('responsible');
                        if (!replaceExisting) {
                            const existingCodes = new Set(existingResponsible.map(r => r.diseaseCode));
                            const duplicateExisting = processedData.filter(r => existingCodes.has(r.diseaseCode));
                            
                            if (duplicateExisting.length > 0) {
                                errors.push(`‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${duplicateExisting.map(r => r.diseaseCode).join(', ')}`);
                            }
                            
                            const newData = processedData.filter(r => !existingCodes.has(r.diseaseCode));
                            processedData.length = 0;
                            processedData.push(...newData);
                        }
                        
                        if (errors.length > 0) {
                            const errorMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? '\\n...' : ''}`;
                            if (!confirm(`${errorMsg}\\n\\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                            }
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                        }
                        
                        const finalData = replaceExisting ? processedData : [...existingResponsible, ...processedData];
                        await saveToFirebase('responsible', finalData);
                        
                        const message = replaceExisting 
                            ? `‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                            : `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        showNotification(message, 'success');
                        closeImportResponsibleModal();
                        loadResponsibleTable();
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Save responsible data
        async function saveResponsibleData(event, editIndex = null) {
            event.preventDefault();
            
            const diseaseCode = document.getElementById('responsibleDiseaseCode').value.trim();
            const responsibleName = document.getElementById('responsibleName').value.trim();
            const responsiblePosition = document.getElementById('responsiblePosition').value.trim();
            const reviewerName = document.getElementById('reviewerName').value.trim();
            const reviewerPosition = document.getElementById('reviewerPosition').value.trim();
            
            if (!diseaseCode || !responsibleName || !responsiblePosition || !reviewerName || !reviewerPosition) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const responsible = await loadFromFirebase('responsible');
                
                // Check for duplicate disease code (only if not editing the same record)
                const existingIndex = responsible.findIndex(r => r.diseaseCode === diseaseCode);
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newResponsible = {
                    diseaseCode,
                    responsibleName,
                    responsiblePosition,
                    reviewerName,
                    reviewerPosition
                };
                
                if (editIndex !== null) {
                    // Edit existing responsible
                    responsible[editIndex] = newResponsible;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new responsible
                    responsible.push(newResponsible);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('responsible', responsible);
                
                // Close modal
                closeResponsibleModal();
                
                // Refresh table
                await loadResponsibleTable();
                
            } catch (error) {
                console.error('Error saving responsible:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit responsible function
        function editResponsible(index) {
            showResponsibleForm(index);
        }

        // Delete responsible function
        async function deleteResponsible(index) {
            const responsible = await loadFromFirebase('responsible');
            const resp = responsible[index];
            
            if (!resp) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            // Get disease name for confirmation
            const diseases = await loadFromFirebase('diseases');
            const disease = diseases.find(d => d.code === resp.diseaseCode);
            const diseaseName = disease ? disease.name : resp.diseaseCode;
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÇ‡∏£‡∏Ñ: ${diseaseName}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${resp.responsibleName}\n‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô: ${resp.reviewerName}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    responsible.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('responsible', responsible);
                    
                    // Refresh table
                    await loadResponsibleTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting responsible:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };
            
            const icons = {
                success: `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>`,
                error: `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>`,
                info: `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>`,
                warning: `<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/>`
            };
            
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm`;
            notificationDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        ${icons[type]}
                    </svg>
                    <div class="font-medium">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notificationDiv);
            
            setTimeout(() => {
                notificationDiv.remove();
            }, 4000);
        }
        // Population management functions
        function showPopulationForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'populationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closePopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="populationForm" onsubmit="savePopulationData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Year Input -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                    </svg>
                                    ‡∏õ‡∏µ
                                </label>
                                <input type="number" id="populationYear" name="year" min="2500" max="2600" step="1"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡∏õ‡∏µ ‡∏û.‡∏®." required>
                            </div>
                            <!-- District Name -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                                </label>
                                <input type="text" id="populationDistrict" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å" required>
                            </div>
                            
                            <!-- Male Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                                </label>
                                <input type="number" id="populationMale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 25000" required min="0" oninput="calculateTotal()">
                            </div>
                            
                            <!-- Female Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                                </label>
                                <input type="number" id="populationFemale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 27000" required min="0" oninput="calculateTotal()">
                            </div>
                            
                            <!-- Total Population (Auto-calculated) -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°
                                </label>
                                <input type="number" id="populationTotal" class="w-full input-field bg-gray-50" readonly>
                            </div>
                        </div>
                        
                        <!-- Population Statistics Preview -->
                        <div id="populationPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:</span>
                                    <span id="malePercentage" class="font-bold text-blue-600 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span id="femalePercentage" class="font-bold text-pink-600 ml-2">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closePopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populatePopulationForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('populationDistrict').focus();
            }, 100);
        }

        // Calculate total population and show preview
        function calculateTotal() {
            const male = parseInt(document.getElementById('populationMale').value) || 0;
            const female = parseInt(document.getElementById('populationFemale').value) || 0;
            const total = male + female;
            
            document.getElementById('populationTotal').value = total;
            
            if (total > 0) {
                const malePercent = Math.round((male / total) * 100);
                const femalePercent = Math.round((female / total) * 100);
                
                document.getElementById('malePercentage').textContent = `${malePercent}%`;
                document.getElementById('femalePercentage').textContent = `${femalePercent}%`;
                document.getElementById('populationPreview').classList.remove('hidden');
            } else {
                document.getElementById('populationPreview').classList.add('hidden');
            }
        }

        // Populate form for editing
        async function populatePopulationForm(index) {
            const population = await loadFromFirebase('population');
            const pop = population[index];
            
            if (pop) {
                document.getElementById('populationDistrict').value = pop.district;
                document.getElementById('populationMale').value = pop.malePopulation;
                document.getElementById('populationFemale').value = pop.femalePopulation;
                calculateTotal();
            }
        }

        // Close population modal
        function closePopulationModal() {
            const modal = document.getElementById('populationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save population data
        async function savePopulationData(event, editIndex = null) {
            event.preventDefault();
            
            const year = parseInt(document.getElementById('populationYear').value);
            const district = document.getElementById('populationDistrict').value.trim();
            const male = parseInt(document.getElementById('populationMale').value) || 0;
            const female = parseInt(document.getElementById('populationFemale').value) || 0;
            const total = male + female;
            
            if (!year || !district || total <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            if (year < 2500 || year > 2600) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (2500-2600)', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const population = await loadFromFirebase('population');
                
                // Check for duplicate year and district combination (only if not editing the same record)
                const existingIndex = population.findIndex(p => 
                    p.district.toLowerCase() === district.toLowerCase() && 
                    p.year === year
                );
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification(`‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï ${district} ‡πÉ‡∏ô‡∏õ‡∏µ ${year} ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô`, 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newPopulation = {
                    year,
                    district,
                    malePopulation: male,
                    femalePopulation: female,
                    totalPopulation: total,
                    density: density
                };
                
                if (editIndex !== null) {
                    // Edit existing population
                    population[editIndex] = newPopulation;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new population
                    population.push(newPopulation);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('population', population);
                
                // Close modal
                closePopulationModal();
                
                // Refresh table
                await loadPopulationTable();
                
            } catch (error) {
                console.error('Error saving population:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit population function
        function editPopulation(index) {
            showPopulationForm(index);
        }

        // Delete population function
        // Show import population modal
        function showImportPopulationModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importPopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£
                        </h3>
                        <button onclick="closeImportPopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2024)</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡πÄ‡∏Ç‡∏ï</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300">2025</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300">31500</td>
                                            <td class="px-3 py-2 border border-gray-300">15000</td>
                                            <td class="px-3 py-2 border border-gray-300">16500</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á/‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="populationExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handlePopulationFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('populationExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadPopulationExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="populationFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRowPopulation" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExistingPopulation" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processPopulationImport()" class="flex-1 btn-primary" id="importPopulationButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportPopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import population modal
        function closeImportPopulationModal() {
            const modal = document.getElementById('importPopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle population file select
        function handlePopulationFileSelect(input) {
            const fileInfo = document.getElementById('populationFileInfo');
            const importButton = document.getElementById('importPopulationButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download population example file
        function downloadPopulationExampleFile() {
            const data = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [2025, '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', 31500, 15000, 16500],
                [2025, '‡∏î‡∏∏‡∏™‡∏¥‡∏ï', 25000, 12000, 13000],
                [2025, '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', 37500, 18000, 19500],
                [2025, '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', 18800, 9000, 9800],
                [2025, '‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô', 43500, 21000, 22500]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].toString().length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£.xlsx');
        }

        // Process population import
        async function processPopulationImport() {
            const fileInput = document.getElementById('populationExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowPopulation').checked;
            const replaceExisting = document.getElementById('replaceExistingPopulation').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importPopulationButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        let startRow = skipFirstRow ? 1 : 0;
                        const processedData = [];
                        const errors = [];
                        const duplicateKeys = new Set();
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const year = row[0] ? Number(row[0]) : NaN;
                            const district = row[1] ? row[1].toString().trim() : '';
                            const malePopulation = row[3] ? Number(row[3]) : NaN;
                            const femalePopulation = row[4] ? Number(row[4]) : NaN;
                            const totalPopulation = row[2] ? Number(row[2]) : (malePopulation + femalePopulation);
                            
                            if (!district || isNaN(year) || isNaN(malePopulation) || isNaN(femalePopulation)) {
                                if (district || row[1] || row[2]) {
                                    errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                                }
                                continue;
                            }
                            
                            if (year < 1900 || year > 2100) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1900-2100 (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‡∏û.‡∏®.)`);
                                continue;
                            }
                            
                            if (malePopulation < 0 || femalePopulation < 0) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 0`);
                                continue;
                            }
                            
                            const key = `${year}_${district}`;
                            if (duplicateKeys.has(key)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï ${district} ‡∏õ‡∏µ ${year} ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                                continue;
                            }
                            
                            duplicateKeys.add(key);
                            processedData.push({
                                year,
                                district,
                                malePopulation,
                                femalePopulation,
                                totalPopulation
                            });
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                        }
                        
                        let existingPopulation = await loadFromFirebase('population');
                        if (!replaceExisting) {
                            const existingKeys = new Set(existingPopulation.map(p => `${p.year}_${p.district}`));
                            const duplicateExisting = processedData.filter(p => existingKeys.has(`${p.year}_${p.district}`));
                            
                            if (duplicateExisting.length > 0) {
                                errors.push(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${duplicateExisting.map(p => `${p.district} (‡∏õ‡∏µ ${p.year})`).join(', ')}`);
                            }
                            
                            const newData = processedData.filter(p => !existingKeys.has(`${p.year}_${p.district}`));
                            processedData.length = 0;
                            processedData.push(...newData);
                        }
                        
                        if (errors.length > 0) {
                            const errorMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? '\\n...' : ''}`;
                            if (!confirm(`${errorMsg}\\n\\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                            }
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                        }
                        
                        const finalData = replaceExisting ? processedData : [...existingPopulation, ...processedData];
                        await saveToFirebase('population', finalData);
                        
                        const message = replaceExisting 
                            ? `‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                            : `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        showNotification(message, 'success');
                        closeImportPopulationModal();
                        loadPopulationTable();
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        async function deletePopulation(index) {
            const population = await loadFromFirebase('population');
            const pop = population[index];
            
            if (!pop) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const totalPop = pop.totalPopulation || (pop.malePopulation + pop.femalePopulation);
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÄ‡∏Ç‡∏ï: ${pop.district}\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°: ${totalPop.toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢: ${pop.malePopulation.toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á: ${pop.femalePopulation.toLocaleString()} ‡∏Ñ‡∏ô\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    population.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('population', population);
                    
                    // Refresh table
                    await loadPopulationTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting population:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Age Population management functions
        function showAgePopulationForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'agePopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeAgePopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="agePopulationForm" onsubmit="saveAgePopulationData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Year Input -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                    </svg>
                                    ‡∏õ‡∏µ
                                </label>
                                <input type="number" id="agePopulationYear" name="year" min="1900" max="2100" step="1"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡∏õ‡∏µ ‡∏Ñ.‡∏®." value="2025" required>
                            </div>
                            <!-- Age Range -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                                </label>
                                <input type="number" id="agePopulationStartAge" name="startAge" min="0" max="999" step="1"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 0, 5, 10" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                                </label>
                                <input type="number" id="agePopulationEndAge" name="endAge" min="0" max="999" step="1"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 4, 9, 14 (‡πÉ‡∏ä‡πâ 999 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 80+)" required>
                                <p class="text-xs text-gray-500 mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ä‡πâ 999 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ 80+ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</p>
                            </div>
                            
                            <!-- Age Group Display (Auto-generated) -->
                            <!-- Male Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                                </label>
                                <input type="number" id="agePopulationMale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 125000" required min="0" oninput="calculateAgeTotal()">
                            </div>
                            
                            <!-- Female Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                                </label>
                                <input type="number" id="agePopulationFemale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 135000" required min="0" oninput="calculateAgeTotal()">
                            </div>
                            
                            <!-- Total Population (Auto-calculated) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°
                                </label>
                                <input type="number" id="agePopulationTotal" class="w-full input-field bg-gray-50" readonly>
                            </div>
                            
                            <!-- Percentage -->
                        </div>
                        
                        <!-- Age Population Statistics Preview -->
                        <div id="agePopulationPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:</span>
                                    <span id="ageMalePercentage" class="font-bold text-blue-600 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span id="ageFemalePercentage" class="font-bold text-pink-600 ml-2">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeAgePopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateAgePopulationForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('agePopulationStartAge').focus();
            }, 100);
        }

        // Calculate total age population and show preview
        function calculateAgeTotal() {
            const male = parseInt(document.getElementById('agePopulationMale').value) || 0;
            const female = parseInt(document.getElementById('agePopulationFemale').value) || 0;
            const total = male + female;
            
            document.getElementById('agePopulationTotal').value = total;
            
            if (total > 0) {
                const malePercent = Math.round((male / total) * 100);
                const femalePercent = Math.round((female / total) * 100);
                
                document.getElementById('ageMalePercentage').textContent = `${malePercent}%`;
                document.getElementById('ageFemalePercentage').textContent = `${femalePercent}%`;
                document.getElementById('agePopulationPreview').classList.remove('hidden');
            } else {
                document.getElementById('agePopulationPreview').classList.add('hidden');
            }
        }

        // Populate form for editing
        async function populateAgePopulationForm(index) {
            const agePopulation = await loadFromFirebase('agePopulation');
            const age = agePopulation[index];
            
            if (age) {
                document.getElementById('agePopulationYear').value = age.year || new Date().getFullYear();
                document.getElementById('agePopulationStartAge').value = age.startAge || age.startAge === 0 ? age.startAge : '';
                document.getElementById('agePopulationEndAge').value = age.endAge || age.endAge === 0 ? age.endAge : '';
                document.getElementById('agePopulationMale').value = age.male;
                document.getElementById('agePopulationFemale').value = age.female;
                
                calculateAgeTotal();
            }
        }

        // Close age population modal
        function closeAgePopulationModal() {
            const modal = document.getElementById('agePopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show import age population modal
        function showImportAgePopulationModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importAgePopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                        </h3>
                        <button onclick="closeImportAgePopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">F</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300">2025</td>
                                            <td class="px-3 py-2 border border-gray-300">0</td>
                                            <td class="px-3 py-2 border border-gray-300">4</td>
                                            <td class="px-3 py-2 border border-gray-300">25000</td>
                                            <td class="px-3 py-2 border border-gray-300">12800</td>
                                            <td class="px-3 py-2 border border-gray-300">12200</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300">2025</td>
                                            <td class="px-3 py-2 border border-gray-300">5</td>
                                            <td class="px-3 py-2 border border-gray-300">9</td>
                                            <td class="px-3 py-2 border border-gray-300">28000</td>
                                            <td class="px-3 py-2 border border-gray-300">14300</td>
                                            <td class="px-3 py-2 border border-gray-300">13700</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 0, 5, 10)</p>
                                <p>‚Ä¢ <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong> ‡∏≠‡∏≤‡∏¢‡∏∏ 0-4 ‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô=0, ‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î=4</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="agePopulationExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleAgePopulationFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('agePopulationExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadAgePopulationExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="agePopulationFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRowAge" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExistingAge" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processAgePopulationImport()" class="flex-1 btn-primary" id="importAgePopulationButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportAgePopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import age population modal
        function closeImportAgePopulationModal() {
            const modal = document.getElementById('importAgePopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle age population file select
        function handleAgePopulationFileSelect(input) {
            const fileInfo = document.getElementById('agePopulationFileInfo');
            const importButton = document.getElementById('importAgePopulationButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                    fileInfo.innerHTML = '';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-gray-700">${fileName}</span>
                        <span class="text-gray-500">(${fileSize} KB)</span>
                    </div>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download age population example file
        function downloadAgePopulationExampleFile() {
            const currentYear = new Date().getFullYear();
            const data = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [currentYear, 0, 4, 25000, 12800, 12200],
                [currentYear, 5, 9, 28000, 14300, 13700],
                [currentYear, 10, 14, 30000, 15400, 14600],
                [currentYear, 15, 19, 32000, 16100, 15900],
                [currentYear, 20, 24, 35000, 17200, 17800],
                [currentYear, 25, 29, 38000, 18800, 19200],
                [currentYear, 30, 34, 40000, 19500, 20500],
                [currentYear, 35, 39, 42000, 20800, 21200],
                [currentYear, 40, 44, 45000, 22000, 23000],
                [currentYear, 45, 49, 47000, 23200, 23800],
                [currentYear, 50, 54, 44000, 21800, 22200],
                [currentYear, 55, 59, 41000, 20300, 20700],
                [currentYear, 60, 64, 38000, 18500, 19500],
                [currentYear, 65, 69, 35000, 16800, 18200],
                [currentYear, 70, 74, 28000, 13200, 14800],
                [currentYear, 75, 79, 22000, 10000, 12000],
                [currentYear, 80, 999, 18000, 7500, 10500]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].toString().length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏.xlsx');
        }

        // Process age population import
        async function processAgePopulationImport() {
            const fileInput = document.getElementById('agePopulationExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowAge').checked;
            const replaceExisting = document.getElementById('replaceExistingAge').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importAgePopulationButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length < 2) {
                        showNotification('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    // Start processing from row 1 if skipFirstRow is true
                    const startRow = skipFirstRow ? 1 : 0;
                    let newData = [];
                    let errors = [];
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 6) continue; // Skip incomplete rows - now checking for 6 columns
                        
                        const year = parseInt(row[0]);
                        const startAge = parseInt(row[1]);
                        const endAge = parseInt(row[2]);
                        const total = parseInt(row[3]);
                        const male = parseInt(row[4]);
                        const female = parseInt(row[5]);
                        
                        if (!year || isNaN(startAge) || isNaN(endAge) || isNaN(total) || isNaN(male) || isNaN(female)) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            continue;
                        }
                        
                        if (year < 1900 || year > 2100) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1900-2100 (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‡∏û.‡∏®.)`);
                            continue;
                        }
                        
                        if (startAge < 0 || endAge < 0 || startAge > endAge) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö`);
                            continue;
                        }
                        
                        // Generate age group display name
                        const ageGroup = endAge >= 999 ? `${startAge}+ ‡∏õ‡∏µ` : `${startAge}-${endAge} ‡∏õ‡∏µ`;
                        
                        newData.push({
                            year: year.toString(),
                            startAge,
                            endAge,
                            ageGroup, // Keep for backward compatibility
                            total,
                            male,
                            female
                        });
                    }
                    
                    if (errors.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`, 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    try {
                        let existingData = replaceExisting ? [] : await loadFromFirebase('agePopulation');
                        
                        // Update existing data with new data
                        for (const newItem of newData) {
                            const existingIndex = existingData.findIndex(item => 
                                item.year === newItem.year && 
                                parseInt(item.startAge || 0) === newItem.startAge && 
                                parseInt(item.endAge || 0) === newItem.endAge
                            );
                            
                            if (existingIndex !== -1) {
                                existingData[existingIndex] = newItem;
                            } else {
                                existingData.push(newItem);
                            }
                        }
                        
                        await saveToFirebase('agePopulation', existingData);
                        await loadAgePopulationTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportAgePopulationModal();
                        
                    } catch (error) {
                        console.error('Error saving data:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                    
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Save age population data
        async function saveAgePopulationData(event, editIndex = null) {
            event.preventDefault();
            
            const year = parseInt(document.getElementById('agePopulationYear').value);
            const startAge = parseInt(document.getElementById('agePopulationStartAge').value);
            const endAge = parseInt(document.getElementById('agePopulationEndAge').value);
            const male = parseInt(document.getElementById('agePopulationMale').value) || 0;
            const female = parseInt(document.getElementById('agePopulationFemale').value) || 0;
            const total = male + female;
            
            if (!year || isNaN(startAge) || isNaN(endAge) || total <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            if (startAge < 0 || endAge < 0 || startAge > endAge) {
                showNotification('‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö', 'error');
                return;
            }
            
            const currentYear = new Date().getFullYear();
            if (year < 1900 || year > currentYear + 10) {
                showNotification(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (1900-${currentYear + 10})`, 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const agePopulation = await loadFromFirebase('agePopulation');
                
                // Check for duplicate age range (only if not editing the same record)
                const existingRecord = agePopulation.findIndex(a => 
                    a.year === year.toString() && 
                    parseInt(a.startAge) === startAge && 
                    parseInt(a.endAge) === endAge
                );
                if (existingRecord !== -1 && existingRecord !== editIndex) {
                    showNotification('‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newAgePopulation = {
                    year: year.toString(),
                    startAge: parseInt(startAge),
                    endAge: parseInt(endAge),
                    male: male.toString(),
                    female: female.toString(),
                    total: total.toString()
                };
                
                if (editIndex !== null) {
                    // Edit existing age population
                    agePopulation[editIndex] = newAgePopulation;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new age population
                    agePopulation.push(newAgePopulation);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('agePopulation', agePopulation);
                
                // Close modal
                closeAgePopulationModal();
                
                // Refresh table
                await loadAgePopulationTable();
                
            } catch (error) {
                console.error('Error saving age population:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit age population function
        function editAgePopulation(index) {
            showAgePopulationForm(index);
        }

        // Delete age population function
        async function deleteAgePopulation(index) {
            const agePopulation = await loadFromFirebase('agePopulation');
            const age = agePopulation[index];
            
            if (!age) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏õ‡∏µ: ${age.year || 2025}\n‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏: ${age.ageGroup}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£: ${parseInt(age.total).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏ä‡∏≤‡∏¢: ${parseInt(age.male).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏´‡∏ç‡∏¥‡∏á: ${parseInt(age.female).toLocaleString()} ‡∏Ñ‡∏ô\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    agePopulation.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('agePopulation', agePopulation);
                    
                    // Save empty array if it's the last item
                    if (agePopulation.length === 0) {
                        await saveToFirebase('agePopulation', []);
                    }
                    
                    // Refresh the table to show updated data
                    await loadAgePopulationTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting age population:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Thailand Population management functions
        function showThailandPopulationForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'thailandPopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeThailandPopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="thailandPopulationForm" onsubmit="saveThailandPopulationData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Year -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                    </svg>
                                    ‡∏õ‡∏µ (‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä)
                                </label>
                                <input type="number" id="thailandYear" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2025" min="1900" max="2100" required>
                            </div>
                            <!-- Province Name -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                </label>
                                <input type="text" id="thailandProvince" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" required>
                            </div>
                            
                            <!-- Male Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                                </label>
                                <input type="number" id="thailandMale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2500000" required min="0" oninput="calculateThailandTotal()">
                            </div>
                            
                            <!-- Female Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                                </label>
                                <input type="number" id="thailandFemale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2700000" required min="0" oninput="calculateThailandTotal()">
                            </div>
                            
                            <!-- Total Population (Auto-calculated) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°
                                </label>
                                <input type="number" id="thailandTotal" class="w-full input-field bg-gray-50" readonly>
                            </div>
                        </div>
                        
                        <!-- Thailand Population Statistics Preview -->
                        <div id="thailandPopulationPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:</span>
                                    <span id="thailandMalePercentage" class="font-bold text-blue-600 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span id="thailandFemalePercentage" class="font-bold text-pink-600 ml-2">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeThailandPopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateThailandPopulationForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('thailandProvince').focus();
            }, 100);
        }

        // Calculate total Thailand population and show preview
        function calculateThailandTotal() {
            const male = parseInt(document.getElementById('thailandMale').value) || 0;
            const female = parseInt(document.getElementById('thailandFemale').value) || 0;
            const total = male + female;
            
            document.getElementById('thailandTotal').value = total;
            
            if (total > 0) {
                const malePercent = Math.round((male / total) * 100);
                const femalePercent = Math.round((female / total) * 100);
                
                document.getElementById('thailandMalePercentage').textContent = `${malePercent}%`;
                document.getElementById('thailandFemalePercentage').textContent = `${femalePercent}%`;
                document.getElementById('thailandPopulationPreview').classList.remove('hidden');
            } else {
                document.getElementById('thailandPopulationPreview').classList.add('hidden');
            }
        }

        // Populate form for editing
        async function populateThailandPopulationForm(index) {
            const thailandPopulation = await loadFromFirebase('thailandPopulation');
            const province = thailandPopulation[index];
            
            if (province) {
                document.getElementById('thailandYear').value = province.year;
                document.getElementById('thailandProvince').value = province.province;
                document.getElementById('thailandMale').value = province.male;
                document.getElementById('thailandFemale').value = province.female;
                calculateThailandTotal();
            }
        }

        // Close Thailand population modal
        function closeThailandPopulationModal() {
            const modal = document.getElementById('thailandPopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save Thailand population data
        async function saveThailandPopulationData(event, editIndex = null) {
            event.preventDefault();
            
            const year = parseInt(document.getElementById('thailandYear').value);
            const province = document.getElementById('thailandProvince').value.trim();
            const male = parseInt(document.getElementById('thailandMale').value) || 0;
            const female = parseInt(document.getElementById('thailandFemale').value) || 0;
            const total = male + female;
            
            if (!year || year < 1900 || year > 2100) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            if (!province || total <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const thailandPopulation = await loadFromFirebase('thailandPopulation');
                
                // Check for duplicate province (only if not editing the same record)
                const existingIndex = thailandPopulation.findIndex(p => p.province.toLowerCase() === province.toLowerCase());
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newThailandPopulation = {
                    year,
                    province,
                    male: male.toString(),
                    female: female.toString(),
                    total: total.toString()
                };
                
                if (editIndex !== null) {
                    // Edit existing Thailand population
                    thailandPopulation[editIndex] = newThailandPopulation;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new Thailand population
                    thailandPopulation.push(newThailandPopulation);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('thailandPopulation', thailandPopulation);
                
                // Close modal
                closeThailandPopulationModal();
                
                // Refresh table
                await loadThailandPopulationTable();
                
            } catch (error) {
                console.error('Error saving Thailand population:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit Thailand population function
        function editThailandPopulation(index) {
            showThailandPopulationForm(index);
        }

        // Delete Thailand population function
        async function deleteThailandPopulation(index) {
            const thailandPopulation = await loadFromFirebase('thailandPopulation');
            const province = thailandPopulation[index];
            
            if (!province) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${province.province}\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢: ${parseInt(province.male).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á: ${parseInt(province.female).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°: ${parseInt(province.total).toLocaleString()} ‡∏Ñ‡∏ô\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    thailandPopulation.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('thailandPopulation', thailandPopulation);
                    
                    // Refresh table
                    await loadThailandPopulationTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting Thailand population:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Bangkok District management functions
        function showBangkokDistrictForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'bangkokDistrictModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeBangkokDistrictModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="bangkokDistrictForm" onsubmit="saveBangkokDistrictData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Subdistrict Name -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á
                                </label>
                                <input type="text" id="bangkokSubdistrict" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡∏•‡∏°" required>
                            </div>
                            
                            <!-- District Input -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                    </svg>
                                    ‡πÄ‡∏Ç‡∏ï
                                </label>
                                <input type="text" id="bangkokDistrict" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å" required oninput="updateDistrictPreview()">
                            </div>
                            
                            <!-- Province (Auto-filled) -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                    </svg>
                                    ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                </label>
                                <input type="text" id="bangkokProvince" class="w-full input-field bg-gray-50" value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" readonly>
                            </div>
                        </div>
                        
                        <!-- Data Preview -->
                        <div id="bangkokDistrictPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="bg-white rounded-lg p-3">
                                    <span class="text-gray-600 block mb-1">‡πÅ‡∏Ç‡∏ß‡∏á:</span>
                                    <span id="previewSubdistrict" class="font-bold text-gray-900">-</span>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <span class="text-gray-600 block mb-1">‡πÄ‡∏Ç‡∏ï:</span>
                                    <span id="previewDistrict" class="font-bold text-blue-600">-</span>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <span class="text-gray-600 block mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
                                    <span id="previewProvince" class="font-bold text-green-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeBangkokDistrictModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateBangkokDistrictForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('bangkokSubdistrict').focus();
            }, 100);
        }

        // Update district preview
        function updateDistrictPreview() {
            const subdistrict = document.getElementById('bangkokSubdistrict').value.trim();
            const district = document.getElementById('bangkokDistrict').value;
            
            if (subdistrict || district) {
                document.getElementById('previewSubdistrict').textContent = subdistrict || '-';
                document.getElementById('previewDistrict').textContent = district || '-';
                document.getElementById('bangkokDistrictPreview').classList.remove('hidden');
            } else {
                document.getElementById('bangkokDistrictPreview').classList.add('hidden');
            }
        }

        // Add event listener for subdistrict input
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'bangkokSubdistrict') {
                updateDistrictPreview();
            }
            // Event listeners for epidemic week form
            if (e.target && (e.target.id === 'epidemicYear' || e.target.id === 'epidemicWeekNumber')) {
                updatePreview();
            }
        });

        // Add event listener for date changes
        document.addEventListener('change', function(e) {
            if (e.target && (e.target.id === 'epidemicStartDate' || e.target.id === 'epidemicEndDate')) {
                updatePreview();
            }
        });

        // Populate form for editing
        async function populateBangkokDistrictForm(index) {
            const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
            const district = bangkokDistricts[index];
            
            if (district) {
                document.getElementById('bangkokSubdistrict').value = district.subdistrict;
                document.getElementById('bangkokDistrict').value = district.district;
                document.getElementById('bangkokProvince').value = district.province;
                updateDistrictPreview();
            }
        }

        // Close Bangkok district modal
        function closeBangkokDistrictModal() {
            const modal = document.getElementById('bangkokDistrictModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save Bangkok district data
        async function saveBangkokDistrictData(event, editIndex = null) {
            event.preventDefault();
            
            const subdistrict = document.getElementById('bangkokSubdistrict').value.trim();
            const district = document.getElementById('bangkokDistrict').value.trim();
            const province = document.getElementById('bangkokProvince').value.trim();
            
            if (!subdistrict || !district || !province) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
                
                // Check for duplicate subdistrict in the same district (only if not editing the same record)
                const existingIndex = bangkokDistricts.findIndex(d => 
                    d.subdistrict.toLowerCase() === subdistrict.toLowerCase() && 
                    d.district.toLowerCase() === district.toLowerCase()
                );
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡πÅ‡∏Ç‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newBangkokDistrict = {
                    subdistrict,
                    district,
                    province
                };
                
                if (editIndex !== null) {
                    // Edit existing Bangkok district
                    bangkokDistricts[editIndex] = newBangkokDistrict;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new Bangkok district
                    bangkokDistricts.push(newBangkokDistrict);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('bangkokDistricts', bangkokDistricts);
                
                // Close modal
                closeBangkokDistrictModal();
                
                // Refresh table
                await loadBangkokDistrictsTable();
                
            } catch (error) {
                console.error('Error saving Bangkok district:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit Bangkok district function
        function editBangkokDistrict(index) {
            showBangkokDistrictForm(index);
        }

        // Delete Bangkok district function
        async function deleteBangkokDistrict(index) {
            const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
            const district = bangkokDistricts[index];
            
            if (!district) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÅ‡∏Ç‡∏ß‡∏á: ${district.subdistrict}\n‡πÄ‡∏Ç‡∏ï: ${district.district}\n‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${district.province}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    bangkokDistricts.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('bangkokDistricts', bangkokDistricts);
                    
                    // Refresh table
                    await loadBangkokDistrictsTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting Bangkok district:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Epidemic Week management functions
        function showEpidemicWeekForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'epidemicWeekModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            üìÖ ${title}
                        </h3>
                        <button onclick="closeEpidemicWeekModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="epidemicWeekForm" onsubmit="saveEpidemicWeekData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="epidemicYear" class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</label>
                                <input type="number" id="epidemicYear" min="2020" max="2030" value="${new Date().getFullYear()}"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 2024" onchange="calculateWeekDates()" required>
                            </div>
                            
                            <div>
                                <label for="epidemicWeekNumber" class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</label>
                                <input type="number" id="epidemicWeekNumber" min="1" max="53"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 1" onchange="calculateWeekDates()" required>
                            </div>
                            
                            <div>
                                <label for="epidemicStartDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                <input type="date" id="epidemicStartDate"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    onchange="updateEndDate()" required>
                            </div>
                            
                            <div>
                                <label for="epidemicEndDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                <input type="date" id="epidemicEndDate"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    required>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="epidemicNote" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                <textarea id="epidemicNote" rows="3"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ô‡∏µ‡πâ..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Week Preview -->
                        <div id="epidemicWeekPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <div class="text-gray-600">‡∏õ‡∏µ/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                                    <div class="text-lg font-bold text-blue-600" id="previewYearWeek">-</div>
                                </div>
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <div class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
                                    <div class="text-lg font-bold text-green-600" id="previewStartDate">-</div>
                                </div>
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <div class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</div>
                                    <div class="text-lg font-bold text-purple-600" id="previewEndDate">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeEpidemicWeekModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateEpidemicWeekForm(editIndex);
            }
            
            // Calculate initial week dates
            calculateWeekDates();
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('epidemicWeekNumber').focus();
            }, 100);
        }

        // Calculate week dates based on year and week number
        function calculateWeekDates() {
            const year = parseInt(document.getElementById('epidemicYear').value);
            const weekNumber = parseInt(document.getElementById('epidemicWeekNumber').value);
            
            if (!year || !weekNumber) return;
            
            // Calculate the start date of the epidemic week
            const startDate = getDateOfWeek(year, weekNumber);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            
            // Format dates for input fields
            document.getElementById('epidemicStartDate').value = formatDateForInput(startDate);
            document.getElementById('epidemicEndDate').value = formatDateForInput(endDate);
            
            updatePreview();
        }

        // Update end date when start date changes
        function updateEndDate() {
            const startDate = new Date(document.getElementById('epidemicStartDate').value);
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                document.getElementById('epidemicEndDate').value = formatDateForInput(endDate);
                updatePreview();
            }
        }

        // Update preview information
        function updatePreview() {
            const year = document.getElementById('epidemicYear').value;
            const weekNumber = document.getElementById('epidemicWeekNumber').value;
            const startDate = document.getElementById('epidemicStartDate').value;
            const endDate = document.getElementById('epidemicEndDate').value;
            
            if (year && weekNumber && startDate && endDate) {
                document.getElementById('previewYearWeek').textContent = `${year}/${weekNumber}`;
                document.getElementById('previewStartDate').textContent = formatDateThai(startDate);
                document.getElementById('previewEndDate').textContent = formatDateThai(endDate);
                document.getElementById('epidemicWeekPreview').classList.remove('hidden');
            } else {
                document.getElementById('epidemicWeekPreview').classList.add('hidden');
            }
        }

        // Helper function to get the start date of a week
        function getDateOfWeek(year, week) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        // Helper function to format date for input
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // Helper function to format date in Thai
        function formatDateThai(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth();
            const year = date.getFullYear() + 543;
            const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                               '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            return `${day} ${monthNames[month]} ${year}`;
        }

        // Populate form for editing
        async function populateEpidemicWeekForm(index) {
            const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
            const week = epidemicWeeks[index];
            
            if (week) {
                document.getElementById('epidemicYear').value = week.year;
                document.getElementById('epidemicWeekNumber').value = week.weekNumber;
                document.getElementById('epidemicStartDate').value = week.startDate;
                document.getElementById('epidemicEndDate').value = week.endDate;
                document.getElementById('epidemicNote').value = week.note || '';
                updatePreview();
            }
        }

        // Close epidemic week modal
        function closeEpidemicWeekModal() {
            const modal = document.getElementById('epidemicWeekModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save epidemic week data
        async function saveEpidemicWeekData(event, editIndex = null) {
            event.preventDefault();
            
            const year = document.getElementById('epidemicYear').value;
            const weekNumber = parseInt(document.getElementById('epidemicWeekNumber').value);
            const startDate = document.getElementById('epidemicStartDate').value;
            const endDate = document.getElementById('epidemicEndDate').value;
            const note = document.getElementById('epidemicNote').value.trim();
            
            if (!year || !weekNumber || !startDate || !endDate) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Validate week number
            if (weekNumber < 1 || weekNumber > 53) {
                showNotification('‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-53', 'error');
                return;
            }
            
            // Validate dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end <= start) {
                showNotification('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
                
                // Check for duplicate year/week combination (only if not editing the same record)
                const existingIndex = epidemicWeeks.findIndex(w => 
                    parseInt(w.year) === parseInt(year) && 
                    parseInt(w.weekNumber) === weekNumber
                );
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${weekNumber} ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ${year} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô`, 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newEpidemicWeek = {
                    year: year.toString(),
                    weekNumber: weekNumber.toString(),
                    startDate,
                    endDate,
                    note: note || ''
                };
                
                if (editIndex !== null) {
                    // Edit existing epidemic week
                    epidemicWeeks[editIndex] = newEpidemicWeek;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new epidemic week
                    epidemicWeeks.push(newEpidemicWeek);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('epidemicWeeks', epidemicWeeks);
                
                // Close modal
                closeEpidemicWeekModal();
                
                // Refresh table
                await loadEpidemicWeeksTable();
                
            } catch (error) {
                console.error('Error saving epidemic week:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit epidemic week function
        function editEpidemicWeek(index) {
            showEpidemicWeekForm(index);
        }

        // Delete epidemic week function
        async function deleteEpidemicWeek(index) {
            const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
            const week = epidemicWeeks[index];
            
            if (!week) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏õ‡∏µ: ${week.year}\n‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà: ${week.weekNumber}\n‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateThai(week.startDate)} - ${formatDateThai(week.endDate)}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    epidemicWeeks.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('epidemicWeeks', epidemicWeeks);
                    
                    // Refresh table
                    await loadEpidemicWeeksTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting epidemic week:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Excel Import Functions
        function showImportExcelModal(dataType) {
            const isResponsible = dataType === 'responsible';
            const isPopulation = dataType === 'population';
            const isAgePopulation = dataType === 'agePopulation';
            const isThailandPopulation = dataType === 'thailandPopulation';
            const isBangkokDistricts = dataType === 'bangkokDistricts';
            
            let title, icon;
            if (isResponsible) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üë•';
            } else if (isPopulation) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üèôÔ∏è';
            } else if (isAgePopulation) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üë∂üëµ';
            } else if (isBangkokDistricts) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üèõÔ∏è';
            } else if (dataType === 'epidemicWeeks') {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üìÖ';
            } else if (isThailandPopulation) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üáπüá≠';
            } else {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üìä';
            }
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importExcelModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${icon} ${title}
                        </h3>
                        <button onclick="closeImportExcelModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Import Instructions -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                            ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                        </h4>
                        <div class="text-sm text-blue-700 space-y-2">
                            ${isResponsible ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô A00, B01, C02)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏π‡πâ‡∏î‡∏µ)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E:</strong> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô)</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô)</p>
                            ` : isPopulation ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å, ‡∏ß‡∏±‡∏í‡∏ô‡∏≤, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 25000, 30000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 27000, 32000)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            ` : isAgePopulation ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å, ‡∏ß‡∏±‡∏í‡∏ô‡∏≤, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> 0-14 ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 12000, 15000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> 15-59 ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 35000, 42000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D:</strong> 60+ ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 8000, 10000)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            ` : isThailandPopulation ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£, ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 2500000, 850000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 2700000, 920000)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            ` : `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô A00, B01, C02)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ, ‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà)</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                            `}
                            <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å:</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                        </div>
                        
                        ${isPopulation ? `
                        <!-- Example Table for Population Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg">
                            <h5 class="font-bold text-orange-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">25000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">27000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ß‡∏±‡∏í‡∏ô‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">42000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">45000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">38000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">41000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏≤‡∏ó‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">35000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">37000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">52000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">55000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">48000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">51000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-orange-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï:</strong> ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏¢ + ‡∏´‡∏ç‡∏¥‡∏á</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadPopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isAgePopulation ? `
                        <!-- Example Table for Age Population Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-lg">
                            <h5 class="font-bold text-teal-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">0-14 ‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">15-59 ‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">60+ ‡∏õ‡∏µ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">8,500</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">35,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">8,500</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ß‡∏±‡∏í‡∏ô‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">14,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">58,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">15,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">12,500</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">52,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">14,500</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏≤‡∏ó‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">11,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">47,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">14,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">18,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">71,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">18,000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-teal-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏:</strong> 0-14 ‡∏õ‡∏µ (‡πÄ‡∏î‡πá‡∏Å), 15-59 ‡∏õ‡∏µ (‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô), 60+ ‡∏õ‡∏µ (‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏)</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadAgePopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${dataType === 'epidemicWeeks' ? `
                        <!-- Example Table for Epidemic Weeks Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg">
                            <h5 class="font-bold text-emerald-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 text-emerald-600">2566</td>
                                            <td class="px-3 py-2 border border-gray-300 text-blue-600">1</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-01</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-07</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 text-emerald-600">2566</td>
                                            <td class="px-3 py-2 border border-gray-300 text-blue-600">2</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-08</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-14</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600"></td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 text-emerald-600">2566</td>
                                            <td class="px-3 py-2 border border-gray-300 text-blue-600">3</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-15</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-21</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-emerald-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏µ:</strong> ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 2023</p>
                                <p>‚Ä¢ <strong>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</strong> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏ô‡∏õ‡∏µ (1-53)</p>
                                <p>‚Ä¢ <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD ‡πÄ‡∏ä‡πà‡∏ô 2023-01-01</p>
                                <p>‚Ä¢ <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadEpidemicWeeksExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isBangkokDistricts ? `
                        <!-- Example Table for Bangkok Districts Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg">
                            <h5 class="font-bold text-indigo-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡πÅ‡∏Ç‡∏ß‡∏á</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡πÄ‡∏Ç‡∏ï</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏µ‡∏•‡∏°</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏ß‡∏á‡∏®‡πå</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ó‡∏∏‡πà‡∏á‡∏û‡∏ç‡∏≤‡πÑ‡∏ó</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ñ‡∏ô‡∏ô‡∏û‡∏ç‡∏≤‡πÑ‡∏ó</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-indigo-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡πÅ‡∏Ç‡∏ß‡∏á:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</p>
                                <p>‚Ä¢ <strong>‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà</p>
                                <p>‚Ä¢ <strong>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏™‡πà "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadBangkokDistrictsExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isThailandPopulation ? `
                        <!-- Example Table for Thailand Population Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                            <h5 class="font-bold text-blue-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">2,850,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">3,150,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">850,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">920,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">1,300,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">1,380,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">890,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">940,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">720,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">760,000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-blue-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á 77 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏¢ + ‡∏´‡∏ç‡∏¥‡∏á</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadThailandPopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isResponsible ? `
                        <!-- Example Table for Responsible Person Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                            <h5 class="font-bold text-purple-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏π‡πâ‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">B01</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏û‡∏£ ‡∏î‡∏µ‡πÉ‡∏à</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">C02</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏¢‡πâ‡∏°</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÑ‡∏î‡πâ)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:</strong> ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏ï‡πá‡∏°</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadResponsibleExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${false ? `
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">B01</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">C02</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">D03</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">E04</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-green-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ICD-10 ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadDiseaseExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-6">
                        <label for="excelFileInput" class="block text-sm font-medium text-gray-700 mb-2">
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx, .xls)
                        </label>
                        <div class="relative">
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls" 
                                class="hidden" onchange="handleFileSelect(event, '${dataType}')">
                            <div id="fileDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-green-400 transition-colors"
                                onclick="document.getElementById('excelFileInput').click()">
                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21l3-3m-3 3l3 3m-3-3h8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-gray-600 font-medium mb-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                                <p class="text-gray-400 text-sm">‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                                <p class="text-gray-400 text-xs mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÅ‡∏•‡∏∞ .xls</p>
                            </div>
                        </div>
                        <div id="selectedFileName" class="mt-2 text-sm text-green-600 font-medium hidden"></div>
                    </div>
                    
                    <!-- Options -->
                    <div class="mb-6 space-y-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="skipFirstRow" checked class="mr-2 text-green-600 focus:ring-green-500">
                            <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="replaceExisting" class="mr-2 text-green-600 focus:ring-green-500">
                            <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                        </label>
                    </div>
                    
                    <!-- Preview Area -->
                    <div id="previewArea" class="mb-6 hidden">
                        <h4 class="font-bold text-gray-700 mb-3">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (5 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å)</h4>
                        <div id="previewTable" class="overflow-x-auto border rounded-lg"></div>
                        <div id="previewSummary" class="mt-3 text-sm text-gray-600"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button id="importButton" onclick="processExcelImport('${dataType}')" 
                            class="flex-1 btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                            </svg>
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="closeImportExcelModal()" class="flex-1 btn-secondary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                            </svg>
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            setupFileDropZone(dataType);
        }

        // Setup drag and drop for file
        function setupFileDropZone(dataType = 'diseases') {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('excelFileInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                dropZone.classList.add('border-green-400', 'bg-green-50');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('border-green-400', 'bg-green-50');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect({ target: { files: files } }, dataType);
                }
            }
        }

        // Handle file selection
        let selectedFileData = null;
        let currentDataType = 'diseases';
        
        function handleFileSelect(event, dataType = 'diseases') {
            currentDataType = dataType;
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && !file.name.match(/\\.(xlsx|xls)$/i)) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }
            
            // Show file name
            const fileNameDiv = document.getElementById('selectedFileName');
            fileNameDiv.textContent = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${file.name}`;
            fileNameDiv.classList.remove('hidden');
            
            // Read and parse Excel file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                    
                    selectedFileData = jsonData;
                    showPreview(jsonData, dataType);
                    document.getElementById('importButton').disabled = false;
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Show preview of Excel data
        function showPreview(data, dataType = 'diseases') {
            const skipFirstRow = document.getElementById('skipFirstRow').checked;
            const startRow = skipFirstRow ? 1 : 0;
            const previewData = data.slice(startRow, startRow + 5);
            
            if (previewData.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel', 'error');
                return;
            }
            
            const isResponsible = dataType === 'responsible';
            const isPopulation = dataType === 'population';
            const isAgePopulation = dataType === 'agePopulation';
            const isThailandPopulation = dataType === 'thailandPopulation';
            const previewTable = document.getElementById('previewTable');
            
            if (isThailandPopulation) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (isAgePopulation) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">0-14 ‡∏õ‡∏µ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">15-59 ‡∏õ‡∏µ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">60+ ‡∏õ‡∏µ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[3] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (isPopulation) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (isResponsible) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[3] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[4] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // Show summary
            const totalRows = data.length - (skipFirstRow ? 1 : 0);
            let validRows;
            
            if (dataType === 'epidemicWeeks') {
                validRows = data.slice(startRow).filter(row =>
                    row[0] && !isNaN(Number(row[0])) && // ‡∏õ‡∏µ
                    row[1] && !isNaN(Number(row[1])) && // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
                    row[2] && row[2].toString().trim() && // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    row[3] && row[3].toString().trim()    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                ).length;
            } else if (isBangkokDistricts) {
                validRows = data.slice(startRow).filter(row =>
                    row[0] && row[0].toString().trim() && // ‡πÅ‡∏Ç‡∏ß‡∏á
                    row[1] && row[1].toString().trim()    // ‡πÄ‡∏Ç‡∏ï
                ).length;
            } else if (isThailandPopulation) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    row[1] && !isNaN(Number(row[1])) && Number(row[1]) >= 0 && // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                    row[2] && !isNaN(Number(row[2])) && Number(row[2]) >= 0    // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                ).length;
            } else if (isAgePopulation) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                    row[1] && !isNaN(Number(row[1])) && Number(row[1]) >= 0 && // 0-14 ‡∏õ‡∏µ
                    row[2] && !isNaN(Number(row[2])) && Number(row[2]) >= 0 && // 15-59 ‡∏õ‡∏µ
                    row[3] && !isNaN(Number(row[3])) && Number(row[3]) >= 0    // 60+ ‡∏õ‡∏µ
                ).length;
            } else if (isPopulation) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                    row[1] && !isNaN(Number(row[1])) && Number(row[1]) >= 0 && // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                    row[2] && !isNaN(Number(row[2])) && Number(row[2]) >= 0    // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                ).length;
            } else if (isResponsible) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                    row[1] && row[1].toString().trim() && // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                    row[2] && row[2].toString().trim() && // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                    row[3] && row[3].toString().trim() && // ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                    row[4] && row[4].toString().trim()    // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                ).length;
            } else {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && 
                    row[1] && row[1].toString().trim()
                ).length;
            }
            
            document.getElementById('previewSummary').innerHTML = `
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${totalRows}</strong> ‡πÅ‡∏ñ‡∏ß | 
                ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö: <strong>${validRows}</strong> ‡πÅ‡∏ñ‡∏ß
            `;
            
            document.getElementById('previewArea').classList.remove('hidden');
        }

        // Process Excel import
        async function processExcelImport(dataType = 'diseases') {
            if (!selectedFileData) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...
            `;
            importButton.disabled = true;
            
            try {
                const skipFirstRow = document.getElementById('skipFirstRow').checked;
                const replaceExisting = document.getElementById('replaceExisting').checked;
                const startRow = skipFirstRow ? 1 : 0;
                
                if (dataType === 'epidemicWeeks') {
                    await processEpidemicWeeksImport(startRow, replaceExisting);
                }
                
                // Close modal and refresh table
                closeImportExcelModal();
                if (dataType === 'agePopulation') {
                    await loadAgePopulationTable();
                } else if (dataType === 'responsible') {
                    await loadResponsibleTable();
                } else if (dataType === 'bangkokDistricts') {
                    await loadBangkokDistrictsTable();
                } else if (dataType === 'epidemicWeeks') {
                    await loadEpidemicWeeksTable();
                }
                
            } catch (error) {
                console.error('Error importing Excel data:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }


        // Download example Excel file for population
        function downloadPopulationExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á'],
                [2025, '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', 52000, 25000, 27000],
                [2025, '‡∏ß‡∏±‡∏í‡∏ô‡∏≤', 87000, 42000, 45000],
                [2025, '‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', 79000, 38000, 41000],
                [2025, '‡∏™‡∏≤‡∏ó‡∏£', 72000, 35000, 37000],
                [2025, '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', 107000, 52000, 55000],
                [2025, '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°', 99000, 48000, 51000],
                [2025, '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤', 91000, 44000, 47000],
                [2025, '‡∏ö‡∏≤‡∏á‡∏ô‡∏≤', 181000, 89000, 92000],
                [2025, '‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á', 153000, 75000, 78000],
                [2025, '‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á', 127000, 62000, 65000],
                [2025, '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', 193000, 95000, 98000],
                [2025, '‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', 179000, 88000, 91000],
                [2025, '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', 160000, 78000, 82000],
                [2025, '‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', 255000, 125000, 130000],
                [2025, '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏', 139000, 68000, 71000]
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 18 },  // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                { wch: 15 },  // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                { wch: 15 }   // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "FFE082" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add number formatting for population columns
            const numberStyle = {
                numFmt: "#,##0"
            };

            // Apply number formatting to data rows
            for (let row = 2; row <= sampleData.length; row++) {
                ['B', 'C'].forEach(col => {
                    const cell = col + row;
                    if (ws[cell]) {
                        ws[cell].s = numberStyle;
                    }
                });
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for Epidemic Weeks
        function downloadEpidemicWeeksExampleFile() {
            // Create sample data with CE year
            const currentYear = new Date().getFullYear(); // Already in CE format
            const sampleData = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'],
                [currentYear, 1, `${currentYear}-01-01`, `${currentYear}-01-07`, '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ'],
                [currentYear, 2, `${currentYear}-01-08`, `${currentYear}-01-14`, ''],
                [currentYear, 3, `${currentYear}-01-15`, `${currentYear}-01-21`, ''],
                [currentYear, 4, `${currentYear}-01-22`, `${currentYear}-01-28`, ''],
                [currentYear, 5, `${currentYear}-01-29`, `${currentYear}-02-04`, '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 },   // ‡∏õ‡∏µ
                { wch: 12 },  // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
                { wch: 15 },  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                { wch: 15 },  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                { wch: 30 }   // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            ];

            // Set header style
            const headerStyle = {
                font: { bold: true, color: { rgb: "FF333333" } },
                fill: { fgColor: { rgb: "FFFFF2CC" } }
            };

            // Apply header style to first row
            for (let col of ['A', 'B', 'C', 'D', 'E']) {
                const cell = col + '1';
                if (ws[cell]) {
                    ws[cell].s = headerStyle;
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for Bangkok Districts
        function downloadBangkokDistrictsExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï'],
                ['‡∏™‡∏µ‡∏•‡∏°', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏ß‡∏á‡∏®‡πå', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏°‡∏´‡∏≤‡∏û‡∏§‡∏í‡∏≤‡∏£‡∏≤‡∏°', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏ó‡∏∏‡πà‡∏á‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ'],
                ['‡∏ñ‡∏ô‡∏ô‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ'],
                ['‡∏ñ‡∏ô‡∏ô‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ'],
                ['‡∏°‡∏±‡∏Å‡∏Å‡∏∞‡∏™‡∏±‡∏ô', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 20 },  // ‡πÅ‡∏Ç‡∏ß‡∏á
                { wch: 15 }   // ‡πÄ‡∏Ç‡∏ï
            ];

            // Set header style
            const headerStyle = {
                font: { bold: true, color: { rgb: "FF333333" } },
                fill: { fgColor: { rgb: "FFFFF2CC" } }
            };

            // Apply header style to first row
            for (let col of ['A', 'B']) {
                const cell = col + '1';
                if (ws[cell]) {
                    ws[cell].s = headerStyle;
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for Thailand population
        function downloadThailandPopulationExampleFile() {
            // Create sample data
            const currentYear = new Date().getFullYear(); // Get current year in CE
            const sampleData = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [currentYear, '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', 5666264, 2694574, 2971690],
                [currentYear, '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', 1276745, 598741, 678004],
                [currentYear, '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', 1770000, 850000, 920000],
                [currentYear, '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', 1830000, 890000, 940000],
                [currentYear, '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', 1480000, 720000, 760000]
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 20 },  // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                { wch: 15 },  // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                { wch: 15 }   // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "87CEEB" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add number formatting for population columns
            const numberStyle = {
                numFmt: "#,##0"
            };

            // Apply number formatting to data rows
            for (let row = 2; row <= sampleData.length; row++) {
                ['B', 'C'].forEach(col => {
                    const cell = col + row;
                    if (ws[cell]) {
                        ws[cell].s = numberStyle;
                    }
                });
            }

            XLSX.utils.book_append_sheet(wb, ws, "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢");

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Download example Excel file for age population
        function downloadAgePopulationExampleFile() {
            const data = [
                ['‡∏õ‡∏µ', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [2025, 0, 4, 25000, 12800, 12200],
                [2025, 5, 9, 28000, 14300, 13700],
                [2025, 10, 14, 30000, 15400, 14600],
                [2025, 15, 19, 32000, 16100, 15900],
                [2025, 20, 24, 35000, 17200, 17800],
                [2025, 25, 29, 38000, 18500, 19500],
                [2025, 30, 34, 40000, 19500, 20500],
                [2025, 35, 39, 42000, 20800, 21200],
                [2025, 40, 44, 45000, 22000, 23000],
                [2025, 45, 49, 47000, 23200, 23800],
                [2025, 50, 54, 44000, 21800, 22200],
                [2025, 55, 59, 41000, 20300, 20700],
                [2025, 60, 64, 38000, 18500, 19500],
                [2025, 65, 69, 35000, 16800, 18200],
                [2025, 70, 74, 28000, 13200, 14800],
                [2025, 75, 79, 22000, 10000, 12000],
                [2025, 80, 999, 18000, 7500, 10500]
            ];
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 },   // ‡∏õ‡∏µ
                { wch: 12 },  // ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                { wch: 12 },  // ‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                { wch: 15 },  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                { wch: 12 },  // ‡∏ä‡∏≤‡∏¢
                { wch: 12 }   // ‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "FFEB9C" } },  // Light yellow background
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add number formatting for numeric columns
            const numberStyle = {
                numFmt: "#,##0"
            };

            // Apply number formatting to numeric columns (A2:E12)
            for (let row = 2; row <= 12; row++) {
                ['C', 'D', 'E'].forEach(col => {  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£, ‡∏ä‡∏≤‡∏¢, ‡∏´‡∏ç‡∏¥‡∏á
                    const cellRef = col + row;
                    if (ws[cellRef]) {
                        ws[cellRef].s = {
                            alignment: { horizontal: "right" },
                            numFmt: "#,##0"  // Format numbers with thousands separator
                        };
                    }
                });
            }

            XLSX.utils.book_append_sheet(wb, ws, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏");
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏.xlsx');
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Download example Excel file for responsible persons
        function downloadResponsibleExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô'],
                ['A00', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏π‡πâ‡∏î‡∏µ', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô'],
                ['B01', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏î‡∏µ', '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏û‡∏£ ‡∏î‡∏µ‡πÉ‡∏à', '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£'],
                ['C02', '‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à', '‡πÅ‡∏û‡∏ó‡∏¢‡πå', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏¢‡πâ‡∏°', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å'],
                ['D03', '‡∏ô‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ó‡∏¥‡∏ô ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™', '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', '‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ç ‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'],
                ['E04', '‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Å‡∏£ ‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á', '‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡πÑ‡∏• ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°'],
                ['F05', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏¥‡∏†‡∏≤ ‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡πÄ‡∏ü‡∏∑‡πâ‡∏≠', '‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ô‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≤‡∏ç ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£'],
                ['G06', '‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡∏¢‡∏ß‡∏±‡∏í‡∏ô‡πå ‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤', '‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î', '‡∏ô‡∏≤‡∏á‡∏™‡∏∏‡∏°‡∏≤‡∏•‡∏µ ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π'],
                ['H07', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏≤‡∏ì‡∏µ ‡πÉ‡∏™‡πà‡πÉ‡∏à', '‡∏ô‡∏±‡∏Å‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', '‡∏ô‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏î‡∏≥‡∏£‡∏á', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 10 },  // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                { wch: 20 },  // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                { wch: 25 },  // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                { wch: 20 },  // ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                { wch: 25 }   // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "FFE082" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for diseases
        function downloadDiseaseExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ'],
                ['A00', '‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ'],
                ['B01', '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà'],
                ['C02', '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à'],
                ['D03', '‡πÇ‡∏£‡∏Ñ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢'],
                ['E04', '‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô'],
                ['F05', '‡πÇ‡∏£‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á'],
                ['G06', '‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à'],
                ['H07', '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï‡∏ß‡∏≤‡∏¢'],
                ['I08', '‡πÇ‡∏£‡∏Ñ‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á'],
                ['J09', '‡πÇ‡∏£‡∏Ñ‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 12 },  // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ column width
                { wch: 35 }   // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ column width
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "FFE082" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            if (ws['A1']) ws['A1'].s = headerStyle;
            if (ws['B1']) ws['B1'].s = headerStyle;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Close import modal
        function closeImportExcelModal() {
            const modal = document.getElementById('importExcelModal');
            if (modal) {
                modal.remove();
            }
            selectedFileData = null;
            currentDataType = 'diseases';
        }

        // Update preview when options change
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'skipFirstRow' && selectedFileData) {
                showPreview(selectedFileData, currentDataType);
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to be ready
            if (window.initializeFirebaseApp) {
                window.initializeFirebaseApp();
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°
                setTimeout(() => {
                    if (window.firebaseDB) {
                        loadSystemOverview();
                    }
                }, 1000);
            } else {
                // Fallback if Firebase is not ready
                setTimeout(() => {
                    if (window.initializeFirebaseApp) {
                        window.initializeFirebaseApp();
                        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°
                        setTimeout(() => {
                            if (window.firebaseDB) {
                                loadSystemOverview();
                            }
                        }, 1000);
                    } else {
                        console.warn('‚ö†Ô∏è Firebase not ready, using localStorage only');
                        initializeData();
                        showPage('summary');
                    }
                }, 1000);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9649c11c7372731d',t:'MTc1MzQyNjU1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
