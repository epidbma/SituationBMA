// Load historical data table
async function loadHistoricalDataTable() {
    const contentDiv = document.getElementById('content');
    
    // HTML for the table interface
    contentDiv.innerHTML = `
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="sm:flex sm:items-center">
                <div class="sm:flex-auto">
                    <h1 class="text-2xl font-semibold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</h1>
                    <p class="mt-2 text-sm text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ</p>
                </div>
                <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none space-x-2">
                    <button onclick="showImportExcelModal('historicalData')" class="inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:w-auto">
                        üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
                    </button>
                    <button onclick="downloadHistoricalDataExampleFile()" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    </button>
                </div>
            </div>

            <div class="mt-8 flex flex-col">
                <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-center text-sm font-semibold text-gray-900 sm:pl-6">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</th>
                                        <th scope="col" colspan="2" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏£‡∏ß‡∏°</th>
                                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                            <span class="sr-only">Actions</span>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-center text-sm font-semibold text-gray-900 sm:pl-6"></th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900"></th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900"></th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏õ‡πà‡∏ß‡∏¢</th>
                                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-gray-900">‡∏ï‡∏≤‡∏¢</th>
                                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 bg-white" id="historicalDataTableBody">
                                    <!-- Data rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Load and display data
    try {
        const historicalData = await loadFromFirebase('historicalData') || [];
        const tableBody = document.getElementById('historicalDataTableBody');
        tableBody.innerHTML = '';

        historicalData.forEach((item, index) => {
            const totalPatients = calculateTotal(item, 'patients');
            const totalDeaths = calculateTotal(item, 'deaths');

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 sm:pl-6">${item.year}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">${item.diseaseCode}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">${item.diseaseName}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.jan?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.jan?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.feb?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.feb?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.mar?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.mar?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.apr?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.apr?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.may?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.may?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.jun?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.jun?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.jul?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.jul?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.aug?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.aug?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.sep?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.sep?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.oct?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.oct?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.nov?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.nov?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.dec?.patients || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900">${formatNumber(item.dec?.deaths || 0)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right font-semibold text-gray-900">${formatNumber(totalPatients)}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-right font-semibold text-gray-900">${formatNumber(totalDeaths)}</td>
                <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                    <button onclick="editHistoricalData(${index})" class="text-indigo-600 hover:text-indigo-900 mr-4">
                        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button onclick="deleteHistoricalData(${index})" class="text-red-600 hover:text-red-900">
                        ‡∏•‡∏ö
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading historical data:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
    }
}

// Calculate total for patients or deaths
function calculateTotal(data, type) {
    const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
    return months.reduce((total, month) => {
        return total + (data[month]?.[type] || 0);
    }, 0);
}

// Format number with commas
function formatNumber(num) {
    return num.toLocaleString();
}

// Process historical data import
async function processHistoricalDataImport(startRow, replaceExisting) {
    try {
        if (!selectedFileData) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
        }

        const data = selectedFileData.slice(startRow);
        const processedData = [];

        for (const row of data) {
            if (!row[0] || !row[1] || !row[2]) continue; // Skip if missing year, disease code, or disease name

            const record = {
                year: parseInt(row[0]),
                diseaseCode: row[1].toString(),
                diseaseName: row[2].toString(),
                jan: { patients: parseInt(row[3]) || 0, deaths: parseInt(row[4]) || 0 },
                feb: { patients: parseInt(row[5]) || 0, deaths: parseInt(row[6]) || 0 },
                mar: { patients: parseInt(row[7]) || 0, deaths: parseInt(row[8]) || 0 },
                apr: { patients: parseInt(row[9]) || 0, deaths: parseInt(row[10]) || 0 },
                may: { patients: parseInt(row[11]) || 0, deaths: parseInt(row[12]) || 0 },
                jun: { patients: parseInt(row[13]) || 0, deaths: parseInt(row[14]) || 0 },
                jul: { patients: parseInt(row[15]) || 0, deaths: parseInt(row[16]) || 0 },
                aug: { patients: parseInt(row[17]) || 0, deaths: parseInt(row[18]) || 0 },
                sep: { patients: parseInt(row[19]) || 0, deaths: parseInt(row[20]) || 0 },
                oct: { patients: parseInt(row[21]) || 0, deaths: parseInt(row[22]) || 0 },
                nov: { patients: parseInt(row[23]) || 0, deaths: parseInt(row[24]) || 0 },
                dec: { patients: parseInt(row[25]) || 0, deaths: parseInt(row[26]) || 0 }
            };

            processedData.push(record);
        }

        if (processedData.length === 0) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
        }

        // Save to Firebase
        let existingData = replaceExisting ? [] : (await loadFromFirebase('historicalData') || []);
        await saveToFirebase('historicalData', [...existingData, ...processedData]);

        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadHistoricalDataTable();

    } catch (error) {
        console.error('Error processing historical data import:', error);
        throw error;
    }
}

// Download example Excel file for historical data
function downloadHistoricalDataExampleFile() {
    // Create sample data
    const currentYear = new Date().getFullYear();
    const sampleData = [
        ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ', 
         '‡∏°.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏°.‡∏Ñ. ‡∏ï‡∏≤‡∏¢', '‡∏Å.‡∏û. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏Å.‡∏û. ‡∏ï‡∏≤‡∏¢', '‡∏°‡∏µ.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏°‡∏µ.‡∏Ñ. ‡∏ï‡∏≤‡∏¢',
         '‡πÄ‡∏°.‡∏¢. ‡∏õ‡πà‡∏ß‡∏¢', '‡πÄ‡∏°.‡∏¢. ‡∏ï‡∏≤‡∏¢', '‡∏û.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏û.‡∏Ñ. ‡∏ï‡∏≤‡∏¢', '‡∏°‡∏¥.‡∏¢. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏°‡∏¥.‡∏¢. ‡∏ï‡∏≤‡∏¢',
         '‡∏Å.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏Å.‡∏Ñ. ‡∏ï‡∏≤‡∏¢', '‡∏™.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏™.‡∏Ñ. ‡∏ï‡∏≤‡∏¢', '‡∏Å.‡∏¢. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏Å.‡∏¢. ‡∏ï‡∏≤‡∏¢',
         '‡∏ï.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏ï.‡∏Ñ. ‡∏ï‡∏≤‡∏¢', '‡∏û.‡∏¢. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏û.‡∏¢. ‡∏ï‡∏≤‡∏¢', '‡∏ò.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢', '‡∏ò.‡∏Ñ. ‡∏ï‡∏≤‡∏¢'],
        [currentYear, 'A00', '‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ', 
         12, 1, 15, 2, 18, 1, 20, 2, 25, 3, 30, 2,
         28, 2, 22, 1, 19, 1, 16, 1, 14, 1, 12, 1],
        [currentYear, 'B01', '‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà', 
         150, 5, 180, 6, 200, 7, 220, 8, 250, 9, 280, 10,
         300, 12, 270, 9, 240, 8, 200, 7, 170, 6, 150, 5]
    ];

    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(sampleData);

    // Set column widths
    ws['!cols'] = [
        { wch: 10 },  // ‡∏õ‡∏µ
        { wch: 12 },  // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
        { wch: 20 },  // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
        { wch: 12 },  // ‡∏°.‡∏Ñ. ‡∏õ‡πà‡∏ß‡∏¢
        { wch: 12 }   // ‡∏°.‡∏Ñ. ‡∏ï‡∏≤‡∏¢
        // ... repeat for other months
    ];

    // Style the header row
    const headerStyle = {
        font: { bold: true, color: { rgb: "000000" } },
        fill: { fgColor: { rgb: "FFE082" } },
        alignment: { horizontal: "center" }
    };

    // Apply header styling
    Object.keys(ws).forEach(cell => {
        if (cell[1] === '1') {  // First row
            ws[cell].s = headerStyle;
        }
    });

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤');

    // Generate filename with current date
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
    const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤_${dateStr}.xlsx`;

    // Download the file
    XLSX.writeFile(wb, filename);

    // Show notification
    showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
}
