

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlL77uQpwMB9qBfHvy7wxYFNoyAGitGcY",
            authDomain: "situation-epid.firebaseapp.com",
            databaseURL: "https://situation-epid-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "situation-epid",
            storageBucket: "situation-epid.firebasestorage.app",
            messagingSenderId: "619424310207",
            appId: "1:619424310207:web:de8c53b897ab7940a0f70a",
            measurementId: "G-253XD0NV73"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            push,
            remove,
            onValue,
            off
        };
        
        // Initialize the application after Firebase is ready
        window.initializeFirebaseApp = function() {
            console.log('üî• Firebase connected to Asia Southeast region!');
            
            // Update Firebase status indicator
            const firebaseStatus = document.getElementById('firebaseStatus');
            if (firebaseStatus) {
                firebaseStatus.className = 'mt-2 inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium';
                firebaseStatus.innerHTML = `
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢) ‡πÅ‡∏•‡πâ‡∏ß
                `;
            }
            
            initializeData();
            showPage('summary');
            
            // Show connection status notification
            const statusDiv = document.createElement('div');
            statusDiv.className = 'fixed top-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 slide-in text-sm';
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>
                    üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                </div>
            `;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@100;200;300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Anuphan', sans-serif; 
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-card {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(6, 95, 70, 0.3);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(6, 95, 70, 0.3);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 95, 70, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
            border: none;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(6, 95, 70, 0.3);
            transform: translateY(-2px);
        }
        
        .tab-inactive {
            color: #6b7280;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            transform: translateY(-1px);
        }
        
        .input-field {
            border: 2px solid rgba(6, 95, 70, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .input-field:focus {
            outline: none;
            border-color: #065f46;
            box-shadow: 0 0 0 4px rgba(6, 95, 70, 0.1);
            background: white;
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid rgba(6, 95, 70, 0.1);
        }
        
        .table-row:hover {
            background: rgba(6, 95, 70, 0.05);
        }
        
        .icon-gradient-blue {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
        }
        
        .icon-gradient-green {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            color: white;
        }
        
        .icon-gradient-purple {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
        }
        
        .icon-gradient-orange {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            color: white;
        }
        
        .icon-gradient-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulse-glow {
            from { box-shadow: 0 4px 20px rgba(6, 95, 70, 0.3); }
            to { box-shadow: 0 8px 40px rgba(6, 95, 70, 0.5); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slideInFromTop {
            animation: slideInFromTop 0.5s ease-out;
        }
        
        @keyframes slideInFromTop {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .master-data-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .master-data-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(6, 95, 70, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .master-data-card:hover::before {
            left: 100%;
        }
        
        .master-data-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(6, 95, 70, 0.2);
            border-color: rgba(6, 95, 70, 0.3);
        }
        
        .notification-badge {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: -8px;
            right: -8px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <!-- Background Pattern -->
    <div class="fixed inset-0 opacity-10">
        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 25% 25%, white 2px, transparent 2px); background-size: 50px 50px;"></div>
    </div>

    <!-- Header -->
    <header class="relative z-10 pt-8 pb-6">
        <div class="max-w-7xl mx-auto px-4">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-20 h-20 gradient-card flex items-center justify-center mx-auto mb-6 floating-animation">
                            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"/>
                            </svg>
                        </div>
                        <h1 class="text-4xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-6">
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ
                        </h1>
                        <p class="text-gray-600 text-lg mb-4">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</p>
                        <div class="mt-4 inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </div>
                        <div id="firebaseStatus" class="mt-2 inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></div>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 py-6 relative z-10">
        <div class="glass-card p-3">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <button id="summaryTab" onclick="showPage('summary')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-active">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                        <span class="text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</span>
                    </div>
                </button>
                <button id="reportTab" onclick="showPage('report')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-inactive">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                        </svg>
                        <span class="text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                    </div>
                </button>
                <button id="patientsTab" onclick="showPage('patients')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-inactive">
                    <div class="flex flex-col items-center space-y-2 relative">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                        </svg>
                        <span class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                    </div>
                </button>
                <button id="masterDataTab" onclick="showPage('masterData')" class="px-6 py-4 text-center font-semibold rounded-lg transition-all tab-inactive">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                        <span class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 pb-12 relative z-10">

        <!-- Summary Page -->
        <div id="summaryPage" class="slide-in">
            <div class="glass-card p-8">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-4">
                        ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                    </h2>
                    <p class="text-gray-600 text-lg">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
                    <div class="stat-card floating-animation" style="animation-delay: 0.1s;">
                        <div class="w-16 h-16 icon-gradient-blue rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-gray-900 mb-2">-</div>
                        <div class="text-sm text-gray-600 font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</div>
                    </div>
                    
                    <div class="stat-card floating-animation" style="animation-delay: 0.2s;">
                        <div class="w-16 h-16 icon-gradient-green rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-gray-900 mb-2">-</div>
                        <div class="text-sm text-gray-600 font-medium">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    
                    <div class="stat-card floating-animation" style="animation-delay: 0.3s;">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-gray-900 mb-2">-</div>
                        <div class="text-sm text-gray-600 font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
                    </div>
                    
                    <div class="stat-card floating-animation" style="animation-delay: 0.4s;">
                        <div class="w-16 h-16 icon-gradient-orange rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-gray-900 mb-2">-</div>
                        <div class="text-sm text-gray-600 font-medium">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                    </div>
                </div>
                
                <div class="glass-card p-6 pulse-glow">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-800 font-semibold text-lg">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
                            <p class="text-gray-600">‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Page -->
        <div id="reportPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-3">
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ
                        </h2>
                        <p class="text-gray-600 text-lg">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                    </div>
                    <button onclick="showPage('summary')" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</label>
                            <select id="diseaseCode" class="w-full input-field" onchange="loadDiseaseInfo()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="date" id="startDate" class="w-full input-field">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="date" id="endDate" class="w-full input-field" onchange="updateReportMonth()">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="reportMonth" class="w-full input-field bg-gray-50" readonly>
                        </div>

                        <button onclick="exportReport()" class="w-full btn-primary text-lg py-4">
                            <svg class="w-6 h-6 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                            </svg>
                            ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ)
                        </button>
                    </div>

                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-700" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                            </svg>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                        </h3>
                        <div class="space-y-6">
                            <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                                <span class="text-xs font-bold text-blue-600 uppercase tracking-wide">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</span>
                                <p id="diseaseName" class="text-gray-900 mt-2 font-semibold text-lg">-</p>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                                <span class="text-xs font-bold text-green-600 uppercase tracking-wide">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                                <p id="reportResponsible" class="text-gray-900 mt-2 font-semibold">-</p>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                                <span class="text-xs font-bold text-purple-600 uppercase tracking-wide">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</span>
                                <p id="reportReviewer" class="text-gray-900 mt-2 font-semibold">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patients Page -->
        <div id="patientsPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-3">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        </h2>
                        <p class="text-gray-600 text-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                    </div>
                    <div class="flex space-x-4">
                        <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" onchange="importExcel()">
                        <button onclick="document.getElementById('excelFile').click()" class="btn-primary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"/>
                            </svg>
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel
                        </button>

                        <button onclick="clearAllPatients()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                            </svg>
                            ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button onclick="showPage('summary')" class="btn-secondary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                            </svg>
                            ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                        </button>
                    </div>
                </div>

                <!-- Import Progress Bar -->
                <div id="importProgressContainer" class="hidden mb-8">
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4">
                                    <svg id="importIcon" class="w-5 h-5 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
                                    <p id="importStatus" class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div id="importPercentage" class="text-2xl font-bold text-blue-600">0%</div>
                                <div id="importCount" class="text-sm text-gray-500">0 / 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                            <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                        
                        <!-- Progress Details -->
                        <div class="grid grid-cols-3 gap-4 text-center mb-4">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <div id="processedCount" class="text-xl font-bold text-blue-600">0</div>
                                <div class="text-xs text-blue-600 font-medium">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3">
                                <div id="validCount" class="text-xl font-bold text-green-600">0</div>
                                <div class="text-xs text-green-600 font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-3">
                                <div id="errorCount" class="text-xl font-bold text-orange-600">0</div>
                                <div class="text-xs text-orange-600 font-medium">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
                            </div>
                        </div>
                        
                        <!-- Batch Processing Details -->
                        <div id="batchDetails" class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-4 hidden">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-purple-700 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                    </svg>
                                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Batch Processing
                                </h4>
                                <div id="currentBatchInfo" class="text-sm text-purple-600 font-medium">
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°...
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-white rounded-lg p-3">
                                    <div class="text-gray-600 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î Batch</div>
                                    <div id="batchSize" class="font-bold text-purple-600">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <div class="text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Batch ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                    <div id="totalBatches" class="font-bold text-purple-600">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <div class="text-gray-600 mb-1">Batch ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                                    <div id="currentBatch" class="font-bold text-blue-600">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <div class="text-gray-600 mb-1">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                                    <div id="batchRange" class="font-bold text-green-600">-</div>
                                </div>
                            </div>
                            
                            <!-- Batch Progress Bar -->
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Batch</span>
                                    <span id="batchPercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="batchProgressBar" class="h-2 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Speed and Time Info -->
                        <div class="flex justify-between items-center mt-4 text-sm text-gray-500">
                            <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: <span id="importSpeed" class="font-medium">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
                            <div>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="timeRemaining" class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</span></div>
                        </div>
                        
                        <!-- Cancel Button -->
                        <div class="flex justify-center mt-6">
                            <button id="cancelImportBtn" onclick="cancelImport()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="glass-card p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0 md:space-x-4">
                        <div class="flex-1 max-w-md">
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." 
                                       class="w-full input-field pl-10 pr-10" 
                                       onkeyup="if(event.key==='Enter') searchPatients()" 
                                       oninput="if(this.value==='') clearSearch()">
                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <button onclick="clearSearch()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">‡πÅ‡∏™‡∏î‡∏á:</label>
                                <select onchange="changeRecordsPerPage(this.value)" class="input-field py-2 px-3 text-sm">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            </div>
                            
                            <button onclick="searchPatients()" class="btn-primary py-2 px-4 text-sm">
                                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÄ‡∏û‡∏®</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÅ‡∏Ç‡∏ß‡∏á</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <tr>
                                <td colspan="12" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">üìã</div>
                                    <p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                                    <p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="glass-card p-4 mt-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                        <div class="text-sm text-gray-700">
                            <span id="paginationInfo">‡πÅ‡∏™‡∏î‡∏á 0 - 0 ‡∏à‡∏≤‡∏Å 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        
                        <div class="flex items-center justify-center">
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationControls">
                                <!-- Pagination buttons will be inserted here -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Master Data Page -->
        <div id="masterDataPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent mb-3">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </h2>
                        <p class="text-gray-600 text-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
                    </div>
                    <button onclick="showPage('summary')" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="master-data-card" onclick="showMasterDataDetail('diseases')">
                        <div class="w-16 h-16 icon-gradient-blue rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</h3>
                        <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('responsible')">
                        <div class="w-16 h-16 icon-gradient-green rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h3>
                        <p class="text-gray-600">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('population')">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('agePopulation')">
                        <div class="w-16 h-16 icon-gradient-orange rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</h3>
                        <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('thailandPopulation')">
                        <div class="w-16 h-16 icon-gradient-blue rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('bangkokDistricts')">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ç‡∏ß‡∏á ‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('diseaseHistory')">
                        <div class="w-16 h-16 icon-gradient-purple rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2 1h10v8H5V6z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                        <p class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
                    </div>

                    <div class="master-data-card" onclick="showMasterDataDetail('epidemicWeeks')">
                        <div class="w-16 h-16 icon-gradient-green rounded-2xl mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-900 mb-3 text-lg">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h3>
                        <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Master Data Detail Pages -->
        <div id="masterDataDetailPage" class="hidden">
            <div class="glass-card p-8 slide-in">
                <div class="flex items-center justify-between mb-8">
                    <h2 id="masterDataDetailTitle" class="text-3xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent"></h2>
                    <div class="flex space-x-4">
                        <button id="addNewButton" class="btn-primary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="showPage('masterData')" class="btn-secondary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                            </svg>
                            ‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                    </div>
                </div>
                <div id="masterDataDetailContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase data management functions
        async function saveToFirebase(path, data) {
            try {
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, path), data);
                // Clear localStorage after successful Firebase save
                localStorage.removeItem(path.replace('/', '_'));
                console.log(`‚úÖ Saved to Firebase: ${path}`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error saving to Firebase (${path}):`, error);
                // Fallback to localStorage only if data is not empty
                if (data && (!Array.isArray(data) || data.length > 0)) {
                    localStorage.setItem(path.replace('/', '_'), JSON.stringify(data));
                } else {
                    localStorage.removeItem(path.replace('/', '_'));
                }
                return false;
            }
        }

        async function loadFromFirebase(path) {
            try {
                const { database, ref, get } = window.firebaseDB;
                const snapshot = await get(ref(database, path));
                let data = null;

                // Try to get data from Firebase first
                if (snapshot.exists()) {
                    data = snapshot.val();
                    console.log(`‚úÖ Loaded from Firebase: ${path}`);
                }

                // If no data in Firebase, try localStorage
                if (!data) {
                    console.log(`üì≠ No data found in Firebase: ${path}`);
                    try {
                        const localData = localStorage.getItem(path.replace('/', '_'));
                        if (localData) {
                            data = JSON.parse(localData);
                            console.log(`‚úÖ Loaded from localStorage: ${path}`);
                        }
                    } catch (localError) {
                        console.error(`‚ùå Error loading from localStorage: ${path}`, localError);
                    }
                }

                // If still no data, return empty array
                if (!data) {
                    console.log(`üì≠ No data found in both Firebase and localStorage: ${path}`);
                    return [];
                }

                // Process the data
                if (Array.isArray(data)) {
                    console.log(`‚úÖ Got array data (${data.length} items)`);
                    return data;
                }
                
                if (typeof data === 'object') {
                    const arrayData = Object.values(data);
                    console.log(`üîÑ Converted object to array (${arrayData.length} items)`);
                    return arrayData;
                }

                console.log(`‚ö†Ô∏è Unexpected data format: ${typeof data}`);
                return [];

            } catch (error) {
                console.error(`‚ùå Error loading data: ${path}`, error);
                return [];
            }
        }

        async function deleteFromFirebase(path) {
            try {
                const { database, ref, remove } = window.firebaseDB;
                await remove(ref(database, path));
                console.log(`üóëÔ∏è Deleted from Firebase: ${path}`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error deleting from Firebase (${path}):`, error);
                return false;
            }
        }

        // Initialize data structure with Firebase
        async function initializeData() {
            console.log('üîÑ Initializing data with Firebase...');
            
            // Initialize all data collections
            const collections = [
                'diseases', 'responsible', 'patients', 'population', 
                'agePopulation', 'thailandPopulation', 'epidemicWeeks', 'bangkokDistricts'
            ];
            
            for (const collection of collections) {
                const data = await loadFromFirebase(collection);
                
                // Initialize with sample data if empty
                if (collection === 'diseases' && data.length === 0) {
                    const sampleDiseases = [
                        { code: '506', name: '‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å' },
                        { code: '507', name: '‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà' },
                        { code: '508', name: '‡πÇ‡∏£‡∏Ñ‡∏°‡∏∑‡∏≠ ‡πÄ‡∏ó‡πâ‡∏≤ ‡∏õ‡∏≤‡∏Å' },
                        { code: '509', name: '‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡∏£‡πà‡∏ß‡∏á' },
                        { code: '510', name: '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏Å' }
                    ];
                    await saveToFirebase('diseases', sampleDiseases);
                    localStorage.setItem(collection, JSON.stringify(sampleDiseases));
                    console.log('‚úÖ Initialized sample diseases data');
                } else {
                    // Keep a local cache for faster access
                    localStorage.setItem(collection, JSON.stringify(data));
                }
            }
            
            console.log('‚úÖ Data initialization complete');
        }

        // Page navigation with animation
        function showPage(page) {
            // Hide all pages
            const pages = ['summaryPage', 'reportPage', 'patientsPage', 'masterDataPage', 'masterDataDetailPage'];
            pages.forEach(pageId => {
                const element = document.getElementById(pageId);
                element.classList.add('hidden');
                element.classList.remove('slide-in');
            });

            // Reset all tabs
            const tabs = ['summaryTab', 'reportTab', 'patientsTab', 'masterDataTab'];
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                tab.className = tab.className.replace('tab-active', 'tab-inactive');
            });

            // Show selected page and activate tab
            setTimeout(() => {
                if (page === 'summary') {
                    const pageElement = document.getElementById('summaryPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('summaryTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                } else if (page === 'report') {
                    const pageElement = document.getElementById('reportPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('reportTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                    loadDiseaseOptions();
                } else if (page === 'patients') {
                    const pageElement = document.getElementById('patientsPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('patientsTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                    loadPatientsTable();
                } else if (page === 'masterData') {
                    const pageElement = document.getElementById('masterDataPage');
                    pageElement.classList.remove('hidden');
                    pageElement.classList.add('slide-in');
                    const tab = document.getElementById('masterDataTab');
                    tab.className = tab.className.replace('tab-inactive', 'tab-active');
                }
            }, 100);
        }

        // Load disease options for report
        async function loadDiseaseOptions() {
            const diseases = await loadFromFirebase('diseases');
            const select = document.getElementById('diseaseCode');
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>';
            
            diseases.forEach(disease => {
                const option = document.createElement('option');
                option.value = disease.code;
                option.textContent = `${disease.code} - ${disease.name}`;
                select.appendChild(option);
            });
        }

        // Load disease info when code is selected
        async function loadDiseaseInfo() {
            const selectedCode = document.getElementById('diseaseCode').value;
            if (!selectedCode) {
                document.getElementById('diseaseName').textContent = '-';
                document.getElementById('reportResponsible').textContent = '-';
                document.getElementById('reportReviewer').textContent = '-';
                return;
            }

            const diseases = await loadFromFirebase('diseases');
            const responsible = await loadFromFirebase('responsible');
            
            const disease = diseases.find(d => d.code === selectedCode);
            const resp = responsible.find(r => r.diseaseCode === selectedCode);

            document.getElementById('diseaseName').textContent = disease ? disease.name : '-';
            document.getElementById('reportResponsible').textContent = resp ? `${resp.responsibleName} (${resp.responsiblePosition})` : '-';
            document.getElementById('reportReviewer').textContent = resp ? `${resp.reviewerName} (${resp.reviewerPosition})` : '-';
        }

        // Update report month based on end date
        function updateReportMonth() {
            const endDate = document.getElementById('endDate').value;
            if (endDate) {
                const date = new Date(endDate);
                const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                const month = months[date.getMonth()];
                const year = date.getFullYear() + 543;
                document.getElementById('reportMonth').value = `${month} ${year}`;
            }
        }

        // Export report (placeholder)
        function exportReport() {
            // Show loading animation
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞ Excel ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
            }, 2000);
        }

        // High-performance Excel import for large datasets (100K+ records)
        function importExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
            console.log(`üìä File size: ${fileSizeMB} MB`);
            
            // Enhanced file size warnings with performance tips
            if (file.size > 100 * 1024 * 1024) { // 100MB+
                const confirmed = confirm(
                    `‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å: ${fileSizeMB} MB\n\n` +
                    `üöÄ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:\n` +
                    `‚Ä¢ ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n` +
                    `‚Ä¢ ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô\n` +
                    `‚Ä¢ ‡πÉ‡∏ä‡πâ Chrome ‡∏´‡∏£‡∏∑‡∏≠ Edge (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ Firefox)\n` +
                    `‚Ä¢ ‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πá‡∏õ‡∏ó‡πá‡∏≠‡∏õ)\n\n` +
                    `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: 5-15 ‡∏ô‡∏≤‡∏ó‡∏µ\n` +
                    `üìà ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${Math.round(file.size / 200).toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` +
                    `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
                );
                
                if (!confirmed) return;
                
                // Show performance mode notification
                showPerformanceModeNotification();
                
            } else if (file.size > 50 * 1024 * 1024) { // 50MB+
                const confirmed = confirm(
                    `üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà: ${fileSizeMB} MB\n\n` +
                    `‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á:\n` +
                    `‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö batch (‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 3-5 ‡πÄ‡∏ó‡πà‡∏≤)\n` +
                    `‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå\n` +
                    `‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤\n\n` +
                    `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: 2-5 ‡∏ô‡∏≤‡∏ó‡∏µ\n` +
                    `üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${Math.round(file.size / 200).toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` +
                    `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
                );
                
                if (!confirmed) return;
            }

            // Show progress container
            const progressContainer = document.getElementById('importProgressContainer');
            progressContainer.classList.remove('hidden');
            
            // Reset progress indicators
            resetProgressIndicators();
            
            // Show file analysis
            updateImportStatus(`üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå Excel (${fileSizeMB} MB)...`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                updateImportStatus('‚ö° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á...');
                
                // Use requestIdleCallback for better performance
                if (window.requestIdleCallback) {
                    requestIdleCallback(() => processExcelFile(e.target.result, fileSizeMB));
                } else {
                    setTimeout(() => processExcelFile(e.target.result, fileSizeMB), 100);
                }
            };
            
            reader.onerror = function() {
                updateImportStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                setTimeout(() => {
                    document.getElementById('importProgressContainer').classList.add('hidden');
                }, 2000);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Show performance mode notification
        function showPerformanceModeNotification() {
            const perfDiv = document.createElement('div');
            perfDiv.className = 'fixed top-4 left-4 bg-purple-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            perfDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/>
                    </svg>
                    <div>
                        <div class="font-bold mb-1">üöÄ ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á</div>
                        <div class="text-sm opacity-90">
                            ‚Ä¢ ‡πÉ‡∏ä‡πâ Web Workers<br>
                            ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Batch<br>
                            ‚Ä¢ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 5-10 ‡πÄ‡∏ó‡πà‡∏≤
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(perfDiv);
            
            setTimeout(() => {
                perfDiv.remove();
            }, 4000);
        }

        // High-performance Excel processing
        function processExcelFile(arrayBuffer, fileSizeMB) {
            try {
                const data = new Uint8Array(arrayBuffer);
                
                // Show processing status based on file size
                if (parseFloat(fileSizeMB) > 50) {
                    updateImportStatus('üî• ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà...');
                } else {
                    updateImportStatus('‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel...');
                }
                
                // Optimized XLSX reading for large files
                const workbook = XLSX.read(data, {
                    type: 'array',
                    cellDates: true,
                    cellNF: false,
                    cellText: false,
                    // Performance optimizations
                    dense: true,  // Use dense mode for better memory usage
                    raw: false,   // Don't parse formulas
                    codepage: 65001 // UTF-8 for Thai characters
                });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Use faster conversion method for large datasets
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                    raw: false,
                    dateNF: 'dd/mm/yyyy',
                    defval: '', // Default value for empty cells
                    blankrows: false // Skip blank rows
                });
                
                console.log(`üìä Parsed ${jsonData.length.toLocaleString()} records from Excel`);
                
                // Clear the workbook from memory immediately
                workbook.Sheets = null;
                
                updateImportStatus('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á...');
                updateImportCount(0, jsonData.length);
                
                // Enhanced time estimation based on actual performance data
                const estimatedSpeed = getEstimatedProcessingSpeed(jsonData.length);
                const estimatedTime = Math.ceil(jsonData.length / estimatedSpeed);
                
                if (jsonData.length > 500000) {
                    updateImportStatus(`‚ö° ‡πÇ‡∏´‡∏°‡∏î‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏£‡πá‡∏ß: ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.ceil(estimatedTime/60)} ‡∏ô‡∏≤‡∏ó‡∏µ)`);
                } else if (jsonData.length > 200000) {
                    updateImportStatus(`üöÄ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡πá‡∏ß: ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${estimatedTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`);
                } else if (jsonData.length > 100000) {
                    updateImportStatus(`‚ö° ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${estimatedTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`);
                } else {
                    updateImportStatus(`üìä ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${jsonData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                }
                
                // Use high-performance processing
                setTimeout(() => {
                    processDataWithHighPerformance(jsonData);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error processing Excel file:', error);
                handleExcelProcessingError(error, fileSizeMB);
            }
        }

        // Get estimated processing speed based on dataset size
        function getEstimatedProcessingSpeed(recordCount) {
            if (recordCount > 500000) return 8000;  // 8K records/second for very large
            if (recordCount > 200000) return 12000; // 12K records/second for large
            if (recordCount > 100000) return 15000; // 15K records/second for medium-large
            if (recordCount > 50000) return 20000;  // 20K records/second for medium
            return 25000; // 25K records/second for small datasets
        }

        // Handle Excel processing errors with helpful messages
        function handleExcelProcessingError(error, fileSizeMB) {
            updateImportStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Excel');
            
            let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ';
            let suggestion = '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (.xlsx)';
            
            if (error.message && error.message.includes('memory')) {
                errorMessage = '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠';
                suggestion = `‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î ${fileSizeMB} MB ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ<br>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏¢‡πà‡∏≠‡∏¢ < 50 MB`;
            } else if (error.message && error.message.includes('format')) {
                errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                suggestion = '‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå .xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            errorDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                    </svg>
                    <div>
                        <div class="font-bold mb-1">${errorMessage}</div>
                        <div class="text-sm opacity-90">${suggestion}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
                document.getElementById('importProgressContainer').classList.add('hidden');
            }, 8000);
        }

        // Reset all progress indicators
        function resetProgressIndicators() {
            document.getElementById('importPercentage').textContent = '0%';
            document.getElementById('importCount').textContent = '0 / 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            document.getElementById('processedCount').textContent = '0';
            document.getElementById('validCount').textContent = '0';
            document.getElementById('errorCount').textContent = '0';
            document.getElementById('importSpeed').textContent = '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ';
            document.getElementById('timeRemaining').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...';
            document.getElementById('progressBar').style.width = '0%';
            
            // Reset batch details
            document.getElementById('batchDetails').classList.add('hidden');
            document.getElementById('batchSize').textContent = '-';
            document.getElementById('totalBatches').textContent = '-';
            document.getElementById('currentBatch').textContent = '-';
            document.getElementById('batchRange').textContent = '-';
            document.getElementById('batchPercentage').textContent = '0%';
            document.getElementById('batchProgressBar').style.width = '0%';
            document.getElementById('currentBatchInfo').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°...';
            
            // Reset icon to spinning
            const icon = document.getElementById('importIcon');
            icon.innerHTML = `
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            `;
            icon.classList.add('animate-spin');
            
            // Reset import control variables
            importCancelled = false;
            currentImportProcess = null;
        }
        
        // Show batch processing information
        function showBatchProcessingInfo(totalRecords, batchSize, phase = 'validation') {
            const batchDetails = document.getElementById('batchDetails');
            batchDetails.classList.remove('hidden');
            
            const totalBatches = Math.ceil(totalRecords / batchSize);
            
            document.getElementById('batchSize').textContent = batchSize.toLocaleString();
            document.getElementById('totalBatches').textContent = totalBatches.toLocaleString();
            
            const phaseText = phase === 'validation' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('currentBatchInfo').textContent = `‡πÄ‡∏£‡∏¥‡πà‡∏°${phaseText}‡πÅ‡∏ö‡∏ö batch`;
            
            console.log(`üìä Batch Info: ${totalRecords.toLocaleString()} records, ${batchSize.toLocaleString()} per batch, ${totalBatches} batches total`);
        }
        
        // Update batch progress
        function updateBatchProgress(phase, currentBatch, totalBatches, startIndex, endIndex, totalRecords) {
            const batchPercentage = Math.round((currentBatch / totalBatches) * 100);
            
            // Update batch-specific elements
            document.getElementById('currentBatch').textContent = `${currentBatch}/${totalBatches}`;
            document.getElementById('batchRange').textContent = `${(startIndex + 1).toLocaleString()}-${endIndex.toLocaleString()}`;
            document.getElementById('batchPercentage').textContent = `${batchPercentage}%`;
            document.getElementById('batchProgressBar').style.width = `${batchPercentage}%`;
            
            // Update phase-specific info
            const phaseText = phase === 'validation' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            const phaseIcon = phase === 'validation' ? 'üîç' : 'üíæ';
            
            document.getElementById('currentBatchInfo').textContent = 
                `${phaseIcon} ${phaseText} Batch ${currentBatch}/${totalBatches}`;
            
            // Add visual feedback for batch completion
            if (currentBatch === totalBatches) {
                setTimeout(() => {
                    document.getElementById('currentBatchInfo').textContent = 
                        `‚úÖ ${phaseText}‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! (${totalBatches} batches)`;
                }, 100);
            }
            
            console.log(`üìà Batch Progress: ${phase} ${currentBatch}/${totalBatches} (${batchPercentage}%) - Records ${startIndex + 1}-${endIndex}`);
        }
        
        // Cancel import process
        function cancelImport() {
            const confirmed = confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà');
            
            if (confirmed) {
                importCancelled = true;
                
                // Update UI to show cancellation
                updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...');
                
                // Change icon to warning
                const icon = document.getElementById('importIcon');
                icon.classList.remove('animate-spin');
                icon.innerHTML = `
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                `;
                
                // Disable cancel button
                const cancelBtn = document.getElementById('cancelImportBtn');
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...
                `;
                
                // Show cancellation notification
                const cancelDiv = document.createElement('div');
                cancelDiv.className = 'fixed top-4 left-4 bg-orange-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in';
                cancelDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        <div>
                            <div class="font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
                            <div class="text-sm opacity-90">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(cancelDiv);
                
                setTimeout(() => {
                    cancelDiv.remove();
                }, 3000);
                
                // The actual cancellation will be handled in the processAndSaveRecord function
                setTimeout(() => {
                    finishCancellation();
                }, 1000);
            }
        }
        
        // Finish cancellation process
        function finishCancellation() {
            updateImportStatus('‚ùå ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            
            // Change icon to cancelled
            const icon = document.getElementById('importIcon');
            icon.innerHTML = `
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
            `;
            
            // Hide progress after delay
            setTimeout(async () => {
                document.getElementById('importProgressContainer').classList.add('hidden');
                
                // Auto-refresh data to show what was imported before cancellation
                console.log('üîÑ Auto-refreshing data after cancellation...');
                await autoRefreshData('cancel', window.allPatients ? window.allPatients.length : 0);
                
                // Show final cancellation message
                const finalDiv = document.createElement('div');
                finalDiv.className = 'fixed top-4 right-4 bg-orange-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in';
                finalDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                        </svg>
                        <div>
                            <div class="font-bold">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
                            <div class="text-sm opacity-90">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(finalDiv);
                
                setTimeout(() => {
                    finalDiv.remove();
                }, 5000);
                
            }, 2000);
        }

        // Update import status text
        function updateImportStatus(status) {
            document.getElementById('importStatus').textContent = status;
        }

        // Update import count display
        function updateImportCount(current, total) {
            document.getElementById('importCount').textContent = `${current.toLocaleString()} / ${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // Process data one by one with batch progress display
        function processDataWithHighPerformance(jsonData) {
            const requiredFields = ['‡πÇ‡∏£‡∏Ñ', '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡πÄ‡∏û‡∏®', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô', '‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢', '‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'];
            
            const totalRecords = jsonData.length;
            let processedRecords = 0;
            let validRecords = 0;
            let errorRecords = 0;
            let savedRecords = 0;
            const startTime = Date.now();

            // Initialize global array for real-time display
            window.allPatients = [];
            
            // Clear existing table and show processing state
            const tbody = document.getElementById('patientsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="px-6 py-20 text-center text-gray-500">
                        <div class="text-6xl mb-4">‚ö°</div>
                        <p class="font-semibold text-xl text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>
                        <p class="text-gray-500 mt-2">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
                    </td>
                </tr>
            `;
            
            // Determine batch size for progress display only
            const batchSize = Math.max(100, Math.floor(totalRecords / 20));
            console.log(`üìä Using batch size for progress: ${batchSize.toLocaleString()} for ${totalRecords.toLocaleString()} records`);
            
            // Show batch processing info (for progress display)
            showBatchProcessingInfo(totalRecords, batchSize);
            
            updateImportStatus('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...');
            
            // Process records one by one
            function processRecord(index) {
                if (importCancelled) {
                    console.log(`üõë Import cancelled at record ${index + 1}`);
                    return;
                }
                
                if (index >= totalRecords) {
                    // Finish import
                    finishImportProcess(savedRecords, validRecords, errorRecords);
                    return;
                }
                
                const row = jsonData[index];
                const newRow = {};
                
                // Copy required fields
                for (const field of requiredFields) {
                    newRow[field] = row[field] || '';
                }
                
                processedRecords++;
                
                // Validate record
                if (newRow['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] && newRow['‡πÄ‡∏û‡∏®']) {
                    validRecords++;
                    
                    // Save record to database
                    saveRecordToDatabase(newRow).then((success) => {
                        if (success) {
                            savedRecords++;
                            
                            // Add to global array (newest first)
                            window.allPatients.unshift(newRow);
                            
                            // Add to table display (limit to 100 records)
                            addRecordToTable(newRow, savedRecords);
                        }
                        
                        // Update batch progress display
                        const currentBatch = Math.ceil(processedRecords / batchSize);
                        const totalBatches = Math.ceil(totalRecords / batchSize);
                        const batchStartIndex = (currentBatch - 1) * batchSize;
                        const batchEndIndex = Math.min(currentBatch * batchSize, totalRecords);
                        
                        updateBatchProgress('saving', currentBatch, totalBatches, batchStartIndex, batchEndIndex - 1, totalRecords);
                        
                        // Update progress stats
                        updateProgressStats(processedRecords, totalRecords, savedRecords, validRecords, errorRecords, startTime);
                        
                        // Continue with next record
                        const delay = getProcessingDelay(totalRecords);
                        setTimeout(() => processRecord(index + 1), delay);
                    });
                } else {
                    errorRecords++;
                    
                    // Update batch progress display
                    const currentBatch = Math.ceil(processedRecords / batchSize);
                    const totalBatches = Math.ceil(totalRecords / batchSize);
                    const batchStartIndex = (currentBatch - 1) * batchSize;
                    const batchEndIndex = Math.min(currentBatch * batchSize, totalRecords);
                    
                    updateBatchProgress('validation', currentBatch, totalBatches, batchStartIndex, batchEndIndex - 1, totalRecords);
                    
                    // Update progress stats
                    updateProgressStats(processedRecords, totalRecords, savedRecords, validRecords, errorRecords, startTime);
                    
                    // Continue with next record
                    const delay = getProcessingDelay(totalRecords);
                    setTimeout(() => processRecord(index + 1), delay);
                }
            }
            
            // Start processing from first record
            processRecord(0);
        }

        // Get optimal batch size based on dataset size and browser performance
        function getOptimalBatchSize(totalRecords) {
            // Detect browser performance capability
            const isHighPerformance = navigator.hardwareConcurrency >= 8 && navigator.deviceMemory >= 8;
            const isMediumPerformance = navigator.hardwareConcurrency >= 4 && navigator.deviceMemory >= 4;
            
            if (totalRecords > 500000) {
                return isHighPerformance ? 5000 : isMediumPerformance ? 3000 : 2000;
            } else if (totalRecords > 200000) {
                return isHighPerformance ? 8000 : isMediumPerformance ? 5000 : 3000;
            } else if (totalRecords > 100000) {
                return isHighPerformance ? 10000 : isMediumPerformance ? 7000 : 5000;
            } else if (totalRecords > 50000) {
                return isHighPerformance ? 15000 : isMediumPerformance ? 10000 : 7000;
            } else {
                return Math.min(totalRecords, 20000);
            }
        }





        // Legacy function for backward compatibility
        function processDataInChunks(jsonData) {
            console.log('üîÑ Redirecting to high-performance processing...');
            processDataWithHighPerformance(jsonData);
        }
        
        // Get processing delay based on dataset size
        function getProcessingDelay(totalRecords) {
            if (totalRecords > 100000) return 100; // 100ms for very large datasets
            if (totalRecords > 50000) return 50;   // 50ms for large datasets
            if (totalRecords > 10000) return 20;   // 20ms for medium datasets
            return 10; // 10ms for small datasets
        }
        
        // Save individual record to database
        async function saveRecordToDatabase(record) {
            try {
                // Save to Firebase (individual record)
                const { database, ref, push } = window.firebaseDB;
                const patientsRef = ref(database, 'patients');
                await push(patientsRef, record);
                
                // Also update localStorage
                const existingData = JSON.parse(localStorage.getItem('patients') || '[]');
                existingData.unshift(record); // Add to beginning
                
                // Keep only latest 50000 records in localStorage to prevent memory issues
                if (existingData.length > 50000) {
                    existingData.splice(50000);
                }
                
                localStorage.setItem('patients', JSON.stringify(existingData));
                
                return true;
            } catch (error) {
                console.error('‚ùå Error saving record:', error);
                
                // Fallback to localStorage only
                try {
                    const existingData = JSON.parse(localStorage.getItem('patients') || '[]');
                    existingData.unshift(record);
                    
                    if (existingData.length > 50000) {
                        existingData.splice(50000);
                    }
                    
                    localStorage.setItem('patients', JSON.stringify(existingData));
                    return true;
                } catch (localError) {
                    console.error('‚ùå Error saving to localStorage:', localError);
                    return false;
                }
            }
        }
        
        // Add record to table with animation
        function addRecordToTable(record, recordNumber) {
            const tbody = document.getElementById('patientsTableBody');
            
            // Remove empty state if it exists
            if (tbody.querySelector('td[colspan="12"]')) {
                tbody.innerHTML = '';
            }
            
            // Limit display to 100 records to prevent performance issues
            const existingRows = tbody.querySelectorAll('tr');
            if (existingRows.length >= 100) {
                // Remove the last row
                existingRows[existingRows.length - 1].remove();
            }
            
            // Create new row
            const newRow = document.createElement('tr');
            newRow.className = 'table-row transition-all duration-300 border-b border-gray-100 bg-green-50 animate-slideInFromTop';
            newRow.innerHTML = `
                <td class="px-6 py-4 text-sm font-semibold text-gray-900">${record.‡πÇ‡∏£‡∏Ñ || record['‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                <td class="px-6 py-4 text-sm text-blue-600 font-medium">${record.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ || record['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡πÄ‡∏û‡∏® || record['‡πÄ‡∏û‡∏®'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ || record['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô || record['‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô || record['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡πÅ‡∏Ç‡∏ß‡∏á || record['‡πÅ‡∏Ç‡∏ß‡∏á'] || ''}</td>
                <td class="px-6 py-4 text-sm font-medium">${record.‡πÄ‡∏Ç‡∏ï || record['‡πÄ‡∏Ç‡∏ï'] || ''}</td>
                <td class="px-6 py-4 text-sm">${record.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î || record['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || ''}</td>
                <td class="px-6 py-4 text-sm">${convertExcelDateToThai(record.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢ || record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢'])}</td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${(record.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || record['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢']) === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${record.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || record['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'] || ''}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm">${convertExcelDateToThai(record.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï || record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])}</td>
            `;
            
            // Insert at the beginning
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // Remove highlight after animation
            setTimeout(() => {
                newRow.classList.remove('bg-green-50');
                newRow.classList.add(recordNumber % 2 === 0 ? 'bg-white' : 'bg-gray-50');
            }, 2000);
        }
        
        // Update progress statistics
        function updateProgressStats(processed, total, saved, valid, errors, startTime) {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const speed = Math.round(processed / elapsedTime);
            const remainingRecords = total - processed;
            const estimatedTimeRemaining = speed > 0 ? Math.round(remainingRecords / speed) : 0;
            const percentage = Math.round((processed / total) * 100);
            const savedPercentage = Math.round((saved / total) * 100);
            
            // Update progress bar and percentage
            document.getElementById('importPercentage').textContent = `${savedPercentage}%`;
            document.getElementById('progressBar').style.width = `${savedPercentage}%`;
            
            // Update counts
            updateImportCount(saved, total);
            document.getElementById('processedCount').textContent = processed.toLocaleString();
            document.getElementById('validCount').textContent = valid.toLocaleString();
            document.getElementById('errorCount').textContent = errors.toLocaleString();
            document.getElementById('importSpeed').textContent = `${speed.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            
            // Update time remaining
            if (estimatedTimeRemaining > 0) {
                const minutes = Math.floor(estimatedTimeRemaining / 60);
                const seconds = estimatedTimeRemaining % 60;
                document.getElementById('timeRemaining').textContent = 
                    minutes > 0 ? `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ` : `${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            } else {
                document.getElementById('timeRemaining').textContent = '‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß...';
            }
            
            // Update status message
            updateImportStatus(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${saved.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${savedPercentage}%) - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${processed.toLocaleString()}/${total.toLocaleString()}`);
        }
        
        // Finish import process
        function finishImportProcess(saved, valid, errors) {
            updateImportStatus(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${saved.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            // Update final statistics
            document.getElementById('importPercentage').textContent = '100%';
            document.getElementById('progressBar').style.width = '100%';
            
            // Change icon to success
            const icon = document.getElementById('importIcon');
            icon.classList.remove('animate-spin');
            icon.innerHTML = `
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            `;
            
            // Hide progress after delay and auto-refresh data
            setTimeout(async () => {
                document.getElementById('importProgressContainer').classList.add('hidden');
                
                // Auto-refresh data after import
                console.log('üîÑ Auto-refreshing data after import...');
                await autoRefreshData('import', saved);
                
                showImportSuccessNotification(saved, valid, errors);
            }, 2000);
        }

        // Legacy function - no longer used with real-time import
        async function finishImport(filteredData, validRecords, errorRecords) {
            // This function is kept for compatibility but not used in real-time import
            console.log('Legacy finishImport called - using real-time import instead');
        }

        // Save to Firebase with chunked uploads for large datasets
        async function saveToFirebaseWithProgress(path, data) {
            try {
                const { database, ref, set } = window.firebaseDB;
                const totalRecords = data.length;
                const CHUNK_SIZE = 2000; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞ 2,000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                
                updateImportStatus(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase...`);
                
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô chunks
                if (totalRecords > CHUNK_SIZE) {
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢...`);
                    
                    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                    await set(ref(database, path), null);
                    updateImportStatus(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...`);
                    
                    let savedRecords = 0;
                    const totalChunks = Math.ceil(totalRecords / CHUNK_SIZE);
                    let currentChunk = 0;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞ chunk
                    for (let i = 0; i < totalRecords; i += CHUNK_SIZE) {
                        currentChunk++;
                        const chunk = data.slice(i, Math.min(i + CHUNK_SIZE, totalRecords));
                        
                        try {
                            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å chunk ‡∏ô‡∏µ‡πâ‡∏•‡∏á Firebase
                            const chunkRef = ref(database, `${path}/chunk_${currentChunk}`);
                            await set(chunkRef, chunk);
                            
                            savedRecords += chunk.length;
                            const percentage = Math.round((savedRecords / totalRecords) * 100);
                            
                            updateImportStatus(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase: ${savedRecords.toLocaleString()}/${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${percentage}%) - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${currentChunk}/${totalChunks}`);
                            
                            console.log(`‚úÖ Saved chunk ${currentChunk}/${totalChunks}: ${chunk.length} records`);
                            
                            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Firebase ‡∏ñ‡∏π‡∏Å rate limit
                            if (currentChunk < totalChunks) {
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                            
                        } catch (chunkError) {
                            console.error(`‚ùå Error saving chunk ${currentChunk}:`, chunkError);
                            updateImportStatus(`‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${currentChunk} - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...`);
                            
                            // ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            try {
                                const retryChunkRef = ref(database, `${path}/chunk_${currentChunk}`);
                                await set(retryChunkRef, chunk);
                                savedRecords += chunk.length;
                                console.log(`‚úÖ Retry successful for chunk ${currentChunk}`);
                            } catch (retryError) {
                                console.error(`‚ùå Retry failed for chunk ${currentChunk}:`, retryError);
                                throw retryError;
                            }
                        }
                    }
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° chunks
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢...`);
                    await set(ref(database, path), data);
                    
                    // ‡∏•‡∏ö chunks ‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÑ‡∏ß‡πâ
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß...`);
                    for (let i = 1; i <= totalChunks; i++) {
                        try {
                            await set(ref(database, `${path}/chunk_${i}`), null);
                        } catch (cleanupError) {
                            console.warn(`Warning: Could not cleanup chunk ${i}:`, cleanupError);
                        }
                    }
                    
                    updateImportStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    
                } else {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                    updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á Firebase...`);
                    await set(ref(database, path), data);
                    updateImportStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                }
                
                console.log(`‚úÖ Successfully saved ${totalRecords.toLocaleString()} records to Firebase: ${path}`);
                return true;
                
            } catch (error) {
                console.error(`‚ùå Error saving to Firebase (${path}):`, error);
                updateImportStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÑ‡∏î‡πâ - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô`);
                
                // Fallback to localStorage
                try {
                    localStorage.setItem(path.replace('/', '_'), JSON.stringify(data));
                    updateImportStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${data.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                } catch (localError) {
                    console.error('‚ùå Error saving to localStorage:', localError);
                    updateImportStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ`);
                }
                return false;
            }
        }

        // Optimized saving for large datasets with better memory management
        function simulateSavingProgress(filteredData, validRecords, errorRecords, firebaseSaved = false) {
            const totalRecords = filteredData.length;
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏•‡∏≠‡∏á
            if (totalRecords > 50000) {
                updateImportStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);
                
                const saveFunction = () => {
                    try {
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡πÄ‡∏õ‡πá‡∏ô backup
                        updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á...');
                        
                        // ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡πÄ‡∏õ‡πá‡∏ô chunks ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á
                        const localStorageChunkSize = 10000;
                        const chunks = [];
                        
                        for (let i = 0; i < totalRecords; i += localStorageChunkSize) {
                            const chunk = filteredData.slice(i, Math.min(i + localStorageChunkSize, totalRecords));
                            chunks.push(chunk);
                        }
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å metadata
                        localStorage.setItem('patients_metadata', JSON.stringify({
                            totalRecords: totalRecords,
                            chunks: chunks.length,
                            timestamp: Date.now(),
                            firebaseSaved: firebaseSaved
                        }));
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ chunk
                        chunks.forEach((chunk, index) => {
                            localStorage.setItem(`patients_chunk_${index}`, JSON.stringify(chunk));
                        });
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility)
                        localStorage.setItem('patients', JSON.stringify(filteredData));
                        
                        // ‡∏•‡πâ‡∏≤‡∏á memory
                        filteredData.length = 0;
                        chunks.length = 0;
                        
                        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
                        document.getElementById('importPercentage').textContent = '100%';
                        document.getElementById('progressBar').style.width = '100%';
                        updateImportStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
                        
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô icon ‡πÄ‡∏õ‡πá‡∏ô success
                        const icon = document.getElementById('importIcon');
                        icon.classList.remove('animate-spin');
                        icon.innerHTML = `
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                        `;
                        
                        // ‡∏ã‡πà‡∏≠‡∏ô progress ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        setTimeout(async () => {
                            document.getElementById('importProgressContainer').classList.add('hidden');
                            
                            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                            console.log('üîÑ Refreshing data from Firebase...');
                            await initializeData();
                            
                            loadPatientsTable();
                            showImportSuccessNotification(totalRecords, validRecords, errorRecords);
                            
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ memory
                            console.log(`üíæ Data saved successfully:`);
                            console.log(`   - Total records: ${totalRecords.toLocaleString()}`);
                            console.log(`   - Firebase: ${firebaseSaved ? 'Yes' : 'No'}`);
                            console.log(`   - LocalStorage chunks: ${chunks.length}`);
                            console.log(`   - Memory freed: ~${Math.round(totalRecords * 0.5 / 1024)} MB`);
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error saving large dataset:', error);
                        
                        // ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
                        try {
                            // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                            const essentialData = filteredData.map(record => ({
                                '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ': record['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'],
                                '‡πÄ‡∏û‡∏®': record['‡πÄ‡∏û‡∏®'],
                                '‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ': record['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'],
                                '‡πÄ‡∏Ç‡∏ï': record['‡πÄ‡∏Ç‡∏ï'],
                                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢': record['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢'],
                                '‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢': record['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢']
                            }));
                            
                            localStorage.setItem('patients', JSON.stringify(essentialData));
                            updateImportStatus(`‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${essentialData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                            
                            setTimeout(async () => {
                                document.getElementById('importProgressContainer').classList.add('hidden');
                                
                                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                console.log('üîÑ Refreshing data from Firebase...');
                                await initializeData();
                                
                                loadPatientsTable();
                                showImportSuccessNotification(essentialData.length, validRecords, errorRecords);
                            }, 1500);
                            
                        } catch (fallbackError) {
                            console.error('Fallback save also failed:', fallbackError);
                            updateImportStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ');
                            
                            // ‡πÅ‡∏™‡∏î‡∏á error notification
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
                            errorDiv.innerHTML = `
                                <div class="flex items-start">
                                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                                    </svg>
                                    <div>
                                        <div class="font-bold mb-1">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ</div>
                                        <div class="text-sm opacity-90">
                                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)<br>
                                            ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ‡πÜ (< 100,000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                                        </div>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(errorDiv);
                            
                            setTimeout(() => {
                                errorDiv.remove();
                                document.getElementById('importProgressContainer').classList.add('hidden');
                            }, 10000);
                        }
                    }
                };
                
                // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
                setTimeout(saveFunction, 500);
                return;
            }
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ñ‡∏∂‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
            const chunkSize = Math.max(1, Math.floor(totalRecords / 20));
            let savedRecords = 0;
            
            function saveChunk() {
                const recordsToSave = Math.min(chunkSize, totalRecords - savedRecords);
                savedRecords += recordsToSave;
                
                const savePercentage = Math.round((savedRecords / totalRecords) * 100);
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó progress bar ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                document.getElementById('importPercentage').textContent = `${savePercentage}%`;
                document.getElementById('progressBar').style.width = `${savePercentage}%`;
                updateImportCount(savedRecords, totalRecords);
                document.getElementById('processedCount').textContent = savedRecords.toLocaleString();
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                if (savePercentage < 30) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                } else if (savePercentage < 60) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö...');
                } else if (savePercentage < 90) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
                } else if (savePercentage < 100) {
                    updateImportStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                } else {
                    updateImportStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
                }
                
                // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                if (savedRecords < totalRecords) {
                    setTimeout(saveChunk, 30); // ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å
                } else {
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô icon ‡πÄ‡∏õ‡πá‡∏ô success
                    const icon = document.getElementById('importIcon');
                    icon.classList.remove('animate-spin');
                    icon.innerHTML = `
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    `;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                    localStorage.setItem('patients', JSON.stringify(filteredData));
                    
                    // ‡∏ã‡πà‡∏≠‡∏ô progress ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    setTimeout(async () => {
                        document.getElementById('importProgressContainer').classList.add('hidden');
                        
                        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        console.log('üîÑ Refreshing data from Firebase...');
                        await initializeData();
                        
                        loadPatientsTable();
                        showImportSuccessNotification(filteredData.length, validRecords, errorRecords);
                    }, 1000);
                }
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            saveChunk();
        }

        // Show import success notification
        function showImportSuccessNotification(total, valid, errors) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm';
            successDiv.innerHTML = `
                <div class="flex items-start">
                    <svg class="w-6 h-6 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    </svg>
                    <div>
                        <div class="font-bold mb-1">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
                        <div class="text-sm opacity-90">
                            ‚Ä¢ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
                            ‚Ä¢ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${valid.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
                            ${errors > 0 ? `‚Ä¢ ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errors.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Utility functions for date conversion
        function convertThaiYearToChristian(thaiYear) {
            if (!thaiYear) return '';
            const year = parseInt(thaiYear);
            return year > 2400 ? year - 543 : year;
        }

        function convertChristianYearToThai(christianYear) {
            if (!christianYear) return '';
            const year = parseInt(christianYear);
            return year < 2400 ? year + 543 : year;
        }

        function formatDateTH(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            
            const day = parts[0];
            const month = parts[1];
            let year = parts[2];
            
            // Convert Thai year to Christian year if needed
            year = convertThaiYearToChristian(year);
            
            return `${day}/${month}/${year}`;
        }

        // Convert Excel date serial number to Christian date format
        function convertExcelDateToChristian(excelDate) {
            if (!excelDate || excelDate === '') return '';
            
            // If it's already a date string, convert Thai year to Christian year
            if (typeof excelDate === 'string' && excelDate.includes('/')) {
                return formatDateTH(excelDate);
            }
            
            // Convert Excel serial number to JavaScript Date
            const serialNumber = parseInt(excelDate);
            if (isNaN(serialNumber) || serialNumber <= 0) return '';
            
            // Excel date starts from January 1, 1900 (but Excel incorrectly treats 1900 as leap year)
            const excelEpoch = new Date(1900, 0, 1);
            const jsDate = new Date(excelEpoch.getTime() + (serialNumber - 2) * 24 * 60 * 60 * 1000);
            
            // Format as DD/MM/YYYY (Christian year)
            const day = jsDate.getDate().toString().padStart(2, '0');
            const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
            const year = jsDate.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // Pagination variables
        let currentPage = 1;
        let recordsPerPage = 50; // Show 50 records per page
        let filteredPatients = [];
        let allPatients = [];
        
        // Import control variables
        let importCancelled = false;
        let currentImportProcess = null;

        // Load patients table with pagination
        async function loadPatientsTable(searchTerm = '') {
            console.log('üîÑ Loading patients table...');
            
            // Use global variables if available (for real-time import)
            if (window.allPatients && window.allPatients.length > 0) {
                allPatients = window.allPatients;
                console.log(`üìä Using cached patients data: ${allPatients.length}`);
            } else {
                // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô
                allPatients = await loadFromFirebase('patients');
                console.log(`üìä Total patients loaded from Firebase: ${allPatients.length}`);
                
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage
                if (allPatients.length === 0) {
                    console.log('üîç No data from Firebase, checking localStorage...');
                    const localData = localStorage.getItem('patients');
                    if (localData) {
                        try {
                            const parsedData = JSON.parse(localData);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                allPatients = parsedData;
                                console.log(`‚úÖ Loaded ${allPatients.length} patients from localStorage`);
                            }
                        } catch (error) {
                            console.error('‚ùå Error parsing localStorage patients data:', error);
                        }
                    }
                }
            }
            
            // Filter patients based on search term
            if (searchTerm) {
                filteredPatients = allPatients.filter(patient => {
                    const searchFields = [
                        patient.‡πÇ‡∏£‡∏Ñ || patient['‡πÇ‡∏£‡∏Ñ'] || '',
                        patient.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ || patient['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || '',
                        patient.‡πÄ‡∏û‡∏® || patient['‡πÄ‡∏û‡∏®'] || '',
                        patient.‡πÅ‡∏Ç‡∏ß‡∏á || patient['‡πÅ‡∏Ç‡∏ß‡∏á'] || '',
                        patient.‡πÄ‡∏Ç‡∏ï || patient['‡πÄ‡∏Ç‡∏ï'] || '',
                        patient.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î || patient['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || ''
                    ];
                    return searchFields.some(field => 
                        field.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                });
            } else {
                filteredPatients = [...allPatients];
            }

            const tbody = document.getElementById('patientsTableBody');
            
            if (filteredPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-6 py-20 text-center text-gray-500">
                            <div class="text-6xl mb-4">üìã</div>
                            <p class="font-semibold text-xl text-gray-700">${searchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'}</p>
                            <p class="text-gray-500 mt-2">${searchTerm ? '‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel'}</p>
                        </td>
                    </tr>
                `;
                updatePaginationInfo(0, 0, 0);
                return;
            }

            // Calculate pagination
            const totalRecords = filteredPatients.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const currentPageData = filteredPatients.slice(startIndex, endIndex);

            // Render current page data
            tbody.innerHTML = currentPageData.map((patient, index) => {
                const globalIndex = startIndex + index;
                return `
                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${globalIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-6 py-4 text-sm font-semibold text-gray-900">${patient.‡πÇ‡∏£‡∏Ñ || patient['‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                        <td class="px-6 py-4 text-sm text-blue-600 font-medium">${patient.‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ || patient['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡πÄ‡∏û‡∏® || patient['‡πÄ‡∏û‡∏®'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏µ'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô || patient['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡πÅ‡∏Ç‡∏ß‡∏á || patient['‡πÅ‡∏Ç‡∏ß‡∏á'] || ''}</td>
                        <td class="px-6 py-4 text-sm font-medium">${patient.‡πÄ‡∏Ç‡∏ï || patient['‡πÄ‡∏Ç‡∏ï'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${patient.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î || patient['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || ''}</td>
                        <td class="px-6 py-4 text-sm">${convertExcelDateToThai(patient.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢ || patient['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢'])}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${(patient.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || patient['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢']) === '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${patient.‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ || patient['‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'] || ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">${convertExcelDateToThai(patient.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï || patient['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'])}</td>
                    </tr>
                `;
            }).join('');

            // Update pagination info
            updatePaginationInfo(totalRecords, currentPage, totalPages);
            updatePaginationControls(totalPages);
            
            console.log(`Table updated: Page ${currentPage}/${totalPages}, showing ${currentPageData.length} of ${totalRecords} records`);
        }

        // Update pagination information display
        function updatePaginationInfo(totalRecords, currentPage, totalPages) {
            const startRecord = totalRecords > 0 ? ((currentPage - 1) * recordsPerPage) + 1 : 0;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
            
            document.getElementById('paginationInfo').textContent = 
                `‡πÅ‡∏™‡∏î‡∏á ${startRecord.toLocaleString()} - ${endRecord.toLocaleString()} ‡∏à‡∏≤‡∏Å ${totalRecords.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // Update pagination controls
        function updatePaginationControls(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            
            if (totalPages <= 1) {
                paginationControls.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 ${currentPage === 1 ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
                <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border-t border-b border-gray-300 hover:bg-gray-50 ${currentPage === 1 ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
            `;

            // Show page numbers (max 5 pages around current page)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="goToPage(${i})" 
                            class="px-3 py-2 text-sm font-medium border-t border-b border-gray-300 ${i === currentPage ? 'bg-blue-50 text-blue-600 border-blue-500' : 'text-gray-500 bg-white hover:bg-gray-50 hover:text-gray-700'}">
                        ${i}
                    </button>
                `;
            }

            paginationHTML += `
                <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border-t border-b border-gray-300 hover:bg-gray-50 ${currentPage === totalPages ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                </button>
                <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 ${currentPage === totalPages ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-700'}">
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                </button>
            `;

            paginationControls.innerHTML = paginationHTML;
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredPatients.length / recordsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadPatientsTable(document.getElementById('searchInput').value);
            }
        }

        // Change records per page
        function changeRecordsPerPage(newRecordsPerPage) {
            recordsPerPage = parseInt(newRecordsPerPage);
            currentPage = 1; // Reset to first page
            loadPatientsTable(document.getElementById('searchInput').value);
        }

        // Search patients
        function searchPatients() {
            const searchTerm = document.getElementById('searchInput').value;
            currentPage = 1; // Reset to first page when searching
            loadPatientsTable(searchTerm);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentPage = 1;
            loadPatientsTable();
        }

        // Show master data detail
        function showMasterDataDetail(type) {
            document.getElementById('masterDataPage').classList.add('hidden');
            const detailPage = document.getElementById('masterDataDetailPage');
            detailPage.classList.remove('hidden');
            detailPage.classList.add('slide-in');
            
            const titles = {
                'diseases': '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ',
                'responsible': '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                'population': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
                'agePopulation': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏',
                'thailandPopulation': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢',
                'bangkokDistricts': '‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
                'epidemicWeeks': '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î',
                'diseaseHistory': '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á'
            };
            
            document.getElementById('masterDataDetailTitle').textContent = titles[type];
            
            // Set up add button
            const addButton = document.getElementById('addNewButton');
            addButton.onclick = () => addNewMasterData(type);
            
            // Set up import button for diseases
            const buttonContainer = addButton.parentElement;
            
            // Remove existing import button if any
            const existingImportBtn = document.getElementById('importExcelButton');
            if (existingImportBtn) {
                existingImportBtn.remove();
            }
            
            if (type === 'diseases' || type === 'responsible' || type === 'population' || type === 'thailandPopulation' || type === 'bangkokDistricts' || type === 'epidemicWeeks') {
                const importButton = document.createElement('button');
                importButton.id = 'importExcelButton';
                importButton.className = 'btn-secondary text-sm flex items-center ml-2';
                importButton.onclick = () => {
                    switch (type) {
                        case 'diseases':
                            showImportDiseaseModal();
                            break;
                        case 'responsible':
                            showImportResponsibleModal();
                            break;
                        case 'population':
                            showImportPopulationModal();
                            break;
                        case 'thailandPopulation':
                            showImportThailandPopulationModal();
                            break;
                        case 'bangkokDistricts':
                            showImportBangkokDistrictsModal();
                            break;
                        case 'epidemicWeeks':
                            showImportEpidemicWeeksModal();
                            break;
                        case 'diseaseHistory':
                            showImportDiseaseHistoryModal();
                            break;
                    }
                };
                importButton.innerHTML = `
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                    </svg>
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                `;
                buttonContainer.appendChild(importButton);
            }
            
            loadMasterDataDetail(type);
        }

        // Load master data detail content (same as before but with better styling)
        async function loadMasterDataDetail(type) {
            const content = document.getElementById('masterDataDetailContent');
            
            switch(type) {
                case 'diseases':
                    await loadDiseasesTable();
                    break;
                case 'responsible':
                    await loadResponsibleTable();
                    break;
                case 'population':
                    loadPopulationTable();
                    break;
                case 'agePopulation':
                    loadAgePopulationTable();
                    break;
                case 'thailandPopulation':
                    await loadThailandPopulationTable();
                    break;
                case 'bangkokDistricts':
                    await loadBangkokDistrictsTable();
                    break;
                case 'epidemicWeeks':
                    loadEpidemicWeeksTable();
                    break;
                case 'diseaseHistory':
                    loadDiseaseHistoryTable();
                    break;
            }
        }

        // Load disease history table
        async function loadDiseaseHistoryTable() {
            const diseases = await loadFromFirebase('diseases');
            const diseaseHistory = await loadFromFirebase('diseaseHistory') || [];
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-3">
                                <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2 1h10v8H5V6z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                                <p class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-purple-50 to-blue-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏°.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏Å.‡∏û.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏°‡∏µ.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏°.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏û.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏°‡∏¥.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏Å.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏™.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏Å.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏ï.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏û.‡∏¢.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏ò.‡∏Ñ.</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏£‡∏ß‡∏°</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${diseaseHistory.length === 0 ? `
                                <tr>
                                    <td colspan="18" class="px-6 py-4">
                                        <div class="text-center text-gray-500 mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                                        <div class="flex justify-center space-x-4">
                                            <button onclick="showDiseaseHistoryForm()" class="btn-primary text-sm px-4 py-2">
                                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                                </svg>
                                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ
                                            </button>
                                            <button onclick="showImportDiseaseHistoryModal()" class="btn-secondary text-sm px-4 py-2">
                                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                                </svg>
                                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ` : diseaseHistory.map((record, index) => {
                                const disease = diseases.find(d => d.code === record.diseaseCode);
                                const totalPatients = Object.values(record.months).reduce((sum, month) => sum + (month.patients || 0), 0);
                                const totalDeaths = Object.values(record.months).reduce((sum, month) => sum + (month.deaths || 0), 0);
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${record.year}</td>
                                        <td class="px-6 py-4 text-sm font-medium text-blue-600">${record.diseaseCode}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${disease ? disease.name : '-'}</td>
                                        ${['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].map(month => `
                                            <td class="px-6 py-4 text-sm text-center">
                                                <div class="text-blue-600">${record.months[month]?.patients || 0}</div>
                                                <div class="text-red-600">${record.months[month]?.deaths || 0}</div>
                                            </td>
                                        `).join('')}
                                        <td class="px-6 py-4 text-sm text-center font-medium">
                                            <div class="text-blue-600">${totalPatients}</div>
                                            <div class="text-red-600">${totalDeaths}</div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-center">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="editDiseaseHistory(${index})" class="text-blue-600 hover:text-blue-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deleteDiseaseHistory(${index})" class="text-red-600 hover:text-red-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="p-4 border-t">
                        <div class="flex justify-end space-x-4">
                            <button onclick="showDiseaseHistoryForm()" class="btn-primary text-sm px-4 py-2">
                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                </svg>
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ
                            </button>
                            <button onclick="showImportDiseaseHistoryModal()" class="btn-secondary text-sm px-4 py-2">
                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show import disease history modal
        function showImportDiseaseHistoryModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importDiseaseHistoryModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-800 to-blue-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                        </h3>
                        <button onclick="closeImportDiseaseHistoryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="text-sm text-blue-700 space-y-2 list-decimal pl-4">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel</li>
                                <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</li>
                                <li>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                            </ol>
                        </div>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                            <input type="file" id="diseaseHistoryExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleDiseaseHistoryFileSelect(this)">
                            <label for="diseaseHistoryExcelFile" class="block text-center cursor-pointer">
                                <svg class="w-8 h-8 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                <span class="text-sm text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</span>
                            </label>
                        </div>
                        
                        <div id="diseaseHistoryFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowDiseaseHistory" class="form-checkbox" checked>
                            <label for="skipFirstRowDiseaseHistory" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingDiseaseHistory" class="form-checkbox">
                            <label for="replaceExistingDiseaseHistory" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadDiseaseHistoryExample()" class="text-blue-600 hover:text-blue-800 text-sm">
                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L9 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportDiseaseHistoryModal()" class="btn-secondary text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button onclick="processDiseaseHistoryImport()" id="importDiseaseHistoryButton" class="btn-primary text-sm" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Download disease history example file
        function downloadDiseaseHistoryExample() {
            const wb = XLSX.utils.book_new();
            
            // Create headers
            const headers = [
                '‡∏õ‡∏µ (‡∏Ñ.‡∏®.)',
                '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
                '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢_‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï_‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];
            
            // Example data
            const exampleData = [
                ['2023', 'D01', 100, 5, 120, 6, 90, 4, 110, 5, 95, 4, 105, 6, 115, 7, 98, 5, 88, 4, 92, 5, 102, 6, 108, 5],
                ['2023', 'D02', 80, 4, 85, 5, 75, 3, 95, 6, 88, 4, 92, 5, 86, 4, 90, 5, 82, 4, 87, 5, 84, 4, 89, 5]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...exampleData]);
            
            // Set column widths
            const colWidths = headers.map(() => ({ wch: 15 }));
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, 'DiseaseHistory');
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á.xlsx');
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Handle disease history file select
        function handleDiseaseHistoryFileSelect(input) {
            const fileInfo = document.getElementById('diseaseHistoryFileInfo');
            const importButton = document.getElementById('importDiseaseHistoryButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                fileInfo.textContent = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${file.name}`;
                importButton.disabled = false;
            } else {
                fileInfo.textContent = '';
                importButton.disabled = true;
            }
        }

        // Close import disease history modal
        function closeImportDiseaseHistoryModal() {
            const modal = document.getElementById('importDiseaseHistoryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Process disease history import
        async function processDiseaseHistoryImport() {
            const fileInput = document.getElementById('diseaseHistoryExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowDiseaseHistory').checked;
            const replaceExisting = document.getElementById('replaceExistingDiseaseHistory').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importDiseaseHistoryButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    const startRow = skipFirstRow ? 1 : 0;
                    const diseaseHistory = replaceExisting ? [] : (await loadFromFirebase('diseaseHistory') || []);
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 26) continue; // Skip invalid rows
                        
                        const record = {
                            year: row[0].toString(),
                            diseaseCode: row[1].toString(),
                            months: {}
                        };
                        
                        // Process monthly data
                        for (let month = 1; month <= 12; month++) {
                            const monthStr = month.toString().padStart(2, '0');
                            const patientIndex = (month - 1) * 2 + 2;
                            const deathIndex = patientIndex + 1;
                            
                            const patients = parseInt(row[patientIndex]);
                            const deaths = parseInt(row[deathIndex]);
                            
                            if (!isNaN(patients) || !isNaN(deaths)) {
                                record.months[monthStr] = {
                                    patients: isNaN(patients) ? 0 : patients,
                                    deaths: isNaN(deaths) ? 0 : deaths
                                };
                            }
                        }
                        
                        diseaseHistory.push(record);
                    }
                    
                    await saveToFirebase('diseaseHistory', diseaseHistory);
                    await loadDiseaseHistoryTable();
                    
                    showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    closeImportDiseaseHistoryModal();
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error importing disease history:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Function to show the form for adding/editing disease history
        function showDiseaseHistoryForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á';
            
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'diseaseHistoryModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-6xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-800 to-blue-600 bg-clip-text text-transparent">
                            üìä ${title}
                        </h3>
                        <button onclick="closeDiseaseHistoryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="diseaseHistoryForm" onsubmit="saveDiseaseHistoryData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</label>
                                <input type="number" id="historyYear" required min="1900" max="2100"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</label>
                                <select id="historyDiseaseCode" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                            <h4 class="text-lg font-semibold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                ${['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].map(month => `
                                    <div class="p-4 border rounded-lg">
                                        <h5 class="font-medium mb-2">${getThaiMonth(month)}</h5>
                                        <div class="space-y-2">
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                                                <input type="number" id="patients_${month}" min="0"
                                                    class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</label>
                                                <input type="number" id="deaths_${month}" min="0"
                                                    class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 btn-primary bg-gradient-to-r from-purple-600 to-blue-600">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeDiseaseHistoryModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            loadDiseaseOptionsForHistory();
            
            if (isEdit) {
                populateDiseaseHistoryForm(editIndex);
            }
        }

        // Helper function to get Thai month name
        function getThaiMonth(monthNumber) {
            const months = {
                '01': '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
                '02': '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
                '03': '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
                '04': '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
                '05': '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
                '06': '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '07': '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
                '08': '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
                '09': '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
                '10': '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
                '11': '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
                '12': '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            };
            return months[monthNumber];
        }

        // Load disease options for the history form
        async function loadDiseaseOptionsForHistory() {
            const diseases = await loadFromFirebase('diseases');
            const select = document.getElementById('historyDiseaseCode');
            
            if (select) {
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>';
                diseases.forEach(disease => {
                    const option = document.createElement('option');
                    option.value = disease.code;
                    option.textContent = `${disease.code} - ${disease.name}`;
                    select.appendChild(option);
                });
            }
        }

        // Close disease history modal
        function closeDiseaseHistoryModal() {
            const modal = document.getElementById('diseaseHistoryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Add new disease history entry
        function addNewDiseaseHistory() {
            showDiseaseHistoryForm();
        }

        // Populate form with existing data for editing
        async function populateDiseaseHistoryForm(index) {
            const diseaseHistory = await loadFromFirebase('diseaseHistory');
            const record = diseaseHistory[index];
            
            if (record) {
                document.getElementById('historyYear').value = record.year;
                document.getElementById('historyDiseaseCode').value = record.diseaseCode;
                
                // Populate monthly data
                Object.entries(record.months).forEach(([month, data]) => {
                    if (data.patients) document.getElementById(`patients_${month}`).value = data.patients;
                    if (data.deaths) document.getElementById(`deaths_${month}`).value = data.deaths;
                });
            }
        }

        // Save disease history data
        async function saveDiseaseHistoryData(event, editIndex = null) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const diseaseHistory = await loadFromFirebase('diseaseHistory') || [];
                const year = document.getElementById('historyYear').value;
                const diseaseCode = document.getElementById('historyDiseaseCode').value;
                
                const months = {};
                ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].forEach(month => {
                    const patients = parseInt(document.getElementById(`patients_${month}`).value) || 0;
                    const deaths = parseInt(document.getElementById(`deaths_${month}`).value) || 0;
                    if (patients > 0 || deaths > 0) {
                        months[month] = { patients, deaths };
                    }
                });
                
                const newRecord = {
                    year,
                    diseaseCode,
                    months
                };
                
                if (editIndex !== null) {
                    diseaseHistory[editIndex] = newRecord;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    diseaseHistory.push(newRecord);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                await saveToFirebase('diseaseHistory', diseaseHistory);
                closeDiseaseHistoryModal();
                await loadDiseaseHistoryTable();
                
            } catch (error) {
                console.error('Error saving disease history:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Delete disease history entry
        async function deleteDiseaseHistory(index) {
            const diseaseHistory = await loadFromFirebase('diseaseHistory');
            const record = diseaseHistory[index];
            
            if (!record) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const disease = (await loadFromFirebase('diseases')).find(d => d.code === record.diseaseCode);
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏õ‡∏µ: ${record.year}\n‡πÇ‡∏£‡∏Ñ: ${disease ? disease.name : record.diseaseCode}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    diseaseHistory.splice(index, 1);
                    await saveToFirebase('diseaseHistory', diseaseHistory);
                    await loadDiseaseHistoryTable();
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } catch (error) {
                    console.error('Error deleting disease history:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Edit disease history entry
        function editDiseaseHistory(index) {
            showDiseaseHistoryForm(index);
        }

        // Enhanced table loading functions with better styling
        async function loadDiseasesTable() {
            const diseases = await loadFromFirebase('diseases');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                <div class="text-2xl font-bold text-blue-600">${diseases.length}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${diseases.length === 0 ? 
                                `<tr><td colspan="4" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">üìã</div>
                                    <p class="font-semibold text-xl text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ</p>
                                    <p class="text-gray-500 mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                                    <div class="flex justify-center space-x-4">
                                        <button onclick="addNewMasterData('diseases')" class="btn-primary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                            </svg>
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ
                                        </button>
                                    </div>
                                </td></tr>` :
                                diseases.map((disease, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                        <td class="px-6 py-4 text-sm text-gray-600">${index + 1}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${disease.code}</td>
                                        <td class="px-6 py-4 font-semibold text-gray-900">${disease.name}</td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="editDisease(${index})" class="text-blue-600 hover:text-blue-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deleteDisease(${index})" class="text-red-600 hover:text-red-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                ${diseases.length > 0 ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                        </h4>
                        <div class="text-sm text-gray-600">
                            <p>‚Ä¢ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong class="text-blue-600">${diseases.length}</strong> ‡πÇ‡∏£‡∏Ñ</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                            <p>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô</p>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Similar enhanced styling for other table functions...
        async function loadResponsibleTable() {
            const responsible = await loadFromFirebase('responsible');
            const diseases = await loadFromFirebase('diseases');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
                                <div class="text-2xl font-bold text-blue-600">${responsible.length}</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
                                <div class="text-2xl font-bold text-green-600">${responsible.length}</div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${responsible.length === 0 ? 
                                `<tr><td colspan="8" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">ÔøΩ</div>
                                    <p class="font-semibold text-xl text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                                    <p class="text-gray-500 mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                                    <div class="flex justify-center space-x-4">
                                        <button onclick="addNewMasterData('responsible')" class="btn-primary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                            </svg>
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                                        </button>
                                        <button onclick="showImportExcelModal('responsible')" class="btn-secondary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                            </svg>
                                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                                        </button>
                                    </div>
                                </td></tr>` :
                                responsible.map((resp, index) => {
                                    const disease = diseases.find(d => d.code === resp.diseaseCode);
                                    return `
                                        <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                            <td class="px-6 py-4 text-sm text-gray-600">${index + 1}</td>
                                            <td class="px-6 py-4 font-bold text-blue-600">${resp.diseaseCode}</td>
                                            <td class="px-6 py-4 font-semibold text-gray-900">${disease ? disease.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ'}</td>
                                            <td class="px-6 py-4 font-medium text-gray-900">${resp.responsibleName}</td>
                                            <td class="px-6 py-4 text-gray-600">${resp.responsiblePosition}</td>
                                            <td class="px-6 py-4 font-medium text-gray-900">${resp.reviewerName}</td>
                                            <td class="px-6 py-4 text-gray-600">${resp.reviewerPosition}</td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex justify-center space-x-2">
                                                    <button onclick="editResponsible(${index})" class="text-blue-600 hover:text-blue-900 transition-colors p-1 rounded">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                        </svg>
                                                    </button>
                                                    <button onclick="deleteResponsible(${index})" class="text-red-600 hover:text-red-900 transition-colors p-1 rounded">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                ${responsible.length > 0 ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                        </h4>
                        <div class="text-sm text-gray-600">
                            <p>‚Ä¢ ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong class="text-blue-600">${responsible.length}</strong> ‡∏Ñ‡∏ô</p>
                            <p>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                            <p>‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</p>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Enhanced population table with full functionality
        async function loadPopulationTable() {
            const population = await loadFromFirebase('population');
            const content = document.getElementById('masterDataDetailContent');
            
            // Calculate totals for summary
            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
            const dataByYear = population.reduce((acc, pop) => {
                const year = pop.year || 2568; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                if (!acc[year]) {
                    acc[year] = {
                        totalPopulation: 0,
                        totalMale: 0,
                        totalFemale: 0,
                        districtCount: 0
                    };
                }
                acc[year].totalPopulation += parseInt(pop.totalPopulation || pop.malePopulation + pop.femalePopulation || 0);
                acc[year].totalMale += parseInt(pop.malePopulation || 0);
                acc[year].totalFemale += parseInt(pop.femalePopulation || 0);
                acc[year].districtCount += 1;
                return acc;
            }, {});

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
            const years = Object.keys(dataByYear).sort((a, b) => b - a);
            
            content.innerHTML = `
                ${years.map(year => `
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-900 mb-4 text-xl flex items-center">
                            <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">‡∏õ‡∏µ ${year}</span>
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°</div>
                                <div class="text-2xl font-bold text-blue-600">${dataByYear[year].totalPopulation.toLocaleString()} ‡∏Ñ‡∏ô</div>
                                <div class="text-sm text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${dataByYear[year].districtCount} ‡πÄ‡∏Ç‡∏ï</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</div>
                                <div class="text-2xl font-bold text-green-600">${dataByYear[year].totalMale.toLocaleString()} ‡∏Ñ‡∏ô</div>
                                <div class="text-sm text-gray-500 mt-1">${((dataByYear[year].totalMale/dataByYear[year].totalPopulation)*100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-gradient-to-r from-pink-50 to-pink-100 rounded-lg p-4 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</div>
                                <div class="text-2xl font-bold text-pink-600">${dataByYear[year].totalFemale.toLocaleString()} ‡∏Ñ‡∏ô</div>
                                <div class="text-sm text-gray-500 mt-1">${((dataByYear[year].totalFemale/dataByYear[year].totalPopulation)*100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `).join('')}

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏µ</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${population.length === 0 ? 
                                `<tr><td colspan="6" class="px-6 py-20 text-center text-gray-500">
                                    <div class="text-6xl mb-4">üèôÔ∏è</div>
                                    <p class="font-semibold text-xl text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</p>
                                    <p class="text-gray-500 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</p>
                                    <div class="flex justify-center space-x-4">
                                        <button onclick="addNewMasterData('population')" class="btn-primary text-sm">
                                            <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                                            </svg>
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                                        </button>
                                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                                        </button>
                                    </div>
                                </td></tr>` :
                                population.map((pop, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                        <td class="px-6 py-4 text-sm text-gray-600">${pop.year || 2568}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${pop.district}</td>
                                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${(pop.totalPopulation || pop.malePopulation + pop.femalePopulation).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-blue-600">${pop.malePopulation.toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${pop.femalePopulation.toLocaleString()}</td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="flex justify-center space-x-2">
                                                <button onclick="editPopulation(${index})" class="text-blue-600 hover:text-blue-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deletePopulation(${index})" class="text-red-600 hover:text-red-900 transition-colors p-1 rounded">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                ${population.length > 0 ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg">
                        <div class="text-sm text-gray-600">
                            <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</p>
                            <p class="mt-1">‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
                        </div>
                    </div>
                    </div>
                ` : ''}
            `;
        }

        async function loadAgePopulationTable() {
            const agePopulation = await loadFromFirebase('agePopulation');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</div>
                                <div class="text-2xl font-bold text-blue-600">${agePopulation.length}</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3">
                                <div class="text-gray-600 text-sm">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°</div>
                                <div class="text-2xl font-bold text-green-600">${agePopulation.reduce((sum, p) => sum + parseInt(p.total), 0).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showImportAgePopulationModal()" class="btn-secondary text-sm">
                                <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${agePopulation.length === 0 ? 
                                '<tr><td colspan="6" class="px-6 py-20 text-center text-gray-500"><div class="text-6xl mb-4">üë•</div><p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p><p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</p></td></tr>' :
                                agePopulation.map((age, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 font-semibold text-gray-900">${age.year}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${age.ageGroup}</td>
                                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${age.total ? parseInt(age.total).toLocaleString() : ''}</td>
                                        <td class="px-6 py-4 text-right text-blue-600">${age.male ? parseInt(age.male).toLocaleString() : ''}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${age.female ? parseInt(age.female).toLocaleString() : ''}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="editAgePopulation(${index})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:from-blue-600 hover:to-blue-700 mr-2 transition-all transform hover:scale-105">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteAgePopulation(${index})" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg text-sm hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Show import Bangkok Districts modal
        function showImportBangkokDistrictsModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importBangkokDistrictsModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <h2 class="text-2xl font-bold mb-6">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span></p>
                                    <p class="text-xs text-gray-500">Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (.xlsx, .xls)</p>
                                </div>
                                <input type="file" id="bangkokDistrictsExcelFile" class="hidden" accept=".xlsx, .xls" onchange="handleBangkokDistrictsFileSelect(this)" />
                            </label>
                        </div>
                        
                        <div id="bangkokDistrictsFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowBangkokDistricts" class="form-checkbox" checked />
                            <label for="skipFirstRowBangkokDistricts" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingBangkokDistricts" class="form-checkbox" />
                            <label for="replaceExistingBangkokDistricts" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadBangkokDistrictsExampleFile()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportBangkokDistrictsModal()" class="btn-secondary text-sm">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="processBangkokDistrictsImport()" id="importBangkokDistrictsButton" class="btn-primary text-sm" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import Bangkok districts modal
        function closeImportBangkokDistrictsModal() {
            const modal = document.getElementById('importBangkokDistrictsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle Bangkok districts file select
        function handleBangkokDistrictsFileSelect(input) {
            const fileInfo = document.getElementById('bangkokDistrictsFileInfo');
            const importButton = document.getElementById('importBangkokDistrictsButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = `<span class="text-red-500">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>`;
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úÖ ${fileName}</span><br>
                    <span class="text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î: ${fileSize} KB</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download Bangkok districts example file
        function downloadBangkokDistrictsExampleFile() {
            const data = [
                ['‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'],
                ['‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö', '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏î‡πÄ‡∏ó‡∏û‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£']
            ];
            
            // Convert array to worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            ws['!cols'] = [
                { wch: 25 },  // ‡πÅ‡∏Ç‡∏ß‡∏á
                { wch: 25 },  // ‡πÄ‡∏Ç‡∏ï
                { wch: 25 }   // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "F0F9FF" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            ['A1', 'B1', 'C1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Process Bangkok districts import
        async function processBangkokDistrictsImport() {
            const fileInput = document.getElementById('bangkokDistrictsExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowBangkokDistricts').checked;
            const replaceExisting = document.getElementById('replaceExistingBangkokDistricts').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importBangkokDistrictsButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length < 2) {
                        showNotification('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    const startRow = skipFirstRow ? 1 : 0;
                    let newData = [];
                    let errors = [];
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 2) continue;
                        
                        const subdistrict = row[0]?.toString().trim();
                        const district = row[1]?.toString().trim();
                        const province = row[2]?.toString().trim() || '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£';
                        
                        if (!district || !subdistrict) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            continue;
                        }
                        
                        newData.push({
                            subdistrict,
                            district,
                            province
                        });
                    }
                    
                    if (errors.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`, 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    try {
                        let existingData = replaceExisting ? [] : await loadFromFirebase('bangkokDistricts');
                        
                        for (const newItem of newData) {
                            const existingIndex = existingData.findIndex(item => 
                                item.district.toLowerCase() === newItem.district.toLowerCase() &&
                                item.subdistrict.toLowerCase() === newItem.subdistrict.toLowerCase()
                            );
                            
                            if (existingIndex !== -1) {
                                existingData[existingIndex] = newItem;
                            } else {
                                existingData.push(newItem);
                            }
                        }
                        
                        await saveToFirebase('bangkokDistricts', existingData);
                        await loadBangkokDistrictsTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportBangkokDistrictsModal();
                        
                    } catch (error) {
                        console.error('Error saving data:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Show import Thailand population modal
        // Show import Bangkok Districts modal
        function showImportBangkokDistrictsModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importBangkokDistrictsModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-4xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h2>
                        <button onclick="closeImportBangkokDistrictsModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="text-blue-800 font-semibold mb-3">üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡πÅ‡∏Ç‡∏ß‡∏á</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡πÄ‡∏Ç‡∏ï</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-blue-100">
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢</td>
                                        <td class="px-4 py-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-blue-600">
                            <p>‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
                            <p>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" ‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£")</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span></p>
                                    <p class="text-xs text-gray-500">Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (.xlsx, .xls)</p>
                                </div>
                                <input type="file" id="bangkokDistrictsFile" class="hidden" accept=".xlsx, .xls" 
                                    onchange="handleBangkokDistrictsFileSelect(this)"/>
                            </label>
                        </div>
                        
                        <div id="bangkokDistrictsFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowBangkokDistricts" class="form-checkbox" checked />
                            <label for="skipFirstRowBangkokDistricts" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingBangkokDistricts" class="form-checkbox" />
                            <label for="replaceExistingBangkokDistricts" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadBangkokDistrictsExample()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportBangkokDistrictsModal()" class="btn-secondary">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="importBangkokDistricts()" id="importBangkokDistrictsButton" class="btn-primary" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Show import Thailand population modal
        function showImportThailandPopulationModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importThailandPopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</h2>
                        <button onclick="closeImportThailandPopulationModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Import Instructions -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                            ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </h4>
                        <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                            <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                            <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                            <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2024)</li>
                            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                        </ol>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm border border-gray-300 rounded">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏ä‡∏≤‡∏¢</th>
                                        <th class="px-4 py-2 text-left text-blue-800 border-b font-semibold">‡∏´‡∏ç‡∏¥‡∏á</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    <tr>
                                        <td class="px-4 py-2 border-b">2024</td>
                                        <td class="px-4 py-2 border-b">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                        <td class="px-4 py-2 border-b">5666264</td>
                                        <td class="px-4 py-2 border-b">2694574</td>
                                        <td class="px-4 py-2 border-b">2971690</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 border-b">2024</td>
                                        <td class="px-4 py-2 border-b">‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</td>
                                        <td class="px-4 py-2 border-b">1276745</td>
                                        <td class="px-4 py-2 border-b">598741</td>
                                        <td class="px-4 py-2 border-b">678004</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="thailandPopulationExcelFile" accept=".xlsx, .xls" class="hidden" 
                                    onchange="handleThailandPopulationFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('thailandPopulationExcelFile').click()" class="btn-secondary text-sm flex items-center">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadThailandPopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                    </button>
                                </div>
                                <div id="thailandPopulationFileInfo" class="mt-3"></div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 mt-4">
                            <input type="checkbox" id="skipFirstRowThailand" class="rounded text-blue-600">
                            <label for="skipFirstRowThailand" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        <div class="flex items-center space-x-2 mt-2">
                            <input type="checkbox" id="replaceExistingThailand" class="rounded text-blue-600">
                            <label for="replaceExistingThailand" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        <div class="flex justify-between mt-8">
                            <button onclick="closeImportThailandPopulationModal()" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button onclick="processThailandPopulationImport()" class="btn-primary" id="importThailandPopulationButton" disabled>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import Thailand population modal
        function closeImportBangkokDistrictsModal() {
            const modal = document.getElementById('importBangkokDistrictsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle Bangkok districts file selection
        function handleBangkokDistrictsFileSelect(input) {
            const fileInfo = document.getElementById('bangkokDistrictsFileInfo');
            const importButton = document.getElementById('importBangkokDistrictsButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (!file.name.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-500">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = `
                    <div class="text-green-600">‚úÖ ${file.name}</div>
                    <div class="text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î: ${fileSize} KB</div>
                `;
                importButton.disabled = false;
            }
        }

        // Download Bangkok districts example file
        function downloadBangkokDistrictsExample() {
            const data = [
                ['‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'],
                ['‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏ß‡∏±‡∏î‡∏£‡∏≤‡∏ä‡∏ö‡∏û‡∏¥‡∏ò', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                ['‡∏™‡∏≥‡∏£‡∏≤‡∏ç‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 25},  // ‡πÅ‡∏Ç‡∏ß‡∏á
                {wch: 25},  // ‡πÄ‡∏Ç‡∏ï
                {wch: 25}   // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            ];
            
            // Style header row
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "E5E7EB" } },
                alignment: { horizontal: "center" }
            };
            
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (!ws[cell]) ws[cell] = {};
                ws[cell].s = headerStyle;
            });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // Import Bangkok districts from Excel
        async function importBangkokDistricts() {
            const fileInput = document.getElementById('bangkokDistrictsFile');
            const skipFirstRow = document.getElementById('skipFirstRowBangkokDistricts').checked;
            const replaceExisting = document.getElementById('replaceExistingBangkokDistricts').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importBangkokDistrictsButton');
            const originalButtonText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (jsonData.length < 2) {
                            throw new Error('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        }
                        
                        const startRow = skipFirstRow ? 1 : 0;
                        let newData = [];
                        let errors = [];
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            
                            const subdistrict = row[0]?.toString().trim();
                            const district = row[1]?.toString().trim();
                            const province = row[2]?.toString().trim() || '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£';
                            
                            if (!subdistrict || !district) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                                continue;
                            }
                            
                            newData.push({
                                subdistrict,
                                district,
                                province
                            });
                        }
                        
                        if (errors.length > 0) {
                            throw new Error('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n' + errors.join('\n'));
                        }
                        
                        let existingData = replaceExisting ? [] : await loadFromFirebase('bangkokDistricts');
                        
                        for (const item of newData) {
                            const index = existingData.findIndex(existing => 
                                existing.district.toLowerCase() === item.district.toLowerCase() &&
                                existing.subdistrict.toLowerCase() === item.subdistrict.toLowerCase()
                            );
                            
                            if (index !== -1) {
                                existingData[index] = item;
                            } else {
                                existingData.push(item);
                            }
                        }
                        
                        await saveToFirebase('bangkokDistricts', existingData);
                        await loadBangkokDistrictsTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportBangkokDistrictsModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalButtonText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(fileInput.files[0]);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalButtonText;
                importButton.disabled = false;
            }
        }

        function closeImportThailandPopulationModal() {
            const modal = document.getElementById('importThailandPopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle Thailand population file select
        function handleThailandPopulationFileSelect(input) {
            const fileInfo = document.getElementById('thailandPopulationFileInfo');
            const importButton = document.getElementById('importThailandPopulationButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                    fileInfo.innerHTML = '';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-gray-700">${fileName}</span>
                        <span class="text-gray-500">(${fileSize} KB)</span>
                    </div>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download Thailand population example file
        function downloadThailandPopulationExampleFile() {
            const data = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [2024, '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', 5666264, 2694574, 2971690],
                [2024, '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', 1276745, 598741, 678004],
                [2024, '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', 1164897, 553874, 611023],
                [2024, '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', 1351479, 652147, 699332]
            ];
            
            // Convert array to worksheet
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 },   // ‡∏õ‡∏µ
                { wch: 20 },  // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                { wch: 15 },  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                { wch: 15 },  // ‡∏ä‡∏≤‡∏¢
                { wch: 15 }   // ‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "F0F9FF" } }, // bg-blue-50
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling to all header cells
            ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Style for numeric columns
            const numberStyle = {
                alignment: { horizontal: "right" },
                numFmt: "#,##0"
            };

            // Apply number formatting to population columns (columns C, D, E)
            for (let row = 2; row <= sampleData.length; row++) {
                ['C', 'D', 'E'].forEach(col => {
                    const cell = col + row;
                    if (ws[cell]) ws[cell].s = numberStyle;
                });
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢");

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Show import epidemic weeks modal
        function showImportEpidemicWeeksModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importEpidemicWeeksModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-4xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h2>
                        <button onclick="closeImportEpidemicWeeksModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="text-blue-800 font-semibold mb-3">üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                                        <th class="px-4 py-2 text-blue-800 font-semibold text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-blue-100">
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">1</td>
                                        <td class="px-4 py-2 text-gray-700">01/01/2024</td>
                                        <td class="px-4 py-2 text-gray-700">07/01/2024</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">2</td>
                                        <td class="px-4 py-2 text-gray-700">08/01/2024</td>
                                        <td class="px-4 py-2 text-gray-700">14/01/2024</td>
                                    </tr>
                                    <tr class="hover:bg-blue-50">
                                        <td class="px-4 py-2 text-gray-700">3</td>
                                        <td class="px-4 py-2 text-gray-700">15/01/2024</td>
                                        <td class="px-4 py-2 text-gray-700">21/01/2024</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-blue-600">
                            <p>‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
                            <p>‚Ä¢ ‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2024)</p>
                            <p>‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            <p>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span></p>
                                    <p class="text-xs text-gray-500">Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (.xlsx, .xls)</p>
                                </div>
                                <input type="file" id="epidemicWeeksFile" class="hidden" accept=".xlsx, .xls" 
                                    onchange="handleEpidemicWeeksFileSelect(this)"/>
                            </label>
                        </div>
                        
                        <div id="epidemicWeeksFileInfo" class="text-sm text-gray-600"></div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="skipFirstRowEpidemicWeeks" class="form-checkbox" checked />
                            <label for="skipFirstRowEpidemicWeeks" class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</label>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="replaceExistingEpidemicWeeks" class="form-checkbox" />
                            <label for="replaceExistingEpidemicWeeks" class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button onclick="downloadEpidemicWeeksExample()" class="text-blue-600 hover:text-blue-800 text-sm">
                                ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                            </button>
                            <div class="space-x-2">
                                <button onclick="closeImportEpidemicWeeksModal()" class="btn-secondary">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onclick="importEpidemicWeeks()" id="importEpidemicWeeksButton" class="btn-primary" disabled>
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import epidemic weeks modal
        function closeImportEpidemicWeeksModal() {
            const modal = document.getElementById('importEpidemicWeeksModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle epidemic weeks file select
        function handleEpidemicWeeksFileSelect(input) {
            const fileInfo = document.getElementById('epidemicWeeksFileInfo');
            const importButton = document.getElementById('importEpidemicWeeksButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (!file.name.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-500">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = `
                    <div class="text-green-600">‚úÖ ${file.name}</div>
                    <div class="text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î: ${fileSize} KB</div>
                `;
                importButton.disabled = false;
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download epidemic weeks example file
        function downloadEpidemicWeeksExample() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û.‡∏®.
            
            const currentYearCE = currentYear - 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
            const data = [
                ['‡∏õ‡∏µ', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'],
                [currentYearCE, '1', '01/01/2024', '07/01/2024', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ'],
                [currentYearCE, '2', '08/01/2024', '14/01/2024', ''],
                [currentYearCE, '3', '15/01/2024', '21/01/2024', ''],
                [currentYearCE, '4', '22/01/2024', '28/01/2024', '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 10},  // ‡∏õ‡∏µ
                {wch: 12},  // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
                {wch: 15},  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                {wch: 15},  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                {wch: 30}   // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            ];
            
            // Style header row
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "E5E7EB" } },
                alignment: { horizontal: "center" }
            };
            
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (!ws[cell]) ws[cell] = {};
                ws[cell].s = headerStyle;
            });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î");
            
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // Function to parse and format date from various formats
        function parseDateFormat(dateStr) {
            if (!dateStr) return '';
            
            // Remove any whitespace
            dateStr = dateStr.toString().trim();
            
            // If it's already in DD/MM/YYYY format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            
            try {
                // Handle Excel serial number
                if (!isNaN(dateStr) && parseInt(dateStr) > 0) {
                    const excelEpoch = new Date(1900, 0, 1);
                    const jsDate = new Date(excelEpoch.getTime() + (parseInt(dateStr) - 2) * 24 * 60 * 60 * 1000);
                    return `${jsDate.getDate().toString().padStart(2, '0')}/${(jsDate.getMonth() + 1).toString().padStart(2, '0')}/${jsDate.getFullYear()}`;
                }

                // Handle YYYY-MM-DD format
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
                    const [year, month, day] = dateStr.split('-');
                    return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                }
                
                // Handle DD-MM-YYYY format
                if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateStr)) {
                    return dateStr.replace(/-/g, '/');
                }
                
                // Handle DD.MM.YYYY format
                if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(dateStr)) {
                    return dateStr.replace(/\./g, '/');
                }

                // Try parsing as a JavaScript Date
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                }

                return '';
            } catch (error) {
                console.error('Error parsing date:', error);
                return '';
            }
        }

        // Import epidemic weeks from Excel
        async function importEpidemicWeeks() {
            const fileInput = document.getElementById('epidemicWeeksFile');
            const skipFirstRow = document.getElementById('skipFirstRowEpidemicWeeks').checked;
            const replaceExisting = document.getElementById('replaceExistingEpidemicWeeks').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importEpidemicWeeksButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (jsonData.length < 2) {
                            throw new Error('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        }
                        
                        const startRow = skipFirstRow ? 1 : 0;
                        let newData = [];
                        let errors = [];
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            
                            let year = row[0];
                            const weekNumber = parseInt(row[1]);
                            let startDate = row[2];
                            let endDate = row[3];
                            const note = row[4]?.toString().trim() || '';
                            
                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                            startDate = parseDateFormat(startDate);
                            endDate = parseDateFormat(endDate);

                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
                            if (!startDate || !endDate) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                                continue;
                            }

                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                            if (!year) {
                                const startDateParts = startDate.split('/');
                                year = parseInt(startDateParts[2]);
                            }
                            
                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                            year = parseInt(year);
                            
                            if (!year || !weekNumber) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà)`);
                                continue;
                            }
                            
                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ ‡∏Ñ.‡∏®.
                            if (year < 1957 || year > 2057) { // 1957-2057 = 2500-2600
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á ‡∏Ñ.‡∏®. 1957-2057`);
                                continue;
                            }
                            
                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                            const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                            if (!dateRegex.test(startDate) || !dateRegex.test(endDate)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY)`);
                                continue;
                            }
                            
                            newData.push({
                                year,
                                weekNumber,
                                startDate,
                                endDate,
                                note
                            });
                        }
                        
                        if (errors.length > 0) {
                            throw new Error('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n' + errors.join('\n'));
                        }
                        
                        let existingData = replaceExisting ? [] : await loadFromFirebase('epidemicWeeks');
                        
                        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
                        for (const item of newData) {
                            const index = existingData.findIndex(existing => 
                                existing.weekNumber === item.weekNumber
                            );
                            
                            if (index !== -1) {
                                existingData[index] = item;
                            } else {
                                existingData.push(item);
                            }
                        }
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                        existingData.sort((a, b) => a.weekNumber - b.weekNumber);
                        
                        await saveToFirebase('epidemicWeeks', existingData);
                        await loadEpidemicWeeksTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportEpidemicWeeksModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(fileInput.files[0]);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Validate CE year for Thailand population
        function validateThailandPopulationYear(year) {
            const currentYear = new Date().getFullYear();
            const yearNum = parseInt(year);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + 10 ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1900)
            if (isNaN(yearNum) || yearNum > currentYear + 10 || yearNum < 1900) {
                return false;
            }
            return true;
        }

        // Process Thailand population import
        async function processThailandPopulationImport() {
            const fileInput = document.getElementById('thailandPopulationExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowThailand').checked;
            const replaceExisting = document.getElementById('replaceExistingThailand').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importThailandPopulationButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length < 2) {
                        showNotification('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    // Start processing from row 1 if skipFirstRow is true
                    const startRow = skipFirstRow ? 1 : 0;
                    let newData = [];
                    let errors = [];
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 4) continue; // Skip incomplete rows
                        
                        const year = parseInt(row[0]) || new Date().getFullYear();
                        // Validate that the year is in CE format
                        if (year > (new Date().getFullYear() + 10) || year < 1900) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (1900-${new Date().getFullYear() + 10})`);
                            continue;
                        }
                        const province = row[1]?.toString().trim();
                        const total = parseInt(row[2]);
                        const male = parseInt(row[3]);
                        const female = parseInt(row[4]);
                        
                        if (!province || isNaN(total) || isNaN(male) || isNaN(female)) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            continue;
                        }
                        
                        newData.push({
                            year,
                            province,
                            total,
                            male,
                            female
                        });
                    }
                    
                    if (errors.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`, 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    try {
                        let existingData = replaceExisting ? [] : await loadFromFirebase('thailandPopulation');
                        
                        // Update existing data with new data
                        for (const newItem of newData) {
                            const existingIndex = existingData.findIndex(item => 
                                item.province.toLowerCase() === newItem.province.toLowerCase() &&
                                item.year === newItem.year
                            );
                            
                            if (existingIndex !== -1) {
                                existingData[existingIndex] = newItem;
                            } else {
                                existingData.push(newItem);
                            }
                        }
                        
                        await saveToFirebase('thailandPopulation', existingData);
                        await loadThailandPopulationTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportThailandPopulationModal();
                        
                    } catch (error) {
                        console.error('Error saving data:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        async function loadThailandPopulationTable() {
            let thailandPopulation = await loadFromFirebase('thailandPopulation');
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            thailandPopulation.sort((a, b) => {
                if (a.year !== b.year) {
                    return a.year - b.year;
                }
                return a.province.localeCompare(b.province);
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
            const yearSummary = thailandPopulation.reduce((acc, curr) => {
                if (!acc[curr.year]) {
                    acc[curr.year] = {
                        totalPopulation: 0,
                        totalMale: 0,
                        totalFemale: 0,
                        provinceCount: 0
                    };
                }
                acc[curr.year].totalPopulation += parseInt(curr.total) || 0;
                acc[curr.year].totalMale += parseInt(curr.male) || 0;
                acc[curr.year].totalFemale += parseInt(curr.female) || 0;
                acc[curr.year].provinceCount++;
                return acc;
            }, {});
            
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                ${Object.keys(yearSummary).length > 0 ? `
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${Object.entries(yearSummary).map(([year, data]) => `
                        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-gray-800">‡∏õ‡∏µ ‡∏Ñ.‡∏®. ${year}</h3>
                                <span class="text-sm text-gray-500">${data.provinceCount} ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</span>
                                    <span class="font-semibold text-blue-600">${data.totalPopulation.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏ä‡∏≤‡∏¢:</span>
                                    <span class="font-medium text-blue-500">${data.totalMale.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span class="font-medium text-pink-500">${data.totalFemale.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}
                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${thailandPopulation.length === 0 ? 
                                '<tr><td colspan="5" class="px-6 py-20 text-center text-gray-500"><div class="text-6xl mb-4">üáπüá≠</div><p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</p><p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p></td></tr>' :
                                thailandPopulation.map((province, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 text-gray-900">${province.year || new Date().getFullYear()}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${province.province}</td>
                                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${parseInt(province.total).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-blue-600">${parseInt(province.male).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${parseInt(province.female).toLocaleString()}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="editThailandPopulation(${index})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:from-blue-600 hover:to-blue-700 mr-2 transition-all transform hover:scale-105">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteThailandPopulation(${index})" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg text-sm hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Get regional summary
        function getRegionalSummary(thailandPopulation) {
            const regions = {};
            
            thailandPopulation.forEach(province => {
                if (!regions[province.region]) {
                    regions[province.region] = {
                        name: province.region,
                        provinces: 0,
                        total: 0,
                        male: 0,
                        female: 0,
                        totalDensity: 0
                    };
                }
                
                regions[province.region].provinces++;
                regions[province.region].total += parseInt(province.total);
                regions[province.region].male += parseInt(province.male);
                regions[province.region].female += parseInt(province.female);
                regions[province.region].totalDensity += parseFloat(province.density);
            });
            
            return Object.values(regions).map(region => ({
                ...region,
                avgDensity: region.totalDensity / region.provinces
            }));
        }

        async function loadBangkokDistrictsTable() {
            const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="table-container">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÅ‡∏Ç‡∏ß‡∏á</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bangkokDistricts.length === 0 ? 
                                '<tr><td colspan="4" class="px-6 py-20 text-center text-gray-500"><div class="text-6xl mb-4">üè¢</div><p class="font-semibold text-xl text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï</p><p class="text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ç‡∏ß‡∏á ‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p></td></tr>' :
                                bangkokDistricts.map((district, index) => `
                                    <tr class="table-row transition-all duration-300 border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 font-semibold text-gray-900">${district.subdistrict}</td>
                                        <td class="px-6 py-4 font-bold text-blue-600">${district.district}</td>
                                        <td class="px-6 py-4 font-medium text-green-600">${district.province}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="editBangkokDistrict(${index})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:from-blue-600 hover:to-blue-700 mr-2 transition-all transform hover:scale-105">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteBangkokDistrict(${index})" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg text-sm hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">‡∏•‡∏ö</button>
                                        </td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Statistics -->
                ${bangkokDistricts.length > 0 ? `
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="stat-card">
                            <div class="w-12 h-12 icon-gradient-blue rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-2">${bangkokDistricts.length}</div>
                            <div class="text-sm text-gray-600 font-medium">‡πÅ‡∏Ç‡∏ß‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="w-12 h-12 icon-gradient-green rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-2">${getUniqueDistricts(bangkokDistricts).length}</div>
                            <div class="text-sm text-gray-600 font-medium">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="w-12 h-12 icon-gradient-purple rounded-xl mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-2">1</div>
                            <div class="text-sm text-gray-600 font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</div>
                        </div>
                    </div>
                    
                    <!-- District Summary -->
                    <div class="mt-8">
                        <h4 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-700" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${getDistrictSummary(bangkokDistricts).map(district => `
                                <div class="glass-card p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h5 class="font-bold text-lg text-gray-900">${district.name}</h5>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${district.subdistricts} ‡πÅ‡∏Ç‡∏ß‡∏á</span>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Ç‡∏ß‡∏á:</span>
                                            <span class="font-semibold text-gray-900">${district.subdistricts} ‡πÅ‡∏Ç‡∏ß‡∏á</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
                                            <span class="font-medium text-green-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Get unique districts
        function getUniqueDistricts(bangkokDistricts) {
            const uniqueDistricts = [...new Set(bangkokDistricts.map(d => d.district))];
            return uniqueDistricts;
        }

        // Get district summary
        function getDistrictSummary(bangkokDistricts) {
            const districtCounts = {};
            
            bangkokDistricts.forEach(item => {
                if (!districtCounts[item.district]) {
                    districtCounts[item.district] = {
                        name: item.district,
                        subdistricts: 0
                    };
                }
                districtCounts[item.district].subdistricts++;
            });
            
            return Object.values(districtCounts).sort((a, b) => b.subdistricts - a.subdistricts);
        }

        async function loadEpidemicWeeksTable() {
            const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
            const content = document.getElementById('masterDataDetailContent');
            
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                        üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                    </h3>
                    <button onclick="addNewMasterData('epidemicWeeks')" class="btn-primary text-sm px-4 py-2">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                        </svg>
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                    </button>
                </div>
                
                ${epidemicWeeks && epidemicWeeks.length > 0 ? `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow">
                            <thead class="bg-gradient-to-r from-green-50 to-emerald-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏µ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${epidemicWeeks.map((week, index) => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${week.year}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${week.weekNumber}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTH(week.startDate)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTH(week.endDate)}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${week.note || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex space-x-2">
                                                <button onclick="editEpidemicWeek(${index})" class="text-blue-600 hover:text-blue-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="deleteEpidemicWeek(${index})" class="text-red-600 hover:text-red-900 transition-colors">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-white rounded p-3 shadow-sm">
                                <div class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                <div class="text-2xl font-bold text-blue-600">${epidemicWeeks.length}</div>
                            </div>
                            <div class="bg-white rounded p-3 shadow-sm">
                                <div class="text-gray-600">‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                                <div class="text-2xl font-bold text-green-600">${getLatestYear(epidemicWeeks)}</div>
                            </div>
                            <div class="bg-white rounded p-3 shadow-sm">
                                <div class="text-gray-600">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                                <div class="text-2xl font-bold text-purple-600">${getLatestWeek(epidemicWeeks)}</div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="text-center py-20">
                        <div class="text-6xl mb-4">üìÖ</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î</h3>
                        <p class="text-gray-500 mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà</p>
                        <button onclick="addNewMasterData('epidemicWeeks')" class="btn-primary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                `}
            `;
        }

        // Helper functions for epidemic weeks
        function getLatestYear(epidemicWeeks) {
            if (!epidemicWeeks || epidemicWeeks.length === 0) return '-';
            return Math.max(...epidemicWeeks.map(w => parseInt(w.year)));
        }

        function getLatestWeek(epidemicWeeks) {
            if (!epidemicWeeks || epidemicWeeks.length === 0) return '-';
            const latestYear = getLatestYear(epidemicWeeks);
            const weeksInLatestYear = epidemicWeeks.filter(w => parseInt(w.year) === latestYear);
            return Math.max(...weeksInLatestYear.map(w => parseInt(w.weekNumber)));
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Clear all patients data
        async function clearAllPatients() {
            const patients = await loadFromFirebase('patients');
            
            if (patients.length === 0) {
                // Show info message if no data
                const infoDiv = document.createElement('div');
                infoDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                infoDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                        </svg>
                        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏ö
                    </div>
                `;
                document.body.appendChild(infoDiv);
                
                setTimeout(() => {
                    infoDiv.remove();
                }, 3000);
                return;
            }

            // Show confirmation dialog
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${patients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                const deletedCount = patients.length;
                
                // Clear the data from Firebase and localStorage
                await saveToFirebase('patients', []);
                localStorage.setItem('patients', JSON.stringify([]));
                
                // Clear global cache
                window.allPatients = [];
                
                // Auto-refresh data after delete
                console.log('üîÑ Auto-refreshing data after delete...');
                await autoRefreshData('delete', deletedCount);
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                        </svg>
                        ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${deletedCount.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                    </div>
                `;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        }

        // Auto-refresh data after operations
        async function autoRefreshData(operation, count) {
            try {
                console.log(`üîÑ Auto-refreshing after ${operation} operation (${count} records)...`);
                
                // Force refresh from Firebase
                await initializeData();
                
                // Clear search and reset pagination
                document.getElementById('searchInput').value = '';
                currentPage = 1;
                
                // Reload table
                await loadPatientsTable();
                
                // Show auto-refresh notification
                const refreshDiv = document.createElement('div');
                refreshDiv.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 slide-in text-sm';
                refreshDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
                    </div>
                `;
                document.body.appendChild(refreshDiv);
                
                setTimeout(() => {
                    refreshDiv.remove();
                }, 2000);
                
                console.log(`‚úÖ Auto-refresh completed after ${operation}`);
                
            } catch (error) {
                console.error(`‚ùå Error in auto-refresh after ${operation}:`, error);
                
                // Show error notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 slide-in text-sm';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            }
        }

        // Refresh patients data from Firebase
        async function refreshPatientsData() {
            console.log('üîÑ Manual refresh requested...');
            
            // Show loading indicator
            const button = event.target;
            const originalHTML = button.innerHTML;
            button.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...
            `;
            button.disabled = true;
            
            try {
                // Force refresh from Firebase
                await initializeData();
                
                // Clear search and reset pagination
                document.getElementById('searchInput').value = '';
                currentPage = 1;
                
                await loadPatientsTable();
                
                // Show success notification
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
                    </div>
                `;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error refreshing data:', error);
                
                // Show error notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            } finally {
                // Restore button
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        }

        // Master data management functions
        function addNewMasterData(type) {
            if (type === 'diseases') {
                showDiseaseForm();
            } else if (type === 'responsible') {
                showResponsibleForm();
            } else if (type === 'population') {
                showPopulationForm();
            } else if (type === 'agePopulation') {
                showAgePopulationForm();
            } else if (type === 'thailandPopulation') {
                showThailandPopulationForm();
            } else if (type === 'bangkokDistricts') {
                showBangkokDistrictForm();
            } else if (type === 'epidemicWeeks') {
                showEpidemicWeekForm();
            } else if (type === 'diseaseHistory') {
                showDiseaseHistoryForm();
            } else {
                alert(`‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type} ‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢`);
            }
        }

        // Show disease form modal
        function showDiseaseForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'diseaseModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-md w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeDiseaseModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="diseaseForm" onsubmit="saveDiseaseData(event, ${editIndex})">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</label>
                                <input type="text" id="diseaseCode" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 506" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</label>
                                <input type="text" id="diseaseName" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å" required>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeDiseaseModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateDiseaseForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('diseaseCode').focus();
            }, 100);
        }

        // Populate form for editing
        async function populateDiseaseForm(index) {
            const diseases = await loadFromFirebase('diseases');
            const disease = diseases[index];
            
            if (disease) {
                document.getElementById('diseaseCode').value = disease.code;
                document.getElementById('diseaseName').value = disease.name;
            }
        }

        // Close disease modal
        function closeDiseaseModal() {
            const modal = document.getElementById('diseaseModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save disease data
        async function saveDiseaseData(event, editIndex = null) {
            event.preventDefault();
            
            const code = document.getElementById('diseaseCode').value.trim();
            const name = document.getElementById('diseaseName').value.trim();
            
            if (!code || !name) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const diseases = await loadFromFirebase('diseases');
                
                // Check for duplicate code (only if not editing the same record)
                const existingIndex = diseases.findIndex(d => d.code === code);
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∑‡πà‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newDisease = { code, name };
                
                if (editIndex !== null) {
                    // Edit existing disease
                    diseases[editIndex] = newDisease;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new disease
                    diseases.push(newDisease);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('diseases', diseases);
                
                // Close modal
                closeDiseaseModal();
                
                // Refresh table
                await loadDiseasesTable();
                
            } catch (error) {
                console.error('Error saving disease:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit disease function
        function editDisease(index) {
            showDiseaseForm(index);
        }

        // Delete disease function
        // Show import disease modal
        function showImportDiseaseModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importDiseaseModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                        </h3>
                        <button onclick="closeImportDiseaseModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">B01</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ICD-10 ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="diseaseExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleDiseaseFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('diseaseExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadDiseaseExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="diseaseFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRow" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExisting" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processDiseaseImport()" class="flex-1 btn-primary" id="importDiseaseButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportDiseaseModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import disease modal
        function closeImportDiseaseModal() {
            const modal = document.getElementById('importDiseaseModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle disease file select
        function handleDiseaseFileSelect(input) {
            const fileInfo = document.getElementById('diseaseFileInfo');
            const importButton = document.getElementById('importDiseaseButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download disease example file
        function downloadDiseaseExampleFile() {
            const data = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ'],
                ['A00', '‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ'],
                ['B01', '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà'],
                ['C02', '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à'],
                ['D03', '‡πÇ‡∏£‡∏Ñ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢'],
                ['E04', '‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ.xlsx');
        }

        // Process disease import
        async function processDiseaseImport() {
            const fileInput = document.getElementById('diseaseExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRow').checked;
            const replaceExisting = document.getElementById('replaceExisting').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importDiseaseButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        let startRow = skipFirstRow ? 1 : 0;
                        const processedData = [];
                        const errors = [];
                        const duplicateCodes = new Set();
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const code = row[0] ? row[0].toString().trim() : '';
                            const name = row[1] ? row[1].toString().trim() : '';
                            
                            if (!code || !name) {
                                if (code || name) {
                                    errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                                }
                                continue;
                            }
                            
                            if (duplicateCodes.has(code)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${code} ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                                continue;
                            }
                            
                            duplicateCodes.add(code);
                            processedData.push({code, name});
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                        }
                        
                        let existingDiseases = await loadFromFirebase('diseases');
                        if (!replaceExisting) {
                            const existingCodes = new Set(existingDiseases.map(d => d.code));
                            const duplicateExisting = processedData.filter(d => existingCodes.has(d.code));
                            
                            if (duplicateExisting.length > 0) {
                                errors.push(`‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß: ${duplicateExisting.map(d => d.code).join(', ')}`);
                            }
                            
                            const newData = processedData.filter(d => !existingCodes.has(d.code));
                            processedData.length = 0;
                            processedData.push(...newData);
                        }
                        
                        if (errors.length > 0) {
                            const errorMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? '\\n...' : ''}`;
                            if (!confirm(`${errorMsg}\\n\\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                            }
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                        }
                        
                        const finalData = replaceExisting ? processedData : [...existingDiseases, ...processedData];
                        await saveToFirebase('diseases', finalData);
                        
                        const message = replaceExisting 
                            ? `‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                            : `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        showNotification(message, 'success');
                        closeImportDiseaseModal();
                        loadDiseasesTable();
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        async function deleteDisease(index) {
            const diseases = await loadFromFirebase('diseases');
            const disease = diseases[index];
            
            if (!disease) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏£‡∏´‡∏±‡∏™: ${disease.code}\n‡∏ä‡∏∑‡πà‡∏≠: ${disease.name}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    diseases.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('diseases', diseases);
                    
                    // Refresh table
                    await loadDiseasesTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting disease:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Show responsible form modal
        function showResponsibleForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'responsibleModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeResponsibleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="responsibleForm" onsubmit="saveResponsibleData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Disease Selection -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                    </svg>
                                    ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                                </label>
                                <select id="responsibleDiseaseCode" class="w-full input-field" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>
                                </select>
                            </div>
                            
                            <!-- Responsible Person -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                                </label>
                                <input type="text" id="responsibleName" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"/>
                                    </svg>
                                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                                </label>
                                <input type="text" id="responsiblePosition" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç" required>
                            </div>
                            
                            <!-- Reviewer -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                                </label>
                                <input type="text" id="reviewerName" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"/>
                                    </svg>
                                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                                </label>
                                <input type="text" id="reviewerPosition" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤" required>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeResponsibleModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Load disease options
            loadDiseaseOptionsForResponsible();
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateResponsibleForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('responsibleDiseaseCode').focus();
            }, 100);
        }

        // Load disease options for responsible form
        async function loadDiseaseOptionsForResponsible() {
            const diseases = await loadFromFirebase('diseases');
            const select = document.getElementById('responsibleDiseaseCode');
            
            if (select) {
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</option>';
                
                diseases.forEach(disease => {
                    const option = document.createElement('option');
                    option.value = disease.code;
                    option.textContent = `${disease.code} - ${disease.name}`;
                    select.appendChild(option);
                });
            }
        }

        // Populate responsible form for editing
        async function populateResponsibleForm(index) {
            const responsible = await loadFromFirebase('responsible');
            const resp = responsible[index];
            
            if (resp) {
                document.getElementById('responsibleDiseaseCode').value = resp.diseaseCode;
                document.getElementById('responsibleName').value = resp.responsibleName;
                document.getElementById('responsiblePosition').value = resp.responsiblePosition;
                document.getElementById('reviewerName').value = resp.reviewerName;
                document.getElementById('reviewerPosition').value = resp.reviewerPosition;
            }
        }

        // Close responsible modal
        function closeResponsibleModal() {
            const modal = document.getElementById('responsibleModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show import responsible modal
        function showImportResponsibleModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importResponsibleModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </h3>
                        <button onclick="closeImportResponsibleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏≤‡∏ô‡∏∞ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÑ‡∏î‡πâ)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:</strong> ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏ï‡πá‡∏°</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="responsibleExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleResponsibleFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('responsibleExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadResponsibleExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="responsibleFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRowResponsible" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExistingResponsible" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processResponsibleImport()" class="flex-1 btn-primary" id="importResponsibleButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportResponsibleModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import responsible modal
        function closeImportResponsibleModal() {
            const modal = document.getElementById('importResponsibleModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle responsible file select
        function handleResponsibleFileSelect(input) {
            const fileInfo = document.getElementById('responsibleFileInfo');
            const importButton = document.getElementById('importResponsibleButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download responsible example file
        function downloadResponsibleExampleFile() {
            const data = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô'],
                ['A00', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏≤‡∏ô‡∏∞ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç'],
                ['B01', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏µ', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ', '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'],
                ['C02', '‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ò‡∏µ‡∏£‡∏∞ ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç', '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏£‡∏±‡∏ï‡∏ô‡∏≤ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö.xlsx');
        }

        // Process responsible import
        async function processResponsibleImport() {
            const fileInput = document.getElementById('responsibleExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowResponsible').checked;
            const replaceExisting = document.getElementById('replaceExistingResponsible').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importResponsibleButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        let startRow = skipFirstRow ? 1 : 0;
                        const processedData = [];
                        const errors = [];
                        const duplicateCodes = new Set();
                        
                        // Load existing diseases to validate disease codes
                        const diseases = await loadFromFirebase('diseases');
                        const validDiseaseCodes = new Set(diseases.map(d => d.code));
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const diseaseCode = row[0] ? row[0].toString().trim() : '';
                            const responsibleName = row[1] ? row[1].toString().trim() : '';
                            const responsiblePosition = row[2] ? row[2].toString().trim() : '';
                            const reviewerName = row[3] ? row[3].toString().trim() : '';
                            const reviewerPosition = row[4] ? row[4].toString().trim() : '';
                            
                            if (!diseaseCode || !responsibleName || !responsiblePosition || !reviewerName || !reviewerPosition) {
                                if (diseaseCode || responsibleName || responsiblePosition || reviewerName || reviewerPosition) {
                                    errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                                }
                                continue;
                            }
                            
                            if (!validDiseaseCodes.has(diseaseCode)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${diseaseCode} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                                continue;
                            }
                            
                            if (duplicateCodes.has(diseaseCode)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ ${diseaseCode} ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                                continue;
                            }
                            
                            duplicateCodes.add(diseaseCode);
                            processedData.push({
                                diseaseCode,
                                responsibleName,
                                responsiblePosition,
                                reviewerName,
                                reviewerPosition
                            });
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                        }
                        
                        let existingResponsible = await loadFromFirebase('responsible');
                        if (!replaceExisting) {
                            const existingCodes = new Set(existingResponsible.map(r => r.diseaseCode));
                            const duplicateExisting = processedData.filter(r => existingCodes.has(r.diseaseCode));
                            
                            if (duplicateExisting.length > 0) {
                                errors.push(`‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${duplicateExisting.map(r => r.diseaseCode).join(', ')}`);
                            }
                            
                            const newData = processedData.filter(r => !existingCodes.has(r.diseaseCode));
                            processedData.length = 0;
                            processedData.push(...newData);
                        }
                        
                        if (errors.length > 0) {
                            const errorMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? '\\n...' : ''}`;
                            if (!confirm(`${errorMsg}\\n\\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                            }
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                        }
                        
                        const finalData = replaceExisting ? processedData : [...existingResponsible, ...processedData];
                        await saveToFirebase('responsible', finalData);
                        
                        const message = replaceExisting 
                            ? `‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                            : `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        showNotification(message, 'success');
                        closeImportResponsibleModal();
                        loadResponsibleTable();
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Save responsible data
        async function saveResponsibleData(event, editIndex = null) {
            event.preventDefault();
            
            const diseaseCode = document.getElementById('responsibleDiseaseCode').value.trim();
            const responsibleName = document.getElementById('responsibleName').value.trim();
            const responsiblePosition = document.getElementById('responsiblePosition').value.trim();
            const reviewerName = document.getElementById('reviewerName').value.trim();
            const reviewerPosition = document.getElementById('reviewerPosition').value.trim();
            
            if (!diseaseCode || !responsibleName || !responsiblePosition || !reviewerName || !reviewerPosition) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const responsible = await loadFromFirebase('responsible');
                
                // Check for duplicate disease code (only if not editing the same record)
                const existingIndex = responsible.findIndex(r => r.diseaseCode === diseaseCode);
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newResponsible = {
                    diseaseCode,
                    responsibleName,
                    responsiblePosition,
                    reviewerName,
                    reviewerPosition
                };
                
                if (editIndex !== null) {
                    // Edit existing responsible
                    responsible[editIndex] = newResponsible;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new responsible
                    responsible.push(newResponsible);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('responsible', responsible);
                
                // Close modal
                closeResponsibleModal();
                
                // Refresh table
                await loadResponsibleTable();
                
            } catch (error) {
                console.error('Error saving responsible:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit responsible function
        function editResponsible(index) {
            showResponsibleForm(index);
        }

        // Delete responsible function
        async function deleteResponsible(index) {
            const responsible = await loadFromFirebase('responsible');
            const resp = responsible[index];
            
            if (!resp) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            // Get disease name for confirmation
            const diseases = await loadFromFirebase('diseases');
            const disease = diseases.find(d => d.code === resp.diseaseCode);
            const diseaseName = disease ? disease.name : resp.diseaseCode;
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÇ‡∏£‡∏Ñ: ${diseaseName}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${resp.responsibleName}\n‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô: ${resp.reviewerName}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    responsible.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('responsible', responsible);
                    
                    // Refresh table
                    await loadResponsibleTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting responsible:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };
            
            const icons = {
                success: `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>`,
                error: `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/>`,
                info: `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>`,
                warning: `<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/>`
            };
            
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50 slide-in max-w-sm`;
            notificationDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        ${icons[type]}
                    </svg>
                    <div class="font-medium">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notificationDiv);
            
            setTimeout(() => {
                notificationDiv.remove();
            }, 4000);
        }
        // Population management functions
        function showPopulationForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'populationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closePopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="populationForm" onsubmit="savePopulationData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Year Input -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                    </svg>
                                    ‡∏õ‡∏µ
                                </label>
                                <input type="number" id="populationYear" name="year" min="2500" max="2600" step="1"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡∏õ‡∏µ ‡∏û.‡∏®." required>
                            </div>
                            <!-- District Name -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                                </label>
                                <input type="text" id="populationDistrict" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å" required>
                            </div>
                            
                            <!-- Male Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                                </label>
                                <input type="number" id="populationMale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 25000" required min="0" oninput="calculateTotal()">
                            </div>
                            
                            <!-- Female Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                                </label>
                                <input type="number" id="populationFemale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 27000" required min="0" oninput="calculateTotal()">
                            </div>
                            
                            <!-- Total Population (Auto-calculated) -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°
                                </label>
                                <input type="number" id="populationTotal" class="w-full input-field bg-gray-50" readonly>
                            </div>
                        </div>
                        
                        <!-- Population Statistics Preview -->
                        <div id="populationPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:</span>
                                    <span id="malePercentage" class="font-bold text-blue-600 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span id="femalePercentage" class="font-bold text-pink-600 ml-2">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closePopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populatePopulationForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('populationDistrict').focus();
            }, 100);
        }

        // Calculate total population and show preview
        function calculateTotal() {
            const male = parseInt(document.getElementById('populationMale').value) || 0;
            const female = parseInt(document.getElementById('populationFemale').value) || 0;
            const total = male + female;
            
            document.getElementById('populationTotal').value = total;
            
            if (total > 0) {
                const malePercent = Math.round((male / total) * 100);
                const femalePercent = Math.round((female / total) * 100);
                
                document.getElementById('malePercentage').textContent = `${malePercent}%`;
                document.getElementById('femalePercentage').textContent = `${femalePercent}%`;
                document.getElementById('populationPreview').classList.remove('hidden');
            } else {
                document.getElementById('populationPreview').classList.add('hidden');
            }
        }

        // Populate form for editing
        async function populatePopulationForm(index) {
            const population = await loadFromFirebase('population');
            const pop = population[index];
            
            if (pop) {
                document.getElementById('populationDistrict').value = pop.district;
                document.getElementById('populationMale').value = pop.malePopulation;
                document.getElementById('populationFemale').value = pop.femalePopulation;
                calculateTotal();
            }
        }

        // Close population modal
        function closePopulationModal() {
            const modal = document.getElementById('populationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save population data
        async function savePopulationData(event, editIndex = null) {
            event.preventDefault();
            
            const year = parseInt(document.getElementById('populationYear').value);
            const district = document.getElementById('populationDistrict').value.trim();
            const male = parseInt(document.getElementById('populationMale').value) || 0;
            const female = parseInt(document.getElementById('populationFemale').value) || 0;
            const total = male + female;
            
            if (!year || !district || total <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            if (year < 2500 || year > 2600) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (2500-2600)', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const population = await loadFromFirebase('population');
                
                // Check for duplicate year and district combination (only if not editing the same record)
                const existingIndex = population.findIndex(p => 
                    p.district.toLowerCase() === district.toLowerCase() && 
                    p.year === year
                );
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification(`‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï ${district} ‡πÉ‡∏ô‡∏õ‡∏µ ${year} ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô`, 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newPopulation = {
                    year,
                    district,
                    malePopulation: male,
                    femalePopulation: female,
                    totalPopulation: total,
                    density: density
                };
                
                if (editIndex !== null) {
                    // Edit existing population
                    population[editIndex] = newPopulation;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new population
                    population.push(newPopulation);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('population', population);
                
                // Close modal
                closePopulationModal();
                
                // Refresh table
                await loadPopulationTable();
                
            } catch (error) {
                console.error('Error saving population:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit population function
        function editPopulation(index) {
            showPopulationForm(index);
        }

        // Delete population function
        // Show import population modal
        function showImportPopulationModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importPopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£
                        </h3>
                        <button onclick="closeImportPopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 2024)</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡πÄ‡∏Ç‡∏ï</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300">2025</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300">31500</td>
                                            <td class="px-3 py-2 border border-gray-300">15000</td>
                                            <td class="px-3 py-2 border border-gray-300">16500</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á/‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="populationExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handlePopulationFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('populationExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadPopulationExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="populationFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRowPopulation" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExistingPopulation" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processPopulationImport()" class="flex-1 btn-primary" id="importPopulationButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportPopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import population modal
        function closeImportPopulationModal() {
            const modal = document.getElementById('importPopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle population file select
        function handlePopulationFileSelect(input) {
            const fileInfo = document.getElementById('populationFileInfo');
            const importButton = document.getElementById('importPopulationButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    fileInfo.innerHTML = '<span class="text-red-600">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <span class="text-green-600">‚úì ${fileName}</span>
                    <span class="text-gray-500">(${fileSize} KB)</span>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download population example file
        function downloadPopulationExampleFile() {
            const data = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [2025, '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', 31500, 15000, 16500],
                [2025, '‡∏î‡∏∏‡∏™‡∏¥‡∏ï', 25000, 12000, 13000],
                [2025, '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', 37500, 18000, 19500],
                [2025, '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', 18800, 9000, 9800],
                [2025, '‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô', 43500, 21000, 22500]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].toString().length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£.xlsx');
        }

        // Process population import
        async function processPopulationImport() {
            const fileInput = document.getElementById('populationExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowPopulation').checked;
            const replaceExisting = document.getElementById('replaceExistingPopulation').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importPopulationButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        let startRow = skipFirstRow ? 1 : 0;
                        const processedData = [];
                        const errors = [];
                        const duplicateKeys = new Set();
                        
                        for (let i = startRow; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const year = row[0] ? Number(row[0]) : NaN;
                            const district = row[1] ? row[1].toString().trim() : '';
                            const malePopulation = row[3] ? Number(row[3]) : NaN;
                            const femalePopulation = row[4] ? Number(row[4]) : NaN;
                            const totalPopulation = row[2] ? Number(row[2]) : (malePopulation + femalePopulation);
                            
                            if (!district || isNaN(year) || isNaN(malePopulation) || isNaN(femalePopulation)) {
                                if (district || row[1] || row[2]) {
                                    errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                                }
                                continue;
                            }
                            
                            if (year < 1900 || year > 2100) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1900-2100 (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‡∏û.‡∏®.)`);
                                continue;
                            }
                            
                            if (malePopulation < 0 || femalePopulation < 0) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 0`);
                                continue;
                            }
                            
                            const key = `${year}_${district}`;
                            if (duplicateKeys.has(key)) {
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï ${district} ‡∏õ‡∏µ ${year} ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                                continue;
                            }
                            
                            duplicateKeys.add(key);
                            processedData.push({
                                year,
                                district,
                                malePopulation,
                                femalePopulation,
                                totalPopulation
                            });
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                        }
                        
                        let existingPopulation = await loadFromFirebase('population');
                        if (!replaceExisting) {
                            const existingKeys = new Set(existingPopulation.map(p => `${p.year}_${p.district}`));
                            const duplicateExisting = processedData.filter(p => existingKeys.has(`${p.year}_${p.district}`));
                            
                            if (duplicateExisting.length > 0) {
                                errors.push(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${duplicateExisting.map(p => `${p.district} (‡∏õ‡∏µ ${p.year})`).join(', ')}`);
                            }
                            
                            const newData = processedData.filter(p => !existingKeys.has(`${p.year}_${p.district}`));
                            processedData.length = 0;
                            processedData.push(...newData);
                        }
                        
                        if (errors.length > 0) {
                            const errorMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? '\\n...' : ''}`;
                            if (!confirm(`${errorMsg}\\n\\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                            }
                        }
                        
                        if (processedData.length === 0) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                        }
                        
                        const finalData = replaceExisting ? processedData : [...existingPopulation, ...processedData];
                        await saveToFirebase('population', finalData);
                        
                        const message = replaceExisting 
                            ? `‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                            : `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${processedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        showNotification(message, 'success');
                        closeImportPopulationModal();
                        loadPopulationTable();
                        
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showNotification(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        async function deletePopulation(index) {
            const population = await loadFromFirebase('population');
            const pop = population[index];
            
            if (!pop) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const totalPop = pop.totalPopulation || (pop.malePopulation + pop.femalePopulation);
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÄ‡∏Ç‡∏ï: ${pop.district}\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°: ${totalPop.toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢: ${pop.malePopulation.toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á: ${pop.femalePopulation.toLocaleString()} ‡∏Ñ‡∏ô\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    population.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('population', population);
                    
                    // Refresh table
                    await loadPopulationTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting population:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Age Population management functions
        function showAgePopulationForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'agePopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeAgePopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="agePopulationForm" onsubmit="saveAgePopulationData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Year Input -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                    </svg>
                                    ‡∏õ‡∏µ
                                </label>
                                <input type="number" id="agePopulationYear" name="year" min="1900" max="2100" step="1"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡∏õ‡∏µ ‡∏Ñ.‡∏®." value="2025" required>
                            </div>
                            <!-- Age Group -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                                </label>
                                <input type="text" id="agePopulationGroup" name="ageGroup"
                                    class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 0-4 ‡∏õ‡∏µ, 5-9 ‡∏õ‡∏µ" required>
                            </div>
                            
                            <!-- Male Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                                </label>
                                <input type="number" id="agePopulationMale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 125000" required min="0" oninput="calculateAgeTotal()">
                            </div>
                            
                            <!-- Female Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                                </label>
                                <input type="number" id="agePopulationFemale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 135000" required min="0" oninput="calculateAgeTotal()">
                            </div>
                            
                            <!-- Total Population (Auto-calculated) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°
                                </label>
                                <input type="number" id="agePopulationTotal" class="w-full input-field bg-gray-50" readonly>
                            </div>
                            
                            <!-- Percentage -->
                        </div>
                        
                        <!-- Age Population Statistics Preview -->
                        <div id="agePopulationPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:</span>
                                    <span id="ageMalePercentage" class="font-bold text-blue-600 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span id="ageFemalePercentage" class="font-bold text-pink-600 ml-2">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeAgePopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateAgePopulationForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('agePopulationGroup').focus();
            }, 100);
        }

        // Calculate total age population and show preview
        function calculateAgeTotal() {
            const male = parseInt(document.getElementById('agePopulationMale').value) || 0;
            const female = parseInt(document.getElementById('agePopulationFemale').value) || 0;
            const total = male + female;
            
            document.getElementById('agePopulationTotal').value = total;
            
            if (total > 0) {
                const malePercent = Math.round((male / total) * 100);
                const femalePercent = Math.round((female / total) * 100);
                
                document.getElementById('ageMalePercentage').textContent = `${malePercent}%`;
                document.getElementById('ageFemalePercentage').textContent = `${femalePercent}%`;
                document.getElementById('agePopulationPreview').classList.remove('hidden');
            } else {
                document.getElementById('agePopulationPreview').classList.add('hidden');
            }
        }

        // Populate form for editing
        async function populateAgePopulationForm(index) {
            const agePopulation = await loadFromFirebase('agePopulation');
            const age = agePopulation[index];
            
            if (age) {
                document.getElementById('agePopulationGroup').value = age.ageGroup;
                document.getElementById('agePopulationMale').value = age.male;
                document.getElementById('agePopulationFemale').value = age.female;
                document.getElementById('agePopulationPercentage').value = age.percentage;
                calculateAgeTotal();
            }
        }

        // Close age population modal
        function closeAgePopulationModal() {
            const modal = document.getElementById('agePopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show import age population modal
        function showImportAgePopulationModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importAgePopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                        </h3>
                        <button onclick="closeImportAgePopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</li>
                            </ol>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-gray-700 font-semibold mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300">2025</td>
                                            <td class="px-3 py-2 border border-gray-300">0-4 ‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">25000</td>
                                            <td class="px-3 py-2 border border-gray-300">12800</td>
                                            <td class="px-3 py-2 border border-gray-300">12200</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                                <p>‚Ä¢ <strong>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏ä‡πà‡∏ô "0-4 ‡∏õ‡∏µ", "5-9 ‡∏õ‡∏µ"</p>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-4">
                            <div>
                                <input type="file" id="agePopulationExcelFile" accept=".xlsx, .xls" class="hidden" onchange="handleAgePopulationFileSelect(this)">
                                <div class="flex justify-between items-center">
                                    <button onclick="document.getElementById('agePopulationExcelFile').click()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                                        </svg>
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                                    </button>
                                    <button onclick="downloadAgePopulationExampleFile()" class="btn-secondary text-sm">
                                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                        </svg>
                                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                                    </button>
                                </div>
                                <div id="agePopulationFileInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="skipFirstRowAge" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="replaceExistingAge" class="form-checkbox text-green-600">
                                <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            </label>
                        </div>

                        <div class="flex space-x-4 mt-8">
                            <button onclick="processAgePopulationImport()" class="flex-1 btn-primary" id="importAgePopulationButton" disabled>
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L10 8.586V3a1 1 0 012 0v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <button onclick="closeImportAgePopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        // Close import age population modal
        function closeImportAgePopulationModal() {
            const modal = document.getElementById('importAgePopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle age population file select
        function handleAgePopulationFileSelect(input) {
            const fileInfo = document.getElementById('agePopulationFileInfo');
            const importButton = document.getElementById('importAgePopulationButton');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                if (!fileName.match(/\.(xls|xlsx)$/)) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xls, .xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                    fileInfo.innerHTML = '';
                    importButton.disabled = true;
                    return;
                }
                
                fileInfo.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-gray-700">${fileName}</span>
                        <span class="text-gray-500">(${fileSize} KB)</span>
                    </div>
                `;
                importButton.disabled = false;
                
            } else {
                fileInfo.innerHTML = '';
                importButton.disabled = true;
            }
        }

        // Download age population example file
        function downloadAgePopulationExampleFile() {
            const currentYear = new Date().getFullYear();
            const data = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [currentYear, '0-4 ‡∏õ‡∏µ', 25000, 12800, 12200],
                [currentYear, '5-9 ‡∏õ‡∏µ', 28000, 14300, 13700],
                [currentYear, '10-14 ‡∏õ‡∏µ', 30000, 15400, 14600],
                [currentYear, '15-19 ‡∏õ‡∏µ', 32000, 16100, 15900],
                [currentYear, '20-24 ‡∏õ‡∏µ', 35000, 17200, 17800]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏');
            
            // Auto-size columns
            const colWidths = data[0].map((col, i) => {
                return {wch: Math.max(...data.map(row => row[i].toString().length))};
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏.xlsx');
        }

        // Process age population import
        async function processAgePopulationImport() {
            const fileInput = document.getElementById('agePopulationExcelFile');
            const skipFirstRow = document.getElementById('skipFirstRowAge').checked;
            const replaceExisting = document.getElementById('replaceExistingAge').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importAgePopulationButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            `;
            importButton.disabled = true;
            
            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length < 2) {
                        showNotification('‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    // Start processing from row 1 if skipFirstRow is true
                    const startRow = skipFirstRow ? 1 : 0;
                    let newData = [];
                    let errors = [];
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 5) continue; // Skip incomplete rows - now checking for 5 columns
                        
                        const year = parseInt(row[0]);
                        const ageGroup = row[1]?.toString().trim();
                        const total = parseInt(row[2]);
                        const male = parseInt(row[3]);
                        const female = parseInt(row[4]);
                        
                        if (!year || !ageGroup || isNaN(total) || isNaN(male) || isNaN(female)) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            continue;
                        }
                        
                        if (year < 1900 || year > 2100) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1}: ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1900-2100 (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‡∏û.‡∏®.)`);
                            continue;
                        }
                        
                        newData.push({
                            year: year.toString(),
                            ageGroup,
                            total,
                            male,
                            female
                        });
                    }
                    
                    if (errors.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`, 'error');
                        importButton.innerHTML = originalText;
                        importButton.disabled = false;
                        return;
                    }
                    
                    try {
                        let existingData = replaceExisting ? [] : await loadFromFirebase('agePopulation');
                        
                        // Update existing data with new data
                        for (const newItem of newData) {
                            const existingIndex = existingData.findIndex(item => 
                                item.year === newItem.year && 
                                item.ageGroup.toLowerCase() === newItem.ageGroup.toLowerCase()
                            );
                            
                            if (existingIndex !== -1) {
                                existingData[existingIndex] = newItem;
                            } else {
                                existingData.push(newItem);
                            }
                        }
                        
                        await saveToFirebase('agePopulation', existingData);
                        await loadAgePopulationTable();
                        
                        showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeImportAgePopulationModal();
                        
                    } catch (error) {
                        console.error('Error saving data:', error);
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                    
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }

        // Save age population data
        async function saveAgePopulationData(event, editIndex = null) {
            event.preventDefault();
            
            const year = parseInt(document.getElementById('agePopulationYear').value);
            const ageGroup = document.getElementById('agePopulationGroup').value.trim();
            const male = parseInt(document.getElementById('agePopulationMale').value) || 0;
            const female = parseInt(document.getElementById('agePopulationFemale').value) || 0;
            const total = male + female;
            
            if (!year || !ageGroup || total <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            const currentYear = new Date().getFullYear();
            if (year < 1900 || year > currentYear + 10) {
                showNotification(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (1900-${currentYear + 10})`, 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const agePopulation = await loadFromFirebase('agePopulation');
                
                // Check for duplicate year (only if not editing the same record)
                const existingYearRecord = agePopulation.findIndex(a => a.year === year.toString());
                if (existingYearRecord !== -1 && existingYearRecord !== editIndex) {
                    showNotification('‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newAgePopulation = {
                    year: year.toString(),
                    ageGroup,
                    male: male.toString(),
                    female: female.toString(),
                    total: total.toString()
                };
                
                if (editIndex !== null) {
                    // Edit existing age population
                    agePopulation[editIndex] = newAgePopulation;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new age population
                    agePopulation.push(newAgePopulation);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('agePopulation', agePopulation);
                
                // Close modal
                closeAgePopulationModal();
                
                // Refresh table
                await loadAgePopulationTable();
                
            } catch (error) {
                console.error('Error saving age population:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit age population function
        function editAgePopulation(index) {
            showAgePopulationForm(index);
        }

        // Delete age population function
        async function deleteAgePopulation(index) {
            const agePopulation = await loadFromFirebase('agePopulation');
            const age = agePopulation[index];
            
            if (!age) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏õ‡∏µ: ${age.year || 2025}\n‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏: ${age.ageGroup}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£: ${parseInt(age.total).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏ä‡∏≤‡∏¢: ${parseInt(age.male).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏´‡∏ç‡∏¥‡∏á: ${parseInt(age.female).toLocaleString()} ‡∏Ñ‡∏ô\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    agePopulation.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('agePopulation', agePopulation);
                    
                    // Save empty array if it's the last item
                    if (agePopulation.length === 0) {
                        await saveToFirebase('agePopulation', []);
                    }
                    
                    // Refresh the table to show updated data
                    await loadAgePopulationTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting age population:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Thailand Population management functions
        function showThailandPopulationForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'thailandPopulationModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeThailandPopulationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="thailandPopulationForm" onsubmit="saveThailandPopulationData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Year -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                    </svg>
                                    ‡∏õ‡∏µ (‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä)
                                </label>
                                <input type="number" id="thailandYear" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2025" min="1900" max="2100" required>
                            </div>
                            <!-- Province Name -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                </label>
                                <input type="text" id="thailandProvince" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" required>
                            </div>
                            
                            <!-- Male Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                                </label>
                                <input type="number" id="thailandMale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2500000" required min="0" oninput="calculateThailandTotal()">
                            </div>
                            
                            <!-- Female Population -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                                </label>
                                <input type="number" id="thailandFemale" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2700000" required min="0" oninput="calculateThailandTotal()">
                            </div>
                            
                            <!-- Total Population (Auto-calculated) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°
                                </label>
                                <input type="number" id="thailandTotal" class="w-full input-field bg-gray-50" readonly>
                            </div>
                        </div>
                        
                        <!-- Thailand Population Statistics Preview -->
                        <div id="thailandPopulationPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢:</span>
                                    <span id="thailandMalePercentage" class="font-bold text-blue-600 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á:</span>
                                    <span id="thailandFemalePercentage" class="font-bold text-pink-600 ml-2">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeThailandPopulationModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateThailandPopulationForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('thailandProvince').focus();
            }, 100);
        }

        // Calculate total Thailand population and show preview
        function calculateThailandTotal() {
            const male = parseInt(document.getElementById('thailandMale').value) || 0;
            const female = parseInt(document.getElementById('thailandFemale').value) || 0;
            const total = male + female;
            
            document.getElementById('thailandTotal').value = total;
            
            if (total > 0) {
                const malePercent = Math.round((male / total) * 100);
                const femalePercent = Math.round((female / total) * 100);
                
                document.getElementById('thailandMalePercentage').textContent = `${malePercent}%`;
                document.getElementById('thailandFemalePercentage').textContent = `${femalePercent}%`;
                document.getElementById('thailandPopulationPreview').classList.remove('hidden');
            } else {
                document.getElementById('thailandPopulationPreview').classList.add('hidden');
            }
        }

        // Populate form for editing
        async function populateThailandPopulationForm(index) {
            const thailandPopulation = await loadFromFirebase('thailandPopulation');
            const province = thailandPopulation[index];
            
            if (province) {
                document.getElementById('thailandYear').value = province.year;
                document.getElementById('thailandProvince').value = province.province;
                document.getElementById('thailandMale').value = province.male;
                document.getElementById('thailandFemale').value = province.female;
                calculateThailandTotal();
            }
        }

        // Close Thailand population modal
        function closeThailandPopulationModal() {
            const modal = document.getElementById('thailandPopulationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save Thailand population data
        async function saveThailandPopulationData(event, editIndex = null) {
            event.preventDefault();
            
            const year = parseInt(document.getElementById('thailandYear').value);
            const province = document.getElementById('thailandProvince').value.trim();
            const male = parseInt(document.getElementById('thailandMale').value) || 0;
            const female = parseInt(document.getElementById('thailandFemale').value) || 0;
            const total = male + female;
            
            if (!year || year < 1900 || year > 2100) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            if (!province || total <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const thailandPopulation = await loadFromFirebase('thailandPopulation');
                
                // Check for duplicate province (only if not editing the same record)
                const existingIndex = thailandPopulation.findIndex(p => p.province.toLowerCase() === province.toLowerCase());
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newThailandPopulation = {
                    year,
                    province,
                    male: male.toString(),
                    female: female.toString(),
                    total: total.toString()
                };
                
                if (editIndex !== null) {
                    // Edit existing Thailand population
                    thailandPopulation[editIndex] = newThailandPopulation;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new Thailand population
                    thailandPopulation.push(newThailandPopulation);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('thailandPopulation', thailandPopulation);
                
                // Close modal
                closeThailandPopulationModal();
                
                // Refresh table
                await loadThailandPopulationTable();
                
            } catch (error) {
                console.error('Error saving Thailand population:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit Thailand population function
        function editThailandPopulation(index) {
            showThailandPopulationForm(index);
        }

        // Delete Thailand population function
        async function deleteThailandPopulation(index) {
            const thailandPopulation = await loadFromFirebase('thailandPopulation');
            const province = thailandPopulation[index];
            
            if (!province) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${province.province}\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢: ${parseInt(province.male).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á: ${parseInt(province.female).toLocaleString()} ‡∏Ñ‡∏ô\n‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°: ${parseInt(province.total).toLocaleString()} ‡∏Ñ‡∏ô\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    thailandPopulation.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('thailandPopulation', thailandPopulation);
                    
                    // Refresh table
                    await loadThailandPopulationTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting Thailand population:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Bangkok District management functions
        function showBangkokDistrictForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'bangkokDistrictModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${title}
                        </h3>
                        <button onclick="closeBangkokDistrictModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="bangkokDistrictForm" onsubmit="saveBangkokDistrictData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Subdistrict Name -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                    </svg>
                                    ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á
                                </label>
                                <input type="text" id="bangkokSubdistrict" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡∏•‡∏°" required>
                            </div>
                            
                            <!-- District Input -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                    </svg>
                                    ‡πÄ‡∏Ç‡∏ï
                                </label>
                                <input type="text" id="bangkokDistrict" class="w-full input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å" required oninput="updateDistrictPreview()">
                            </div>
                            
                            <!-- Province (Auto-filled) -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    <svg class="w-4 h-4 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/>
                                    </svg>
                                    ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                </label>
                                <input type="text" id="bangkokProvince" class="w-full input-field bg-gray-50" value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" readonly>
                            </div>
                        </div>
                        
                        <!-- Data Preview -->
                        <div id="bangkokDistrictPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="bg-white rounded-lg p-3">
                                    <span class="text-gray-600 block mb-1">‡πÅ‡∏Ç‡∏ß‡∏á:</span>
                                    <span id="previewSubdistrict" class="font-bold text-gray-900">-</span>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <span class="text-gray-600 block mb-1">‡πÄ‡∏Ç‡∏ï:</span>
                                    <span id="previewDistrict" class="font-bold text-blue-600">-</span>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <span class="text-gray-600 block mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
                                    <span id="previewProvince" class="font-bold text-green-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeBangkokDistrictModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateBangkokDistrictForm(editIndex);
            }
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('bangkokSubdistrict').focus();
            }, 100);
        }

        // Update district preview
        function updateDistrictPreview() {
            const subdistrict = document.getElementById('bangkokSubdistrict').value.trim();
            const district = document.getElementById('bangkokDistrict').value;
            
            if (subdistrict || district) {
                document.getElementById('previewSubdistrict').textContent = subdistrict || '-';
                document.getElementById('previewDistrict').textContent = district || '-';
                document.getElementById('bangkokDistrictPreview').classList.remove('hidden');
            } else {
                document.getElementById('bangkokDistrictPreview').classList.add('hidden');
            }
        }

        // Add event listener for subdistrict input
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'bangkokSubdistrict') {
                updateDistrictPreview();
            }
            // Event listeners for epidemic week form
            if (e.target && (e.target.id === 'epidemicYear' || e.target.id === 'epidemicWeekNumber')) {
                updatePreview();
            }
        });

        // Add event listener for date changes
        document.addEventListener('change', function(e) {
            if (e.target && (e.target.id === 'epidemicStartDate' || e.target.id === 'epidemicEndDate')) {
                updatePreview();
            }
        });

        // Populate form for editing
        async function populateBangkokDistrictForm(index) {
            const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
            const district = bangkokDistricts[index];
            
            if (district) {
                document.getElementById('bangkokSubdistrict').value = district.subdistrict;
                document.getElementById('bangkokDistrict').value = district.district;
                document.getElementById('bangkokProvince').value = district.province;
                updateDistrictPreview();
            }
        }

        // Close Bangkok district modal
        function closeBangkokDistrictModal() {
            const modal = document.getElementById('bangkokDistrictModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save Bangkok district data
        async function saveBangkokDistrictData(event, editIndex = null) {
            event.preventDefault();
            
            const subdistrict = document.getElementById('bangkokSubdistrict').value.trim();
            const district = document.getElementById('bangkokDistrict').value.trim();
            const province = document.getElementById('bangkokProvince').value.trim();
            
            if (!subdistrict || !district || !province) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
                
                // Check for duplicate subdistrict in the same district (only if not editing the same record)
                const existingIndex = bangkokDistricts.findIndex(d => 
                    d.subdistrict.toLowerCase() === subdistrict.toLowerCase() && 
                    d.district.toLowerCase() === district.toLowerCase()
                );
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification('‡πÅ‡∏Ç‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newBangkokDistrict = {
                    subdistrict,
                    district,
                    province
                };
                
                if (editIndex !== null) {
                    // Edit existing Bangkok district
                    bangkokDistricts[editIndex] = newBangkokDistrict;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new Bangkok district
                    bangkokDistricts.push(newBangkokDistrict);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('bangkokDistricts', bangkokDistricts);
                
                // Close modal
                closeBangkokDistrictModal();
                
                // Refresh table
                await loadBangkokDistrictsTable();
                
            } catch (error) {
                console.error('Error saving Bangkok district:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit Bangkok district function
        function editBangkokDistrict(index) {
            showBangkokDistrictForm(index);
        }

        // Delete Bangkok district function
        async function deleteBangkokDistrict(index) {
            const bangkokDistricts = await loadFromFirebase('bangkokDistricts');
            const district = bangkokDistricts[index];
            
            if (!district) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÅ‡∏Ç‡∏ß‡∏á: ${district.subdistrict}\n‡πÄ‡∏Ç‡∏ï: ${district.district}\n‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${district.province}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    bangkokDistricts.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('bangkokDistricts', bangkokDistricts);
                    
                    // Refresh table
                    await loadBangkokDistrictsTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting Bangkok district:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Epidemic Week management functions
        function showEpidemicWeekForm(editIndex = null) {
            const isEdit = editIndex !== null;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'epidemicWeekModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            üìÖ ${title}
                        </h3>
                        <button onclick="closeEpidemicWeekModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="epidemicWeekForm" onsubmit="saveEpidemicWeekData(event, ${editIndex})">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="epidemicYear" class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</label>
                                <input type="number" id="epidemicYear" min="2020" max="2030" value="${new Date().getFullYear()}"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 2024" onchange="calculateWeekDates()" required>
                            </div>
                            
                            <div>
                                <label for="epidemicWeekNumber" class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</label>
                                <input type="number" id="epidemicWeekNumber" min="1" max="53"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 1" onchange="calculateWeekDates()" required>
                            </div>
                            
                            <div>
                                <label for="epidemicStartDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                <input type="date" id="epidemicStartDate"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    onchange="updateEndDate()" required>
                            </div>
                            
                            <div>
                                <label for="epidemicEndDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                <input type="date" id="epidemicEndDate"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    required>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="epidemicNote" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                <textarea id="epidemicNote" rows="3"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ô‡∏µ‡πâ..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Week Preview -->
                        <div id="epidemicWeekPreview" class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg hidden">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <div class="text-gray-600">‡∏õ‡∏µ/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                                    <div class="text-lg font-bold text-blue-600" id="previewYearWeek">-</div>
                                </div>
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <div class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
                                    <div class="text-lg font-bold text-green-600" id="previewStartDate">-</div>
                                </div>
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <div class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</div>
                                    <div class="text-lg font-bold text-purple-600" id="previewEndDate">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-8">
                            <button type="submit" class="flex-1 btn-primary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                            </button>
                            <button type="button" onclick="closeEpidemicWeekModal()" class="flex-1 btn-secondary">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                </svg>
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // If editing, populate form with existing data
            if (isEdit) {
                populateEpidemicWeekForm(editIndex);
            }
            
            // Calculate initial week dates
            calculateWeekDates();
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('epidemicWeekNumber').focus();
            }, 100);
        }

        // Calculate week dates based on year and week number
        function calculateWeekDates() {
            const year = parseInt(document.getElementById('epidemicYear').value);
            const weekNumber = parseInt(document.getElementById('epidemicWeekNumber').value);
            
            if (!year || !weekNumber) return;
            
            // Calculate the start date of the epidemic week
            const startDate = getDateOfWeek(year, weekNumber);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            
            // Format dates for input fields
            document.getElementById('epidemicStartDate').value = formatDateForInput(startDate);
            document.getElementById('epidemicEndDate').value = formatDateForInput(endDate);
            
            updatePreview();
        }

        // Update end date when start date changes
        function updateEndDate() {
            const startDate = new Date(document.getElementById('epidemicStartDate').value);
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                document.getElementById('epidemicEndDate').value = formatDateForInput(endDate);
                updatePreview();
            }
        }

        // Update preview information
        function updatePreview() {
            const year = document.getElementById('epidemicYear').value;
            const weekNumber = document.getElementById('epidemicWeekNumber').value;
            const startDate = document.getElementById('epidemicStartDate').value;
            const endDate = document.getElementById('epidemicEndDate').value;
            
            if (year && weekNumber && startDate && endDate) {
                document.getElementById('previewYearWeek').textContent = `${year}/${weekNumber}`;
                document.getElementById('previewStartDate').textContent = formatDateThai(startDate);
                document.getElementById('previewEndDate').textContent = formatDateThai(endDate);
                document.getElementById('epidemicWeekPreview').classList.remove('hidden');
            } else {
                document.getElementById('epidemicWeekPreview').classList.add('hidden');
            }
        }

        // Helper function to get the start date of a week
        function getDateOfWeek(year, week) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        // Helper function to format date for input
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // Helper function to format date in Thai
        function formatDateThai(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Populate form for editing
        async function populateEpidemicWeekForm(index) {
            const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
            const week = epidemicWeeks[index];
            
            if (week) {
                document.getElementById('epidemicYear').value = week.year;
                document.getElementById('epidemicWeekNumber').value = week.weekNumber;
                document.getElementById('epidemicStartDate').value = week.startDate;
                document.getElementById('epidemicEndDate').value = week.endDate;
                document.getElementById('epidemicNote').value = week.note || '';
                updatePreview();
            }
        }

        // Close epidemic week modal
        function closeEpidemicWeekModal() {
            const modal = document.getElementById('epidemicWeekModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save epidemic week data
        async function saveEpidemicWeekData(event, editIndex = null) {
            event.preventDefault();
            
            const year = document.getElementById('epidemicYear').value;
            const weekNumber = parseInt(document.getElementById('epidemicWeekNumber').value);
            const startDate = document.getElementById('epidemicStartDate').value;
            const endDate = document.getElementById('epidemicEndDate').value;
            const note = document.getElementById('epidemicNote').value.trim();
            
            if (!year || !weekNumber || !startDate || !endDate) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            // Validate week number
            if (weekNumber < 1 || weekNumber > 53) {
                showNotification('‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-53', 'error');
                return;
            }
            
            // Validate dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end <= start) {
                showNotification('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
                return;
            }
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;
            submitBtn.disabled = true;
            
            try {
                const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
                
                // Check for duplicate year/week combination (only if not editing the same record)
                const existingIndex = epidemicWeeks.findIndex(w => 
                    parseInt(w.year) === parseInt(year) && 
                    parseInt(w.weekNumber) === weekNumber
                );
                if (existingIndex !== -1 && existingIndex !== editIndex) {
                    showNotification(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${weekNumber} ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ${year} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô`, 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const newEpidemicWeek = {
                    year: year.toString(),
                    weekNumber: weekNumber.toString(),
                    startDate,
                    endDate,
                    note: note || ''
                };
                
                if (editIndex !== null) {
                    // Edit existing epidemic week
                    epidemicWeeks[editIndex] = newEpidemicWeek;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    // Add new epidemic week
                    epidemicWeeks.push(newEpidemicWeek);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
                
                // Save to Firebase
                await saveToFirebase('epidemicWeeks', epidemicWeeks);
                
                // Close modal
                closeEpidemicWeekModal();
                
                // Refresh table
                await loadEpidemicWeeksTable();
                
            } catch (error) {
                console.error('Error saving epidemic week:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Edit epidemic week function
        function editEpidemicWeek(index) {
            showEpidemicWeekForm(index);
        }

        // Delete epidemic week function
        async function deleteEpidemicWeek(index) {
            const epidemicWeeks = await loadFromFirebase('epidemicWeeks');
            const week = epidemicWeeks[index];
            
            if (!week) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }
            
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏õ‡∏µ: ${week.year}\n‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà: ${week.weekNumber}\n‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateThai(week.startDate)} - ${formatDateThai(week.endDate)}\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
            
            if (confirmed) {
                try {
                    // Remove from array
                    epidemicWeeks.splice(index, 1);
                    
                    // Save to Firebase
                    await saveToFirebase('epidemicWeeks', epidemicWeeks);
                    
                    // Refresh table
                    await loadEpidemicWeeksTable();
                    
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting epidemic week:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Excel Import Functions
        function showImportExcelModal(dataType) {
            const isResponsible = dataType === 'responsible';
            const isPopulation = dataType === 'population';
            const isAgePopulation = dataType === 'agePopulation';
            const isThailandPopulation = dataType === 'thailandPopulation';
            const isBangkokDistricts = dataType === 'bangkokDistricts';
            
            let title, icon;
            if (isResponsible) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üë•';
            } else if (isPopulation) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üèôÔ∏è';
            } else if (isAgePopulation) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üë∂üëµ';
            } else if (isBangkokDistricts) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üèõÔ∏è';
            } else if (dataType === 'epidemicWeeks') {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üìÖ';
            } else if (isThailandPopulation) {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üáπüá≠';
            } else {
                title = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel';
                icon = 'üìä';
            }
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modalOverlay.id = 'importExcelModal';
            
            modalOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-2xl w-full mx-4 animate-slideInFromTop max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-green-800 to-green-600 bg-clip-text text-transparent">
                            ${icon} ${title}
                        </h3>
                        <button onclick="closeImportExcelModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Import Instructions -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                            ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                        </h4>
                        <div class="text-sm text-blue-700 space-y-2">
                            ${isResponsible ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô A00, B01, C02)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏π‡πâ‡∏î‡∏µ)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E:</strong> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô)</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô)</p>
                            ` : isPopulation ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å, ‡∏ß‡∏±‡∏í‡∏ô‡∏≤, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 25000, 30000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 27000, 32000)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            ` : isAgePopulation ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å, ‡∏ß‡∏±‡∏í‡∏ô‡∏≤, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> 0-14 ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 12000, 15000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> 15-59 ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 35000, 42000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D:</strong> 60+ ‡∏õ‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 8000, 10000)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            ` : isThailandPopulation ? `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£, ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 2500000, 850000)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C:</strong> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 2700000, 920000)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            ` : `
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A:</strong> ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô A00, B01, C02)</p>
                                <p>‚Ä¢ <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ, ‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà)</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>
                            `}
                            <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å:</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                        </div>
                        
                        ${isPopulation ? `
                        <!-- Example Table for Population Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg">
                            <h5 class="font-bold text-orange-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">25000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">27000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ß‡∏±‡∏í‡∏ô‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">42000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">45000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">38000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">41000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏≤‡∏ó‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">35000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">37000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">52000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">55000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">48000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-pink-600">51000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-orange-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï:</strong> ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏¢ + ‡∏´‡∏ç‡∏¥‡∏á</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadPopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isAgePopulation ? `
                        <!-- Example Table for Age Population Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-lg">
                            <h5 class="font-bold text-teal-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">0-14 ‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">15-59 ‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">60+ ‡∏õ‡∏µ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">8,500</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">35,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">8,500</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ß‡∏±‡∏í‡∏ô‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">14,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">58,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">15,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">12,500</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">52,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">14,500</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏≤‡∏ó‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">11,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">47,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">14,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">18,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">71,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-orange-600">18,000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-teal-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏:</strong> 0-14 ‡∏õ‡∏µ (‡πÄ‡∏î‡πá‡∏Å), 15-59 ‡∏õ‡∏µ (‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô), 60+ ‡∏õ‡∏µ (‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏)</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadAgePopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${dataType === 'epidemicWeeks' ? `
                        <!-- Example Table for Epidemic Weeks Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg">
                            <h5 class="font-bold text-emerald-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 text-emerald-600">2566</td>
                                            <td class="px-3 py-2 border border-gray-300 text-blue-600">1</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-01</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-07</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 text-emerald-600">2566</td>
                                            <td class="px-3 py-2 border border-gray-300 text-blue-600">2</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-08</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-14</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600"></td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 text-emerald-600">2566</td>
                                            <td class="px-3 py-2 border border-gray-300 text-blue-600">3</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-15</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">2566-01-21</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-emerald-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏µ:</strong> ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 2023</p>
                                <p>‚Ä¢ <strong>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</strong> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏ô‡∏õ‡∏µ (1-53)</p>
                                <p>‚Ä¢ <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD ‡πÄ‡∏ä‡πà‡∏ô 2023-01-01</p>
                                <p>‚Ä¢ <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadEpidemicWeeksExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isBangkokDistricts ? `
                        <!-- Example Table for Bangkok Districts Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg">
                            <h5 class="font-bold text-indigo-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡πÅ‡∏Ç‡∏ß‡∏á</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡πÄ‡∏Ç‡∏ï</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏µ‡∏•‡∏°</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏ß‡∏á‡∏®‡πå</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ó‡∏∏‡πà‡∏á‡∏û‡∏ç‡∏≤‡πÑ‡∏ó</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ñ‡∏ô‡∏ô‡∏û‡∏ç‡∏≤‡πÑ‡∏ó</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-indigo-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡πÅ‡∏Ç‡∏ß‡∏á:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡∏ß‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</p>
                                <p>‚Ä¢ <strong>‡πÄ‡∏Ç‡∏ï:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà</p>
                                <p>‚Ä¢ <strong>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏™‡πà "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadBangkokDistrictsExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isThailandPopulation ? `
                        <!-- Example Table for Thailand Population Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                            <h5 class="font-bold text-blue-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">2,850,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">3,150,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">850,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">920,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">1,300,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">1,380,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">890,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">940,000</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-semibold text-blue-600">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</td>
                                            <td class="px-3 py-2 border border-gray-300 text-green-600">720,000</td>
                                            <td class="px-3 py-2 border border-gray-300 text-purple-600">760,000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-blue-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á 77 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£:</strong> ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                                <p>‚Ä¢ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏£‡∏ß‡∏°:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏¢ + ‡∏´‡∏ç‡∏¥‡∏á</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadThailandPopulationExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isResponsible ? `
                        <!-- Example Table for Responsible Person Import -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                            <h5 class="font-bold text-purple-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                </svg>
                                ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">C</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">D</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">E</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏π‡πâ‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">B01</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏î‡∏µ</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏û‡∏£ ‡∏î‡∏µ‡πÉ‡∏à</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">C02</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏¢‡πâ‡∏°</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-purple-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÑ‡∏î‡πâ)</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:</strong> ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏ï‡πá‡∏°</p>
                                <p>‚Ä¢ <strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadResponsibleExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${false ? `
                            </h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm border border-gray-300 rounded">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">A</th>
                                            <th class="px-3 py-2 border border-gray-300 text-left font-bold text-gray-700">B</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr class="bg-yellow-50">
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</td>
                                            <td class="px-3 py-2 border border-gray-300 text-gray-600 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">A00</td>
                                            <td class="px-3 py-2 border border-gray-300">‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">B01</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">C02</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">D03</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢</td>
                                        </tr>
                                        <tr>
                                            <td class="px-3 py-2 border border-gray-300 font-mono text-blue-600">E04</td>
                                            <td class="px-3 py-2 border border-gray-300">‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-green-700 space-y-1">
                                <p>‚Ä¢ <strong>‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</strong> ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å")</p>
                                <p>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ:</strong> ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ICD-10 ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</p>
                                <p>‚Ä¢ <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ:</strong> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <button onclick="downloadDiseaseExampleFile()" class="btn-secondary text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                    </svg>
                                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Excel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-6">
                        <label for="excelFileInput" class="block text-sm font-medium text-gray-700 mb-2">
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx, .xls)
                        </label>
                        <div class="relative">
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls" 
                                class="hidden" onchange="handleFileSelect(event, '${dataType}')">
                            <div id="fileDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-green-400 transition-colors"
                                onclick="document.getElementById('excelFileInput').click()">
                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21l3-3m-3 3l3 3m-3-3h8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-gray-600 font-medium mb-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                                <p class="text-gray-400 text-sm">‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                                <p class="text-gray-400 text-xs mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÅ‡∏•‡∏∞ .xls</p>
                            </div>
                        </div>
                        <div id="selectedFileName" class="mt-2 text-sm text-green-600 font-medium hidden"></div>
                    </div>
                    
                    <!-- Options -->
                    <div class="mb-6 space-y-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="skipFirstRow" checked class="mr-2 text-green-600 focus:ring-green-500">
                            <span class="text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="replaceExisting" class="mr-2 text-green-600 focus:ring-green-500">
                            <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                        </label>
                    </div>
                    
                    <!-- Preview Area -->
                    <div id="previewArea" class="mb-6 hidden">
                        <h4 class="font-bold text-gray-700 mb-3">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (5 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å)</h4>
                        <div id="previewTable" class="overflow-x-auto border rounded-lg"></div>
                        <div id="previewSummary" class="mt-3 text-sm text-gray-600"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button id="importButton" onclick="processExcelImport('${dataType}')" 
                            class="flex-1 btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                            </svg>
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="closeImportExcelModal()" class="flex-1 btn-secondary">
                            <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                            </svg>
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            setupFileDropZone(dataType);
        }

        // Setup drag and drop for file
        function setupFileDropZone(dataType = 'diseases') {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('excelFileInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                dropZone.classList.add('border-green-400', 'bg-green-50');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('border-green-400', 'bg-green-50');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect({ target: { files: files } }, dataType);
                }
            }
        }

        // Handle file selection
        let selectedFileData = null;
        let currentDataType = 'diseases';
        
        function handleFileSelect(event, dataType = 'diseases') {
            currentDataType = dataType;
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && !file.name.match(/\\.(xlsx|xls)$/i)) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }
            
            // Show file name
            const fileNameDiv = document.getElementById('selectedFileName');
            fileNameDiv.textContent = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${file.name}`;
            fileNameDiv.classList.remove('hidden');
            
            // Read and parse Excel file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                    
                    selectedFileData = jsonData;
                    showPreview(jsonData, dataType);
                    document.getElementById('importButton').disabled = false;
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Show preview of Excel data
        function showPreview(data, dataType = 'diseases') {
            const skipFirstRow = document.getElementById('skipFirstRow').checked;
            const startRow = skipFirstRow ? 1 : 0;
            const previewData = data.slice(startRow, startRow + 5);
            
            if (previewData.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel', 'error');
                return;
            }
            
            const isResponsible = dataType === 'responsible';
            const isPopulation = dataType === 'population';
            const isAgePopulation = dataType === 'agePopulation';
            const isThailandPopulation = dataType === 'thailandPopulation';
            const previewTable = document.getElementById('previewTable');
            
            if (isThailandPopulation) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (isAgePopulation) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">0-14 ‡∏õ‡∏µ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">15-59 ‡∏õ‡∏µ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">60+ ‡∏õ‡∏µ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[3] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (isPopulation) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (isResponsible) {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[2] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[3] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[4] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                previewTable.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${previewData.map(row => `
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[0] || '-'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900">${row[1] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // Show summary
            const totalRows = data.length - (skipFirstRow ? 1 : 0);
            let validRows;
            
            if (dataType === 'epidemicWeeks') {
                validRows = data.slice(startRow).filter(row =>
                    row[0] && !isNaN(Number(row[0])) && // ‡∏õ‡∏µ
                    row[1] && !isNaN(Number(row[1])) && // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
                    row[2] && row[2].toString().trim() && // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    row[3] && row[3].toString().trim()    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                ).length;
            } else if (isBangkokDistricts) {
                validRows = data.slice(startRow).filter(row =>
                    row[0] && row[0].toString().trim() && // ‡πÅ‡∏Ç‡∏ß‡∏á
                    row[1] && row[1].toString().trim()    // ‡πÄ‡∏Ç‡∏ï
                ).length;
            } else if (isThailandPopulation) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    row[1] && !isNaN(Number(row[1])) && Number(row[1]) >= 0 && // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                    row[2] && !isNaN(Number(row[2])) && Number(row[2]) >= 0    // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                ).length;
            } else if (isAgePopulation) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                    row[1] && !isNaN(Number(row[1])) && Number(row[1]) >= 0 && // 0-14 ‡∏õ‡∏µ
                    row[2] && !isNaN(Number(row[2])) && Number(row[2]) >= 0 && // 15-59 ‡∏õ‡∏µ
                    row[3] && !isNaN(Number(row[3])) && Number(row[3]) >= 0    // 60+ ‡∏õ‡∏µ
                ).length;
            } else if (isPopulation) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                    row[1] && !isNaN(Number(row[1])) && Number(row[1]) >= 0 && // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                    row[2] && !isNaN(Number(row[2])) && Number(row[2]) >= 0    // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
                ).length;
            } else if (isResponsible) {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                    row[1] && row[1].toString().trim() && // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                    row[2] && row[2].toString().trim() && // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                    row[3] && row[3].toString().trim() && // ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                    row[4] && row[4].toString().trim()    // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                ).length;
            } else {
                validRows = data.slice(startRow).filter(row => 
                    row[0] && row[0].toString().trim() && 
                    row[1] && row[1].toString().trim()
                ).length;
            }
            
            document.getElementById('previewSummary').innerHTML = `
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${totalRows}</strong> ‡πÅ‡∏ñ‡∏ß | 
                ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö: <strong>${validRows}</strong> ‡πÅ‡∏ñ‡∏ß
            `;
            
            document.getElementById('previewArea').classList.remove('hidden');
        }

        // Process Excel import
        async function processExcelImport(dataType = 'diseases') {
            if (!selectedFileData) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const importButton = document.getElementById('importButton');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...
            `;
            importButton.disabled = true;
            
            try {
                const skipFirstRow = document.getElementById('skipFirstRow').checked;
                const replaceExisting = document.getElementById('replaceExisting').checked;
                const startRow = skipFirstRow ? 1 : 0;
                
                if (dataType === 'epidemicWeeks') {
                    await processEpidemicWeeksImport(startRow, replaceExisting);
                }
                
                // Close modal and refresh table
                closeImportExcelModal();
                if (dataType === 'agePopulation') {
                    await loadAgePopulationTable();
                } else if (dataType === 'responsible') {
                    await loadResponsibleTable();
                } else if (dataType === 'bangkokDistricts') {
                    await loadBangkokDistrictsTable();
                } else if (dataType === 'epidemicWeeks') {
                    await loadEpidemicWeeksTable();
                }
                
            } catch (error) {
                console.error('Error importing Excel data:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                importButton.innerHTML = originalText;
                importButton.disabled = false;
            }
        }


        // Download example Excel file for population
        function downloadPopulationExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á'],
                [2025, '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', 52000, 25000, 27000],
                [2025, '‡∏ß‡∏±‡∏í‡∏ô‡∏≤', 87000, 42000, 45000],
                [2025, '‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', 79000, 38000, 41000],
                [2025, '‡∏™‡∏≤‡∏ó‡∏£', 72000, 35000, 37000],
                [2025, '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', 107000, 52000, 55000],
                [2025, '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°', 99000, 48000, 51000],
                [2025, '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤', 91000, 44000, 47000],
                [2025, '‡∏ö‡∏≤‡∏á‡∏ô‡∏≤', 181000, 89000, 92000],
                [2025, '‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á', 153000, 75000, 78000],
                [2025, '‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á', 127000, 62000, 65000],
                [2025, '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', 193000, 95000, 98000],
                [2025, '‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', 179000, 88000, 91000],
                [2025, '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', 160000, 78000, 82000],
                [2025, '‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', 255000, 125000, 130000],
                [2025, '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏', 139000, 68000, 71000]
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 18 },  // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï
                { wch: 15 },  // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                { wch: 15 }   // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "FFE082" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add number formatting for population columns
            const numberStyle = {
                numFmt: "#,##0"
            };

            // Apply number formatting to data rows
            for (let row = 2; row <= sampleData.length; row++) {
                ['B', 'C'].forEach(col => {
                    const cell = col + row;
                    if (ws[cell]) {
                        ws[cell].s = numberStyle;
                    }
                });
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for Epidemic Weeks
        function downloadEpidemicWeeksExampleFile() {
            // Create sample data with CE year
            const currentYear = new Date().getFullYear(); // Already in CE format
            const sampleData = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'],
                [currentYear, 1, `${currentYear}-01-01`, `${currentYear}-01-07`, '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ'],
                [currentYear, 2, `${currentYear}-01-08`, `${currentYear}-01-14`, ''],
                [currentYear, 3, `${currentYear}-01-15`, `${currentYear}-01-21`, ''],
                [currentYear, 4, `${currentYear}-01-22`, `${currentYear}-01-28`, ''],
                [currentYear, 5, `${currentYear}-01-29`, `${currentYear}-02-04`, '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 },   // ‡∏õ‡∏µ
                { wch: 12 },  // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
                { wch: 15 },  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                { wch: 15 },  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                { wch: 30 }   // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
            ];

            // Set header style
            const headerStyle = {
                font: { bold: true, color: { rgb: "FF333333" } },
                fill: { fgColor: { rgb: "FFFFF2CC" } }
            };

            // Apply header style to first row
            for (let col of ['A', 'B', 'C', 'D', 'E']) {
                const cell = col + '1';
                if (ws[cell]) {
                    ws[cell].s = headerStyle;
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for Bangkok Districts
        function downloadBangkokDistrictsExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡πÅ‡∏Ç‡∏ß‡∏á', '‡πÄ‡∏Ç‡∏ï'],
                ['‡∏™‡∏µ‡∏•‡∏°', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏ß‡∏á‡∏®‡πå', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏°‡∏´‡∏≤‡∏û‡∏§‡∏í‡∏≤‡∏£‡∏≤‡∏°', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å'],
                ['‡∏ó‡∏∏‡πà‡∏á‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ'],
                ['‡∏ñ‡∏ô‡∏ô‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ'],
                ['‡∏ñ‡∏ô‡∏ô‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ'],
                ['‡∏°‡∏±‡∏Å‡∏Å‡∏∞‡∏™‡∏±‡∏ô', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 20 },  // ‡πÅ‡∏Ç‡∏ß‡∏á
                { wch: 15 }   // ‡πÄ‡∏Ç‡∏ï
            ];

            // Set header style
            const headerStyle = {
                font: { bold: true, color: { rgb: "FF333333" } },
                fill: { fgColor: { rgb: "FFFFF2CC" } }
            };

            // Apply header style to first row
            for (let col of ['A', 'B']) {
                const cell = col + '1';
                if (ws[cell]) {
                    ws[cell].s = headerStyle;
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡πÄ‡∏Ç‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for Thailand population
        function downloadThailandPopulationExampleFile() {
            // Create sample data
            const currentYear = new Date().getFullYear(); // Get current year in CE
            const sampleData = [
                ['‡∏õ‡∏µ (‡∏Ñ.‡∏®.)', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [currentYear, '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', 5666264, 2694574, 2971690],
                [currentYear, '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', 1276745, 598741, 678004],
                [currentYear, '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', 1770000, 850000, 920000],
                [currentYear, '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', 1830000, 890000, 940000],
                [currentYear, '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', 1480000, 720000, 760000]
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 20 },  // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                { wch: 15 },  // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ä‡∏≤‡∏¢
                { wch: 15 }   // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "87CEEB" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add number formatting for population columns
            const numberStyle = {
                numFmt: "#,##0"
            };

            // Apply number formatting to data rows
            for (let row = 2; row <= sampleData.length; row++) {
                ['B', 'C'].forEach(col => {
                    const cell = col + row;
                    if (ws[cell]) {
                        ws[cell].s = numberStyle;
                    }
                });
            }

            XLSX.utils.book_append_sheet(wb, ws, "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢");

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Download example Excel file for age population
        function downloadAgePopulationExampleFile() {
            const data = [
                ['‡∏õ‡∏µ', '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                [2025, '0-4 ‡∏õ‡∏µ', 25000, 12800, 12200],
                [2025, '5-9 ‡∏õ‡∏µ', 28000, 14300, 13700],
                [2025, '10-14 ‡∏õ‡∏µ', 30000, 15400, 14600],
                [2025, '15-19 ‡∏õ‡∏µ', 32000, 16100, 15900],
                [2025, '20-24 ‡∏õ‡∏µ', 35000, 17200, 17800],
                [2568, '25-29 ‡∏õ‡∏µ', 38000, 18500, 19500],
            ];
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            ws['!cols'] = [
                { wch: 8 },   // ‡∏õ‡∏µ
                { wch: 15 },  // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                { wch: 15 },  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
                { wch: 12 },  // ‡∏ä‡∏≤‡∏¢
                { wch: 12 }   // ‡∏´‡∏ç‡∏¥‡∏á
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "FFEB9C" } },  // Light yellow background
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add number formatting for numeric columns
            const numberStyle = {
                numFmt: "#,##0"
            };

            // Apply number formatting to numeric columns (A2:E12)
            for (let row = 2; row <= 12; row++) {
                ['C', 'D', 'E'].forEach(col => {  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£, ‡∏ä‡∏≤‡∏¢, ‡∏´‡∏ç‡∏¥‡∏á
                    const cellRef = col + row;
                    if (ws[cellRef]) {
                        ws[cellRef].s = {
                            alignment: { horizontal: "right" },
                            numFmt: "#,##0"  // Format numbers with thousands separator
                        };
                    }
                });
            }

            XLSX.utils.book_append_sheet(wb, ws, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏");
            XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏.xlsx');
            
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Download example Excel file for responsible persons
        function downloadResponsibleExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô'],
                ['A00', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏π‡πâ‡∏î‡∏µ', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô'],
                ['B01', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏î‡∏µ', '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏û‡∏£ ‡∏î‡∏µ‡πÉ‡∏à', '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£'],
                ['C02', '‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à', '‡πÅ‡∏û‡∏ó‡∏¢‡πå', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏¢‡πâ‡∏°', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å'],
                ['D03', '‡∏ô‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ó‡∏¥‡∏ô ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™', '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', '‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ç ‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'],
                ['E04', '‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Å‡∏£ ‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á', '‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡πÑ‡∏• ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°'],
                ['F05', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏¥‡∏†‡∏≤ ‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡πÄ‡∏ü‡∏∑‡πâ‡∏≠', '‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ô‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≤‡∏ç ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£'],
                ['G06', '‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡∏¢‡∏ß‡∏±‡∏í‡∏ô‡πå ‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤', '‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î', '‡∏ô‡∏≤‡∏á‡∏™‡∏∏‡∏°‡∏≤‡∏•‡∏µ ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π'],
                ['H07', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏≤‡∏ì‡∏µ ‡πÉ‡∏™‡πà‡πÉ‡∏à', '‡∏ô‡∏±‡∏Å‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', '‡∏ô‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏î‡∏≥‡∏£‡∏á', '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 10 },  // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ
                { wch: 20 },  // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                { wch: 25 },  // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                { wch: 20 },  // ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
                { wch: 25 }   // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "FFE082" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Download example Excel file for diseases
        function downloadDiseaseExampleFile() {
            // Create sample data
            const sampleData = [
                ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ', '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ'],
                ['A00', '‡∏≠‡∏´‡∏¥‡∏ß‡∏≤‡∏ï‡∏Å‡πÇ‡∏£‡∏Ñ'],
                ['B01', '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà'],
                ['C02', '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à'],
                ['D03', '‡πÇ‡∏£‡∏Ñ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢'],
                ['E04', '‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô'],
                ['F05', '‡πÇ‡∏£‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á'],
                ['G06', '‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à'],
                ['H07', '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï‡∏ß‡∏≤‡∏¢'],
                ['I08', '‡πÇ‡∏£‡∏Ñ‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á'],
                ['J09', '‡πÇ‡∏£‡∏Ñ‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤']
            ];

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);

            // Set column widths
            ws['!cols'] = [
                { wch: 12 },  // ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ column width
                { wch: 35 }   // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ column width
            ];

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "FFE082" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            if (ws['A1']) ws['A1'].s = headerStyle;
            if (ws['B1']) ws['B1'].s = headerStyle;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏Ñ');

            // Generate filename with current date
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á_‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ_${dateStr}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);

            // Show notification
            showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Close import modal
        function closeImportExcelModal() {
            const modal = document.getElementById('importExcelModal');
            if (modal) {
                modal.remove();
            }
            selectedFileData = null;
            currentDataType = 'diseases';
        }

        // Update preview when options change
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'skipFirstRow' && selectedFileData) {
                showPreview(selectedFileData, currentDataType);
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to be ready
            if (window.initializeFirebaseApp) {
                window.initializeFirebaseApp();
            } else {
                // Fallback if Firebase is not ready
                setTimeout(() => {
                    if (window.initializeFirebaseApp) {
                        window.initializeFirebaseApp();
                    } else {
                        console.warn('‚ö†Ô∏è Firebase not ready, using localStorage only');
                        initializeData();
                        showPage('summary');
                    }
                }, 1000);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9649c11c7372731d',t:'MTc1MzQyNjU1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
